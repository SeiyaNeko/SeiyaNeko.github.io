<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŒ«ã®æ¨¡æ‹Ÿå°é•‡ Ver 3.6.0 - ç¼¤çº·å››å­£</title>
    <style>
        :root { --bg: #f0f2f5; --card: #fff; --primary: #4a90e2; --love: #ff6b6b; --text: #333; --dark: #2d3436; --crime: #8e44ad; --item: #e17055; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; }
        
        /* é¡¶éƒ¨ */
        header { background: var(--card); padding: 10px 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; flex-wrap: wrap; gap: 15px; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .header-group { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        h1 { margin: 0; font-size: 1.2rem; }
        .btn { cursor: pointer; background: var(--primary); color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.9rem; transition: 0.2s; white-space: nowrap; }
        .btn:hover { opacity: 0.9; }
        .btn.save { background: #27ae60; }
        .btn.reset { background: #e74c3c; }
        .btn.gold { background: #f1c40f; color: #333; font-weight: bold; }
        .btn.cyan { background: #00b894; color: white; font-weight: bold; }
        .btn.purple { background: #9b59b6; color: white; font-weight: bold; }
        .btn.speed { background: #e67e22; font-weight: bold; width: 80px; }
        .btn.create { background: #e17055; color: white; font-weight: bold; }
        .btn.create:hover { background: #d35400; }
        .btn.achieve { background: #34495e; color: #fff; font-weight: bold; }
        .btn.gov { background: #2c3e50; color: white; font-weight: bold; border: 1px solid #34495e; }
        .btn.guide { background: #0984e3; color: white; font-weight: bold; }

        .btn.fund { background: #9b59b6; font-size: 0.8rem; padding: 4px 8px; margin-left: 5px; } 
        .btn.accelerate { background: #2ecc71; color: white; font-size: 0.8rem; padding: 4px 8px; margin-top: 5px; width: 100%; border: 1px solid #27ae60; }
        .btn.start-build { background: #95a5a6; color: white; font-size: 0.8rem; padding: 4px 8px; margin-top: 5px; width: 100%; border: 1px solid #7f8c8d; cursor: not-allowed; }
        
        .btn.control { background: #34495e; width: 100%; margin-top: 10px; }
        .btn.upgrade { background: #8e44ad; color: white; border:none; padding:5px 10px; border-radius:4px; font-size:0.85rem; cursor:pointer; }
        .btn.train { background: #e67e22; color: white; border:none; padding:5px 10px; border-radius:4px; font-size:0.85rem; cursor:pointer; margin-left:5px; }

        #calendar-display { cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: background 0.2s; }
        #calendar-display:hover { background: #e1e4e8; }

        input[type="number"] { width: 50px; padding: 4px; }
        select { padding: 6px; border-radius: 4px; border: 1px solid #ddd; }

        /* æ ‡ç­¾å¯¼èˆªæ  */
        .tab-nav { display: flex; gap: 10px; margin-bottom: 15px; background: var(--card); padding: 8px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tab-btn { flex: 1; padding: 10px; cursor: pointer; border: none; background: #f0f2f5; color: #666; border-radius: 6px; font-weight: bold; font-size: 1rem; transition: 0.2s; }
        .tab-btn:hover { background: #e1e4e8; }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 2px 4px rgba(74, 144, 226, 0.3); }

        /* ä¸»åŒºåŸŸ */
        .game-container { display: flex; flex: 1; gap: 15px; overflow: hidden; }
        .col-view { display: none; flex-direction: column; gap: 10px; overflow-y: auto; flex: 2.5; } 
        .col-view.active-view { display: flex; }

        .section-title { font-weight: bold; color: #666; margin-bottom: 5px; display: flex; justify-content: space-between; font-size: 1.1rem; border-bottom: 2px solid #eee; padding-bottom: 8px; }
        
        .char-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; }
        .char-card { cursor: pointer; background: var(--card); padding: 12px; border-radius: 8px; border-left: 5px solid #ddd; font-size: 0.9rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: relative; transition: transform 0.2s, box-shadow 0.2s; }
        .char-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.15); z-index: 1; }
        .char-card.action-social { border-left-color: var(--love); }
        .char-card.action-work { border-left-color: #f1c40f; }
        .char-card.action-build { border-left-color: #e67e22; }
        .char-card.action-lieflat { border-left-color: #a29bfe; background: #f8f8ff; }
        .char-card.action-eat { border-left-color: #00b894; background: #f0fff4; }
        .char-card.action-crime { border-left-color: var(--crime); background: #fcf0ff; }
        .char-card.action-shop { border-left-color: var(--item); background: #fff5f0; } 
        .char-card.action-use { border-left-color: #00cec9; background: #e0f7fa; }
        .char-card.action-jail { border-left-color: #2d3436; background: #dcdde1; color: #636e72; }
        
        .bar-container { height: 6px; background: #eee; margin: 8px 0; border-radius: 3px; overflow: hidden; }
        .bar-fill { height: 100%; width: 0; transition: width 0.3s; }
        .hp-fill { background: #2ecc71; } 
        .food-fill { background: #fdcb6e; }
        .health-fill { background: #ff7675; }

        .build-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 12px; }
        .build-card { cursor: pointer; background: var(--card); padding: 15px; border-radius: 8px; opacity: 0.6; filter: grayscale(1); transition: 0.3s; border: 2px dashed #ccc; display: flex; flex-direction: column; justify-content: space-between; }
        .build-card:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .build-card.built { opacity: 1; filter: grayscale(0); border: 2px solid #27ae60; background: #f0fff4; }
        .build-card.building { opacity: 0.9; filter: grayscale(0.5); border: 2px solid #e67e22; }
        .build-card.active-project { opacity: 1; filter: grayscale(0); border: 2px solid #3498db; background: #f0f8ff; }
        
        .build-prog { font-size: 0.85rem; color: #666; margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee; }
        .lvl-badge { background: #8e44ad; color: white; padding: 1px 5px; border-radius: 3px; font-size: 0.75rem; margin-left: 5px; vertical-align: middle; }
        
        .category-header { grid-column: 1 / -1; font-weight: bold; margin-top: 15px; margin-bottom: 5px; border-left: 4px solid #aaa; padding-left: 8px; background: #f0f2f5; padding: 5px; border-radius: 4px; }

        .col-right { flex: 1; display: flex; flex-direction: column; min-width: 280px; gap: 10px; overflow: hidden;}
        
        .log-container { background: var(--dark); color: #dfe6e9; border-radius: 10px; padding: 10px; overflow-y: auto; font-family: monospace; font-size: 0.85rem; display: flex; flex-direction: column; flex: 1; }
        .log-header { font-weight: bold; margin-bottom: 5px; border-bottom: 1px solid #555; padding-bottom: 5px; color: #b2bec3; display: flex; justify-content: space-between; }
        
        #interaction-log { background: #dfe6e9; color: #2d3436; border: 1px solid #b2bec3; }
        #interaction-log .log-entry { border-bottom: 1px solid #ccc; }
        #interaction-log .log-time { color: #636e72; }

        .log-entry { margin-bottom: 8px; line-height: 1.4; border-bottom: 1px solid #444; padding-bottom: 4px; }
        .log-time { color: #74b9ff; opacity: 0.7; margin-right: 5px; font-size: 0.8em; }
        .tag-love { color: #ff7675; }
        .tag-reject { color: #a29bfe; font-weight: bold; }
        .tag-drama { color: #fdcb6e; font-weight: bold; }
        .tag-build { color: #00b894; }
        .tag-venue { color: #81ecec; font-style: italic; }
        .tag-crime { color: #e056fd; font-weight: bold; text-shadow: 0 0 2px rgba(142, 68, 173, 0.5); }
        .tag-event { color: #0984e3; font-weight: bold; background: rgba(9, 132, 227, 0.1); padding: 2px 4px; border-radius: 3px;}
        .tag-item { color: var(--item); font-weight: bold; }
        .tag-use { color: #00cec9; }
        .tag-promote { color: #f1c40f; font-weight: bold; text-shadow: 0 0 5px rgba(241, 196, 15, 0.3); }
        .tag-weather { color: #74b9ff; font-style: italic; }
        .tag-gov { color: #f39c12; font-weight: bold; border: 1px solid #f39c12; padding: 1px 4px; border-radius: 3px; }
        .tag-gossip { color: #6c5ce7; font-style: italic; }

        @media (max-width: 800px) { 
            .game-container { flex-direction: column; overflow-y: auto; } 
            .col-right { height: 400px; flex: none; order: 3; }
            .col-view { flex: none; }
        }

        /* æ¨¡æ€æ¡† */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: var(--card); padding: 25px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .modal-header h3 { margin: 0; font-size: 1.3rem; }
        .modal-close { cursor: pointer; font-size: 1.5rem; color: #999; background: none; border: none; padding: 0; width: 30px; height: 30px; }
        .modal-close:hover { color: #333; }

        .guide-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .guide-item { background: #f8f9fa; padding: 12px; border-radius: 8px; border: 1px solid #eee; position: relative; overflow: hidden; }
        .guide-item::before { content: ''; position: absolute; top:0; left:0; bottom:0; width:5px; background: #ccc; }
        .guide-name { font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; display: flex; justify-content: space-between; }
        .guide-desc { color: #666; font-size: 0.9rem; margin-bottom: 8px; min-height: 2.5em; }
        .guide-stats { font-size: 0.85rem; color: #555; background: #fff; padding: 5px; border-radius: 4px; }
        .stat-row { display: flex; justify-content: space-between; margin: 2px 0; }

        .detail-group { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .detail-group:last-child { border-bottom: none; }
        .detail-label { font-weight: bold; color: #666; margin-bottom: 5px; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; }
        .detail-val { font-size: 1.05rem; }
        .detail-desc { font-size: 0.9rem; color: #888; margin-top: 4px; font-style: italic; }
        .trait-tag { display: inline-block; padding: 3px 8px; border-radius: 4px; background: #f0f0f0; color: #333; margin-right: 5px; font-size: 0.9rem; margin-bottom: 5px; }
        .ideology-box { padding: 10px; border-radius: 6px; background: #f9f9f9; border: 1px solid #eee; margin-top: 5px; }
        .edit-btn { font-size: 0.8rem; color: var(--primary); cursor: pointer; text-decoration: underline; background: none; border: none; padding: 0; }
        
        .relation-view { display: none; flex: 1; background: var(--card); padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden; flex-direction: column; }
        .relation-view.active { display: flex; }
        .rel-layout { display: flex; gap: 20px; flex: 1; min-height: 0; height: 100%; }
        .rel-graph { flex: 2; border: 1px solid #eee; border-radius: 8px; position: relative; background: #fdfdfd; overflow: hidden; }
        .rel-list { flex: 1; overflow-y: auto; overflow-x: hidden; font-size: 0.9rem; padding-right: 5px; border-left: 1px solid #eee; padding-left: 10px; }
        .rel-item { padding: 8px; border-bottom: 1px solid #eee; }
        .rel-tag { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; margin-right: 5px; color: white; }
        .tag-spouse { background: #e84393; } .tag-lover { background: #ff7675; } .tag-mistress { background: #ff8c00; } .tag-friend { background: #74b9ff; } .tag-bestfriend { background: #3498db; } .tag-ex { background: #636e72; } .tag-stranger { background: #95a5a6; } .tag-enemy { background: #c0392b; }
        canvas { width: 100%; height: 100%; display: block; }

        /* æ’è¡Œæ¦œ */
        .rank-list { display: flex; flex-direction: column; gap: 10px; }
        .rank-item { display: flex; align-items: center; background: #f8f9fa; padding: 10px 15px; border-radius: 8px; border: 1px solid #eee; }
        .rank-num { width: 40px; font-weight: bold; font-size: 1.2rem; color: #999; text-align: center; margin-right: 10px; }
        .rank-1 { color: #f1c40f; font-size: 1.5rem; }
        .rank-2 { color: #bdc3c7; font-size: 1.4rem; }
        .rank-3 { color: #e67e22; font-size: 1.3rem; }
        .rank-info { flex: 1; }
        .rank-name { font-weight: bold; font-size: 1.05rem; }
        .rank-val { font-weight: bold; color: #27ae60; font-family: monospace; font-size: 1.1rem; }
        
        /* å·¥ä½œæ¦œ */
        .job-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .job-name { font-weight: bold; }
        .job-wage { color: #e67e22; font-weight: bold; }
        .job-loc { font-size: 0.85rem; color: #999; }
        .job-section-header { padding: 8px; font-weight: bold; background: #f0f2f5; border-left: 4px solid #333; margin-top: 15px; margin-bottom: 5px; border-radius: 4px; }
        
        /* æ‹¨æ¬¾/æ“ä½œå¼¹çª—æ ·å¼ */
        .fund-list { display: flex; flex-direction: column; gap: 5px; }
        .fund-item { padding: 8px; background: #f9f9f9; border-radius: 4px; cursor: pointer; border: 1px solid #eee; transition: 0.2s; }
        .fund-item:hover { background: #eef5ff; border-color: var(--primary); }
        .fund-item.selected { background: var(--primary); color: white; border-color: var(--primary); }
        
        .action-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px; }
        .action-btn { padding: 8px; border: 1px solid #ddd; border-radius: 5px; background: #f8f9fa; cursor: pointer; font-size: 0.9rem; transition: 0.2s; text-align: center; }
        .action-btn:hover { background: #e1e4e8; border-color: #ccc; }

        /* æ´»åŠ¨ç­–åˆ’å¡ç‰‡ */
        .event-card { display: flex; flex-direction: column; background: #f8f9fa; border: 1px solid #eee; border-radius: 6px; padding: 10px; gap: 5px; transition: 0.2s; }
        .event-card:hover { border-color: var(--primary); background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .event-header { display: flex; justify-content: space-between; align-items: center; }
        .event-name { font-weight: bold; font-size: 1.1rem; }
        .event-cost { font-weight: bold; color: #e67e22; background: #fff3e0; padding: 2px 6px; border-radius: 4px; font-size: 0.9rem; }
        .event-desc { font-size: 0.9rem; color: #666; margin: 5px 0; min-height: 32px; }
        .event-btn { background: var(--primary); color: white; border: none; padding: 6px; border-radius: 4px; cursor: pointer; width: 100%; font-weight: bold; }
        .event-btn:hover { opacity: 0.9; }
        .event-btn:disabled { background: #ccc; cursor: not-allowed; }

        .staff-list-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee; background: #f9f9f9; align-items: center; }
        .staff-role { font-weight: bold; color: #2d3436; margin-right: 5px; }
        .staff-name { color: #0984e3; font-weight: bold; }
        
        /* ç‰©å“ä¸èƒŒåŒ… */
        .bag-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 5px; margin-top: 5px; }
        .bag-item { background: #fff5f0; border: 1px solid #e17055; border-radius: 4px; padding: 5px; text-align: center; font-size: 0.8rem; color: #d35400; cursor:help; }
        
        .history-list { font-size: 0.85rem; color: #555; background: #f8f9fa; border-radius: 6px; padding: 8px; border: 1px solid #eee; max-height: 150px; overflow-y: auto; }
        .history-item { padding: 4px 0; border-bottom: 1px dashed #e0e0e0; }
        .history-item:last-child { border-bottom: none; }
        .history-time { color: #999; font-size: 0.8em; margin-right: 5px; font-family: monospace; }

        .tooltip-item { position: relative; cursor: help; }
        .tooltip-item:hover::after {
            content: attr(data-tip);
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: #fff;
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            white-space: pre-wrap;
            z-index: 9999;
            width: max-content;
            max-width: 220px;
            line-height: 1.4;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            pointer-events: none;
        }
        .tooltip-item:hover::before {
            content: "";
            position: absolute;
            bottom: 110%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.85) transparent transparent transparent;
            z-index: 9999;
        }

        .skill-row { display: flex; align-items: center; margin-bottom: 6px; font-size: 0.85rem; }
        .skill-name { width: 60px; font-weight: bold; color: #555; }
        .skill-track { flex: 1; height: 8px; background: #eee; border-radius: 4px; overflow: hidden; margin: 0 10px; }
        .skill-bar { height: 100%; border-radius: 4px; transition: width 0.3s; }
        .skill-val { width: 30px; text-align: right; color: #777; }
        .sk-social { background: #e84393; }
        .sk-craft { background: #e67e22; }
        .sk-intel { background: #0984e3; }
        .sk-str { background: #2d3436; }
        
        /* é€‰é¡¹å¡è¿‡æ»¤å™¨æ ·å¼ */
        .tab-filter { display:flex; gap:5px; margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px; }
        .filter-btn { background:none; border:none; cursor:pointer; padding:5px 10px; font-weight:bold; color:#999; border-bottom:3px solid transparent; transition:0.2s; }
        .filter-btn.active { color:var(--primary); border-bottom-color:var(--primary); }
        .filter-btn.active { color:var(--primary); border-bottom-color:var(--primary); }
        .filter-btn:hover { color:#666; }

        /* æˆå°±ç³»ç»Ÿæ ·å¼ */
        .achieve-list { display: flex; flex-direction: column; gap: 10px; }
        .achieve-item { display: flex; align-items: center; background: #f8f9fa; padding: 12px; border-radius: 8px; border: 1px solid #eee; opacity: 0.5; filter: grayscale(1); transition: 0.3s; }
        .achieve-item.unlocked { opacity: 1; filter: grayscale(0); border-left: 5px solid #f1c40f; background: #fffff0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .achieve-icon { font-size: 2rem; margin-right: 15px; width: 40px; text-align: center; }
        .achieve-info { flex: 1; }
        .achieve-title { font-weight: bold; font-size: 1.1rem; margin-bottom: 4px; color: #2c3e50; }
        .achieve-desc { font-size: 0.9rem; color: #7f8c8d; }
        .achieve-reward { font-size: 0.85rem; color: #e67e22; margin-top: 4px; font-weight: bold; }

        /* æ”¿åºœé¢æ¿æ ·å¼ */
        .gov-panel { display: flex; flex-direction: column; gap: 15px; }
        .gov-stat-row { display: flex; gap: 15px; flex-wrap: wrap; }
        .gov-stat-card { flex: 1; background: #f8f9fa; border: 1px solid #e1e4e8; padding: 15px; border-radius: 8px; text-align: center; min-width: 140px; }
        .gov-stat-card .label { font-size: 0.9rem; color: #666; margin-bottom: 5px; }
        .gov-stat-card .value { font-size: 1.5rem; font-weight: bold; color: #2c3e50; margin-bottom: 10px; }
        .gov-policy-section { background: #fffcf0; padding: 15px; border: 1px solid #f1c40f; border-radius: 8px; }
        .gov-policy-section h4 { margin: 0 0 10px 0; color: #7f8c8d; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .policy-item { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 10px; }
        .policy-desc { font-size: 0.85rem; color: #666; margin-top: 5px; line-height: 1.4; }

        .checkbox-container { display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none; }
        .policy-name { font-weight: bold; }
        
        .gov-mayor-section { background: #f0f8ff; padding: 15px; border: 1px solid #bcdff1; border-radius: 8px; }
        .mayor-avatar { font-size: 2.5rem; }
        .mayor-details { flex: 1; }
        .mayor-name { font-weight: bold; font-size: 1.2rem; color: #2c3e50; }
        .mayor-ideology { font-size: 0.9rem; padding: 2px 6px; border-radius: 4px; color: white; background: #999; display: inline-block; margin-top: 2px; }
        .mayor-effect { margin-top: 8px; font-size: 0.9rem; color: #555; font-style: italic; }

        /* æŠ•ç¥¨æ¨¡æ€æ¡† */
        .voting-candidate { background: #f8f9fa; border: 2px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 10px; position: relative; overflow: hidden; }
        .voting-candidate.winner { border-color: #27ae60; background: #eaffea; }
        .vote-bar-container { height: 10px; background: #eee; border-radius: 5px; margin-top: 8px; overflow: hidden; }
        .vote-bar-fill { height: 100%; background: #3498db; width: 0%; transition: width 0.3s; }
        .voting-log { max-height: 100px; overflow-y: auto; font-size: 0.85rem; background: #333; color: #fff; padding: 8px; border-radius: 6px; font-family: monospace; margin-top: 15px; }
        
        /* æ—¥å†æ ·å¼ */
        .calendar-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; }
        .month-card { background: #fff; border: 1px solid #eee; border-radius: 6px; padding: 5px; }
        .month-title { text-align: center; font-weight: bold; background: #f0f2f5; padding: 4px; border-radius: 4px; margin-bottom: 5px; font-size: 0.9rem; color: #2c3e50; }
        .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; font-size: 0.7rem; text-align: center; }
        .day-cell { padding: 2px 0; border-radius: 3px; position: relative; }
        .day-cell.today { background: var(--primary); color: white; font-weight: bold; }
        .day-cell.event-day { background: #ff7675; color: white; cursor: help; }
        .day-cell.event-day:hover::after {
            content: attr(data-evt);
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 4px 6px; border-radius: 4px;
            white-space: nowrap; z-index: 10;
        }

    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body>

<header>
    <div class="header-group">
        <h1>ğŸ¡ çŒ«ã®æ¨¡æ‹Ÿå°é•‡ <small>Ver 3.6.0 ç¼¤çº·å››å­£</small></h1>
        <div style="font-size: 0.9rem;">
            <span id="calendar-display" onclick="showCalendar()" title="ç‚¹å‡»æŸ¥çœ‹å…¨å¹´æ—¥å†">ğŸ“… 1æœˆ1æ—¥ (å†¬)</span> <span id="weather-display" style="margin-left:5px; color:#0984e3;"></span> |
            <span id="game-day">å‘¨ä¸€</span> |
            <span>ğŸ•’ <span id="game-time">08:00</span></span> <button class="btn speed" onclick="toggleSpeed()" id="speed-btn">â¸ æ­£å¸¸</button>
        </div>
    </div>
    <div class="header-group">
        <button class="btn gov" onclick="showGov()">ğŸ› æ”¿åºœ & è´¢æ”¿</button>
        <button class="btn purple" onclick="showTownEvents()">ğŸ‰ ä¸¾åŠæ´»åŠ¨</button>
        <button class="btn achieve" onclick="showAchievements()">ğŸ† æˆå°±</button>
        <button class="btn gold" onclick="showLeaderboard()">ğŸ“Š æ’è¡Œæ¦œ</button>
        <button class="btn cyan" onclick="showJobBoard()">ğŸ“‹ å·¥ä½œæ¦œ</button>
        <button class="btn guide" onclick="showGameGuide()">ğŸ“˜ æ¸¸æˆå›¾é‰´</button>
        <button class="btn" onclick="toggleRelationView()">â¤ å…³ç³»è°±</button>
        <span style="font-size:0.8rem;">è‡ªåŠ¨å­˜æ¡£: <input type="number" id="autosave-rate" value="30" min="5">ç§’</span>
        <button class="btn save" onclick="manualSave()">ğŸ’¾ å­˜æ¡£</button>
    </div>
</header>

<div class="tab-nav">
    <button class="tab-btn active" onclick="switchTab('residents')" id="tab-residents">ğŸ‘¥ å±…æ°‘çŠ¶æ€</button>
    <button class="tab-btn" onclick="switchTab('buildings')" id="tab-buildings">ğŸ—ï¸ å°é•‡å»ºè®¾</button>
</div>

<div class="game-container" id="main-view">
    <div class="col-view active-view" id="view-residents">
        <div class="section-title">å±…æ°‘ç”Ÿæ´»åœˆ <small style="font-weight:normal; font-size:0.8em; color:#999;">(ç‚¹å‡»å¡ç‰‡æŸ¥çœ‹è¯¦æƒ…)</small></div>
        <div class="char-grid" id="char-list"></div>
    </div>

    <div class="col-view" id="view-buildings">
        <div class="section-title">å…¬å…±è®¾æ–½å»ºè®¾ <small style="font-weight:normal; font-size:0.8em; color:#999;">(æ‰€æœ‰å»ºè®¾å‡ç”±é•‡é•¿å‘èµ·æŠ•ç¥¨å†³å®š)</small></div>
        <div class="build-grid" id="build-list"></div>
    </div>

    <div class="col-right">
        <div class="log-container">
            <div class="log-header">ğŸ“¡ ç³»ç»Ÿå…¬å‘Š</div>
            <div id="game-log">
                <div class="log-entry">âœ¨ æ¸¸æˆå¼€å§‹ã€‚Ver 3.6.0 ç¼¤çº·å››å­£æ›´æ–°ï¼ç‚¹å‡»å·¦ä¸Šè§’æ—¥å†æŸ¥çœ‹å…¨å¹´èŠ‚æ—¥ã€‚</div>
            </div>
        </div>
        <div class="log-container" id="interaction-log-container">
             <div class="log-header" style="color:#2d3436">ğŸ’¬ å±…æ°‘äº’åŠ¨</div>
             <div id="interaction-log"></div>
        </div>
    </div>
</div>

<div class="relation-view" id="relation-view">
    <div style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:center">
        <h2 style="margin:0; font-size:1.2rem">â¤ å±…æ°‘å…³ç³»è°±</h2>
        <button class="btn" onclick="toggleRelationView()">ğŸ”™ è¿”å›å°é•‡</button>
    </div>
    <div id="rel-stats" style="background:#f8f9fa; padding:10px; border-radius:6px; margin-bottom:15px; font-size:0.9rem; display:flex; gap:20px; border:1px solid #eee;">
        <span style="color:#e17055">ğŸ”¥ <b>äººæ°”ç‹:</b> <span id="stat-pop">è®¡ç®—ä¸­...</span></span>
        <span style="color:#636e72">ğŸ‚ <b>å°é€æ˜:</b> <span id="stat-lonely">è®¡ç®—ä¸­...</span></span>
    </div>
    <div class="rel-layout">
        <div class="rel-graph" id="rel-graph-container"><canvas id="rel-canvas"></canvas></div>
        <div class="rel-list" id="rel-list"></div>
    </div>
</div>

<!-- æ¨¡æ€æ¡†å®šä¹‰ -->
<div class="modal-overlay" id="guide-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ“˜ æ¸¸æˆå›¾é‰´</h3>
            <button class="modal-close" onclick="closeGameGuide()">Ã—</button>
        </div>
        <div class="tab-filter">
            <button class="filter-btn active" id="guide-tab-personality" onclick="switchGuideTab('personality')">æ€§æ ¼</button>
            <button class="filter-btn" id="guide-tab-ideology" onclick="switchGuideTab('ideology')">ä¿¡ä»°ä¸»ä¹‰</button>
        </div>
        <div id="guide-content" class="guide-grid"></div>
    </div>
</div>

<div class="modal-overlay" id="edit-modal">
    <div class="modal-content" style="max-width:400px;">
        <div class="modal-header">
            <h3 id="edit-title">ä¿®æ”¹å±æ€§</h3>
            <button class="modal-close" onclick="closeEditModal()">Ã—</button>
        </div>
        <div style="margin-bottom:15px;">
            <select id="edit-select" style="width:100%; padding:8px; font-size:1rem; border-radius:4px; border:1px solid #ddd;"></select>
        </div>
        <button class="btn save" style="width:100%" onclick="confirmEdit()">ğŸ’¾ ä¿å­˜ä¿®æ”¹</button>
    </div>
</div>

<div class="modal-overlay" id="voting-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="voting-title">ğŸ—³ï¸ å…¨æ°‘æŠ•ç¥¨</h3>
        </div>
        <div style="margin-bottom:15px; color:#555; font-size:0.9rem;">
            <span id="voting-mayor-msg"></span>
            <span id="voting-instruction">è¯·æŠ•å‡ºç¥åœ£çš„ä¸€ç¥¨ï¼</span>
        </div>
        <div id="voting-candidates-list"></div>
        <div class="voting-log" id="voting-realtime-log"></div>
    </div>
</div>

<div class="modal-overlay" id="char-detail-modal"><div class="modal-content"><div class="modal-header"><h3 id="detail-name">è§’è‰²è¯¦æƒ…</h3><button class="modal-close" onclick="closeCharDetail()">Ã—</button></div><div id="detail-content"></div></div></div>

<div class="modal-overlay" id="gov-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ› å°é•‡æ”¿åºœ & è´¢æ”¿ä¸­å¿ƒ</h3>
            <button class="modal-close" onclick="closeGov()">Ã—</button>
        </div>
        <div class="gov-panel">
            <div class="gov-mayor-section">
                <h4 style="margin:0 0 10px 0; color:#2980b9; border-bottom:1px solid #d6eaf8; padding-bottom:5px;">ğŸ–ï¸ ç°ä»»é•‡é•¿</h4>
                <div id="mayor-info" style="display:flex; align-items:center; gap:15px;">
                    <div class="mayor-avatar">ğŸ§¢</div>
                    <div class="mayor-details">
                        <div id="mayor-name-display" class="mayor-name">æš‚æ— é•‡é•¿</div>
                        <div id="mayor-ideology-display" class="mayor-ideology" style="background:#ccc">--</div>
                        <div id="mayor-policy-display" class="mayor-effect">æ¯å‘¨ (å‘¨æ—¥) ä¸¾è¡Œä¸€æ¬¡é€‰ä¸¾</div>
                    </div>
                </div>
                <div style="margin-top:15px; border-top:1px dashed #bcdff1; padding-top:10px;">
                    <div style="font-weight:bold; font-size:0.9rem; margin-bottom:5px; color:#2c3e50;">âš–ï¸ é•‡é•¿å†³ç­–:</div>
                    <button class="btn" style="background:#e67e22; font-size:0.85rem; width:100%" onclick="executeCommonProsperity()">ğŸ¤ å…±åŒå¯Œè£• (å‡è´«å¯Œ)</button>
                    <div style="font-size:0.8rem; color:#666; margin-top:4px;">å¼ºåˆ¶æ”¶ç¼´å‰3åå¯Œè±ªéƒ¨åˆ†èµ„äº§ï¼Œå¹³åˆ†ç»™æ‰€æœ‰è´«å›°æˆ·(<50)ã€‚</div>
                </div>
            </div>

            <div class="gov-stat-row">
                <div class="gov-stat-card">
                    <div class="label">ğŸ‘¥ å°é•‡å¸¸ä½äººå£</div>
                    <div class="value" id="resident-count">0</div>
                    <button class="btn create" onclick="inputNewResident()">â• æ‹›å‹Ÿæ–°å±…æ°‘</button>
                </div>
                <div class="gov-stat-card">
                    <div class="label">ğŸ’° é•‡åº“èµ„é‡‘</div>
                    <div class="value" id="town-money">0</div>
                    <button class="btn fund" onclick="showEmbezzle()">ğŸ’¸ è´¢æ”¿æ‹¨æ¬¾</button>
                </div>
            </div>
            
            <div class="gov-policy-section">
                <h4>ğŸ“œ ç¤¾ä¼šä¿éšœæ”¿ç­–</h4>
                <div class="policy-item">
                    <div style="flex:1">
                        <label class="checkbox-container">
                            <input type="checkbox" id="policy-social-security" onchange="togglePolicy('social')">
                            <span class="policy-name">ç¤¾ä¼šæœ€ä½ä¿éšœé‡‘</span>
                        </label>
                        <div class="policy-desc">
                            <small>æ¯æ—¥å‡Œæ™¨æ£€æµ‹ã€‚è‹¥èµ„é‡‘>10ï¼Œä¸ºå­˜æ¬¾<15çš„å±…æ°‘å‘æ”¾10æ•‘æµé‡‘ã€‚</small>
                        </div>
                    </div>
                </div>
                <div class="policy-item">
                    <div style="flex:1">
                        <label class="checkbox-container">
                            <input type="checkbox" id="policy-housing" onchange="togglePolicy('housing')">
                            <span class="policy-name">ä¿éšœæ€§ä½æˆ¿è®¡åˆ’</span>
                        </label>
                        <div class="policy-desc">
                            <small>æ¯æ—¥ä¸ºæ— ä¸šå±…æ°‘æä¾›å…è´¹ä½æˆ¿è¡¥è´´ï¼ˆå¿ƒæƒ…+5ï¼‰ï¼Œæ¯äººæ¶ˆè€—é•‡åº“ğŸ’°5ã€‚</small>
                        </div>
                    </div>
                </div>
                <div class="policy-item">
                    <div style="flex:1">
                        <label class="checkbox-container">
                            <input type="checkbox" id="policy-food" onchange="togglePolicy('food')">
                            <span class="policy-name">æœ€ä½é£Ÿå“ä¿éšœ</span>
                        </label>
                        <div class="policy-desc">
                            <small>æ¯æ—¥ä¸ºæåº¦é¥¥é¥¿(<20)çš„å±…æ°‘å‘æ”¾çŒªè‚‰åŒ…ï¼ˆé¥±é£Ÿ+20ï¼‰ï¼Œæ¯äººæ¶ˆè€—é•‡åº“ğŸ’°4ã€‚</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="border-top:1px solid #eee; padding-top:15px;">
                <button class="btn reset" style="width:100%" onclick="resetData()">ğŸ—‘ é‡ç½®å°é•‡æ•°æ® (æ…ç”¨)</button>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="leaderboard-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ“Š å°é•‡æ’è¡Œæ¦œ</h3>
            <button class="modal-close" onclick="closeLeaderboard()">Ã—</button>
        </div>
        <div style="margin-bottom:15px; display:flex; gap:10px; flex-wrap: wrap;">
            <button class="btn" onclick="renderLeaderboard('money')">ğŸ’° è´¢å¯Œæ¦œ</button>
            <button class="btn" onclick="renderLeaderboard('happiness')" style="background:#2ecc71">â¤ å¹¸ç¦æ¦œ</button>
            <button class="btn" onclick="renderLeaderboard('popularity')" style="background:#a55eea">ğŸ”¥ äººæ°”æ¦œ</button>
            <button class="btn" onclick="renderLeaderboard('robbery')" style="background:#2d3436; color:white;">ğŸ”ª æŠ¢åŠ«æ¦œ</button>
            <button class="btn" onclick="renderLeaderboard('streetwalk')" style="background:#e056fd; color:white;">ğŸ’‹ ç«™è¡—æ¦œ</button>
            <button class="btn" onclick="renderLeaderboard('assault')" style="background:#c0392b; color:white;">ğŸ˜ˆ åŠ«è‰²æ¦œ</button>
        </div>
        <div id="leaderboard-list" class="rank-list"></div>
    </div>
</div>

<div class="modal-overlay" id="achievements-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ† è£èª‰æˆå°±é¦†</h3>
            <button class="modal-close" onclick="closeAchievements()">Ã—</button>
        </div>
        <div id="achievements-list" class="achieve-list"></div>
    </div>
</div>

<div class="modal-overlay" id="jobboard-modal"><div class="modal-content"><div class="modal-header"><h3>ğŸ“‹ äººæ‰å¸‚åœº & å·¥ä½œæ¦œ</h3><button class="modal-close" onclick="closeJobBoard()">Ã—</button></div><div id="jobboard-list"></div></div></div>
<div class="modal-overlay" id="embezzle-modal"><div class="modal-content"><div class="modal-header"><h3>ğŸ’¸ é•‡åº“æ‹¨æ¬¾</h3><button class="modal-close" onclick="closeEmbezzle()">Ã—</button></div><div style="margin-bottom:15px;"><p>å½“å‰é•‡åº“èµ„é‡‘: <span id="embezzle-town-money" style="font-weight:bold; color:#f1c40f;">0</span></p><p>é€‰æ‹©æ‹¨æ¬¾å¯¹è±¡:</p><div id="embezzle-list" class="fund-list" style="max-height:200px; overflow-y:auto; margin-bottom:10px; border:1px solid #eee; padding:5px;"></div><div style="display:flex; gap:10px; align-items:center;"><span>é‡‘é¢:</span><input type="number" id="embezzle-amount" value="100" style="width:100px;"><button class="btn save" onclick="doEmbezzle()">ç¡®è®¤æ‹¨æ¬¾</button></div></div></div></div>
<div class="modal-overlay" id="action-select-modal"><div class="modal-content"><div class="modal-header"><h3>ğŸ•¹ï¸ å¼ºåˆ¶å®‰æ’æ´»åŠ¨</h3><button class="modal-close" onclick="closeActionSelect()">Ã—</button></div><div id="action-select-content"></div></div></div>
<div class="modal-overlay" id="town-event-modal">
    <div class="modal-content">
        <div class="modal-header"><h3>ğŸ‰ æ´»åŠ¨ç­–åˆ’éƒ¨</h3><button class="modal-close" onclick="closeTownEvents()">Ã—</button></div>
        <div class="tab-filter">
            <button class="filter-btn active" id="evt-tab-normal" onclick="switchEventTab('normal')">å¸¸è§„æ´»åŠ¨</button>
            <button class="filter-btn" id="evt-tab-season" onclick="switchEventTab('season')">ğŸ—“ï¸ ä»Šæ—¥èŠ‚æ—¥/é™å®š</button>
        </div>
        <p style="color:#666; font-size:0.9rem; margin-bottom:15px;">å½“å‰é•‡åº“: <span id="event-town-money" style="font-weight:bold; color:#f1c40f; font-size:1.1rem;">0</span> (å½“å‰æ—¥æœŸ: <span id="event-season-name"></span>)</p>
        <div id="town-event-list" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(240px, 1fr)); gap:12px;"></div>
    </div>
</div>
<div class="modal-overlay" id="building-detail-modal"><div class="modal-content"><div class="modal-header"><h3 id="b-detail-name">å»ºç­‘è¯¦æƒ…</h3><button class="modal-close" onclick="closeBuildingDetail()">Ã—</button></div><div id="b-detail-content"></div></div></div>

<!-- æ—¥å†æ¨¡æ€æ¡† -->
<div class="modal-overlay" id="calendar-modal">
    <div class="modal-content" style="max-width:800px;">
        <div class="modal-header">
            <h3>ğŸ“… å°é•‡å¹´å†</h3>
            <button class="modal-close" onclick="closeCalendar()">Ã—</button>
        </div>
        <div style="margin-bottom:10px; color:#666; font-size:0.9rem;">
            é¼ æ ‡æ‚¬åœçº¢è‰²æ—¥æœŸå¯æŸ¥çœ‹èŠ‚æ—¥åç§°ã€‚ç‰¹å®šèŠ‚æ—¥å½“å¤©å¯åœ¨æ´»åŠ¨ä¸­å¿ƒä¸¾åŠåº†å…¸ã€‚
        </div>
        <div id="calendar-container" class="calendar-grid"></div>
    </div>
</div>

<script>
    const NAMES = ["è€„è€‹", "æ›¼æ³¢", "å“ˆåŸºç±³", "æœçŒ«", "æš–æ³ª", "æ²å¤", "sans", "æ—¶è‹", "å°ç¿", "æ ¢æŸ“", "äº‘ç»’", "ç›å¡å·´å¡", "çŒ«å†¬", "æ— å", "æ–—ç½—", "CPU0", "é—ªæŸ ", "æ°˜é•‰æ®†", "ç©ºé›¶", "çŒ«çŒ«", "å°æ ¼è•¾ä¿®"];
    
    // å®šä¹‰æ¯ä¸ªæœˆçš„å¤©æ•° (0æ˜¯å ä½ç¬¦)
    const MONTH_DAYS = [0, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
    
    const ITEMS_DB = {
        "rose": { name: "ğŸŒ¹ ç«ç‘°", price: 50, type: "gift", loveBonus: 15, desc: "èµ äººç«ç‘°ï¼Œæ‰‹æœ‰ä½™é¦™" },
        "baozi_tofu": { name: "ğŸ¥Ÿ è±†è…åŒ…", price: 2, type: "food", hungerBonus: 10, desc: "ç´ é£Ÿä¸»ä¹‰è€…çš„æœ€çˆ±" },
        "baozi_pork": { name: "ğŸ¥© çŒªè‚‰åŒ…", price: 4, type: "food", hungerBonus: 20, desc: "çš®è–„é¦…å¤§æ±å¤š" },
        "baozi_beef": { name: "ğŸ® ç‰›è‚‰åŒ…", price: 5, type: "food", hungerBonus: 25, desc: "å®å®åœ¨åœ¨çš„ç‰›è‚‰" },
        "water_wahaha": { name: "ğŸ¥¤ å¨ƒå“ˆå“ˆ", price: 2, type: "drink", hungerBonus: 2, happinessBonus: 1, desc: "ç«¥å¹´çš„å‘³é“" },
        "water_ganten": { name: "ğŸ’§ ç™¾å²å±±", price: 4, type: "drink", hungerBonus: 2, happinessBonus: 3, desc: "æ°´ä¸­è´µæ—" },
        "noodle_beef": { name: "ğŸœ åº·å¸ˆå‚…", price: 5, type: "food", hungerBonus: 30, desc: "çº¢çƒ§ç‰›è‚‰é¢ï¼Œå°±æ˜¯è¿™ä¸ªå‘³" },
        "chips_lays": { name: "ğŸ¥” ä¹äº‹è–¯ç‰‡", price: 6, type: "snack", hungerBonus: 5, happinessBonus: 5, desc: "åŸå‘³æœ€ç»å…¸" },
        "chocolate": { name: "ğŸ« å¾·èŠ™å·§å…‹åŠ›", price: 8, type: "snack", hungerBonus: 3, happinessBonus: 8, desc: "çºµäº«ä¸æ»‘" },
        "cola_pepsi": { name: "ğŸ¥¤ æ—¥æœ¬ç”Ÿå¯ä¹", price: 5, type: "drink", hungerBonus: 3, happinessBonus: 4, desc: "å¬è¯´å¾ˆå¥½å–" },
        "coffee_instant": { name: "â˜• é€Ÿæº¶å’–å•¡", price: 6, type: "drink", hungerBonus: 2, happinessBonus: 5, desc: "æç¥é†’è„‘" },
        "sushi_box": { name: "ğŸ± å¯¿å¸æ‹¼ç›˜", price: 12, type: "food", hungerBonus: 35, happinessBonus: 3, desc: "ä¾¿åˆ©åº—çš„é«˜çº§è´§" },
        "beer_tsingtao": { name: "ğŸº é’å²›å•¤é…’", price: 6, type: "alcohol", hungerBonus: 2, happinessBonus: 6, desc: "å“ˆå•¤é…’åƒå˜å•¦" },
        "beer_laoshan": { name: "ğŸº å´‚å±±å•¤é…’", price: 5, type: "alcohol", hungerBonus: 2, happinessBonus: 5, desc: "ç”šè‡³èƒ½å½“æ°´å–" },
        "cocktail": { name: "ğŸ¸ é¸¡å°¾é…’", price: 25, type: "alcohol", hungerBonus: -2, happinessBonus: 15, desc: "è‰²å½©æ–‘æ–“çš„å¾®é†º" },
        "bloody_mary": { name: "ğŸ¹ è¡€è…¥ç›ä¸½", price: 30, type: "alcohol", hungerBonus: -2, happinessBonus: 18, desc: "å£å‘³ç‹¬ç‰¹çš„ç»å…¸" },
        "rum": { name: "ğŸ¥ƒ æœ—å§†é…’", price: 35, type: "alcohol", hungerBonus: -3, happinessBonus: 20, desc: "æµ·ç›—çš„æœ€çˆ±" },
        "tequila": { name: "ğŸŒµ é¾™èˆŒå…°", price: 40, type: "alcohol", hungerBonus: -3, happinessBonus: 22, desc: "èˆ”ä¸€å£ç›ï¼Œå¹²ä¸€æ¯é…’" },
        "whisky": { name: "ğŸ¥ƒ å¨å£«å¿Œ", price: 50, type: "alcohol", hungerBonus: -4, happinessBonus: 25, desc: "ç”·äººçš„æµªæ¼«" },
        "bandage": { name: "ğŸ©¹ ç»·å¸¦", price: 10, type: "medicine", healthBonus: 8, desc: "å¤„ç†è½»å¾®å¤–ä¼¤" },
        "painkiller": { name: "ğŸ’Š æ­¢ç—›è¯", price: 15, type: "medicine", healthBonus: 15, happinessBonus: 2, desc: "ç¼“è§£ç–¼ç—›ï¼Œå±…å®¶å¿…å¤‡" },
        "digestion_tablets": { name: "ğŸŒ¿ å¥èƒƒæ¶ˆé£Ÿç‰‡", price: 12, type: "medicine", healthBonus: 5, hungerBonus: 5, desc: "åƒæ’‘äº†ï¼Ÿæ¥ä¸€ç‰‡" },
        "cold_medicine": { name: "ğŸ§ª æ„Ÿå†’çµ", price: 20, type: "medicine", healthBonus: 20, desc: "æš–æš–çš„å¾ˆè´´å¿ƒ" },
        "anti_inflammatory": { name: "ğŸ”¬ æ¶ˆç‚è¯", price: 25, type: "medicine", healthBonus: 25, desc: "é’ˆå¯¹å„ç±»ç‚ç—‡" },
        "fever_medicine": { name: "ğŸŒ¡ï¸ é€€çƒ§è¯", price: 35, type: "medicine", healthBonus: 35, desc: "é«˜çƒ§ä¸é€€æ—¶çš„æ•‘æ˜Ÿ" }
    };

    const WEATHER_TYPES = {
        'Sunny': { name: 'â˜€ æ™´æœ—', mood: 0.5, health: 0, desc: 'é˜³å…‰æ˜åªšï¼Œå¿ƒæƒ…èˆ’ç•…' },
        'Cloudy': { name: 'â˜ é˜´å¤©', mood: 0, health: 0, desc: 'ä¸å†·ä¸çƒ­ï¼Œé€‚åˆå‡ºè¡Œ' },
        'Rainy': { name: 'ğŸŒ§ å°é›¨', mood: -1, health: -0.2, desc: 'å‡ºé—¨è®°å¾—å¸¦ä¼ï¼Œå¿ƒæƒ…æœ‰äº›ä½è½' },
        'Storm': { name: 'â›ˆ æš´é›¨', mood: -3, health: -0.5, desc: 'ç³Ÿç³•çš„å¤©æ°”ï¼Œå®¹æ˜“ç”Ÿç—…' },
        'Snowy': { name: 'â„ ä¸‹é›ª', mood: 1, health: -1, desc: 'ç¾ä¸½çš„é›ªæ™¯ï¼Œä½†å°å¿ƒç€å‡‰' },
        'Heatwave': { name: 'ğŸ”¥ çƒ­æµª', mood: -2, health: -0.5, desc: 'é«˜æ¸©é¢„è­¦ï¼Œæ³¨æ„é˜²æš‘' },
        'Foggy': { name: 'ğŸŒ« å¤§é›¾', mood: -0.5, health: -0.2, desc: 'èƒ½è§åº¦ä½ï¼Œç©ºæ°”ä¸å¥½' }
    };
    
    const SOCIAL_SCENARIOS = [
        { text: "{A} æ­£åœ¨å‘ {B} ç–¯ç‹‚å®‰åˆ©ä¸€æ¬¾æ–°æ¸¸æˆ", effect: (a,b) => { a.happiness+=2; b.happiness+=2; } },
        { text: "{A} å·å·å‘Šè¯‰ {B} ä¸€ä¸ªæƒŠå¤©å¤§å…«å¦", effect: (a,b) => { a.happiness+=3; b.happiness+=3; } },
        { text: "{A} å‘ {B} æŠ±æ€¨æœ€è¿‘çš„å·¥èµ„å¤ªä½äº†", effect: (a,b) => { a.happiness+=1; b.happiness-=1; } },
        { text: "{A} è¯•å›¾ç»™ {B} è®²ä¸€ä¸ªå†·ç¬‘è¯ï¼Œæ°”æ°›å°´å°¬", effect: (a,b) => { a.happiness+=1; b.happiness-=1; } },
        { text: "{A} ç§°èµ {B} ä»Šå¤©çš„ç©¿æ­å¾ˆæœ‰å“å‘³", effect: (a,b) => { a.happiness+=2; b.happiness+=5; } },
        { text: "{A} å’Œ {B} æ¿€çƒˆè®¨è®ºå°é•‡çš„æœªæ¥å‘å±•", effect: (a,b) => { a.happiness+=1; b.happiness+=1; } },
        { text: "{A} é‚€è¯· {B} ä¸€èµ·å»å–å¥¶èŒ¶", effect: (a,b) => { a.happiness+=3; b.happiness+=3; } },
        { text: "{A} å¯¹ {B} ä¹‹å‰çš„è¡Œä¸ºè¡¨ç¤ºäº†ä¸æ»¡", effect: (a,b) => { a.happiness-=2; b.happiness-=2; } },
        { text: "{A} å®‰æ…°äº†çœ‹èµ·æ¥ä¸å¤ªå¼€å¿ƒçš„ {B}", effect: (a,b) => { a.happiness+=2; b.happiness+=5; } },
        { text: "{A} è¯¢é—® {B} æ˜¯å¦æœ‰å¤šä½™çš„æ„Ÿå†’è¯", effect: (a,b) => { } }
    ];

    const ACHIEVEMENTS_DB = [
        { id: 'first_build', name: 'ğŸ—ï¸ å¥ åŸºäºº', desc: 'å»ºæˆå°é•‡çš„ç¬¬ä¸€åº§å»ºç­‘', reward: 500, icon: 'ğŸ—ï¸' },
        { id: 'first_marriage', name: 'ğŸ‘©â€â¤ï¸â€ğŸ’‹â€ğŸ‘¨ ç¥ä»™çœ·ä¾£', desc: 'è¯ç”Ÿç¬¬ä¸€å¯¹ç¡®è®¤å…³ç³»çš„æƒ…ä¾£', reward: 300, icon: 'â¤ï¸' },
        { id: 'first_crime', name: 'ğŸ˜ˆ ç½ªæ¶éƒ½å¸‚', desc: 'å‘ç”Ÿäº†ç¬¬ä¸€èµ·æŠ¢åŠ«æˆ–éªšæ‰°æ¡ˆä»¶', reward: 200, icon: 'ğŸ˜ˆ' },
        { id: 'rich_town', name: 'ğŸ’° å°åº·ç¤¾ä¼š', desc: 'é•‡åº“èµ„é‡‘è¾¾åˆ° 5000', reward: 1000, icon: 'ğŸ’°' },
        { id: 'first_gym', name: 'ğŸ’ª è‡ªå¾‹è¾¾äºº', desc: 'å»ºæˆå¥èº«æˆ¿ï¼Œå¼€å§‹å…¨æ°‘å¥èº«', reward: 300, icon: 'ğŸ’ª' },
        { id: 'culture_hub', name: 'ğŸ› æ–‡åŒ–ä¸­å¿ƒ', desc: 'å»ºæˆåšç‰©é¦†ï¼Œæå‡å°é•‡æ–‡åŒ–åº•è•´', reward: 400, icon: 'ğŸ›' },
        { id: 'first_pot', name: 'ğŸ’° ç¬¬ä¸€æ¡¶é‡‘', desc: 'å­˜æ¬¾è¾¾åˆ°100', reward: 150, icon: 'ğŸ’°' },
        { id: 'financial_freedom', name: 'ğŸ¦ è´¢å¯Œè‡ªç”±', desc: 'å­˜æ¬¾è¾¾åˆ°1000', reward: 500, icon: 'ğŸ¦' },
        { id: 'common_prosperity', name: 'ğŸ¤ å…±åŒå¯Œè£•', desc: 'æ‰€æœ‰å±…æ°‘å¹³å‡å­˜æ¬¾è¶…è¿‡50', reward: 300, icon: 'ğŸ¤' },
        { id: 'workaholic', name: 'ğŸ’¼ å·¥ä½œç‹‚äºº', desc: 'è¿ç»­å·¥ä½œè¶…è¿‡12å°æ—¶', reward: 250, icon: 'ğŸ’¼' },
        { id: 'perfect_day', name: 'âœ¨ å®Œç¾ä¸€å¤©', desc: 'å¿ƒæƒ…ã€é¥±é£Ÿã€å¥åº·åŒæ—¶è¾¾åˆ°80ä»¥ä¸Š', reward: 300, icon: 'âœ¨' }
    ];

    function getItemTooltipText(itemId) {
        const item = ITEMS_DB[itemId];
        if (!item) return "";
        let parts = [];
        parts.push(item.desc);
        parts.push("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
        if (item.type === 'gift') {
            parts.push(`ğŸ’— å¢åŠ å¥½æ„Ÿ: +${item.loveBonus || 0}`);
        } else if (item.type === 'medicine') {
            parts.push(`ğŸš‘ æ¢å¤å¥åº·: +${item.healthBonus || 0}`);
            if (item.happinessBonus) parts.push(`â¤ å¿ƒæƒ…å€¼: +${item.happinessBonus}`);
        } else {
            if (item.hungerBonus !== undefined && item.hungerBonus !== 0) {
                const sign = item.hungerBonus > 0 ? '+' : '';
                parts.push(`ğŸ— é¥±é£Ÿåº¦: ${sign}${item.hungerBonus}`);
            }
            if (item.happinessBonus !== undefined && item.happinessBonus !== 0) {
                const sign = item.happinessBonus > 0 ? '+' : '';
                parts.push(`â¤ å¿ƒæƒ…å€¼: ${sign}${item.happinessBonus}`);
            }
        }
        parts.push(`ğŸ’° ä»·å€¼: ${item.price}`);
        return parts.join('\n');
    }
    
    function getJobSkillType(role) {
        if (role.includes("å¨") || role.includes("æ‹‰é¢") || role.includes("èŠ±è‰º") || role.includes("æ—©ç‚¹") || role.includes("æŠ€å¸ˆ")) return 'craft';
        if (role.includes("åŒ»") || role.includes("è€å¸ˆ") || role.includes("ç¥çˆ¶") || role.includes("å›¾ä¹¦") || role.includes("ç½‘ç®¡") || role.includes("è®²è§£")) return 'intel';
        if (role.includes("è­¦") || role.includes("ä¿å®‰") || role.includes("æ¬ç –") || role.includes("ä¿æ´") || role.includes("è·‘å ‚") || role.includes("å¤–å–") || role.includes("æ•™ç»ƒ") || role.includes("æ£€ç¥¨")) return 'strength';
        return 'social'; 
    }

    function getLevelInfo(skillVal) {
         if (skillVal < 20) return { level: 0, multiplier: 1.0, title: "è§ä¹ ", next: 20 };
         if (skillVal < 50) return { level: 1, multiplier: 1.2, title: "æ­£å¼", next: 50 };
         if (skillVal < 80) return { level: 2, multiplier: 1.4, title: "èµ„æ·±", next: 80 };
         return { level: 3, multiplier: 1.6, title: "å¤§å¸ˆ", next: 100 };
    }

    const BUILDINGS_BLUEPRINT = [
        { id: "baozi", name: "ğŸ¥¯ åŒ…å­é“º", category: "food", cost: 100, desc: "ç‰©ç¾ä»·å»‰çš„æ—©é¤åº—", effect: "shop", price: 0, open: 5, close: 14, jobs: ["æ—©ç‚¹å·¥"], sells: ["baozi_tofu", "baozi_pork", "baozi_beef"], isBuilt: true }, 
        { id: "ramen", name: "ğŸœ å…°å·æ‹‰é¢", category: "food", cost: 250, desc: "æ­£å®—ç‰›è‚‰é¢ï¼Œç®¡é¥±", effect: "food", price: 12, food: 35, open: 7, close: 22, jobs: ["æ‹‰é¢å¸ˆå‚…"] },
        { id: "711", name: "ğŸª 7-11ä¾¿åˆ©åº—", category: "food", cost: 300, desc: "24å°æ—¶è¥ä¸š", effect: "shop", price: 0, open: 0, close: 24, jobs: ["æ”¶é“¶å‘˜"], sells: ["water_wahaha", "water_ganten", "noodle_beef", "chips_lays", "chocolate", "cola_pepsi", "coffee_instant", "sushi_box", "beer_tsingtao", "beer_laoshan"] },
        { id: "kfc", name: "ğŸ— è‚¯å¾·åŸº", category: "food", cost: 600, desc: "ç–¯ç‹‚æ˜ŸæœŸå››", effect: "food", price: 30, food: 50, open: 10, close: 22, jobs: ["å‰å°", "ç‚¸é¸¡å¨å¸ˆ"] },
        { id: "gym", name: "ğŸ’ª å¥èº«æˆ¿", category: "fun", cost: 800, desc: "æŒ¥æ´’æ±—æ°´ï¼Œæå‡é¢œå€¼ä¸å¥åº·", effect: "beauty", price: 50, open: 6, close: 22, jobs: ["å¥èº«æ•™ç»ƒ", "ä¿æ´"] },
        { id: "amusement", name: "ğŸ¡ æ¸¸ä¹åœº", category: "fun", cost: 2000, desc: "å……æ»¡å°–å«ä¸æ¬¢ç¬‘çš„åœ°æ–¹", effect: "fun_high", price: 100, open: 9, close: 20, jobs: ["æ£€ç¥¨å‘˜", "ç©å¶æ‰®æ¼”"] },
        { id: "museum", name: "ğŸ› åšç‰©é¦†", category: "fun", cost: 1200, desc: "å†å²çš„æ²‰æ·€ï¼Œå¢é•¿è§è¯†", effect: "study", price: 40, open: 9, close: 17, jobs: ["è®²è§£å‘˜", "ä¿å®‰"], closedDays: [1] },
        { id: "police", name: "ğŸ‘® æ´¾å‡ºæ‰€", category: "service", cost: 800, desc: "ç»´æŠ¤å°é•‡æ²»å®‰", effect: "security", price: 0, open: 0, close: 24, jobs: ["è­¦å¯Ÿ", "è­¦å¯Ÿ"] }, 
        { id: "hospital", name: "ğŸ¥ ç»¼åˆåŒ»é™¢", category: "service", cost: 1500, desc: "è®¾å¤‡å…ˆè¿›çš„åŒ»ç–—ä¸­å¿ƒ", effect: "health", price: 80, open: 0, close: 24, jobs: ["ä¸»æ²»åŒ»å¸ˆ", "æŠ¤å£«", "ä¿æ´"] },
        { id: "clinic", name: "ğŸ’Š ç¤¾åŒºè¯Šæ‰€", category: "service", cost: 400, desc: "æ–¹ä¾¿å¿«æ·çš„å°è¯Šæ‰€", effect: "shop", price: 0, open: 8, close: 20, jobs: ["ç¤¾åŒºåŒ»ç”Ÿ", "æŠ¤å£«"], sells: ["bandage", "painkiller", "digestion_tablets", "cold_medicine", "anti_inflammatory", "fever_medicine"] },
        { id: "school", name: "ğŸ« å°é•‡å­¦æ ¡", category: "service", cost: 1000, desc: "çŸ¥è¯†å°±æ˜¯åŠ›é‡", effect: "study", price: 0, open: 7, close: 17, jobs: ["è¯­æ–‡è€å¸ˆ", "æ•°å­¦è€å¸ˆ", "ä½“è‚²è€å¸ˆ", "ä¿å®‰"], closedDays: [0, 6] },
        { id: "library", name: "ğŸ“š å›¾ä¹¦é¦†", category: "fun", cost: 500, desc: "é™è°§çš„é˜…è¯»æ—¶å…‰", effect: "study", price: 0, open: 9, close: 21, jobs: ["å›¾ä¹¦ç®¡ç†å‘˜", "ä¿æ´"] },
        { id: "church", name: "â›ª å©šç¤¼æ•™å ‚", category: "service", cost: 1200, desc: "ç¥åœ£ä¹‹åœ°", effect: "marriage", price: 20, open: 8, close: 20, jobs: ["ç¥çˆ¶"] },
        { id: "park", name: "ğŸŒ³ ä¸­å¿ƒå…¬å›­", category: "fun", cost: 200, desc: "å…è´¹ä¼‘é—²", effect: "romance", price: 0, open: 0, close: 24, jobs: [] },
        { id: "netcafe", name: "ğŸ® éº¦å…‹ç”µç«", category: "fun", cost: 450, desc: "é€šå®µå¼€é»‘", effect: "fun", price: 15, open: 0, close: 24, jobs: ["ç½‘ç®¡", "ç½‘å§ä¿æ´"] },
        { id: "cinema", name: "ğŸ¬ ç”µå½±é™¢", category: "fun", cost: 400, desc: "æ¢å¤å¿ƒæƒ…å¿«", effect: "fun", price: 40, open: 10, close: 24, jobs: ["å”®ç¥¨å‘˜"] },
        { id: "bar", name: "ğŸº æ·±å¤œé…’å§", category: "fun", cost: 500, desc: "ä¹°é†‰æ¶ˆæ„", effect: "shop", price: 50, open: 18, close: 2, jobs: ["è€æ¿", "å¤§å¨", "è·‘å ‚"], closedDays: [0], sells: ["beer_tsingtao", "cocktail", "bloody_mary", "rum", "tequila", "whisky"] },
        { id: "footshop", name: "ğŸ’† ç¥ç§˜æ´—è„šåº—", category: "fun", cost: 600, desc: "æ¶©æƒ…äº¤æ˜“åœºæ‰€", effect: "ntr", price: 0, open: 0, close: 24, jobs: ["è€æ¿"] },
        { id: "hotel", name: "ğŸ© å¿«æ·é…’åº—", category: "fun", cost: 800, desc: "æ‡‚å¾—éƒ½æ‡‚", effect: "ntr", price: 100, open: 0, close: 24, jobs: ["å‰å°", "ä¿æ´"] },
        { id: "flowershop", name: "ğŸŒ¹ æµªæ¼«èŠ±åº—", category: "shop", cost: 300, desc: "è´­ä¹°é²œèŠ±é€ç»™å¿ƒä¸Šäºº", effect: "shop", price: 50, open: 9, close: 20, jobs: ["èŠ±è‰ºå¸ˆ"], sells: ["rose"] },
        { id: "statue", name: "ğŸ± é»„é‡‘çŒ«åƒ", category: "landmark", cost: 5000, desc: "çº¯é‡‘æ‰“é€ çš„çŒ«ç¥åƒï¼Œå¸å¼•æ¸¸å®¢æ‰“å¡ (ç¨æ”¶+50/h)", effect: "tourist", price: 50, open: 0, close: 24, jobs: ["ä¿å®‰"] },
        { id: "skytower", name: "ğŸ—¼ é€šå¤©å¡”", category: "landmark", cost: 8000, desc: "ä¿¯ç°å…¨é•‡çš„è§‚å…‰å¡” (ç¨æ”¶+100/h, å¹¸ç¦UP)", effect: "tourist_high", price: 100, open: 8, close: 22, jobs: ["æ£€ç¥¨å‘˜", "ç”µæ¢¯å‘˜", "ä¿æ´"] },
        { id: "hotspring", name: "â™¨ï¸ çŒ«å±±æ¸©æ³‰", category: "landmark", cost: 6000, desc: "è‘—åçš„ç–—å…»èƒœåœ° (ç¨æ”¶+80/h, å¥åº·UP)", effect: "tourist_health", price: 80, open: 10, close: 23, jobs: ["å‰å°", "æŠ€å¸ˆ"] }
    ];

    const CATEGORY_NAMES = { 'food': 'ğŸ” é¥®é£Ÿé¤é¥®', 'service': 'ğŸ¥ å…¬å…±æœåŠ¡', 'fun': 'ğŸ¡ ä¼‘é—²å¨±ä¹', 'shop': 'ğŸ›ï¸ å•†ä¸šè´­ç‰©', 'landmark': 'ğŸš© åœ°æ ‡å»ºç­‘' };

    const DAYS = ["å‘¨æ—¥", "å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­"];
    const TRAITS = [{id:"sleepy",name:"å–œæ¬¢ç¡è§‰",desc:"ç¡çœ æ—¶é—´æ›´é•¿"},{id:"promiscuous",name:"æ·«ä¹±",desc:"æ›´å®¹æ˜“äº¤æ¬¢ï¼Œå¢åŠ é¢œå€¼"},{id:"money-loving",name:"çˆ±é’±",desc:"æ›´çæƒœé‡‘é’±"}];
    const PERSONALITIES = [{name:"æ˜“æ€’",chaosBonus:0.3,loveGain:-0.5,desc:"è„¾æ°”æš´èº"},{name:"æ²‰ç€",chaosBonus:-0.2,loveGain:0.3,desc:"å†·é™ç†æ™º"},{name:"å¼€æœ—",chaosBonus:-0.1,loveGain:0.5,desc:"ä¹è§‚å¤–å‘"},{name:"å†…å‘",chaosBonus:0.1,loveGain:-0.2,desc:"ä¸å–„ç¤¾äº¤"},{name:"æ¸©æŸ”",chaosBonus:-0.15,loveGain:0.4,desc:"æ¸©å’Œå‹å–„"},{name:"åˆ»è–„",chaosBonus:0.25,loveGain:-0.3,desc:"è¯´è¯å¸¦åˆº"},{name:"å¹½é»˜",chaosBonus:-0.1,loveGain:0.3,desc:"é£è¶£å¹½é»˜"},{name:"ä¸¥è‚ƒ",chaosBonus:0.05,loveGain:0,desc:"ä¸€æœ¬æ­£ç»"}];
    
    const IDEOLOGIES = [
        // å·¦æ´¾ (Left)
        {name:"å…±äº§ä¸»ä¹‰",color:"#c0392b",chaosMod:-0.2,loveMod:0.6,wageMod:0.1,desc:"å„å°½æ‰€èƒ½ï¼Œå„å–æ‰€éœ€"},
        {name:"ç¤¾ä¼šä¸»ä¹‰",color:"#e74c3c",chaosMod:-0.15,loveMod:0.5,wageMod:0.1,desc:"å…¬å¹³æ­£ä¹‰ï¼Œç¤¾ä¼šäº’åŠ©"},
        {name:"æ¯›ä¸»ä¹‰",color:"#e17055",chaosMod:0.05,loveMod:0.6,wageMod:0.05,desc:"é€ åæœ‰ç†ï¼Œç»§ç»­é©å‘½"},
        {name:"åˆ—å®ä¸»ä¹‰",color:"#d63031",chaosMod:-0.05,loveMod:0.4,wageMod:0.1,desc:"èŒä¸šé©å‘½ï¼Œå…ˆé”‹å¸¦å¤´"},
        {name:"æ–¯å¤§æ—ä¸»ä¹‰",color:"#636e72",chaosMod:-0.35,loveMod:-0.1,wageMod:0.2,desc:"é’¢é“æ„å¿—ï¼Œé«˜åº¦é›†æƒ"},
        {name:"è¶…è§†ç¤¾ä¼šä¸»ä¹‰",color:"#00cec9",chaosMod:-0.1,loveMod:0.3,wageMod:0.2,desc:"ç§‘å­¦æ‰§æ”¿ï¼Œç†æ€§è§„åˆ’"},
        
        // ä¸­é—´/æ¸©å’Œ (Center)
        {name:"æ°‘ä¸»ä¸»ä¹‰",color:"#3498db",chaosMod:0.02,loveMod:0.2,wageMod:0.1,desc:"å°Šé‡å¤šå…ƒï¼Œå´‡å°šè¡¨è¾¾"},
        {name:"å…±å’Œåˆ¶",color:"#2980b9",chaosMod:-0.05,loveMod:0.1,wageMod:0.15,desc:"å¤©ä¸‹ä¸ºå…¬ï¼Œæ³•æ²»ç¤¾ä¼š"},
        {name:"å›ä¸»ç«‹å®ª",color:"#9b59b6",chaosMod:-0.25,loveMod:0.2,wageMod:0.05,desc:"æ‹¥æŠ¤ä¼ ç»Ÿï¼Œæ¸©å’Œæ”¹è‰¯"},
        {name:"ä¿å®ˆä¸»ä¹‰",color:"#7f8c8d",chaosMod:-0.1,loveMod:0.2,wageMod:0.02,desc:"å°Šé‡ä¼ ç»Ÿï¼Œå¾ªåºæ¸è¿›"},
        
        // å³æ´¾ (Right)
        {name:"èµ„æœ¬ä¸»ä¹‰",color:"#f1c40f",chaosMod:0.1,loveMod:-0.4,wageMod:0.6,desc:"é‡‘é’±è‡³ä¸Šï¼Œæ•ˆç‡ä¼˜å…ˆ"},
        {name:"è‡ªç”±ä¸»ä¹‰",color:"#0984e3",chaosMod:0.15,loveMod:-0.1,wageMod:0.3,desc:"å¤©èµ‹äººæƒï¼Œå°æ”¿åºœ"},
        {name:"é‡å•†ä¸»ä¹‰",color:"#f39c12",chaosMod:0.02,loveMod:-0.3,wageMod:0.4,desc:"è´¸æ˜“é¡ºå·®ï¼Œè´¢å¯Œç§¯ç´¯"},
        {name:"å¯¡å¤´æ”¿æ²»",color:"#d35400",chaosMod:-0.1,loveMod:-0.5,wageMod:0.5,desc:"æŒæ¡èµ„æºï¼Œç²¾è‹±ç‰¹æƒ"},
        
        // æç«¯/å…¶ä»–
        {name:"æ— æ”¿åºœä¸»ä¹‰",color:"#2d3436",chaosMod:0.25,loveMod:0.2,wageMod:-0.2,desc:"æ‹’ç»æƒå¨ï¼Œç»å¯¹è‡ªç”±"},
        {name:"æ³•è¥¿æ–¯ä¸»ä¹‰",color:"#000000",chaosMod:-0.4,loveMod:-0.6,wageMod:0.1,desc:"æç«¯æ°‘æ—ï¼Œææƒæœä»"},
        {name:"å†›å›½ä¸»ä¹‰",color:"#2c3e50",chaosMod:-0.15,loveMod:-0.2,wageMod:0.2,desc:"æ­¦åŠ›è‡³ä¸Šï¼Œé“è¡€æ‰©å¼ "},
        {name:"å°å»ºåˆ¶",color:"#8e44ad",chaosMod:-0.25,loveMod:0,wageMod:-0.2,desc:"ç­‰çº§æ£®ä¸¥ï¼Œå¿ è¯šç¬¬ä¸€"},
        {name:"å†›äº‹ç‹¬è£",color:"#34495e",chaosMod:-0.15,loveMod:-0.3,wageMod:0.2,desc:"é“è¡€çºªå¾‹ï¼Œæ­¦åŠ›å´‡æ‹œ"},
        {name:"æ€»ç»Ÿåˆ¶",color:"#34495e",chaosMod:-0.05,loveMod:0,wageMod:0.2,desc:"å¼ºåŠ›è¡Œæ”¿ï¼Œè¡Œèƒœäºè¨€"},
        {name:"é€‰ä¸¾åˆ¶",color:"#16a085",chaosMod:0.1,loveMod:0.2,wageMod:0.05,desc:"çƒ­è¡·æŠ•ç¥¨ï¼Œæ”¿æ²»åŠ¨ç‰©"},
    ];

    // Map for logic to look up effects easily
    const MAYOR_EFFECTS = {};
    IDEOLOGIES.forEach(i => {
        MAYOR_EFFECTS[i.name] = { wage: 1 + i.wageMod, happy: i.loveMod, chaos: i.chaosMod, desc: i.desc };
    });
    
    const ODD_JOBS = [
        {name:"æ¸…æ´å·¥",wage:8,mood:-3},
        {name:"å‘ä¼ å•",wage:7,mood:-2},
        {name:"æ¬ç –",wage:9,mood:-4},
        {name:"å¤–å–å‘˜",wage:11,mood:-5}, 
        {name:"æ´—ç¢—å·¥",wage:8,mood:-3}, 
        {name:"èººå¹³",wage:-3,mood:5}
    ];
    
    const REL_TRANSLATE = { 'friend': 'æœ‹å‹', 'stranger': 'é™Œç”Ÿäºº', 'bestfriend': 'æŒšå‹', 'lover': 'æƒ…ä¾£', 'spouse': 'é…å¶', 'mistress': 'å°ä¸‰', 'ex': 'å‰ä»»', 'enemy': 'ä»‡äºº' };
    const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    const choose = (arr) => arr[Math.floor(Math.random() * arr.length)];
    
const TOWN_EVENTS = [
        { id: 'concert', name: 'ğŸ¤ å·¨æ˜Ÿæ¼”å”±ä¼š', cost: 500, desc: 'å…¨å‘˜å¿«ä¹+20ï¼Œå…³ç³»+5ã€‚10%æ¦‚ç‡ç¿»è½¦æ•ˆæœå‡åŠã€‚', emoji: 'ğŸ¤' },
        { id: 'matchmaking', name: 'ğŸ’˜ é•‡ç«‹ç›¸äº²å¤§ä¼š', cost: 200, desc: 'æ‰€æœ‰å•èº«è€…å°è¯•è¡¨ç™½(æˆåŠŸç‡up)ï¼Œæˆå¯¹åå¿«ä¹+5ã€‚', emoji: 'ğŸ’˜' },
        { id: 'charity', name: 'ğŸ—ï¸ æ…ˆå–„å‹Ÿæ', cost: 0, desc: 'å±…æ°‘è‡ªæ„¿ææ¬¾ç»™é•‡åº“ï¼Œå¿«ä¹-5ï¼Œå…³ç³»+5ã€‚', emoji: 'ğŸ—ï¸' },
        { id: 'anniversary', name: 'ğŸˆ å°é•‡çºªå¿µæ—¥', cost: 100, desc: 'å…¨å‘˜å¿«ä¹+10ï¼Œå…³ç³»å¾®é‡æå‡ã€‚', emoji: 'ğŸˆ' },
        { id: 'fireworks', name: 'ğŸ† ç››å¤§çƒŸèŠ±ä¼š', cost: 250, desc: 'å…¨å‘˜å¿«ä¹+25ï¼Œå…³ç³»+5ã€‚5%æ¦‚ç‡å¼•å‘ç«ç¾çƒ§æ¯å»ºç­‘ã€‚', emoji: 'ğŸ†' },
        { id: 'jobfair', name: 'ğŸ¤ å¤§å‹æ‹›è˜ä¼š', cost: 150, desc: 'å¸®åŠ©æ— ä¸šæ¸¸æ°‘è‡ªåŠ¨å¡«è¡¥ç©ºç¼ºå²—ä½ï¼Œå…¥èŒå¿«ä¹+10ã€‚', emoji: 'ğŸ¤' },
        { id: 'artfest', name: 'ğŸ¨ è‰ºæœ¯èŠ‚', cost: 300, desc: 'å…¨å‘˜å¿«ä¹+15ï¼Œå…³ç³»+3ã€‚10%æ¦‚ç‡å‘ç”Ÿè‰ºæœ¯å“å¤±çªƒã€‚', emoji: 'ğŸ¨' },
        { id: 'marathon', name: 'ğŸƒ å…¨æ°‘é©¬æ‹‰æ¾', cost: 200, desc: 'å¿«ä¹+10ï¼Œé¥±é£Ÿ-10ã€‚5%æ¦‚ç‡æœ‰äººå—ä¼¤(å¿«ä¹-20)ã€‚', emoji: 'ğŸƒ' },
        { id: 'reading', name: 'ğŸ“š è¯»ä¹¦ä¼š', cost: 100, desc: 'å¿«ä¹+5ï¼Œå…³ç³»+2ã€‚20%æ¦‚ç‡æ ‘è‹—æ¯æ­»æ•ˆæœå‡åŠã€‚', emoji: 'ğŸ“š' },
        { id: 'shopping', name: 'ğŸ›ï¸ è´­ç‰©èŠ‚ (åŒ11)', cost: 0, desc: 'åŒ11ç‹‚æ¬¢ï¼å±…æ°‘ç–¯ç‹‚è´­ç‰©ï¼Œé•‡åº“è·å¾—å…¨é¢å•†å“æ”¶å…¥ï¼', emoji: 'ğŸ›ï¸' },
        
        // èŠ‚æ—¥ / ç‰¹å®šæ—¥æœŸ
        { id: 'new_year', name: 'ğŸ§¨ å…ƒæ—¦ä½³èŠ‚', cost: 300, desc: 'æ–°å¹´æ–°æ°”è±¡ï¼å…¨å‘˜å¿«ä¹+20ï¼Œæ¶ˆè´¹æ¬²æœ›æå‡ã€‚', emoji: 'ğŸ§¨', date: {m:1, d:1} },
        { id: 'cat_return', name: 'ğŸ± çŒ«å’ªæŠ¥æ©æ—¥', cost: 0, desc: 'ä¼ è¯´ä¸­çŒ«ç¥æ˜¾çµçš„æ—¥å­ï¼Œæ¯ä½å±…æ°‘éƒ½ä¼šé‡åˆ°éšæœºå¥½äº‹ï¼', emoji: 'ğŸ±', date: {m:2, d:22} },
        { id: 'sakura', name: 'ğŸŒ¸ æ¨±èŠ±ç¥­', cost: 200, desc: 'ç²‰è‰²çš„æµªæ¼«å­£èŠ‚ã€‚å•èº«å±…æ°‘åœ¨æ ‘ä¸‹æ›´å®¹æ˜“å å…¥çˆ±æ²³ã€‚', emoji: 'ğŸŒ¸', date: {m:3, d:1} },
        { id: 'planting', name: 'ğŸŒ³ æ¤æ ‘èŠ‚', cost: 150, desc: 'å¿«ä¹+5ï¼Œå…³ç³»+3ã€‚10%æ¦‚ç‡æ ‘è‹—æ¯æ­»æ•ˆæœå‡åŠã€‚', emoji: 'ğŸŒ³', date: {m:3, d:12} },
        { id: 'fools_day', name: 'ğŸ¤¡ æ„šäººèŠ‚', cost: 100, desc: 'å°å¿ƒæ¶ä½œå‰§ï¼å…¨å‘˜å¿«ä¹+10ï¼Œä½†å®¹æ˜“å‘ç”Ÿäº‰åµã€‚', emoji: 'ğŸ¤¡', date: {m:4, d:1} },
        { id: 'labor_day', name: 'ğŸ› ï¸ åŠ³åŠ¨èŠ‚', cost: 200, desc: 'åŠ³åŠ¨æœ€å…‰è£ï¼ä»Šæ—¥å·¥ä½œæ”¶ç›Šæå‡20%ã€‚', emoji: 'ğŸ› ï¸', date: {m:5, d:1} },
        { id: 'children_day', name: 'ğŸˆ å„¿ç«¥èŠ‚', cost: 250, desc: 'ç«¥å¿ƒæœªæ³¯ã€‚æ¸¸ä¹åœºæ•ˆæœç¿»å€ã€‚', emoji: 'ğŸˆ', date: {m:6, d:1} },
        { id: 'music_fest', name: 'ğŸµ éŸ³ä¹èŠ‚', cost: 400, desc: 'éœ²å¤©éŸ³ä¹ç‹‚æ¬¢ï¼å…¨å‘˜å¿ƒæƒ…å¤§å¹…æå‡ï¼Œå‹åŠ›é‡Šæ”¾ã€‚', emoji: 'ğŸµ', date: {m:6, d:21} },
        { id: 'matsuri', name: 'ğŸ® å¤æ—¥ç¥­', cost: 400, desc: 'å…¨å‘˜ç©¿æµ´è¡£åº†ç¥å¤å¤©ï¼å¿«ä¹å¤§å¹…æå‡ï¼Œå•èº«ç‹—å®¹æ˜“è„±å•ã€‚', emoji: 'ğŸ®', date: {m:7, d:15} },
        { id: 'charity_day', name: 'ğŸ’ å›½é™…æ…ˆå–„æ—¥', cost: 0, desc: 'é¼“åŠ±å±…æ°‘é€šè¿‡ææ¬¾å¸®åŠ©ä»–äººï¼Œæå‡ç¤¾ä¼šè´£ä»»æ„Ÿã€‚', emoji: 'ğŸ’', date: {m:9, d:5} },
        { id: 'harvest', name: 'ğŸŒ¾ ä¸°æ”¶èŠ‚', cost: 300, desc: 'åº†ç¥ä¸°æ”¶ï¼é¤å…é£Ÿç‰©ä»·æ ¼åŠä»·(ç”±é•‡åº“è¡¥è´´)ï¼Œå±…æ°‘é¥±é£Ÿåº¦å®¹æ˜“æ¢å¤ã€‚', emoji: 'ğŸŒ¾', date: {m:9, d:23} },
        { id: 'halloween', name: 'ğŸƒ ä¸‡åœ£èŠ‚', cost: 350, desc: 'äº’æ¢ç³–æœï¼Œæ£è›‹é¬¼å‡ºæ²¡ï¼å¿«ä¹+15ï¼Œè·å¾—éšæœºé›¶é£Ÿã€‚', emoji: 'ğŸƒ', date: {m:10, d:31} },
        { id: 'christmas', name: 'ğŸ„ åœ£è¯èŠ‚', cost: 500, desc: 'äº’é€ç¤¼ç‰©ï¼Œå…¨å‘˜å¿«ä¹+20ï¼Œå¥åº·+10ã€‚', emoji: 'ğŸ„', date: {m:12, d:25} },
        { id: 'new_year_eve', name: 'ğŸ† è·¨å¹´æ™šä¼š', cost: 600, desc: 'è¾æ—§è¿æ–°ï¼å…¨å‘˜èšé›†å€’è®¡æ—¶ï¼Œå¿«ä¹ä¸å…³ç³»å¤§å¹…æå‡ã€‚', emoji: 'ğŸ†', date: {m:12, d:31} },
        
        // å­£èŠ‚æ€§ (æ— ç‰¹å®šæ—¥æœŸï¼Œæ•´ä¸ªå­£èŠ‚éƒ½å¯èƒ½å‡ºç°)
        { id: 'snowfest', name: 'â˜ƒï¸ å†°é›ªèŠ‚', cost: 350, desc: 'å †é›ªäººã€åƒç«é”…ï¼å¿«ä¹+15ï¼Œå¥åº·+10ï¼Œé¥±é£Ÿ+10ã€‚', emoji: 'â˜ƒï¸', season: 'Winter' }
    ];

    function getJobWage(role) { 
        if (role.includes("è€æ¿") || role.includes("ä¸»æ²»åŒ»å¸ˆ")) return 35; 
        if (role.includes("ç¥çˆ¶") || role.includes("ç¤¾åŒºåŒ»ç”Ÿ") || role.includes("è®²è§£")) return 25; 
        if (role.includes("è­¦å¯Ÿ") || role.includes("è€å¸ˆ") || role.includes("æ•™ç»ƒ")) return 22; 
        if (role.includes("å–é“¶")) return 20; 
        if (role.includes("å¤§å¨") || role.includes("æŠ¤å£«") || role.includes("ç©å¶")) return 18; 
        if (role.includes("èŠ±è‰º") || role.includes("ç‚¸é¸¡")) return 16; 
        if (role.includes("ç½‘ç®¡") || role.includes("ä¿å®‰")) return 15; 
        if (role.includes("å‰å°") || role.includes("å›¾ä¹¦ç®¡ç†å‘˜") || role.includes("æ£€ç¥¨") || role.includes("ç”µæ¢¯")) return 15; 
        if (role.includes("æ‹‰é¢")) return 15; 
        if (role.includes("æ”¶é“¶") || role.includes("å”®ç¥¨")) return 15; 
        if (role.includes("ç½‘å§ä¿æ´") || role.includes("ä¿æ´") || role.includes("è·‘å ‚") || role.includes("æ—©ç‚¹")) return 15; 
        return 15; 
    }
    function getBaseJobWage(role) { return getJobWage(role); }

    class Character {
        constructor(name) {
            this.name = name; this.gender = Math.random() > 0.5 ? 'â™‚ ç”·' : 'â™€ å¥³'; this.happiness = 60; this.hunger = 80; this.health = 100; this.money = 0; this.job = null; this.currentAction = "å‘å‘†"; this.relationships = {}; this.partner = null; this.interactingWith = null; 
            this.personality = choose(PERSONALITIES); this.traits = []; this.ideology = choose(IDEOLOGIES);
            this.nextActionOverride = null; 
            this.bag = []; 
            this.history = [];
            this.jailTerm = 0; 
            this.lastMealTime = -999;
            this.consecutiveWork = 0;
            this.skills = { social: rand(5, 15), craft: rand(5, 15), intel: rand(5, 15), strength: rand(5, 15) };
            this.stat_rob = 0;        
            this.stat_be_robbed = 0;  
            this.stat_streetwalk = 0; 
            this.stat_assault = 0;    
            this.stat_be_assaulted = 0; 
            
            this.dailySleepOffset = rand(-2, 4); 
            this.stayUpLate = false;

            const traitCount = rand(0, 2); for (let i = 0; i < traitCount; i++) { const availableTraits = TRAITS.filter(t => !this.traits.find(tt => tt.id === t.id)); if (availableTraits.length > 0) this.traits.push(choose(availableTraits)); }
            this.constructionContribution = {}; this.prostitute = null; 
            
            this.appearance = rand(40, 80); 
            if (this.hasTrait('promiscuous')) this.appearance += 15; 
            if (this.hasTrait('sleepy')) this.appearance += 5; 
            if (this.personality.name === 'å¼€æœ—') this.appearance += 5;
            if (this.personality.name === 'é˜´æ²‰') this.appearance -= 5;
            if (this.personality.name === 'æ¸©æŸ”') this.appearance += 3;
            this.appearance = Math.max(0, Math.min(100, this.appearance));
        }
        hasTrait(traitId) { return this.traits.some(t => t.id === traitId); }
        
        addLog(msg) {
            this.history.unshift(msg);
            if (this.history.length > 10) this.history.pop();
        }

        getSleepSchedule() { 
            if (this.stayUpLate) return { start: 4, end: 8 }; 
            let baseStart = 22; let baseEnd = 7;
            if (this.job && (this.job.buildingId === 'bar' || this.job.buildingId === 'netcafe')) { 
                baseStart = 5; baseEnd = 13; 
            } else {
                baseStart = (baseStart + this.dailySleepOffset + 24) % 24; 
                baseEnd = (baseEnd + Math.floor(this.dailySleepOffset/2) + 24) % 24;
            }
            if (this.hasTrait('sleepy')) { baseStart = (baseStart - 1 + 24) % 24; baseEnd = (baseEnd + 1) % 24; }
            if (Math.random() < 0.1) baseStart = (baseStart + 2) % 24;
            return { start: baseStart, end: baseEnd }; 
        }
        
        decideProposal(askerName, type) { const rel = this.relationships[askerName]; let chance = rel.love + (this.happiness - 50) / 2; let threshold = 0; if (type === 'date') threshold = 30; if (type === 'confess') threshold = 75; if (type === 'propose') threshold = 90; chance += rand(-10, 10); return chance >= threshold; }
        
        calculateWage(baseWage, role) { 
            let bonus = (this.ideology && this.ideology.wageMod) ? this.ideology.wageMod : 0;
            let mayorMult = 1.0;
            const g = (typeof gameInstance !== 'undefined' && gameInstance) ? gameInstance : window.gameInstance;
            if (g && g.mayor) {
                const mayorChar = g.chars.find(c => c.name === g.mayor);
                if (mayorChar && mayorChar.ideology) {
                   let effect = MAYOR_EFFECTS[mayorChar.ideology.name];
                   if (effect && effect.wage !== undefined) mayorMult = effect.wage;
                }
            }
            let buildLevelBonus = 1.0;
            if (this.job && g) {
                const b = g.buildings.find(x => x.id === this.job.buildingId);
                if (b && b.level > 1) {
                    buildLevelBonus = 1 + (b.level - 1) * 0.1;
                }
            }
            if (role) {
                const type = getJobSkillType(role);
                const skillVal = this.skills[type] || 0;
                const info = getLevelInfo(skillVal);
                const skillBonus = skillVal * 0.005;
                return Math.floor(baseWage * info.multiplier * (1 + bonus + skillBonus) * mayorMult * buildLevelBonus); 
            }
            return Math.floor(baseWage * (1 + bonus) * mayorMult); 
        }
    }

    class Building {
        constructor(blueprint) { 
            this.id = blueprint.id; this.name = blueprint.name; this.category = blueprint.category || 'fun'; this.totalCost = blueprint.cost; this.currentProgress = 0; 
            this.isBuilt = blueprint.isBuilt || false; 
            this.effect = blueprint.effect; this.desc = blueprint.desc; this.price = blueprint.price || 0; this.food = blueprint.food || 0; this.open = blueprint.open; this.close = blueprint.close; this.jobs = blueprint.jobs || []; this.staff = []; this.closedDays = blueprint.closedDays || []; this.prostitutes = []; this.sells = blueprint.sells || []; 
            this.history = [];
            this.level = 1; 
            this.isUnderConstruction = false; 
            
            if (this.isBuilt) this.currentProgress = this.totalCost;
        }
        addLog(msg) {
            this.history.unshift(msg);
            if (this.history.length > 10) this.history.pop();
        }
        isOpen(hour, day) { if (!this.isBuilt) return false; if (this.closedDays.includes(day)) return false; if (this.jobs.length > 0 && this.staff.length === 0) return false; if (this.open === 0 && this.close === 24) return true; if (this.close < this.open) return hour >= this.open || hour < this.close; return hour >= this.open && hour < this.close; }
    }

    class Game {
        constructor() { 
            this.chars = []; this.buildings = []; this.townMoney = 0; this.gameTime = 480; this.gameDay = 1; this.autoSaveTimer = 0; this.lastSaveTime = Date.now(); 
            this.speed = 1500; this.speedLevel = 1; 
            this.dateMonth = 1;
            this.dateDay = 1;
            this.weather = 'Sunny';
            this.achievements = []; 
            this.policySocialSecurity = false; 
            this.policyHousing = false; 
            this.policyFood = false; 
            this.mayor = null; 
            
            this.votingInProgress = false;
            this.voteTimer = null;

            this.loadOrInit(); 
            if(!this.weather) this.generateDailyWeather();
            this.loopId = setInterval(() => this.tick(), this.speed); 
            window.gameInstance = this;
        }
        
        getSeason() {
            const m = this.dateMonth;
            if (m >= 3 && m <= 5) return 'Spring';
            if (m >= 6 && m <= 8) return 'Summer';
            if (m >= 9 && m <= 11) return 'Autumn';
            return 'Winter';
        }

        getSeasonName() {
            const s = this.getSeason();
            const map = { 'Spring': 'æ˜¥', 'Summer': 'å¤', 'Autumn': 'ç§‹', 'Winter': 'å†¬' };
            return map[s];
        }
        
        generateDailyWeather() {
            const season = this.getSeason();
            const roll = Math.random();
            let type = 'Sunny';
            if (season === 'Spring') { if(roll < 0.5) type = 'Sunny'; else if(roll < 0.8) type = 'Cloudy'; else type = 'Rainy'; } else if (season === 'Summer') { if(roll < 0.4) type = 'Sunny'; else if(roll < 0.6) type = 'Rainy'; else if(roll < 0.8) type = 'Heatwave'; else type = 'Storm'; } else if (season === 'Autumn') { if(roll < 0.5) type = 'Sunny'; else if(roll < 0.7) type = 'Cloudy'; else if(roll < 0.9) type = 'Rainy'; else type = 'Foggy'; } else { if(roll < 0.4) type = 'Sunny'; else if(roll < 0.7) type = 'Cloudy'; else type = 'Snowy'; }
            this.weather = type;
            const wInfo = WEATHER_TYPES[type];
            this.log(`[ğŸŒ¦ï¸å¤©æ°”] ä»Šå¤©æ˜¯ **${wInfo.name}**ã€‚${wInfo.desc}`, "tag-event");
        }

        loadOrInit() { 
            const saveStr = localStorage.getItem('happyTownV2_Save'); 
            if (saveStr) { 
                this.loadFromJSON(saveStr); 
                this.checkAndAddNewChars(); 
                this.log("ğŸ“‚ è¯»å–å­˜æ¡£æˆåŠŸï¼"); 
            } else { 
                this.initNewGame(); 
            } 
            if (!this.mayor) {
                setTimeout(() => this.triggerMayorElection(), 2000);
            }
            this.renderUIStatic(); 
        }
        checkAndAddNewChars() { let added = false; NAMES.forEach(name => { if (!this.chars.find(c => c.name === name)) { this.chars.push(new Character(name)); this.log(`[ğŸ‰æ–°å±…æ°‘] ${name} å…¥ä½ï¼`); added = true; } }); if (added) { this.chars.forEach(c1 => { this.chars.forEach(c2 => { if (c1.name !== c2.name && !c1.relationships[c2.name]) { c1.relationships[c2.name] = { love: 0, status: 'stranger' }; } }); }); } }
        initNewGame() { 
            this.chars = NAMES.map(n => { let c = new Character(n); NAMES.forEach(target => { if (target !== n) c.relationships[target] = { love: 0, status: 'stranger' }; }); return c; }); 
            this.buildings = BUILDINGS_BLUEPRINT.map(b => new Building(b)); 
            
            const park = this.buildings.find(b => b.id === 'park'); if(park) { park.isBuilt = true; park.currentProgress = park.totalCost; }
            const clinic = this.buildings.find(b => b.id === 'clinic'); if(clinic) { clinic.isBuilt = true; clinic.currentProgress = clinic.totalCost; }
            const baozi = this.buildings.find(b => b.id === 'baozi'); if(baozi) { baozi.isBuilt = true; baozi.currentProgress = baozi.totalCost; }
            
            setTimeout(() => this.triggerConstructionVote(), 2000);
        }
        
        tick() { 
            if(this.votingInProgress) return; 
            this.gameTime += 10; 
            
            if (this.gameTime % 60 === 0) {
                this.applyMayorEffects();
                this.checkAchievements();

                this.buildings.forEach(b => {
                    if (b.isBuilt && b.category === 'landmark') {
                        this.townMoney += b.price; 
                        if (b.effect === 'tourist_high') { this.chars.forEach(c => c.happiness = Math.min(100, c.happiness + 0.5)); } else if (b.effect === 'tourist_health') { this.chars.forEach(c => c.health = Math.min(100, c.health + 0.5)); }
                    }
                });
                
                if (this.gameDay === 0 && this.gameTime === 720) {
                    this.triggerMayorElection();
                }

                const h = Math.floor(this.gameTime / 60);
                if ((h === 9 || h === 14) && !this.votingInProgress && !this.buildings.some(b => b.isUnderConstruction) && this.buildings.some(b => !b.isBuilt)) {
                     this.triggerConstructionVote();
                }
            }

            if (this.gameTime >= 1440) { 
                this.gameTime = 0; 
                this.gameDay = (this.gameDay + 1) % 7; 
                this.dateDay++;
                
                // Update Month logic based on MONTH_DAYS
                const daysInMonth = MONTH_DAYS[this.dateMonth];
                if (this.dateDay > daysInMonth) { 
                    this.dateDay = 1; 
                    this.dateMonth++; 
                    if (this.dateMonth > 12) this.dateMonth = 1; 
                }
                
                this.runDailyPolicies();
                this.chars.forEach(c => { c.dailySleepOffset = rand(-2, 4); c.stayUpLate = Math.random() < 0.05; });
                this.generateDailyWeather();
                
                // æ£€æŸ¥ä»Šæ—¥æ˜¯å¦æœ‰èŠ‚æ—¥
                const todayEvent = TOWN_EVENTS.find(ev => ev.date && ev.date.m === this.dateMonth && ev.date.d === this.dateDay);
                if (todayEvent) {
                    this.log(`[ğŸ—“ï¸èŠ‚æ—¥] éšç€æ—¥å‡ºï¼Œ**${todayEvent.name}** åˆ°äº†ï¼è¯·å‰å¾€æ´»åŠ¨ç­–åˆ’éƒ¨ä¸¾åŠåº†å…¸ï¼`, "tag-event");
                }
            } 
            
            if (this.townMoney >= 5000) this.unlockAchievement('rich_town');

            if (this.gameTime % 60 === 0) { 
                this.runElectionsAndHiring(); 
                const weatherInfo = WEATHER_TYPES[this.weather] || WEATHER_TYPES['Sunny'];
                this.chars.forEach(c => { 
                    if (c.jailTerm > 0) { c.jailTerm -= 60; if (c.jailTerm <= 0) { c.jailTerm = 0; this.log(`[ğŸ”“é‡Šæ”¾] **${c.name}** åˆ‘æ»¡é‡Šæ”¾ï¼Œé‡è·è‡ªç”±ï¼`, "tag-build"); } }
                    c.hunger = Math.max(0, c.hunger - 0.4); 
                    if (c.hunger === 0) c.happiness -= 2; 
                    if (c.health < 30) c.happiness -= 5;
                    c.happiness = Math.min(100, Math.max(0, c.happiness + weatherInfo.mood));
                    c.health = Math.min(100, Math.max(0, c.health + weatherInfo.health));
                    if (Math.random() < 0.001) { c.health = Math.max(0, c.health - rand(5, 15)); this.log(`[ğŸš‘ç”Ÿç—…] **${c.name}** çªç„¶æ„Ÿè§‰èº«ä½“ä¸é€‚ï¼Œå¥åº·åº¦ä¸‹é™äº†ã€‚`, "tag-reject"); }
                }); 
            } 
            this.decideAction(choose(this.chars)); 
            if (Date.now() - this.lastSaveTime > (parseInt(document.getElementById('autosave-rate').value)||30) * 1000) this.saveData(true); 
            this.updateUI(); 
        }

        triggerVoting(title, candidates, onComplete, instruction="è¯·æŠ•ç¥¨") {
             this.votingInProgress = true;
             const modal = document.getElementById('voting-modal');
             document.getElementById('voting-title').innerText = title;
             document.getElementById('voting-mayor-msg').innerText = "";
             document.getElementById('voting-instruction').innerText = instruction;
             const list = document.getElementById('voting-candidates-list');
             const log = document.getElementById('voting-realtime-log');
             list.innerHTML = '';
             log.innerHTML = '';
             
             candidates.forEach(c => {
                c.votes = 0;
                const div = document.createElement('div');
                div.className = 'voting-candidate';
                div.id = `vote-c-${c.id}`;
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; font-weight:bold;">
                        <span>${c.name} ${c.extra ? `<small style="font-weight:normal">(${c.extra})</small>` : ''}</span>
                        <span id="vote-count-${c.id}">0 ç¥¨</span>
                    </div>
                    <div style="font-size:0.8rem; color:#666;">${c.desc}</div>
                    <div class="vote-bar-container"><div class="vote-bar-fill" id="vote-bar-${c.id}"></div></div>
                `;
                list.appendChild(div);
            });
             
             modal.classList.add('active');
             let voterIndex = 0;
             const voters = [...this.chars];
             
             this.voteTimer = setInterval(() => {
                if (voterIndex >= voters.length) {
                    clearInterval(this.voteTimer);
                    this.votingInProgress = false;
                    candidates.sort((a, b) => b.votes - a.votes);
                    const winner = candidates[0];
                    document.getElementById(`vote-c-${winner.id}`).classList.add('winner');
                    
                    setTimeout(() => {
                        modal.classList.remove('active');
                        onComplete(winner);
                    }, 3000);
                    return;
                }
                const voter = voters[voterIndex];
                const choice = candidates[Math.floor(Math.random() * candidates.length)];
                choice.votes++;
                document.getElementById(`vote-count-${choice.id}`).innerText = `${choice.votes} ç¥¨`;
                const totalVotes = voterIndex + 1;
                candidates.forEach(c => {
                    const pct = (c.votes / totalVotes) * 100;
                    document.getElementById(`vote-bar-${c.id}`).style.width = `${pct}%`;
                });
                const logEntry = document.createElement('div');
                logEntry.innerText = `ğŸ—³ï¸ ${voter.name} æŠ•ç¥¨ç»™ ${choice.name}`;
                log.prepend(logEntry);
                voterIndex++;
            }, 100);
        }

        triggerConstructionVote() {
            const unbuilt = this.buildings.filter(b => !b.isBuilt && !b.isUnderConstruction);
            if (unbuilt.length === 0) return;
            const candidates = [];
            const tempUnbuilt = [...unbuilt];
            const count = Math.min(3, tempUnbuilt.length);
            for(let i=0; i<count; i++) {
                const idx = Math.floor(Math.random() * tempUnbuilt.length);
                const b = tempUnbuilt[idx];
                candidates.push({ id: b.id, name: b.name, desc: `${b.desc} (ğŸ’°${b.totalCost})`, extra: CATEGORY_NAMES[b.category] });
                tempUnbuilt.splice(idx, 1);
            }
            this.triggerVoting("ğŸ—ï¸ å»ºè®¾å…¬æŠ•", candidates, (winner) => {
                const building = this.buildings.find(b => b.id === winner.id);
                if(building) {
                    building.isUnderConstruction = true;
                    this.log(`[ğŸ—³ï¸å…¬æŠ•] æŠ•ç¥¨ç»“æŸï¼**${building.name}** èƒœå‡ºï¼Œæ­£å¼åŠ¨å·¥ï¼`, "tag-gov");
                    this.updateUI();
                }
            }, "è¯·å±…æ°‘æ ¹æ®è‡ªèº«éœ€æ±‚æŠ•å‡ºç¥åœ£çš„ä¸€ç¥¨ï¼");
        }

        triggerMayorElection() {
            if (this.chars.length < 3) return;
            const scoredChars = this.chars.map(c => {
                let popularity = 0;
                this.chars.forEach(other => { if (other.name !== c.name && other.relationships[c.name]) { popularity += other.relationships[c.name].love; } });
                const wealthScore = Math.floor(c.money / 10);
                const score = popularity + wealthScore + rand(0, 50);
                return { char: c, score: score };
            });
            scoredChars.sort((a, b) => b.score - a.score);
            const candidates = scoredChars.slice(0, 3).map(item => ({
                id: item.char.name, 
                name: item.char.name,
                desc: `ä¿¡ä»°: ${item.char.ideology.name} | èµ„é‡‘: ğŸ’°${item.char.money}`,
                extra: "å€™é€‰äºº"
            }));

            this.triggerVoting("ğŸ© é•‡é•¿æ¢å±Šé€‰ä¸¾", candidates, (winner) => {
                 this.mayor = winner.name;
                 const m = this.chars.find(c => c.name === this.mayor);
                 this.log(`[ğŸ—³ï¸å¤§é€‰] é€‰ä¸¾ç»“æŸï¼**${winner.name}** å½“é€‰ä¸ºæ–°ä»»é•‡é•¿ï¼`, "tag-gov");
                 if(m) this.log(`[ğŸ“¢æ”¿ç­–] é•‡é•¿ ${winner.name} å°†æ¨è¡Œ [${m.ideology.name}] æ”¿ç­–ã€‚`, "tag-gov");
                 this.updateUI();
                 if (document.getElementById('gov-modal').classList.contains('active')) this.showGov();
            }, "è°èƒ½å¸¦é¢†å°é•‡èµ°å‘ç¹è£ï¼Ÿè¯·æŠ•ç¥¨ï¼");
        }

        checkAchievements() {
            this.chars.forEach(c => {
                if (c.money >= 100) this.unlockAchievement('first_pot');
                if (c.money >= 1000) this.unlockAchievement('financial_freedom');
                if (c.happiness >= 80 && c.hunger >= 80 && c.health >= 80) this.unlockAchievement('perfect_day');
            });
            const totalMoney = this.chars.reduce((acc, c) => acc + c.money, 0);
            const avgMoney = totalMoney / this.chars.length;
            if (avgMoney > 50) this.unlockAchievement('common_prosperity');
        }

        applyMayorEffects() {
            if (!this.mayor) return;
            const m = this.chars.find(c => c.name === this.mayor);
            if (!m) return;
            let effect = MAYOR_EFFECTS[m.ideology.name];
            if (effect && effect.happy !== 0) {
                this.chars.forEach(c => { c.happiness = Math.min(100, Math.max(0, c.happiness + effect.happy)); });
            }
        }

        runDailyPolicies() {
            if (this.policySocialSecurity) {
                let count = 0; let totalPayout = 0; const subsidy = 10; const threshold = 15;
                this.chars.forEach(c => { if (c.money < threshold) { if (this.townMoney >= subsidy) { this.townMoney -= subsidy; c.money += subsidy; count++; totalPayout += subsidy; c.addLog(`[ğŸ›ç¤¾ä¿] æ”¶åˆ°æ”¿åºœå‘æ”¾çš„ä½ä¿é‡‘ ğŸ’°${subsidy}`); } } });
                if (count > 0) { this.log(`[ğŸ“œç¤¾ä¿] ç¤¾ä¼šä½ä¿é‡‘ç”Ÿæ•ˆï¼Œä¸º ${count} ä½è´«å›°å±…æ°‘å‘æ”¾è¡¥åŠ© ğŸ’°${totalPayout}ã€‚`, "tag-promote"); }
            }
            if (this.policyHousing) {
                let housingCost = 5; let count = 0; let totalCost = 0;
                this.chars.forEach(c => { if (!c.job && !c.prostitute) { if (this.townMoney >= housingCost) { this.townMoney -= housingCost; totalCost += housingCost; c.happiness = Math.min(100, c.happiness + 5); count++; } } });
                if (count > 0) { this.log(`[ğŸ ä½æˆ¿] ä¿éšœæ€§ä½æˆ¿è®¡åˆ’ä¸º ${count} ä½æ— ä¸šå±…æ°‘æä¾›äº†ä½æ‰€(å¿ƒæƒ…+5)ï¼Œè€—èµ„ ğŸ’°${totalCost}ã€‚`, "tag-promote"); }
            }
            if (this.policyFood) {
                let foodCost = 4; let count = 0; let totalCost = 0;
                this.chars.forEach(c => { if (c.hunger < 20) { if (this.townMoney >= foodCost) { this.townMoney -= foodCost; totalCost += foodCost; c.hunger = Math.min(100, c.hunger + 20); c.bag.push('baozi_pork'); c.addLog(`[ğŸä½ä¿] é¢†å–äº†æ”¿åºœå‘æ”¾çš„æ•‘æµç²® (çŒªè‚‰åŒ…)`); count++; } } });
                if (count > 0) { this.log(`[ğŸé£Ÿå“] æœ€ä½é£Ÿå“ä¿éšœä¸º ${count} ä½é¥¥é¥¿å±…æ°‘å‘æ”¾äº†æ•‘æµç²®ï¼Œè€—èµ„ ğŸ’°${totalCost}ã€‚`, "tag-promote"); }
            }
        }
        
        getDateTimeStr() { const h = Math.floor(this.gameTime / 60); const m = this.gameTime % 60; return `[${this.dateMonth}æœˆ${this.dateDay}æ—¥ ${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}]`; }

        improveSkill(c, type, amount) {
            const oldVal = c.skills[type] || 0;
            const oldLevelInfo = getLevelInfo(oldVal);
            c.skills[type] = Math.min(100, oldVal + amount);
            const newVal = c.skills[type];
            const newLevelInfo = getLevelInfo(newVal);
            if (newLevelInfo.level > oldLevelInfo.level) { this.log(`[â­æ™‹å‡] æ­å–œ **${c.name}** çš„ ${type} æŠ€èƒ½çªç ´ï¼æ™‹å‡ä¸º **${newLevelInfo.title}** çº§åˆ«ï¼`, "tag-promote"); c.happiness = Math.min(100, c.happiness + 20); }
        }

        unlockAchievement(id) { if (this.achievements.includes(id)) return; const ach = ACHIEVEMENTS_DB.find(a => a.id === id); if (!ach) return; this.achievements.push(id); this.townMoney += ach.reward; this.log(`[ğŸ†æˆå°±] æ­å–œè§£é”æˆå°±ï¼š**${ach.name}** (${ach.desc})ï¼å¥–åŠ±èµ„é‡‘ ğŸ’°${ach.reward}`, "tag-promote"); alert(`ğŸ† æˆå°±è§£é”ï¼š${ach.name}\n${ach.desc}\nè·å¾—å¥–åŠ±: ğŸ’°${ach.reward}`); }

        findItemInBag(p, type) { return p.bag.find(id => ITEMS_DB[id] && ITEMS_DB[id].type === type); }

        decideAction(p) {
            if (p.jailTerm > 0) { p.currentAction = `[ğŸ›‘åç‰¢] é“çª—æ³ª (å‰©ä½™ ${(p.jailTerm/60).toFixed(1)}h)`; p.hunger = Math.max(0, p.hunger - 0.5); p.happiness = Math.max(0, p.happiness - 0.5); p.consecutiveWork = 0; return; }
            if (p.nextActionOverride) { const cmd = p.nextActionOverride; p.nextActionOverride = null; this.log(`[ğŸ•¹ï¸å¼ºåˆ¶] ä¸Šå¸æ§åˆ¶ **${p.name}** å» ${cmd.desc}...`, "tag-build"); if (cmd.type === 'work' && p.job) { const b = this.buildings.find(x => x.id === p.job.buildingId); if(b) { this.doWork(p, b); return; } } else if (cmd.type === 'rest') { this.doRest(p, {name:"å®¶", price:0}); return; } else if (cmd.type === 'build') { const b = this.buildings.find(x => x.id === cmd.target); if (b) { this.doBuild(p, b); return; } } else if (cmd.type === 'visit') { const b = this.buildings.find(x => x.id === cmd.target); if (b) { if(b.effect==='food') this.doEat(p, b); else if(b.effect==='shop') this.doShopping(p, b); else this.doRest(p, b); return; } } else if (cmd.type === 'social') { const t = this.chars.find(x => x.name === cmd.target); if (t) { const park = this.buildings.find(b=>b.id==='park'); this.doSocialTarget(p, t, park || {name:"è·¯è¾¹", effect:"none"}); return; } } else if (cmd.type === 'crime_rob') { const t = this.chars.find(x => x.name === cmd.target); if (t) { this.doRobbery(p, t); return; } } else if (cmd.type === 'crime_assault') { const t = this.chars.find(x => x.name === cmd.target); if (t) { this.doSexualAssault(p, t); return; } } }

            this.breakInteraction(p); 
            const hour = Math.floor(this.gameTime / 60);
            if (p.health < 40) { const medId = this.findItemInBag(p, 'medicine'); if (medId) { this.doUseItem(p, medId); return; } const clinic = this.buildings.find(b => b.id === 'clinic'); if (clinic && clinic.isBuilt && clinic.isOpen(hour, this.gameDay) && p.money >= 10) { this.doShopping(p, clinic, 'medicine'); return; } const hospitals = this.buildings.filter(b => b.isBuilt && b.effect === 'health' && b.isOpen(hour, this.gameDay) && p.money >= b.price); if (hospitals.length > 0) { this.doRest(p, choose(hospitals)); return; } this.doRest(p, {name:"å®¶", price:0}); return; }
            if (p.hunger < 30) { const foodId = this.findItemInBag(p, 'food') || this.findItemInBag(p, 'snack'); if (foodId) { this.doUseItem(p, foodId); return; } const restaurants = this.buildings.filter(b => b.isBuilt && b.effect === 'food' && b.isOpen(hour, this.gameDay) && p.money >= b.price); if (restaurants.length > 0) { this.doEat(p, choose(restaurants)); return; } const shops = this.buildings.filter(b => b.isBuilt && b.effect === 'shop' && b.sells.some(id => ITEMS_DB[id].type === 'food') && b.isOpen(hour, this.gameDay)); if (shops.length > 0 && p.money >= 5) { this.doShopping(p, choose(shops), 'food'); return; } }
            
            const isMealTime = (hour >= 6 && hour < 9) || (hour >= 11 && hour < 14) || (hour >= 17 && hour < 20);
            const timeSinceLastMeal = this.gameTime - (p.lastMealTime || -999); 
            if (isMealTime && p.hunger < 80 && (timeSinceLastMeal > 180 || timeSinceLastMeal < 0)) { const foodId = this.findItemInBag(p, 'food'); if (foodId) { this.doUseItem(p, foodId); return; } const restaurants = this.buildings.filter(b => b.isBuilt && b.effect === 'food' && b.isOpen(hour, this.gameDay) && p.money >= b.price); if (restaurants.length > 0) { this.doEat(p, choose(restaurants)); return; } const shops = this.buildings.filter(b => b.isBuilt && b.effect === 'shop' && b.sells.some(id => ITEMS_DB[id].type === 'food') && b.isOpen(hour, this.gameDay)); if (shops.length > 0 && p.money >= 5) { this.doShopping(p, choose(shops), 'food'); return; } }

            const isPoor = p.money < 10; const isGreedy = p.hasTrait('money-loving'); const isMilitant = p.ideology.name === 'å†›å›½ä¸»ä¹‰';
            const isHorny = p.hasTrait('promiscuous'); const isUgly = p.appearance < 50; const isDepressed = p.happiness < 30;
            const policeStation = this.buildings.find(b => b.id === 'police'); const hasPolice = policeStation && policeStation.isBuilt && policeStation.staff.length > 0; const deterrent = hasPolice ? 0.02 : 0;
            
            let robChance = 0.005; if (isPoor) robChance += 0.002; if (isGreedy) robChance += 0.001; if (isMilitant) robChance += 0.003; robChance = Math.max(0, robChance - deterrent); 
            let assaultChance = 0.005; if (isHorny) assaultChance += 0.002; if (isUgly) assaultChance += 0.001; if (isDepressed) assaultChance += 0.001; assaultChance = Math.max(0, assaultChance - deterrent);
            const roll = Math.random();
            if (roll < robChance) { if (this.doRobbery(p)) return; } else if (roll < robChance + assaultChance) { if (this.doSexualAssault(p)) return; }

            const sleepSchedule = p.getSleepSchedule(); let isSleepTime = (sleepSchedule.start > sleepSchedule.end) ? (hour >= sleepSchedule.start || hour < sleepSchedule.end) : (hour >= sleepSchedule.start && hour < sleepSchedule.end);
            if (isSleepTime) { p.currentAction = "ğŸ˜´ ç¡è§‰"; let recovery = p.hasTrait('sleepy') ? 4 : 2; p.happiness = Math.min(100, p.happiness + recovery); p.consecutiveWork = 0; return; }
            if (p.job && p.hunger > 0) { const workplace = this.buildings.find(b => b.id === p.job.buildingId); if (workplace && workplace.isOpen(hour, this.gameDay)) { if (workplace.open === 0 && workplace.close === 24 ? Math.random() < 0.7 : true) { this.doWork(p, workplace); return; } } }
            if (p.prostitute && p.hunger > 0) { const footshop = this.buildings.find(b => b.id === p.prostitute.buildingId); if (footshop && footshop.isBuilt && footshop.isOpen(hour, this.gameDay)) { this.doProstitution(p, footshop); return; } }
            if (!p.job && p.money < 20 && p.hunger > 0) { if (p.hasTrait('promiscuous') && Math.random() < 0.6) { this.doStreetwalking(p); } else { this.doOddJob(p); } return; }
            
            if (p.happiness < 40) { const funItemId = p.bag.find(id => ITEMS_DB[id] && (ITEMS_DB[id].type === 'alcohol' || ITEMS_DB[id].type === 'snack' || ITEMS_DB[id].type === 'drink')); if (funItemId) { this.doUseItem(p, funItemId); return; } const venues = this.buildings.filter(b => b.isBuilt && (b.category === 'fun' || b.effect === 'fun_high') && b.isOpen(hour, this.gameDay) && p.money >= b.price); if (venues.length > 0) { this.doRest(p, choose(venues)); return; } }
            if (p.bag.length < 2 && p.money > 80 && Math.random() < 0.3) { const shops = this.buildings.filter(b => b.isBuilt && b.effect === 'shop' && b.isOpen(hour, this.gameDay)); if (shops.length > 0) { let intention = 'food'; if (this.findItemInBag(p, 'food')) intention = 'medicine'; if (this.findItemInBag(p, 'medicine')) intention = 'gift'; this.doShopping(p, choose(shops), intention); return; } }

            const multiplier = p.hasTrait('money-loving') ? 2 : 1; 
            const venues = this.buildings.filter(b => b.isBuilt && b.isOpen(hour, this.gameDay) && (p.money >= b.price * multiplier)); const venue = choose(venues) || { name: "è·¯è¾¹", effect: "none", price: 0 }; 
            const pendingProject = choose(this.buildings.filter(b => !b.isBuilt && b.isUnderConstruction));
            if (roll < 0.3 && p.hunger > 0) { if (pendingProject) { this.doBuild(p, pendingProject); } else if (!p.job) { if (p.hasTrait('promiscuous') && Math.random() < 0.6) this.doStreetwalking(p); else this.doOddJob(p); } else { this.doSocial(p, venue); } } else if (roll < 0.8) { this.doSocial(p, venue); } else { this.doRest(p, venue); }
        }
        
        doSexualAssault(p, target = null) {
            p.consecutiveWork = 0;
            let victim = target;
            if (!victim) { const targets = this.chars.filter(c => c.name !== p.name && c.appearance >= 70); victim = targets.length > 0 ? choose(targets) : choose(this.chars.filter(c => c.name !== p.name)); }
            if (!victim) return false;
            this.unlockAchievement('first_crime');
            const policeStation = this.buildings.find(b => b.id === 'police'); const hasPolice = policeStation && policeStation.isBuilt && policeStation.staff.length > 0; let securityLevel = hasPolice ? policeStation.staff.length * 0.3 : 0; let successChance = 0.6 - securityLevel; if (p.appearance > 80) successChance += 0.2;
            const timeStr = this.getDateTimeStr();
            if (Math.random() < successChance) {
                p.happiness = Math.min(100, p.happiness + 40); victim.happiness -= 50; victim.health = Math.max(0, victim.health - 15); 
                const pRel = p.relationships[victim.name]; const vRel = victim.relationships[p.name]; pRel.status = "enemy"; vRel.status = "enemy"; pRel.love = -80; vRel.love = -100;
                p.stat_assault = (p.stat_assault || 0) + 1; victim.stat_be_assaulted = (victim.stat_be_assaulted || 0) + 1;
                this.logInteraction(`[ğŸ’‹åŠ«è‰²] éœ‡æƒŠï¼**${p.name}** å¯¹é¢œå€¼é«˜è¾¾ ${victim.appearance} çš„ **${victim.name}** å®æ–½äº†çŒ¥äºµï¼`, "tag-crime"); p.currentAction = `[çŠ¯ç½ª] åŠ«è‰²äº† ${victim.name}`; 
                p.addLog(`${timeStr} åŠ«è‰²äº† ${victim.name}`); victim.addLog(`${timeStr} æƒ¨é­ ${p.name} åŠ«è‰² (å¿ƒæƒ…-50, å¥åº·-15)`); if(policeStation) policeStation.addLog(`${timeStr} æ¥åˆ°æŠ¥æ¡ˆï¼š${p.name} éªšæ‰°äº† ${victim.name}`);
                return true;
            } else {
                if (hasPolice) { const fine = 200; p.happiness -= 40; p.money -= fine; this.townMoney += fine; p.jailTerm = 1440; this.logInteraction(`[ğŸ‘®é€®æ•] **${p.name}** è¯•å›¾å¯¹ **${victim.name}** å›¾è°‹ä¸è½¨ï¼Œè¢«è­¦å¯Ÿé€®æ•ï¼`, "tag-build"); const copName = choose(policeStation.staff); const cop = this.chars.find(c => c.name === copName); if (cop) { cop.money += 30; } p.currentAction = `[è¢«æ•] åŠ«è‰²æœªé‚ï¼Œé”’é“›å…¥ç‹±`; p.addLog(`${timeStr} åŠ«è‰² ${victim.name} å¤±è´¥ï¼Œè¢«æ•å…¥ç‹±`); } else { p.happiness -= 20; p.appearance -= 2; p.health = Math.max(0, p.health - 5); this.logInteraction(`[ğŸ‘Šåå‡»] **${p.name}** æƒ³åŠ«è‰² **${victim.name}**ï¼Œç»“æœè¢«å¯¹æ–¹ä¸€é¡¿æš´æï¼`, "tag-reject"); p.currentAction = `[å¤±è´¥] åŠ«è‰²æŒ¨æï¼Œé¼»é’è„¸è‚¿`; p.addLog(`${timeStr} éªšæ‰° ${victim.name} åè¢«æ‰“`); victim.addLog(`${timeStr} ç—›æ‰äº†è‰²ç‹¼ ${p.name}`); }
                return true;
            }
        }
        
        showActionSelect(name) {
            const c = this.chars.find(x => x.name === name); if (!c) return;
            const modal = document.getElementById('action-select-modal');
            const content = document.getElementById('action-select-content');
            let html = `<p>ä¸º <b>${c.name}</b> é€‰æ‹©ä¸‹ä¸€ä¸ªè¡ŒåŠ¨ (ç«‹å³ç”Ÿæ•ˆ):</p><div class="action-grid">`;
            html += `<button class="action-btn" onclick="setOverride('${name}', 'rest', '', 'å›å®¶ä¼‘æ¯')">ğŸ›Œ ä¼‘æ¯/èººå¹³</button>`;
            if (c.job) { html += `<button class="action-btn" style="border-color:#f1c40f" onclick="setOverride('${name}', 'work', '', 'å»ä¸Šç­')">ğŸ’¼ å»ä¸Šç­</button>`; }
            const pendings = this.buildings.filter(b => !b.isBuilt);
            pendings.forEach(b => { html += `<button class="action-btn" style="border-color:#e67e22" onclick="setOverride('${name}', 'build', '${b.id}', 'å»ºè®¾ ${b.name}')">ğŸ”¨ å»ºè®¾: ${b.name}</button>`; });
            const venues = this.buildings.filter(b => b.isBuilt);
            venues.forEach(b => { const icon = b.effect === 'food' ? 'ğŸ”' : (b.effect === 'shop' ? 'ğŸ›ï¸' : 'ğŸ¡'); html += `<button class="action-btn" onclick="setOverride('${name}', 'visit', '${b.id}', 'å» ${b.name}')">${icon} å»: ${b.name}</button>`; });
            html += `</div><p style="margin-top:10px;">å¼ºåˆ¶ç¤¾äº¤ (é€‰æ‹©å¯¹è±¡):</p><div class="action-grid">`;
            this.chars.forEach(t => { if (t.name !== c.name) { html += `<button class="action-btn" style="border-color:#ff7675" onclick="setOverride('${name}', 'social', '${t.name}', 'æ‰¾ ${t.name}')">â¤ æ‰¾: ${t.name}</button>`; } });
            html += `</div><p style="margin-top:10px;">å¼ºåˆ¶çŠ¯ç½ª (é€‰æ‹©å—å®³äºº):</p><div class="action-grid">`;
            this.chars.forEach(t => { if (t.name !== c.name) { html += `<button class="action-btn" style="border-color:#2d3436; color:#2d3436" onclick="setOverride('${name}', 'crime_rob', '${t.name}', 'æŠ¢åŠ« ${t.name}')">ğŸ”ª æŠ¢: ${t.name}</button>`; html += `<button class="action-btn" style="border-color:#c0392b; color:#c0392b" onclick="setOverride('${name}', 'crime_assault', '${t.name}', 'åŠ«è‰² ${t.name}')">ğŸ˜ˆ åŠ«: ${t.name}</button>`; } });
            html += `</div>`;
            content.innerHTML = html;
            document.getElementById('char-detail-modal').classList.remove('active');
            modal.classList.add('active');
        }
        setOverride(name, type, target, desc) { const c = this.chars.find(x => x.name === name); if (c) { c.nextActionOverride = { type, target, desc }; document.getElementById('action-select-modal').classList.remove('active'); alert(`å·²å®‰æ’ ${name} ä¸‹ä¸€æ­¥ï¼š${desc}`); } }
        closeActionSelect() { document.getElementById('action-select-modal').classList.remove('active'); }

        showGov() {
            document.getElementById('gov-modal').classList.add('active');
            document.getElementById('policy-social-security').checked = this.policySocialSecurity;
            document.getElementById('policy-housing').checked = this.policyHousing;
            document.getElementById('policy-food').checked = this.policyFood;
            if (this.mayor) {
                const m = this.chars.find(c => c.name === this.mayor);
                if (m) {
                    document.getElementById('mayor-name-display').innerText = m.name;
                    document.getElementById('mayor-ideology-display').innerText = m.ideology.name;
                    document.getElementById('mayor-ideology-display').style.backgroundColor = m.ideology.color;
                    
                    // --- Fix Start: Display Detailed Stats ---
                    const i = m.ideology;
                    let effectDesc = i.desc;
                    let statsArr = [];
                    if (i.wageMod !== 0) statsArr.push(`${i.wageMod > 0 ? 'ğŸ“ˆ' : 'ğŸ“‰'}å·¥èµ„${(i.wageMod > 0 ? '+' : '')}${Math.round(i.wageMod * 100)}%`);
                    if (i.loveMod !== 0) statsArr.push(`${i.loveMod > 0 ? 'ğŸ¥°' : 'ğŸ˜’'}å¥½æ„Ÿ${(i.loveMod > 0 ? '+' : '')}${i.loveMod}/h`);
                    if (i.chaosMod !== 0) statsArr.push(`${i.chaosMod < 0 ? 'ğŸ•Šï¸' : 'ğŸ’¥'}å†²çª${(i.chaosMod > 0 ? '+' : '')}${Math.round(i.chaosMod * 100)}%`);
                    
                    if(statsArr.length > 0) {
                         effectDesc += `<div style="margin-top:5px; padding-top:5px; border-top:1px dashed #ccc; font-weight:bold; font-size:0.85rem; color:#27ae60;">${statsArr.join(' | ')}</div>`;
                    }
                    document.getElementById('mayor-policy-display').innerHTML = effectDesc;
                    // --- Fix End ---
                }
            }
        }
        closeGov() { document.getElementById('gov-modal').classList.remove('active'); }
        
        executeCommonProsperity() {
            if (!this.mayor) { alert("å½“å‰æ²¡æœ‰é•‡é•¿ï¼Œæ— æ³•æ‰§è¡Œå†³ç­–ã€‚"); return; }
            if (this.chars.length < 5) { alert("äººå£å¤ªå°‘ï¼Œæ— æ³•æ‰§è¡Œã€‚"); return; }
            const sorted = [...this.chars].sort((a, b) => b.money - a.money);
            const richList = sorted.slice(0, 3);
            const poorList = sorted.filter(c => c.money < 50);
            if (poorList.length === 0) { alert("å°é•‡å·²ç»å…¨é¢è„±è´«ï¼Œæ— éœ€æ‰§è¡Œæ­¤æ”¿ç­–ï¼"); return; }
            let totalPool = 0; let msg = "ğŸ© é•‡é•¿å‘èµ· [å…±åŒå¯Œè£•] è¿åŠ¨ï¼š\n";
            richList.forEach(c => { const tax = Math.floor(c.money * 0.2); if (tax > 0) { c.money -= tax; totalPool += tax; c.happiness -= 10; c.addLog(`[ğŸ’¸è¢«åŠ«å¯Œ] è¢«å¼ºåˆ¶æ”¶ç¼´äº† ğŸ’°${tax} ç”¨äºå…±åŒå¯Œè£•`); msg += `- å‘å¯Œè±ª ${c.name} å¾æ”¶ ğŸ’°${tax}\n`; } });
            if (totalPool > 0) { const share = Math.floor(totalPool / poorList.length); poorList.forEach(c => { c.money += share; c.happiness += 10; c.addLog(`[ğŸ’°æµè´«] æ”¶åˆ°äº†å…±åŒå¯Œè£•åˆ†çº¢ ğŸ’°${share}`); }); msg += `\nğŸ’° å…±è®¡æ”¶ç¼´ ${totalPool}ï¼Œå¹³åˆ†ç»™ ${poorList.length} ä½å›°éš¾æˆ· (æ¯äººå¾— ${share})ã€‚`; this.log(`[âš–ï¸å†³ç­–] é•‡é•¿æ‰§è¡Œäº†â€œå…±åŒå¯Œè£•â€å†³ç­–ï¼å‘å¯Œäººå¾ç¨è¡¥è´´ç©·äººã€‚`, "tag-gov"); alert(msg); this.updateUI(); } else { alert("å¯Œè±ªä»¬ä¹Ÿæ²¡é’±äº†ï¼Œæ¦¨ä¸å‡ºæ²¹æ°´ï¼"); }
        }

        togglePolicy(type) { if (type === 'social') this.policySocialSecurity = document.getElementById('policy-social-security').checked; if (type === 'housing') this.policyHousing = document.getElementById('policy-housing').checked; if (type === 'food') this.policyFood = document.getElementById('policy-food').checked; }
        
        showTownEvents() {
            const modal = document.getElementById('town-event-modal');
            document.getElementById('event-town-money').innerText = this.townMoney;
            const seasonName = this.getSeasonName();
            document.getElementById('event-season-name').innerText = `${seasonName} (${this.dateMonth}æœˆ${this.dateDay}æ—¥)`;
            this.switchEventTab('normal');
            modal.classList.add('active');
        }
        
        switchEventTab(tab) {
            const list = document.getElementById('town-event-list');
            list.innerHTML = '';
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`evt-tab-${tab}`).classList.add('active');
            const currentSeason = this.getSeason();
            let eventsToShow = [];
            
            if (tab === 'normal') {
                // å¸¸è§„æ´»åŠ¨ï¼šæ— å­£èŠ‚ï¼Œæ— æ—¥æœŸ
                eventsToShow = TOWN_EVENTS.filter(ev => !ev.season && !ev.date);
            } else {
                // å­£èŠ‚é™å®šï¼šåŒ¹é…å­£èŠ‚ OR åŒ¹é…ä»Šæ—¥æ—¥æœŸ
                eventsToShow = TOWN_EVENTS.filter(ev => {
                    if (ev.date) {
                        return ev.date.m === this.dateMonth && ev.date.d === this.dateDay;
                    }
                    return ev.season === currentSeason;
                });
            }
            
            if (eventsToShow.length === 0) { list.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:20px; color:#999;">å½“å‰æ—¶æ®µæš‚æ— ç‰¹æ®Šæ´»åŠ¨ã€‚</div>`; return; }
            eventsToShow.forEach(ev => { const div = document.createElement('div'); div.className = 'event-card'; const canAfford = this.townMoney >= ev.cost; div.innerHTML = `<div class="event-header"><span class="event-name">${ev.name}</span><span class="event-cost">-${ev.cost}</span></div><div class="event-desc">${ev.desc}</div><button class="event-btn" ${canAfford?'':'disabled'} onclick="triggerTownEvent('${ev.id}')">${canAfford?'ğŸ‰ ç«‹å³ä¸¾åŠ':'ğŸ’¸ èµ„é‡‘ä¸è¶³'}</button>`; list.appendChild(div); });
        }

        triggerTownEvent(id) {
            const ev = TOWN_EVENTS.find(x => x.id === id); if (!ev || this.townMoney < ev.cost) return;
            this.townMoney -= ev.cost; this.log(`[ğŸ‰æ´»åŠ¨] é•‡é•¿æ–¥èµ„ ğŸ’°${ev.cost} ä¸¾åŠäº† **${ev.name}**ï¼`, "tag-event");
            document.getElementById('town-event-modal').classList.remove('active');
            if (id === 'concert') { const fail = Math.random() < 0.1; if (fail) { this.logInteraction(`[ğŸ˜±æ„å¤–] éŸ³å“è®¾å¤‡çˆ†ç‚¸äº†ï¼æ¼”å”±ä¼šæ•ˆæœå¤§æ‰“æŠ˜æ‰£ï¼`, "tag-reject"); this.chars.forEach(c => { c.happiness += 5; }); } else { this.chars.forEach(c => { c.happiness = Math.min(100, c.happiness + 20); }); this.chars.forEach(c1 => { this.chars.forEach(c2 => { if (c1.name !== c2.name && c1.relationships[c2.name]) { c1.relationships[c2.name].love = Math.min(100, c1.relationships[c2.name].love + 5); } }); }); } }
            else if (id === 'matchmaking' || id === 'sakura' || id === 'valentines') { 
                let pairCount = 0; 
                this.chars.forEach(c => { 
                    if (!c.partner) { 
                        let bestT = null; let maxL = -100; 
                        for(let tName in c.relationships) { 
                            const t = this.chars.find(x=>x.name===tName); 
                            if (t && !t.partner && c.relationships[tName].love > maxL) { maxL = c.relationships[tName].love; bestT = t; } 
                        } 
                        // æ¨±èŠ±ç¥­é—¨æ§›è¾ƒä½
                        const threshold = (id === 'sakura' || id === 'valentines') ? 25 : 40;
                        if (bestT && maxL > threshold && Math.random() < 0.5) { 
                            if (bestT.decideProposal(c.name, 'confess') || Math.random() < (id!=='matchmaking'?0.4:0.3)) { 
                                c.partner = bestT.name; bestT.partner = c.name; 
                                c.relationships[bestT.name].status = 'lover'; bestT.relationships[c.name].status = 'lover'; 
                                c.happiness += 20; bestT.happiness += 20; 
                                this.unlockAchievement('first_marriage'); 
                                const action = id === 'sakura' ? 'åœ¨æ¨±èŠ±æ ‘ä¸‹' : (id === 'valentines' ? 'åœ¨æƒ…äººèŠ‚' : 'åœ¨æ´»åŠ¨ä¸­');
                                this.logInteraction(`[â¤ï¸æµªæ¼«] ${action}ï¼Œ**${c.name}** å’Œ **${bestT.name}** äº’è¯‰è¡·è‚ ï¼Œç¡®ç«‹äº†å…³ç³»ï¼`, "tag-love"); 
                                pairCount++; 
                            } 
                        } 
                    } 
                }); 
                if (pairCount > 0) { this.chars.forEach(c => c.happiness += 5); } 
                else { this.logInteraction(`[ğŸ‚å¹³é™] è™½æœ‰ç¾æ™¯è‰¯è¾°ï¼Œä½†ä¼¼ä¹æ²¡äººé…å¯¹æˆåŠŸ...`, "tag-reject"); } 
                if (id === 'sakura') this.chars.forEach(c => c.happiness += 10); 
            }
            else if (id === 'charity' || id === 'charity_day') { 
                let totalRaised = 0; 
                const isSpecialDay = id === 'charity_day';
                this.chars.forEach(c => { 
                    if (c.money > 10) { 
                        // æ…ˆå–„æ—¥ææ¬¾æ›´å¤š
                        const base = isSpecialDay ? 50 : 20;
                        const donation = Math.min(c.money, rand(5, base)); 
                        c.money -= donation; totalRaised += donation; 
                        c.happiness = isSpecialDay ? c.happiness + 5 : c.happiness - 5; // æ…ˆå–„æ—¥å¤§å®¶ä¹äºåŠ©äºº
                        this.chars.forEach(other => { if(other.name!==c.name) { c.relationships[other.name].love += 2; } }); 
                        if (isSpecialDay) c.addLog(`[ğŸ’æ…ˆå–„æ—¥] ææ¬¾ ğŸ’°${donation} å¸®åŠ©ä»–äºº`);
                    } 
                }); 
                this.townMoney += totalRaised; 
                this.logInteraction(`[ğŸ—ï¸å‹Ÿæ] å±…æ°‘ä»¬å…±ææ¬¾ ğŸ’°${totalRaised}ï¼Œ${isSpecialDay?'çˆ±å¿ƒå……æ»¡äº†å°é•‡ï¼':'è™½ç„¶å¿ƒç–¼é’±ä½†å…³ç³»æ›´ç´§å¯†äº†ã€‚'}`, "tag-build"); 
            }
            else if (id === 'anniversary') { this.chars.forEach(c => { c.happiness = Math.min(100, c.happiness + 10); for(let k in c.relationships) c.relationships[k].love += 2; }); }
            else if (id === 'fireworks') { if (Math.random() < 0.05) { const built = this.buildings.filter(b => b.isBuilt); if (built.length > 0) { const burn = choose(built); burn.isBuilt = false; burn.currentProgress = 0; burn.staff.forEach(sName => { const s = this.chars.find(x=>x.name===sName); if(s) { s.job = null; s.happiness -= 30; } }); burn.staff = []; this.log(`[ğŸ”¥ç«ç¾] å¤©å‘ï¼çƒŸèŠ±å¼•ç‡ƒäº† **${burn.name}**ï¼å»ºç­‘è¢«çƒ§æ¯ï¼Œéœ€è¦é‡å»ºï¼`, "tag-crime"); this.chars.forEach(c => c.happiness -= 10); } } else { this.chars.forEach(c => { c.happiness = Math.min(100, c.happiness + 25); for(let k in c.relationships) c.relationships[k].love += 5; }); } }
            else if (id === 'jobfair') { let hiredCount = 0; this.buildings.forEach(b => { if (b.isBuilt && b.staff.length < b.jobs.length) { const needed = b.jobs.length - b.staff.length; for(let i=0; i<needed; i++) { const candidates = this.chars.filter(c => !c.job); if (candidates.length > 0 && Math.random() < 0.5) { const worker = choose(candidates); const role = b.jobs[b.staff.length]; worker.job = { buildingId: b.id, role: role }; b.staff.push(worker.name); worker.happiness += 10; this.logInteraction(`[ğŸ¤å…¥èŒ] **${worker.name}** åœ¨æ‹›è˜ä¼šä¸Šæ‰¾åˆ°äº† **${b.name}** çš„å·¥ä½œï¼`, "tag-build"); hiredCount++; } } } }); if(hiredCount === 0) this.log("æ‹›è˜ä¼šç»“æŸäº†ï¼Œä¼¼ä¹æ²¡æœ‰åˆé€‚çš„å²—ä½æˆ–æ±‚èŒè€…ã€‚", "tag-reject"); }
            else if (id === 'artfest') { this.chars.forEach(c => { c.happiness = Math.min(100, c.happiness + 15); for(let k in c.relationships) c.relationships[k].love += 3; }); if (Math.random() < 0.1) { const victim = choose(this.chars); victim.happiness -= 10; this.logInteraction(`[ğŸ¨å¤±çªƒ] ç³Ÿç³•ï¼**${victim.name}** çè—çš„è‰ºæœ¯å“åœ¨æ´»åŠ¨ä¸­è¢«å·äº†ï¼(å¿ƒæƒ…-10)`, "tag-crime"); } } 
            else if (id === 'marathon') { this.chars.forEach(c => { c.happiness = Math.min(100, c.happiness + 10); c.hunger = Math.max(0, c.hunger - 10); }); if (Math.random() < 0.05) { const injured = choose(this.chars); injured.happiness -= 20; injured.health = Math.max(0, injured.health - 20); this.logInteraction(`[ğŸš‘æ„å¤–] **${injured.name}** åœ¨é©¬æ‹‰æ¾ä¸­ä¸æ…æ‰­ä¼¤äº†è„šï¼(å¿ƒæƒ…-20, å¥åº·-20)`, "tag-reject"); } }
            else if (id === 'reading') { this.chars.forEach(c => { c.happiness = Math.min(100, c.happiness + 5); for(let k in c.relationships) c.relationships[k].love += 2; }); if (Math.random() < 0.2) { const winner = choose(this.chars); winner.happiness = Math.min(100, winner.happiness + 10); this.logInteraction(`[ğŸ§ ç«èµ›] **${winner.name}** èµ¢å¾—äº†è¯»ä¹¦çŸ¥è¯†ç«èµ›çš„å† å†›ï¼å¤§å®¶å‘ä»–è¡¨ç¤ºç¥è´ºã€‚`, "tag-build"); } }
            else if (id === 'planting') { let success = true; if (Math.random() < 0.1) { success = false; this.log(`[ğŸ‚æ¯è] å“å‘€ï¼Œç”±äºå¤©æ°”åŸå› ï¼Œä¸€åŠçš„æ ‘è‹—æ²¡èƒ½å­˜æ´»...æ•ˆæœå‡åŠã€‚`, "tag-reject"); } const happyBonus = success ? 5 : 2; const relBonus = success ? 3 : 1; this.chars.forEach(c => { c.happiness = Math.min(100, c.happiness + happyBonus); for(let k in c.relationships) c.relationships[k].love += relBonus; }); }
            else if (id === 'shopping') {
                const shops = this.buildings.filter(b => b.isBuilt && b.effect === 'shop' && b.sells.length > 0); if (shops.length === 0) { this.log("âš ï¸ é•‡ä¸Šæ²¡æœ‰è¥ä¸šçš„å•†åº—ï¼Œè´­ç‰©èŠ‚å–æ¶ˆäº†ã€‚", "tag-reject"); return; }
                let shopperCount = 0; let totalSpent = 0;
                this.chars.forEach(c => { if (c.money >= 10) { const shop = choose(shops); const affordables = shop.sells.filter(sid => ITEMS_DB[sid] && ITEMS_DB[sid].price <= c.money); if (affordables.length > 0) { const itemId = choose(affordables); const item = ITEMS_DB[itemId]; c.money -= item.price; 
                this.townMoney += item.price; // å…¨é¢çº³å…¥é•‡åº“
                c.bag.push(itemId); c.happiness = Math.min(100, c.happiness + 15); totalSpent += item.price; shopperCount++; c.addLog(`[ğŸ›ï¸è´­ç‰©èŠ‚] åœ¨ ${shop.name} æŠ¢è´­äº† ${item.name}`); } } });
                if (shopperCount > 0) { this.logInteraction(`[ğŸ›ï¸ç‹‚æ¬¢] è´­ç‰©èŠ‚åœ†æ»¡ç»“æŸï¼${shopperCount} ä½å±…æ°‘æŠ¢è´­äº†å•†å“ï¼Œé•‡åº“æ”¶å…¥ ğŸ’°${totalSpent}ã€‚`, "tag-item"); } else { this.logInteraction(`[ğŸŒ¬ï¸å†·æ¸…] è´­ç‰©èŠ‚å¤§å®¶å›Šä¸­ç¾æ¶©ï¼Œæ— äººæ¶ˆè´¹...`, "tag-lonely"); }
            }
            else if (id === 'matsuri') { this.chars.forEach(c => { c.happiness = Math.min(100, c.happiness + 25); }); let pairs = 0; this.chars.forEach(c => { if (!c.partner && Math.random() < 0.2) { const available = this.chars.filter(t => t.name !== c.name && !t.partner && c.relationships[t.name].love > 30); if (available.length > 0) { const t = choose(available); c.partner = t.name; t.partner = c.name; c.relationships[t.name].status = 'lover'; t.relationships[c.name].status = 'lover'; this.unlockAchievement('first_marriage'); this.logInteraction(`[ğŸ‡æµªæ¼«] çƒŸèŠ±ä¸‹ï¼Œ**${c.name}** å’Œ **${t.name}** ç¡®ç«‹äº†å…³ç³»ï¼`, "tag-love"); pairs++; } } }); }
            else if (id === 'snowfest' || id === 'christmas') { this.chars.forEach(c => { c.happiness = Math.min(100, c.happiness + 20); c.health = Math.min(100, c.health + 10); c.hunger = Math.min(100, c.hunger + 10); }); }
            else if (id === 'new_year') { this.chars.forEach(c => { c.happiness = Math.min(100, c.happiness + 20); c.money = Math.floor(c.money * 1.1); }); this.log("æ–°å¹´æ–°æ°”è±¡ï¼Œå¤§å®¶å¿ƒæƒ…å¤§å¥½ï¼Œå­˜æ¬¾ä¼¼ä¹ä¹Ÿå˜å¤šäº†ï¼Ÿ", "tag-promote"); }
            else if (id === 'fools_day') { this.chars.forEach(c => { c.happiness = Math.min(100, c.happiness + 10); }); if(Math.random()<0.5) { const v = choose(this.chars); v.happiness -= 15; this.logInteraction(`[ğŸ¤¡æ¶æ] **${v.name}** è¢«äººè´´äº†â€œæˆ‘æ˜¯ç¬¨è›‹â€çš„çº¸æ¡ï¼Œæ°”å¾—ä¸è¡Œï¼`, "tag-reject"); } }
            else if (id === 'labor_day') { this.chars.forEach(c => { if(c.job) { c.money += 50; c.addLog(`è·å¾—åŠ³åŠ¨èŠ‚å¥–é‡‘ ğŸ’°50`); } else { c.happiness += 5; } }); this.log("åŠ³åŠ¨èŠ‚å¿«ä¹ï¼æ‰€æœ‰åœ¨èŒå‘˜å·¥è·å¾—äº†50å¥–é‡‘ã€‚", "tag-build"); }
            else if (id === 'children_day') { this.chars.forEach(c => { c.happiness = Math.min(100, c.happiness + 15); }); }
            else if (id === 'harvest') { this.chars.forEach(c => { c.hunger = Math.min(100, c.hunger + 30); }); this.log("ä¸°æ”¶èŠ‚å¤§é¤ï¼æ‰€æœ‰äººé¥±é£Ÿåº¦å¤§å¹…æå‡ï¼", "tag-eat"); }
            else if (id === 'halloween') { 
                this.chars.forEach(c => { 
                    c.happiness = Math.min(100, c.happiness + 15); 
                    if(c.bag.length < 5) { c.bag.push('chocolate'); c.addLog("ğŸƒ è·å¾—äº†ä¸‡åœ£èŠ‚ç³–æœ (å·§å…‹åŠ›)"); }
                }); 
                if(Math.random()<0.3) { this.townMoney = Math.max(0, this.townMoney - 100); this.log("ä¸ç»™ç³–å°±æ£è›‹ï¼ä¸€ç¾¤ç†Šå­©å­ä»é•‡åº“æ‹¿èµ°äº†ä¸€äº›ç³–æœé’±...", "tag-crime"); } 
            }
            else if (id === 'music_fest') { this.chars.forEach(c => { c.happiness = Math.min(100, c.happiness + 30); }); this.log("ğŸµ éŸ³ä¹èŠ‚å—¨ç¿»å…¨åœºï¼å¤§å®¶çš„å‹åŠ›éƒ½æ¶ˆå¤±äº†ã€‚", "tag-event"); }
            else if (id === 'cat_return') { 
                this.chars.forEach(c => {
                    const r = Math.random();
                    if(r < 0.33) { c.money += 100; c.addLog("ğŸ± çŒ«ç¥æ˜¾çµï¼Œæ¡åˆ°äº† ğŸ’°100"); }
                    else if(r < 0.66) { c.health = 100; c.happiness = 100; c.addLog("ğŸ± çŒ«ç¥æ˜¾çµï¼Œèº«ä½“æ¢å¤äº†æœ€ä½³çŠ¶æ€ï¼"); }
                    else { c.bag.push('rose'); c.addLog("ğŸ± çŒ«ç¥æ˜¾çµï¼ŒèƒŒåŒ…é‡Œå¤šäº†ä¸€æœµç«ç‘°ï¼"); }
                });
                this.log("ğŸ± çŒ«å’ªæŠ¥æ©æ—¥ï¼Œç¥å¥‡çš„äº‹æƒ…åœ¨å°é•‡å„åœ°å‘ç”Ÿï¼", "tag-promote");
            }
            else if (id === 'new_year_eve') {
                this.chars.forEach(c => { 
                    c.happiness = 100; 
                    for(let k in c.relationships) c.relationships[k].love += 10; 
                });
                this.log("ğŸ† 5..4..3..2..1.. æ–°å¹´å¿«ä¹ï¼æ‰€æœ‰äººæ¬¢èšä¸€å ‚ï¼Œå…³ç³»å¤§å¹…å¢è¿›ï¼", "tag-event");
            }
            
            this.updateUI();
        }
        closeTownEvents() { document.getElementById('town-event-modal').classList.remove('active'); }


        toggleSpeed() { 
            clearInterval(this.loopId); this.speedLevel = (this.speedLevel + 1) % 4; const btn = document.getElementById('speed-btn');
            if (this.speedLevel === 0) { btn.innerText = "â–¶ ç»§ç»­"; btn.style.backgroundColor = "#7f8c8d"; } 
            else { btn.style.backgroundColor = ""; if (this.speedLevel === 1) { this.speed = 1500; btn.innerText = "â¸ æ­£å¸¸"; } else if (this.speedLevel === 2) { this.speed = 750; btn.innerText = "â© 2x"; } else { this.speed = 500; btn.innerText = "â© 3x"; } this.loopId = setInterval(() => this.tick(), this.speed); }
        }
        toggleConstruction(buildId) { const b = this.buildings.find(x => x.id === buildId); if (!b || b.isBuilt) return; b.isUnderConstruction = !b.isUnderConstruction; this.updateUI(); }
        accelerateBuild(buildId) { const b = this.buildings.find(x => x.id === buildId); if (!b || b.isBuilt) return; if (this.townMoney >= 50) { this.townMoney -= 50; b.currentProgress += 20; this.log(`[ğŸ’¸åŠ é€Ÿ] é•‡é•¿æ–¥èµ„åŠ é€Ÿ **${b.name}** å»ºè®¾ã€‚`, "tag-build"); if (b.currentProgress >= b.totalCost) { b.isBuilt = true; this.log(`[ğŸ”¨ç«£å·¥] **${b.name}** å»ºæˆäº†ï¼`, "tag-build"); this.unlockAchievement('first_build'); if(b.id==='gym') this.unlockAchievement('first_gym'); if(b.id==='museum') this.unlockAchievement('culture_hub'); this.distributeConstructionReward(b); this.triggerConstructionVote(); } this.updateUI(); } else { alert("é•‡åº“èµ„é‡‘ä¸è¶³ (éœ€è¦50)ï¼"); } }
        
        upgradeBuilding(bid) { const b = this.buildings.find(x => x.id === bid); if(!b || !b.isBuilt) return; if(b.level >= 3) { alert("å·²è¾¾åˆ°æœ€é«˜ç­‰çº§ï¼"); return; } const cost = Math.floor(b.totalCost * b.level); if(this.townMoney >= cost) { this.townMoney -= cost; b.level++; this.log(`[ğŸ—ï¸å‡çº§] **${b.name}** å‡çº§åˆ°äº† Lv.${b.level}ï¼å‘˜å·¥æ”¶å…¥å°†è·å¾—æå‡ï¼`, "tag-build"); this.showBuildingDetail(bid); this.updateUI(); } else { alert(`èµ„é‡‘ä¸è¶³ï¼Œå‡çº§éœ€è¦ ğŸ’°${cost}`); } }
        
        boostTraining(bid) { const b = this.buildings.find(x => x.id === bid); if(!b || !b.isBuilt) return; const cost = 200; if(this.townMoney >= cost) { this.townMoney -= cost; let trained = 0; b.staff.forEach(sName => { const s = this.chars.find(c => c.name === sName); if(s) { const role = s.job.role; const skillType = getJobSkillType(role); this.improveSkill(s, skillType, 5); trained++; } }); if(trained > 0) { this.log(`[ğŸ“šåŸ¹è®­] æ”¿åºœæ‹¨æ¬¾ ğŸ’°${cost} ä¸º **${b.name}** çš„å‘˜å·¥è¿›è¡Œäº†æŠ€èƒ½åŸ¹è®­ï¼`, "tag-study"); } else { this.log(`[ğŸ“šåŸ¹è®­] è™½ç„¶æ‹¨æ¬¾äº†ï¼Œä½†æ˜¯è¿™é‡Œå¹¶æ²¡æœ‰å‘˜å·¥...`, "tag-reject"); } this.showBuildingDetail(bid); this.updateUI(); } else { alert(`èµ„é‡‘ä¸è¶³ï¼ŒåŸ¹è®­éœ€è¦ ğŸ’°${cost}`); } }

        runElectionsAndHiring() { this.buildings.forEach(b => { if (!b.isBuilt || b.jobs.length === 0) return; if (b.staff.length === 0) { const candidates = this.chars.filter(c => !c.job).sort(() => Math.random() - 0.5); if (candidates.length > 0) { const votes = {}; candidates.forEach(c => votes[c.name] = 0); this.chars.forEach(voter => { let bestC = null; let maxLove = -999; candidates.forEach(c => { let love = (c.name !== voter.name) ? (voter.relationships[c.name]?.love || 0) : 50; love += rand(-20, 20); if (love > maxLove) { maxLove = love; bestC = c; } }); if (bestC) votes[bestC.name]++; }); let winner = candidates[0]; let maxVotes = -1; for (let name in votes) { if (votes[name] > maxVotes) { maxVotes = votes[name]; winner = candidates.find(c => c.name === name); } } if (winner) { const roleName = b.jobs[0]; winner.job = { buildingId: b.id, role: roleName }; b.staff.push(winner.name); this.log(`[ğŸ—³ï¸é€‰ä¸¾] **${winner.name}** å½“é€‰ä¸º **${b.name}** çš„${roleName}ï¼`, "tag-build"); } } } else if (b.staff.length < b.jobs.length) { const managerName = b.staff[0]; const manager = this.chars.find(c => c.name === managerName); if (manager) { const roleName = b.jobs[b.staff.length]; const candidates = this.chars.filter(c => !c.job); let bestC = null; let maxLove = -999; candidates.forEach(c => { const rel = manager.relationships[c.name]; let love = rel ? rel.love : 0; if (love > maxLove) { maxLove = love; bestC = c; } }); if (bestC) { bestC.job = { buildingId: b.id, role: roleName }; b.staff.push(bestC.name); this.log(`[ğŸ¤æ‹›è˜] ${b.name}ç»ç† **${manager.name}** å½•ç”¨äº† **${bestC.name}** æ‹…ä»» ${roleName}ã€‚`); } } } if (b.id === 'footshop' && b.isBuilt && b.staff.length > 0) { const bossName = b.staff[0]; const boss = this.chars.find(c => c.name === bossName); if (boss && b.prostitutes.length < 3) { const candidates = this.chars.filter(c => !c.job && !c.prostitute && c.hasTrait('promiscuous')); if (candidates.length > 0 && Math.random() < 0.1) { const target = choose(candidates); target.prostitute = { buildingId: b.id }; b.prostitutes.push(target.name); this.logInteraction(`[ğŸ’‹æ‹‰çš®æ¡] **${boss.name}** è¯´æœäº† **${target.name}** åœ¨æ´—è„šåº—å–é“¶...`, "tag-drama"); } } } }); }
        
        doRobbery(p, target = null) { 
            p.consecutiveWork = 0;
            let victim = target; if (!victim) { const targets = this.chars.filter(c => c.name !== p.name && c.money > 20); if (targets.length === 0) return false; victim = choose(targets); }
            this.unlockAchievement('first_crime');
            const policeStation = this.buildings.find(b => b.id === 'police'); const hasPolice = policeStation && policeStation.isBuilt && policeStation.staff.length > 0; let securityLevel = hasPolice ? policeStation.staff.length * 0.3 : 0; let successChance = 0.5; if (p.ideology.name === 'å†›å›½ä¸»ä¹‰') successChance += 0.2; successChance -= securityLevel; 
            const timeStr = this.getDateTimeStr();
            if (Math.random() < successChance) { const stolen = Math.floor(victim.money * rand(0.3, 0.6)); victim.money -= stolen; p.money += stolen; victim.happiness -= 30; victim.health = Math.max(0, victim.health - 10); const pRel = p.relationships[victim.name]; const vRel = victim.relationships[p.name]; if (['lover', 'spouse', 'mistress'].includes(pRel.status)) { pRel.status = "ex"; vRel.status = "ex"; } else { pRel.status = "enemy"; vRel.status = "enemy"; } pRel.love = -50; vRel.love = -50; p.stat_rob = (p.stat_rob || 0) + 1; victim.stat_be_robbed = (victim.stat_be_robbed || 0) + 1; this.logInteraction(`[ğŸ”ªæŠ¢åŠ«] å¤©å‘ï¼**${p.name}** æŠ¢åŠ«äº† **${victim.name}**ï¼ŒæŠ¢èµ° ğŸ’°${stolen}ï¼ä¸¤äººåç›®æˆä»‡ï¼`, "tag-crime"); p.currentAction = `[çŠ¯ç½ª] æŠ¢åŠ«äº† ${victim.name}`; p.addLog(`${timeStr} æŠ¢åŠ«äº† ${victim.name} ğŸ’°${stolen}`); victim.addLog(`${timeStr} è¢« ${p.name} æŠ¢åŠ«äº† ğŸ’°${stolen} (å¥åº·-10)`); if(policeStation) policeStation.addLog(`${timeStr} æ¥åˆ°æŠ¥æ¡ˆï¼š${p.name} æŠ¢åŠ«äº† ${victim.name}`); return true; 
            } else { if (hasPolice) { const fine = 100; p.happiness -= 30; p.money -= fine; this.townMoney += fine; p.jailTerm = 1440; this.logInteraction(`[ğŸ‘®é€®æ•] **${p.name}** æŠ¢åŠ« **${victim.name}** å¤±è´¥ï¼è¢«è­¦å¯Ÿé€®æ•ï¼ç½šæ¬¾ğŸ’°${fine}å¹¶åˆ¤å¤„ç›‘ç¦24å°æ—¶ï¼`, "tag-build"); const copName = choose(policeStation.staff); const cop = this.chars.find(c => c.name === copName); if (cop) { cop.money += 20; this.log(`[ğŸš“æ²»å®‰] è­¦å®˜ **${cop.name}** å› åˆ¶æ­¢çŠ¯ç½ªè·å¾—å¥–é‡‘ ğŸ’°20ã€‚`, "tag-build"); } p.currentAction = `[è¢«æ•] æŠ¢åŠ«å¤±è´¥ï¼Œé”’é“›å…¥ç‹±`; p.addLog(`${timeStr} æŠ¢åŠ« ${victim.name} å¤±è´¥ï¼Œè¢«æ•å…¥ç‹±`); if(policeStation) policeStation.addLog(`${timeStr} è­¦å¯Ÿé€®æ•äº†æŠ¢åŠ«çŠ¯ ${p.name}`); } else { p.happiness -= 10; this.logInteraction(`[ğŸ’¨å¤±è´¥] **${p.name}** è¯•å›¾æŠ¢åŠ« **${victim.name}**ï¼Œä½†è¢«å¯¹æ–¹ä¸€è„šè¸¹é£äº†ï¼`, "tag-reject"); p.currentAction = `[å¤±è´¥] æŠ¢åŠ«æœªé‚ï¼Œè½è’è€Œé€ƒ`; p.addLog(`${timeStr} è¯•å›¾æŠ¢åŠ« ${victim.name} ä½†è¢«æ‰“é£`); } return true; } 
        }
        
        doWork(p, b) { 
            const role = p.job.role; p.money += p.calculateWage(getBaseJobWage(role), role); p.happiness -= 1; p.hunger -= 3; p.consecutiveWork = (p.consecutiveWork || 0) + 1;
            if (p.consecutiveWork >= 12) this.unlockAchievement('workaholic');
            const skillType = getJobSkillType(role); this.improveSkill(p, skillType, 0.2);
            const skillVal = p.skills[skillType] || 0; const title = getLevelInfo(skillVal).title;
            p.currentAction = `[æ‰“å·¥] åœ¨ ${b.name} å½“${title}${role}`; const timeStr = this.getDateTimeStr(); p.addLog(`${timeStr} åœ¨ ${b.name} å·¥ä½œ (${title})`); b.addLog(`${timeStr} å‘˜å·¥ ${p.name} åœ¨æ­¤å·¥ä½œ`);
        }
        
        doOddJob(p) { 
            const job = choose(ODD_JOBS); 
            if (job.name === "èººå¹³" && p.money < 3) { p.money += 4; p.happiness -= 3; p.hunger -= 4; p.currentAction = `[é›¶å·¥] æ²¡é’±èººå¹³ï¼Œè¢«è¿«æ¬ç –`; p.addLog(`${this.getDateTimeStr()} è¢«è¿«å»å·¥åœ°æ¬ç –`); this.improveSkill(p, 'strength', 0.1); p.consecutiveWork = 0; return; } 
            let wage = job.wage > 0 ? p.calculateWage(job.wage) : job.wage; p.money += wage; p.happiness += job.mood; p.happiness = Math.min(100, Math.max(0, p.happiness)); p.hunger -= (job.name === "èººå¹³" ? 1 : 4); 
            if (job.name === "èººå¹³") { p.consecutiveWork = 0; p.currentAction = `[ç”Ÿæ´»] åœ¨å®¶ èººå¹³`; } else { p.consecutiveWork = (p.consecutiveWork || 0) + 1; if (p.consecutiveWork >= 12) this.unlockAchievement('workaholic'); p.currentAction = `[é›¶å·¥] æ­£åœ¨ ${job.name}`; }
            p.addLog(`${this.getDateTimeStr()} æ­£åœ¨åšé›¶å·¥: ${job.name}`);
            if(job.name === 'å‘ä¼ å•' || job.name === 'å¤–å–å‘˜') this.improveSkill(p, 'social', 0.1); else if(job.name !== 'èººå¹³') this.improveSkill(p, 'strength', 0.1);
        }
        
        doEat(p, r) { 
            p.consecutiveWork = 0; const timeStr = this.getDateTimeStr();
            if (p.money >= r.price) { p.money -= r.price; p.hunger = Math.min(100, p.hunger + r.food); p.happiness = Math.min(100, p.happiness + 5); this.townMoney += r.price; p.currentAction = `[åƒé¥­] åœ¨ ${r.name} åƒå¾—é¥±é¥±`; p.lastMealTime = this.gameTime; p.addLog(`${timeStr} åœ¨ ${r.name} åƒé¥­`); r.addLog(`${timeStr} é¡¾å®¢ ${p.name} åœ¨æ­¤ç”¨é¤`); } else { p.currentAction = `[åƒé¥­] æ²¡é’±å» ${r.name}ï¼Œè·¯è¾¹å•ƒé¦’å¤´`; p.hunger += 10; p.lastMealTime = this.gameTime; p.addLog(`${timeStr} æ²¡é’±åƒé¥­ï¼Œè·¯è¾¹å•ƒé¦’å¤´`); } 
        }
        
        doProstitution(p, s) { 
            p.consecutiveWork = 0; const w = p.calculateWage(rand(15, 25), "æŠ€å¸ˆ"); const ps = Math.floor(w * 0.7); const bs = w - ps; p.money += ps; p.happiness -= 2; p.hunger -= 4; if (s.staff.length > 0) { const boss = this.chars.find(c => c.name === s.staff[0]); if (boss) boss.money += bs; } p.currentAction = `[ğŸ’‹å–é“¶] åœ¨ ${s.name} æ¥å®¢`; const timeStr = this.getDateTimeStr(); p.addLog(`${timeStr} åœ¨ ${s.name} æ¥å®¢`); s.addLog(`${timeStr} ${p.name} åœ¨æ­¤æä¾›æœåŠ¡`); this.improveSkill(p, 'craft', 0.2); 
        }
        
        doStreetwalking(p) { p.consecutiveWork = 0; p.money += p.calculateWage(rand(8, 15)); p.happiness -= 4; p.hunger -= 5; p.stat_streetwalk = (p.stat_streetwalk || 0) + 1; p.currentAction = `[ğŸ’‹ç«™è¡—] åœ¨è·¯è¾¹æ‹‰å®¢`; p.addLog(`${this.getDateTimeStr()} åœ¨è·¯è¾¹æ‹‰å®¢`); this.improveSkill(p, 'social', 0.1); }
        
        doBuild(p, b) { 
            p.consecutiveWork = 0; b.currentProgress += rand(5, 15); p.money += 5; p.happiness -= 2; p.hunger -= 5; p.currentAction = `å»ºè®¾: ${b.name}`; if (!p.constructionContribution[b.id]) p.constructionContribution[b.id] = 0; p.constructionContribution[b.id] += 10; const timeStr = this.getDateTimeStr(); p.addLog(`${timeStr} å‚ä¸å»ºè®¾ ${b.name}`); b.addLog(`${timeStr} ${p.name} å‚ä¸äº†å»ºè®¾`);
            if (b.currentProgress >= b.totalCost && !b.isBuilt) { b.isBuilt = true; this.log(`[ğŸ”¨ç«£å·¥] **${b.name}** å»ºæˆäº†ï¼`, "tag-build"); this.unlockAchievement('first_build'); if(b.id==='gym') this.unlockAchievement('first_gym'); if(b.id==='museum') this.unlockAchievement('culture_hub'); this.distributeConstructionReward(b); this.triggerConstructionVote(); } 
            this.improveSkill(p, 'craft', 0.3); this.improveSkill(p, 'strength', 0.1);
        }
        
        doRest(p, v) { 
            p.consecutiveWork = 0; const timeStr = this.getDateTimeStr();
            if (v && v.price > 0) { 
                if (p.money >= v.price * (p.hasTrait('money-loving')?2:1)) { 
                    p.money -= v.price; this.townMoney += v.price; 
                    if (v.effect === 'food') { p.hunger = Math.min(100, p.hunger + v.food); p.lastMealTime = this.gameTime; p.currentAction = `åœ¨ ${v.name} å¤§åƒä¸€é¡¿`; }
                    else if (v.effect === 'health' || v.effect === 'tourist_health') { p.health = Math.min(100, p.health + 40); p.happiness = Math.min(100, p.happiness + 5); p.currentAction = `[æ²»ç–—] åœ¨ ${v.name} çœ‹ç—…ç–—ä¼¤`; } 
                    else if (v.effect === 'beauty') { p.health = Math.min(100, p.health + 5); p.appearance = Math.min(100, p.appearance + 2); p.happiness = Math.min(100, p.happiness + 10); p.currentAction = `[å¥èº«] åœ¨ ${v.name} æ’¸é“å¡‘å½¢`; this.improveSkill(p, 'strength', 0.2); }
                    else if (v.effect === 'fun_high' || v.effect === 'tourist_high') { p.happiness = Math.min(100, p.happiness + 30); p.currentAction = `[æ¸¸ç©] åœ¨ ${v.name} å°½æƒ…å°–å«`; }
                    else if (v.effect === 'study') { p.happiness = Math.min(100, p.happiness + 5); p.currentAction = `[å‚è§‚] åœ¨ ${v.name} å¢é•¿è§é—»`; this.improveSkill(p, 'intel', 0.5); }
                    else if (v.effect === 'tourist') { p.happiness = Math.min(100, p.happiness + 10); p.currentAction = `[æ‰“å¡] åœ¨ ${v.name} æ‹ç…§ç•™å¿µ`; }
                    else p.currentAction = `åœ¨ ${v.name} æ”¾æ¾`; 
                    p.addLog(`${timeStr} åœ¨ ${v.name} æ¶ˆè´¹ä¼‘æ¯`); v.addLog(`${timeStr} é¡¾å®¢ ${p.name} åœ¨æ­¤æ¶ˆè´¹`);
                } else { p.currentAction = `åœ¨ è·¯è¾¹ é—²é€›`; p.addLog(`${timeStr} åœ¨è·¯è¾¹é—²é€›`); return; } 
            } else {
                if (v) { if (v.effect === 'study') { p.happiness = Math.min(100, p.happiness + 8); p.currentAction = `[å­¦ä¹ ] åœ¨ ${v.name} æ±²å–çŸ¥è¯†`; this.improveSkill(p, 'intel', 0.5); } else { p.currentAction = `åœ¨ ${v.name} æ”¾æ¾`; } p.addLog(`${timeStr} åœ¨ ${v.name} ä¼‘æ¯`); v.addLog(`${timeStr} ${p.name} æ¥è®¿`); } else { p.currentAction = `åœ¨ è·¯è¾¹ é—²é€›`; p.addLog(`${timeStr} åœ¨è·¯è¾¹é—²é€›`); }
            }
            p.happiness = Math.min(100, p.happiness + rand(5, 10)); p.hunger -= 1; 
        }

        doShopping(p, shop, intention = null) {
            p.consecutiveWork = 0; const timeStr = this.getDateTimeStr();
            if (shop.sells.length > 0 && p.money >= 5) { 
                let affordableItems = shop.sells.filter(id => ITEMS_DB[id] && p.money >= ITEMS_DB[id].price);
                if (intention) { const intendedItems = affordableItems.filter(id => { const item = ITEMS_DB[id]; if (intention === 'food') return item.type === 'food' || item.type === 'snack'; if (intention === 'medicine') return item.type === 'medicine'; if (intention === 'gift') return item.type === 'gift'; return true; }); if (intendedItems.length > 0) affordableItems = intendedItems; }
                if (affordableItems.length > 0) { const itemId = choose(affordableItems); const itemInfo = ITEMS_DB[itemId]; p.money -= itemInfo.price; this.townMoney += itemInfo.price; p.bag.push(itemId); p.happiness += 5; p.currentAction = `[è´­ç‰©] åœ¨ ${shop.name} ä¹°äº† ${itemInfo.name}`; shop.addLog(`${timeStr} é¡¾å®¢ ${p.name} è´­ä¹°äº† ${itemInfo.name}`); if ((intention === 'food' || itemInfo.type === 'food') && p.hunger < 80) { this.doUseItem(p, itemId); } else { p.addLog(`${timeStr} åœ¨ ${shop.name} ä¹°äº† ${itemInfo.name}`); } } else { this.doRest(p, shop); }
            } else { this.doRest(p, shop); }
        }

        doUseItem(p, itemId) {
            const item = ITEMS_DB[itemId]; if (!item) return; const idx = p.bag.indexOf(itemId); if (idx === -1) return; p.bag.splice(idx, 1);
            if (item.hungerBonus) { p.hunger = Math.min(100, p.hunger + item.hungerBonus); if(item.hungerBonus > 5) p.lastMealTime = this.gameTime; }
            if (item.happinessBonus) p.happiness = Math.min(100, p.happiness + item.happinessBonus); if (item.healthBonus) p.health = Math.min(100, p.health + item.healthBonus); 
            let actionVerb = "ä½¿ç”¨"; if (item.type === 'food' || item.type === 'snack') actionVerb = "åƒ"; if (item.type === 'drink' || item.type === 'alcohol') actionVerb = "å–"; if (item.type === 'medicine') actionVerb = "æœç”¨";
            p.currentAction = `[${actionVerb}] ç”¨äº† ${item.name}`; p.addLog(`${this.getDateTimeStr()} ${actionVerb}äº† ${item.name}`);
        }

        tryGift(p, t, venue) {
            const giftIndex = p.bag.findIndex(id => ITEMS_DB[id] && ITEMS_DB[id].type === 'gift');
            if (giftIndex !== -1) {
                const giftId = p.bag[giftIndex]; const gift = ITEMS_DB[giftId]; p.bag.splice(giftIndex, 1); const pRel = p.relationships[t.name]; const tRel = t.relationships[p.name]; const bonus = gift.loveBonus || 10; pRel.love = Math.min(100, pRel.love + bonus); tRel.love = Math.min(100, tRel.love + bonus); p.currentAction = `[ğŸé€ç¤¼] é€äº† ${t.name} ${gift.name}`; t.currentAction = `[ğŸæ”¶ç¤¼] æ”¶åˆ°äº† ${p.name} çš„ç¤¼ç‰©`; this.logInteraction(`[ğŸé€ç¤¼] **${p.name}** åœ¨ ${venue.name} é€ç»™äº† **${t.name}** ä¸€ä¸ª ${gift.name}ï¼Œæ„Ÿæƒ…å‡æ¸©äº†ï¼`, "tag-item");
                const timeStr = this.getDateTimeStr(); p.addLog(`${timeStr} é€ç»™ ${t.name} ä¸€ä¸ª ${gift.name}`); t.addLog(`${timeStr} æ”¶åˆ°äº† ${p.name} çš„ ${gift.name}`); if(venue.addLog) venue.addLog(`${timeStr} ${p.name} åœ¨æ­¤é€ç¤¼ç»™ ${t.name}`);
                this.updateRelationshipStatus(p, t, pRel, tRel); this.checkRomanceEvent(p, t, pRel, tRel, venue); return true;
            }
            return false;
        }
        
        doSocial(p, v) { 
            p.consecutiveWork = 0; const timeStr = this.getDateTimeStr();
            if (v.price > 0) { if (p.money < v.price) { this.doRest(p, {name:"è·¯è¾¹",price:0}); return; } p.money -= v.price; this.townMoney += v.price; } 
            const t = choose(this.chars.filter(c => c.name !== p.name)); const pRel = p.relationships[t.name]; const tRel = t.relationships[p.name]; this.breakInteraction(t); 
            if (this.tryGift(p, t, v)) return;
            p.currentAction = `å’Œ ${t.name} åœ¨ ${v.name}`; t.currentAction = `å’Œ ${p.name} åœ¨ ${v.name}`; p.interactingWith = t.name; t.interactingWith = p.name; p.hunger -= 2; t.hunger -= 2; this.improveSkill(p, 'social', 0.1);
            if (this.checkRomanceEvent(p, t, pRel, tRel, v)) return; 
            
            // --- Fix Start: Include Mayor Chaos Influence ---
            let chaos = p.personality.chaosBonus + t.personality.chaosBonus + p.ideology.chaosMod + t.ideology.chaosMod; 
            if (this.mayor) {
                const m = this.chars.find(c => c.name === this.mayor);
                if (m && m.ideology) chaos += (m.ideology.chaosMod || 0);
            }
            // --- Fix End ---

            if (v.effect === 'chaos') chaos += 0.2; if (v.effect === 'ntr') chaos += 0.4; 
            if (Math.random() < Math.max(0, Math.min(1, 0.1 + chaos))) { 
                pRel.love -= 5; tRel.love -= 5; this.improveSkill(p, 'social', 0.25); this.improveSkill(p, 'intel', 0.25); this.improveSkill(t, 'social', 0.25); this.improveSkill(t, 'intel', 0.25);
                this.logInteraction(`[ğŸ’¢äº‰åµ] ${p.name} å’Œ ${t.name} åœ¨ ${v.name} åµæ¶äº†ã€‚`, "tag-reject"); p.addLog(`${timeStr} å’Œ ${t.name} åµæ¶`); t.addLog(`${timeStr} å’Œ ${p.name} åµæ¶`);
            } else { 
                const scenario = choose(SOCIAL_SCENARIOS); const text = scenario.text.replace("{A}", p.name).replace("{B}", t.name); this.logInteraction(`[ğŸ’¬äº’åŠ¨] ${text}`, "tag-gossip"); if(scenario.effect) scenario.effect(p, t);
                let boost = rand(1, 3); if (v.effect === 'romance') boost += 2; boost += p.personality.loveGain + t.personality.loveGain + p.ideology.loveMod + t.ideology.loveMod; boost = Math.max(0, Math.round(boost)); pRel.love = Math.min(100, pRel.love + boost); tRel.love = Math.min(100, tRel.love + boost); p.addLog(`${timeStr} å’Œ ${t.name} äº’åŠ¨ (${boost}å¥½æ„Ÿ)`); t.addLog(`${timeStr} å’Œ ${p.name} äº’åŠ¨ (${boost}å¥½æ„Ÿ)`); this.updateRelationshipStatus(p, t, pRel, tRel); 
            } 
            if(v.addLog) v.addLog(`${timeStr} ${p.name} ä¸ ${t.name} æ¥è®¿`);
        }

        distributeConstructionReward(b) { let total = 0; this.chars.forEach(c => total += (c.constructionContribution[b.id] || 0)); if (total === 0) return; const reward = Math.floor(b.totalCost * 0.3); this.chars.forEach(c => { const share = c.constructionContribution[b.id] || 0; if (share > 0) { const m = Math.floor(reward * (share / total)); c.money += m; if(m>0) this.log(`[ğŸ’°å¥–åŠ±] **${c.name}** è·å»ºè®¾å¥–åŠ± ğŸ’°${m}`, "tag-build"); } }); }
        updateRelationshipStatus(p, t, pRel, tRel) { if (pRel.status === 'stranger' && pRel.love > 10) { pRel.status = 'friend'; tRel.status = 'friend'; } else if (pRel.status === 'friend' && pRel.love > 60 && !['lover','spouse','mistress','enemy','ex'].includes(pRel.status)) { pRel.status = 'bestfriend'; tRel.status = 'bestfriend'; } }
        checkRomanceEvent(p, t, pRel, tRel, v) { if (!p.partner && !t.partner && pRel.love > 70 && pRel.status !== 'spouse') { if (Math.random() < 0.2) { if (t.decideProposal(p.name, 'confess')) { p.partner = t.name; t.partner = p.name; pRel.status = "lover"; tRel.status = "lover"; p.happiness += 20; t.happiness += 20; this.unlockAchievement('first_marriage'); this.logInteraction(`[â¤ï¸è¡¨ç™½] ${p.name} å‘ ${t.name} è¡¨ç™½æˆåŠŸï¼`, "tag-love"); } else { p.happiness -= 20; pRel.love -= 10; this.logInteraction(`[ğŸ’”æ‹’ç»] ${p.name} è¡¨ç™½å¤±è´¥...`, "tag-reject"); } return true; } } return false; }
        breakInteraction(c) { if (c.interactingWith) { const partner = this.chars.find(x => x.name === c.interactingWith); if (partner) { partner.interactingWith = null; partner.currentAction = "å‘å‘†"; } c.interactingWith = null; } }
        saveData(isAuto = false) { const data = { chars: this.chars, buildings: this.buildings, townMoney: this.townMoney, gameTime: this.gameTime, gameDay: this.gameDay, dateMonth: this.dateMonth, dateDay: this.dateDay, weather: this.weather, achievements: this.achievements, policySocialSecurity: this.policySocialSecurity, policyHousing: this.policyHousing, policyFood: this.policyFood, mayor: this.mayor, ts: Date.now() }; localStorage.setItem('happyTownV2_Save', JSON.stringify(data)); this.lastSaveTime = Date.now(); if (!isAuto) alert("âœ… å­˜æ¡£æˆåŠŸï¼"); }
        
        loadFromJSON(jsonStr) { 
            try { 
                const data = JSON.parse(jsonStr); 
                this.townMoney = data.townMoney || 0; 
                this.gameTime = data.gameTime || 480; 
                this.gameDay = data.gameDay !== undefined ? data.gameDay : 1;
                this.dateMonth = data.dateMonth || 1;
                this.dateDay = data.dateDay || 1;
                this.weather = data.weather || 'Sunny';
                this.achievements = data.achievements || [];
                this.policySocialSecurity = data.policySocialSecurity || false;
                this.policyHousing = data.policyHousing || false;
                this.policyFood = data.policyFood || false;
                this.mayor = data.mayor || null;

                this.buildings = data.buildings.map(bData => { 
                    const bp = BUILDINGS_BLUEPRINT.find(x => x.id === bData.id); 
                    let b = bp ? new Building(bp) : new Building(bData); 
                    if (bData.currentProgress !== undefined) b.currentProgress = bData.currentProgress; 
                    if (bData.isBuilt !== undefined) b.isBuilt = bData.isBuilt; 
                    if (bData.staff !== undefined) b.staff = bData.staff; if (!b.staff) b.staff = []; 
                    if (bData.prostitutes !== undefined) b.prostitutes = bData.prostitutes; if (!b.prostitutes) b.prostitutes = []; 
                    if(bData.history) b.history = bData.history; 
                    b.level = bData.level || 1; b.isUnderConstruction = bData.isUnderConstruction || false;
                    return b; 
                }); 
                this.chars = data.chars.map(cData => { 
                    // --- Fix Start: Re-bind Ideology ---
                    if (cData.ideology && cData.ideology.name) {
                        const canonical = IDEOLOGIES.find(i => i.name === cData.ideology.name);
                        cData.ideology = canonical || cData.ideology;
                    }
                    // --- Fix End ---
                    let c = new Character(cData.name); 
                    Object.assign(c, cData); 
                    if (c.money === undefined) c.money = 0; 
                    if (!c.personality) c.personality = choose(PERSONALITIES); 
                    if (!c.ideology) c.ideology = choose(IDEOLOGIES); 
                    if (!c.gender) c.gender = Math.random() > 0.5 ? 'â™‚ ç”·' : 'â™€ å¥³'; 
                    if (c.hunger === undefined) c.hunger = 80; 
                    if (c.health === undefined) c.health = 100;
                    if (c.nextActionOverride === undefined) c.nextActionOverride = null; 
                    if(!c.bag) c.bag = []; if(!c.history) c.history = []; 
                    if (c.jailTerm === undefined) c.jailTerm = 0;
                    if (c.lastMealTime === undefined) c.lastMealTime = -999;
                    if (c.consecutiveWork === undefined) c.consecutiveWork = 0;
                    if (c.stat_rob === undefined) c.stat_rob = 0;
                    if (c.stat_be_robbed === undefined) c.stat_be_robbed = 0;
                    if (c.stat_streetwalk === undefined) c.stat_streetwalk = 0;
                    if (c.stat_assault === undefined) c.stat_assault = 0;
                    if (c.stat_be_assaulted === undefined) c.stat_be_assaulted = 0;
                    if (!c.skills) c.skills = { social: rand(5, 15), craft: rand(5, 15), intel: rand(5, 15), strength: rand(5, 15) };
                    if (c.dailySleepOffset === undefined) c.dailySleepOffset = rand(-2, 4);
                    if (c.stayUpLate === undefined) c.stayUpLate = false;

                    if (!c.traits || c.traits.length === 0) { c.traits = []; const traitCount = rand(0, 2); for (let i = 0; i < traitCount; i++) { const availableTraits = TRAITS.filter(t => !c.traits.find(tt => tt.id === t.id)); if (availableTraits.length > 0) c.traits.push(choose(availableTraits)); } } 
                    if (!c.constructionContribution) c.constructionContribution = {}; 
                    if (c.prostitute === undefined) c.prostitute = null; 
                    if(c.appearance === undefined) c.appearance = rand(40, 80); 
                    for (let name in c.relationships) { const rel = c.relationships[name]; if (!rel.status || !['stranger', 'friend', 'bestfriend', 'lover', 'spouse', 'mistress', 'ex','enemy'].includes(rel.status)) { rel.status = rel.love > 10 ? 'friend' : 'stranger'; } if (rel.intimacyCount === undefined) rel.intimacyCount = 0; } 
                    return c; 
                }); 
                this.runElectionsAndHiring(); 
            } catch(e) { console.error("å­˜æ¡£æŸå", e); this.initNewGame(); } 
        }

        log(msg, type = "") { const el = document.getElementById('game-log'); const div = document.createElement('div'); div.className = `log-entry ${type}`; div.innerHTML = `<span class="log-time">[${new Date().toLocaleTimeString()}]</span> ${msg}`; el.prepend(div); if (el.children.length > 60) el.lastChild.remove(); }
        logInteraction(msg, type = "") { const el = document.getElementById('interaction-log'); const div = document.createElement('div'); div.className = `log-entry ${type}`; div.innerHTML = `<span class="log-time">[${new Date().toLocaleTimeString()}]</span> ${msg}`; el.prepend(div); if (el.children.length > 40) el.lastChild.remove(); }

        addNewResident(name) {
            if (this.chars.some(c => c.name === name)) { alert(`å±…æ°‘ "${name}" å·²ç»ä½åœ¨å°é•‡é‡Œäº†ï¼`); return; }
            const newChar = new Character(name);
            this.chars.forEach(existingChar => { newChar.relationships[existingChar.name] = { love: 0, status: 'stranger' }; existingChar.relationships[newChar.name] = { love: 0, status: 'stranger' }; });
            this.chars.push(newChar); newChar.money = 50; this.log(`[ğŸšå…¥ä½] æ¬¢è¿æ–°å±…æ°‘ **${name}** æ¬å…¥çŒ«ã®æ¨¡æ‹Ÿå°é•‡ï¼å¤§å®¶çƒ­çƒˆæ¬¢è¿ï¼`, "tag-event"); newChar.addLog(`[${this.getDateTimeStr()}] åˆšåˆšæ¬è¿›çŒ«ã®æ¨¡æ‹Ÿå°é•‡`);
            this.updateUI(); setTimeout(() => { const charList = document.getElementById('char-list'); if(charList) charList.scrollTop = charList.scrollHeight; }, 100);
        }

        renderUIStatic() { 
            const bList = document.getElementById('build-list'); bList.innerHTML = ''; 
            const categories = ['food', 'fun', 'service', 'shop', 'landmark'];
            categories.forEach(cat => {
                const catHeader = document.createElement('div'); catHeader.className = 'category-header'; catHeader.innerText = CATEGORY_NAMES[cat] || cat; bList.appendChild(catHeader);
                this.buildings.filter(b => b.category === cat).forEach(b => { 
                    const div = document.createElement('div'); div.className = 'build-card'; div.id = `build-${b.id}`; div.onclick = (e) => { if(e.target.tagName !== 'BUTTON') gameInstance.showBuildingDetail(b.id); };
                    let btnHtml = ''; 
                    if (!b.isBuilt) { if (b.isUnderConstruction) { btnHtml = `<button class="btn accelerate" onclick="gameInstance.accelerateBuild('${b.id}')">ğŸ’¸ èµ„é‡‘åŠ é€Ÿ (50)</button><button class="btn stop-build" onclick="gameInstance.toggleConstruction('${b.id}')">â¹ æš‚åœæ–½å·¥</button>`; } else { btnHtml = `<button class="btn start-build" disabled title="è¯·ç­‰å¾…é•‡é•¿å‘èµ·æŠ•ç¥¨">ğŸ—³ï¸ å¾…æŠ•ç¥¨å¯åŠ¨</button>`; } }
                    div.innerHTML = `<div><div style="font-weight:bold; font-size:1.05rem">${b.name}</div><div style="font-size:0.8rem; color:#666">${b.desc}</div></div><div><div class="bar-container"><div class="bar-fill" style="background:#00b894; width:0%"></div></div><div class="build-prog">æœªå»ºæˆ</div>${btnHtml}</div>`; bList.appendChild(div); 
                });
            });
        }
        
        showEmbezzle() { document.getElementById('embezzle-town-money').innerText = this.townMoney; const list = document.getElementById('embezzle-list'); list.innerHTML = ''; this.chars.forEach(c => { const div = document.createElement('div'); div.className = 'fund-item'; div.innerHTML = `${c.name} <small>(ğŸ’°${c.money})</small>`; div.onclick = () => { document.querySelectorAll('.fund-item').forEach(el=>el.classList.remove('selected')); div.classList.add('selected'); window.selectedFundTarget = c.name; }; list.appendChild(div); }); document.getElementById('embezzle-modal').classList.add('active'); }
        doEmbezzle() { const name = window.selectedFundTarget; const amt = parseInt(document.getElementById('embezzle-amount').value); if (!name || isNaN(amt) || amt <= 0) return alert("è¯·é€‰æ‹©å±…æ°‘å¹¶è¾“å…¥æœ‰æ•ˆé‡‘é¢"); if (this.townMoney < amt) return alert("é•‡åº“èµ„é‡‘ä¸è¶³ï¼"); const c = this.chars.find(x => x.name === name); if (c) { c.money += amt; this.townMoney -= amt; this.log(`[ğŸ’¸æ‹¨æ¬¾] é•‡é•¿å‘ **${c.name}** æ‹¨æ¬¾ ğŸ’°${amt}ã€‚`, "tag-build"); this.updateUI(); this.closeEmbezzle(); } }
        closeEmbezzle() { document.getElementById('embezzle-modal').classList.remove('active'); }
        
        showJobBoard() {
            const list = document.getElementById('jobboard-list'); list.innerHTML = '';
            const oddHeader = document.createElement('div'); oddHeader.className = 'job-section-header'; oddHeader.style.borderLeftColor = '#3498db'; oddHeader.innerText = "ğŸ›  ä¸´æ—¶é›¶å·¥ / è‡ªç”±èŒä¸š"; list.appendChild(oddHeader);
            ODD_JOBS.forEach(job => { const item = document.createElement('div'); item.className = 'job-item'; item.innerHTML = `<div><div class="job-name">${job.name}</div><div class="job-loc" style="font-size:0.8em; color:gray;">Mood: ${job.mood}</div></div><div class="job-wage" style="color:${job.wage<0?'#e74c3c':'#27ae60'}">ğŸ’° ${job.wage}</div>`; list.appendChild(item); });
            const hookerItem = document.createElement('div'); hookerItem.className = 'job-item'; hookerItem.innerHTML = `<div><div class="job-name">ğŸ’‹ ç«™è¡—</div></div><div class="job-wage">ğŸ’° 8-15</div>`; list.appendChild(hookerItem);
            const formalHeader = document.createElement('div'); formalHeader.className = 'job-section-header'; formalHeader.style.borderLeftColor = '#f1c40f'; formalHeader.innerText = "ğŸ¢ ä¼ä¸š / æœºæ„å²—ä½"; list.appendChild(formalHeader);
            this.buildings.forEach(b => { if (b.jobs.length > 0) { b.jobs.forEach(role => { const item = document.createElement('div'); item.className = 'job-item'; item.innerHTML = `<div><div class="job-name">ğŸ‘” ${role}</div><div class="job-loc">${b.name} <span class="lvl-badge">Lv.${b.level}</span></div></div><div class="job-wage">ğŸ’° ${getJobWage(role)}</div>`; list.appendChild(item); }); } });
            document.getElementById('jobboard-modal').classList.add('active');
        }
        
        showAchievements() {
            const modal = document.getElementById('achievements-modal');
            const list = document.getElementById('achievements-list'); list.innerHTML = '';
            ACHIEVEMENTS_DB.forEach(ach => {
                const isUnlocked = this.achievements.includes(ach.id);
                const div = document.createElement('div'); div.className = `achieve-item ${isUnlocked ? 'unlocked' : ''}`;
                div.innerHTML = `<div class="achieve-icon">${ach.icon}</div><div class="achieve-info"><div class="achieve-title">${ach.name} ${isUnlocked ? 'âœ…' : ''}</div><div class="achieve-desc">${isUnlocked ? ach.desc : '??? (ç»§ç»­æ¢ç´¢å°é•‡ä»¥è§£é”)'}</div>${isUnlocked ? `<div class="achieve-reward">å¥–åŠ±: ğŸ’°${ach.reward}</div>` : ''}</div>`;
                list.appendChild(div);
            });
            modal.classList.add('active');
        }
        closeAchievements() { document.getElementById('achievements-modal').classList.remove('active'); }

        showGameGuide() {
            const modal = document.getElementById('guide-modal');
            this.switchGuideTab('personality');
            modal.classList.add('active');
        }

        switchGuideTab(tab) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`guide-tab-${tab}`).classList.add('active');
            
            const container = document.getElementById('guide-content');
            container.innerHTML = '';

            if (tab === 'personality') {
                PERSONALITIES.forEach(p => {
                    const item = document.createElement('div'); item.className = 'guide-item';
                    const chaosText = p.chaosBonus > 0 ? `<span class="stat-negative">+${(p.chaosBonus * 100).toFixed(0)}% åµæ¶</span>` : `<span class="stat-positive">${(p.chaosBonus * 100).toFixed(0)}% åµæ¶</span>`;
                    const loveText = p.loveGain > 0 ? `<span class="stat-positive">+${p.loveGain.toFixed(1)} å¥½æ„Ÿ</span>` : `<span class="stat-negative">${p.loveGain.toFixed(1)} å¥½æ„Ÿ</span>`;
                    
                    item.innerHTML = `
                        <div class="guide-name">${p.name}</div>
                        <div class="guide-desc">${p.desc}</div>
                        <div class="guide-stats">
                            <div class="stat-row">${chaosText}</div>
                            <div class="stat-row">${loveText}</div>
                        </div>`;
                    container.appendChild(item);
                });
            } else {
                IDEOLOGIES.forEach(i => {
                    const item = document.createElement('div'); item.className = 'guide-item';
                    item.style.borderLeft = `5px solid ${i.color}`;
                    
                    const chaosText = i.chaosMod > 0 ? `<span class="stat-negative">+${(i.chaosMod * 100).toFixed(0)}% åµæ¶</span>` : `<span class="stat-positive">${(i.chaosMod * 100).toFixed(0)}% åµæ¶</span>`;
                    const loveText = i.loveMod > 0 ? `<span class="stat-positive">+${i.loveMod.toFixed(1)} å¥½æ„Ÿ</span>` : i.loveMod < 0 ? `<span class="stat-negative">${i.loveMod.toFixed(1)} å¥½æ„Ÿ</span>` : `<span>0 å¥½æ„Ÿ</span>`;
                    const wageText = i.wageMod > 0 ? `<span class="stat-positive">+${(i.wageMod * 100).toFixed(0)}% å·¥èµ„</span>` : i.wageMod < 0 ? `<span class="stat-negative">${(i.wageMod * 100).toFixed(0)}% å·¥èµ„</span>` : `<span>0 åŠ æˆ</span>`;
                    
                    item.innerHTML = `
                        <div class="guide-name" style="color:${i.color}">${i.name}</div>
                        <div class="guide-desc">${i.desc}</div>
                        <div class="guide-stats">
                            <div class="stat-row">${loveText}</div>
                            <div class="stat-row">${chaosText}</div>
                            <div class="stat-row">${wageText}</div>
                        </div>`;
                    container.appendChild(item);
                });
            }
        }

        showCharacterDetail(name) {
            const c = this.chars.find(x => x.name === name); if (!c) return;
            const modal = document.getElementById('char-detail-modal');
            const content = document.getElementById('detail-content'); document.getElementById('detail-name').innerText = `${c.name} çš„ä¸ªäººæ¡£æ¡ˆ`;
            
            let jobText = "æ— ä¸š"; if (c.prostitute) { jobText = "å¤±è¶³"; } else if (c.job) { const skillType = getJobSkillType(c.job.role); const skillVal = c.skills[skillType] || 0; const levelInfo = getLevelInfo(skillVal); jobText = `${levelInfo.title}${c.job.role}`; }
            let wageHtml = ''; if (c.job) { const baseWage = getBaseJobWage(c.job.role); const actualWage = c.calculateWage(baseWage, c.job.role); const diff = actualWage - baseWage; const pct = baseWage > 0 ? Math.round((diff / baseWage) * 100) : 0; const color = diff >= 0 ? '#27ae60' : '#e74c3c'; const sign = diff >= 0 ? '+' : ''; wageHtml = `<span style="color:#999; text-decoration:line-through; font-size:0.9em;">${baseWage}</span> <span style="color:${color}; font-weight:bold;">ğŸ’°${actualWage}</span> <small style="color:${color}">(${sign}${pct}%)</small>`; } else { wageHtml = `<span style="color:#aaa">æ— æ”¶å…¥</span>`; }

            let traitsHtml = c.traits.map(t => `<div class="trait-tag" title="${t.desc}">${t.name}</div>`).join('') || "æ— ";
            const ideology = c.ideology || { name: "æ— ", color: "#999", desc: "", chaosMod:0, loveMod:0, wageMod:0 };
            
            let bagHtml = '<div style="color:#999; font-size:0.85rem;">èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿ</div>'; if (c.bag && c.bag.length > 0) { bagHtml = '<div class="bag-grid">'; c.bag.forEach(itemId => { const item = ITEMS_DB[itemId]; if(item) { const tooltipText = getItemTooltipText(itemId); bagHtml += `<div class="bag-item tooltip-item" data-tip="${tooltipText}">${item.name}</div>`; } }); bagHtml += '</div>'; }
            let historyHtml = '<div class="history-list">'; if (!c.history || c.history.length === 0) { historyHtml += '<div class="history-item">æš‚æ— æ´»åŠ¨è®°å½•</div>'; } else { c.history.forEach(h => { historyHtml += `<div class="history-item">${h}</div>`; }); } historyHtml += '</div>';
            const ideologyHtml = `<div class="ideology-box"><div style="color:${ideology.color}; font-weight:bold; font-size:1.1rem;">${ideology.name}</div><div style="font-size:0.9rem; color:#555; margin:4px 0;">${ideology.desc}</div><div style="font-size:0.85rem;"><span class="stat-positive">â¤ +${ideology.loveMod} å¥½æ„Ÿ</span> | <span class="stat-positive">ğŸ’¢ ${Math.floor(ideology.chaosMod * 100)}% åµæ¶</span> | <span class="stat-positive">ğŸ’° ${Math.floor(ideology.wageMod * 100)}% å·¥èµ„</span></div></div>`;
            let jailStatus = ""; if (c.jailTerm > 0) { jailStatus = `<div style="margin-top:5px; color:#e74c3c; font-weight:bold;">â›“ï¸ æœåˆ‘ä¸­: å‰©ä½™ ${(c.jailTerm/60).toFixed(1)} å°æ—¶</div>`; }
            const skillsHtml = `<div class="skill-row"><span class="skill-name">ç¤¾äº¤</span><div class="skill-track"><div class="skill-bar sk-social" style="width:${c.skills.social}%"></div></div><span class="skill-val">${Math.floor(c.skills.social)}</span></div><div class="skill-row"><span class="skill-name">æ‰‹è‰º</span><div class="skill-track"><div class="skill-bar sk-craft" style="width:${c.skills.craft}%"></div></div><span class="skill-val">${Math.floor(c.skills.craft)}</span></div><div class="skill-row"><span class="skill-name">æ™ºåŠ›</span><div class="skill-track"><div class="skill-bar sk-intel" style="width:${c.skills.intel}%"></div></div><span class="skill-val">${Math.floor(c.skills.intel)}</span></div><div class="skill-row"><span class="skill-name">ä½“èƒ½</span><div class="skill-track"><div class="skill-bar sk-str" style="width:${c.skills.strength}%"></div></div><span class="skill-val">${Math.floor(c.skills.strength)}</span></div>`;

            content.innerHTML = `
                <div class="detail-group">
                    <div class="detail-label">åŸºæœ¬çŠ¶æ€ <button class="edit-btn" onclick="openEditModal('ä¿®æ”¹æ€§åˆ«', ['â™‚ ç”·', 'â™€ å¥³'], '${c.gender}', 'gender', '${c.name}')">[ä¿®æ”¹æ€§åˆ«]</button></div>
                    <div class="detail-val">æ€§åˆ«: ${c.gender} | ğŸ’° ${c.money} | â¤ ${Math.floor(c.happiness)} | ğŸ— ${Math.floor(c.hunger)} | ğŸš‘ ${Math.floor(c.health)}</div>
                    <div class="detail-val" style="margin-top:5px; color:#8e44ad">âœ¨ é¢œå€¼: ${Math.floor(c.appearance)}</div>
                    <div style="background:#f8f9fa; padding:8px; border-radius:6px; margin-top:8px; border:1px solid #eee;">
                        <div class="detail-val">ğŸ‘· ${jobText} <span style="margin-left:5px; font-size:0.9em">${wageHtml}</span></div>
                    </div>
                    ${jailStatus}
                    <button class="btn control" onclick="showActionSelect('${c.name}')">ğŸ•¹ï¸ å¼ºåˆ¶å®‰æ’æ´»åŠ¨</button>
                </div>
                <div class="detail-group"><div class="detail-label">ğŸ”§ èŒä¸šæŠ€èƒ½</div>${skillsHtml}</div>
                <div class="detail-group"><div class="detail-label">ğŸ‘£ æœ€è¿‘è¶³è¿¹</div>${historyHtml}</div>
                <div class="detail-group"><div class="detail-label">ğŸ’ èƒŒåŒ…</div>${bagHtml}</div>
                <div class="detail-group">
                    <div class="detail-label">æ€§æ ¼ <button class="edit-btn" onclick="editPersonality('${c.name}')">[ä¿®æ”¹]</button></div>
                    <div class="detail-val">${c.personality.name}</div><div class="detail-desc">${c.personality.desc}</div>
                </div>
                <div class="detail-group"><div class="detail-label">ç‰¹æ€§ <button class="edit-btn" onclick="editTraits('${c.name}')">[é‡ç½®]</button></div><div>${traitsHtml}</div></div>
                <div class="detail-group">
                    <div class="detail-label">ä¿¡ä»° <button class="edit-btn" onclick="editIdeology('${c.name}')">[ä¿®æ”¹]</button></div>
                    ${ideologyHtml}
                </div>
            `;
            modal.classList.add('active');
        }
        
        showBuildingDetail(bid) {
            const b = this.buildings.find(x => x.id === bid); if (!b) return;
            const modal = document.getElementById('building-detail-modal'); document.getElementById('b-detail-name').innerText = `${b.name} (Lv.${b.level})`; const content = document.getElementById('b-detail-content');
            let statusHtml = b.isBuilt ? `<span style="color:#27ae60">âœ… è¥ä¸šä¸­</span>` : `<span style="color:#e67e22">ğŸš§ å»ºè®¾ä¸­ (${Math.floor(b.currentProgress/b.totalCost*100)}%)</span>`;
            const upgradeCost = Math.floor(b.totalCost * b.level); const upgradeBtn = (b.isBuilt && b.level < 3) ? `<button class="btn upgrade" onclick="gameInstance.upgradeBuilding('${b.id}')">â« å‡çº§ (ğŸ’°${upgradeCost})</button>` : (b.isBuilt ? `<span style="color:#9b59b6; font-weight:bold;">å·²æ»¡çº§</span>` : '');
            const trainBtn = (b.isBuilt && b.staff.length > 0) ? `<button class="btn train" onclick="gameInstance.boostTraining('${b.id}')">ğŸ“š åŸ¹è®­å‘˜å·¥ (ğŸ’°200)</button>` : '';
            let staffListHtml = '';
            if (b.jobs.length === 0) { staffListHtml = '<div style="padding:10px; color:#999;">æ­¤å»ºç­‘ä¸æä¾›å·¥ä½œå²—ä½</div>'; } else { b.jobs.forEach((role, index) => { const workerName = b.staff[index] || "ã€ç©ºç¼ºã€‘"; let wage = getJobWage(role); let extraInfo = ""; let progressBarHtml = ""; if (b.staff[index]) { const worker = this.chars.find(c => c.name === workerName); if (worker) { wage = worker.calculateWage(wage, role); const skillType = getJobSkillType(role); const skillVal = worker.skills[skillType] || 0; const levelInfo = getLevelInfo(skillVal); extraInfo = `<span style="font-size:0.8em; color:#2ecc71">(${levelInfo.title})</span>`; if (levelInfo.level < 3) { let prevThreshold = 0; if (levelInfo.level === 1) prevThreshold = 20; if (levelInfo.level === 2) prevThreshold = 50; const range = levelInfo.next - prevThreshold; const progress = skillVal - prevThreshold; const pct = Math.max(0, Math.min(100, Math.floor((progress / range) * 100))); progressBarHtml = `<div style="margin-top:4px; background:#eee; height:4px; border-radius:2px; width:100%; position:relative; margin-bottom:2px;" title="æ™‹å‡è¿›åº¦: ${Math.floor(skillVal)}/${levelInfo.next}"><div style="background:#f1c40f; height:100%; width:${pct}%; border-radius:2px; transition:width 0.3s;"></div></div><div style="font-size:0.7rem; color:#999; text-align:right;">æ™‹å‡è¿›åº¦: ${pct}%</div>`; } else { progressBarHtml = `<div style="font-size:0.7rem; color:#f1c40f; text-align:right; margin-top:4px;">âœ¨ å¤§å¸ˆçº§</div>`; } } } const color = b.staff[index] ? "#0984e3" : "#ccc"; staffListHtml += `<div class="staff-list-item" style="flex-direction:column; align-items:stretch;"><div style="display:flex; justify-content:space-between; align-items:center;"><div><span class="staff-role">${role}</span>${extraInfo}<div style="font-size:0.8rem; color:#666;">æ—¥è–ª: ğŸ’°${wage}</div></div><div style="font-weight:bold; color:${color};">${workerName}</div></div>${progressBarHtml}</div>`; }); }
            if (b.id === 'footshop' && b.prostitutes.length > 0) { staffListHtml += `<div style="margin-top:10px; font-weight:bold; color:#e056fd;">ğŸ’‹ ç‰¹æ®ŠæœåŠ¡äººå‘˜:</div>`; b.prostitutes.forEach(name => { staffListHtml += `<div class="staff-list-item"><span class="staff-role">æŠ€å¸ˆ</span><span class="staff-name" style="color:#e056fd">${name}</span></div>`; }); }
            let sellsHtml = ''; if (b.sells && b.sells.length > 0) { sellsHtml = `<div style="margin-top:10px; font-weight:bold;">ğŸ›ï¸ å”®å–å•†å“:</div><div style="display:flex; flex-wrap:wrap; gap:5px; margin-top:5px;">`; b.sells.forEach(itemId => { const item = ITEMS_DB[itemId]; if (item) { const tooltipText = getItemTooltipText(itemId); sellsHtml += `<span class="tooltip-item" data-tip="${tooltipText}" style="cursor:help; background:#fff5f0; border:1px solid #e17055; color:#d35400; padding:2px 6px; border-radius:4px; font-size:0.8rem;">${item.name} (ğŸ’°${item.price})</span>`; } }); sellsHtml += `</div>`; }
            let historyHtml = '<div class="history-list">'; if (!b.history || b.history.length === 0) { historyHtml += '<div class="history-item">æš‚æ— è®¿å®¢è®°å½•</div>'; } else { b.history.forEach(h => { historyHtml += `<div class="history-item">${h}</div>`; }); } historyHtml += '</div>';
            content.innerHTML = `<div style="margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid #eee;"><div style="font-size:0.9rem; color:#666; margin-bottom:5px;">${b.desc}</div><div style="margin-bottom:5px;">${upgradeBtn}</div><div>çŠ¶æ€: ${statusHtml}</div><div>æ¶ˆè´¹ä»·æ ¼: ğŸ’°${b.price}</div><div>è¥ä¸šæ—¶é—´: ${b.open}:00 - ${b.close}:00</div>${sellsHtml}</div><div style="font-weight:bold; margin-bottom:5px;">ğŸ‘£ æœ€è¿‘è®¿å®¢è®°å½•</div>${historyHtml}<div style="font-weight:bold; margin-bottom:5px; margin-top:10px; display:flex; justify-content:space-between;"><span>ğŸ‘¥ å²—ä½ä¸å‘˜å·¥</span><span>${trainBtn}</span></div><div style="border:1px solid #eee; border-radius:6px; overflow:hidden;">${staffListHtml}</div>`;
            modal.classList.add('active');
        }
        
        editPersonality(name) { openEditModal("ä¿®æ”¹æ€§æ ¼", PERSONALITIES.map(p=>p.name), this.chars.find(x=>x.name===name)?.personality.name, 'personality', name); }
        editIdeology(name) { openEditModal("ä¿®æ”¹ä¿¡ä»°", IDEOLOGIES.map(i=>i.name), this.chars.find(x=>x.name===name)?.ideology.name, 'ideology', name); }
        editTraits(name) { const c = this.chars.find(x=>x.name===name); if(c){ c.traits=[]; const count=rand(0,2); for(let i=0;i<count;i++){ const t=TRAITS.filter(x=>!c.traits.includes(x)); if(t.length) c.traits.push(choose(t)); } this.showCharacterDetail(name); } }
        
        // --- Calendar System ---
        showCalendar() {
            const modal = document.getElementById('calendar-modal');
            this.renderCalendar();
            modal.classList.add('active');
        }
        closeCalendar() { document.getElementById('calendar-modal').classList.remove('active'); }
        
        renderCalendar() {
            const container = document.getElementById('calendar-container');
            container.innerHTML = '';
            const curM = this.dateMonth; const curD = this.dateDay;
            
            for(let m=1; m<=12; m++) {
                const mCard = document.createElement('div');
                mCard.className = 'month-card';
                let season = ''; if(m>=3 && m<=5) season='(æ˜¥)'; else if(m>=6 && m<=8) season='(å¤)'; else if(m>=9 && m<=11) season='(ç§‹)'; else season='(å†¬)';
                
                let gridHtml = '<div class="days-grid">';
                // ä½¿ç”¨ MONTH_DAYS æ•°ç»„å†³å®šå¤©æ•°
                const totalDays = MONTH_DAYS[m];
                for(let d=1; d<=totalDays; d++) {
                    const isToday = (m === curM && d === curD);
                    const evt = TOWN_EVENTS.find(e => e.date && e.date.m === m && e.date.d === d);
                    let classes = 'day-cell';
                    if(isToday) classes += ' today';
                    if(evt) classes += ' event-day';
                    
                    gridHtml += `<div class="${classes}" ${evt ? `data-evt="${evt.name}"` : ''}>${d}</div>`;
                }
                gridHtml += '</div>';
                
                mCard.innerHTML = `<div class="month-title">${m}æœˆ ${season}</div>${gridHtml}`;
                container.appendChild(mCard);
            }
        }
        
        updateUI() {
            const townMoneyEl = document.getElementById('town-money');
            if (townMoneyEl) townMoneyEl.innerText = this.townMoney;
            const h = Math.floor(this.gameTime / 60); const m = this.gameTime % 60;
            document.getElementById('game-time').innerText = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
            document.getElementById('game-day').innerText = DAYS[this.gameDay];
            const seasonName = this.getSeasonName();
            document.getElementById('calendar-display').innerText = `ğŸ“… ${this.dateMonth}æœˆ${this.dateDay}æ—¥ (${seasonName})`;
            const wInfo = WEATHER_TYPES[this.weather];
            document.getElementById('weather-display').innerText = wInfo ? wInfo.name : '';
            const resCountEl = document.getElementById('resident-count');
            if (resCountEl) resCountEl.innerText = this.chars.length;
            const charList = document.getElementById('char-list'); charList.innerHTML = ''; 
            this.chars.forEach(c => {
                let lovedOne = "æ— "; let maxL = 0; for(let name in c.relationships) { if(c.relationships[name].love > maxL) { maxL = c.relationships[name].love; lovedOne = name; } }
                let statusHtml = c.partner ? `<span style="color:var(--love)">â¤ ${c.partner}</span>` : `<span style="color:#999">å–œæ¬¢: ${lovedOne}</span>`;
                let actionClass = ""; if (c.jailTerm > 0) actionClass = "action-jail"; else if (c.currentAction.includes("å»ºè®¾")) actionClass = "action-build"; else if (c.currentAction.includes("å·¥ä½œ") || c.currentAction.includes("æ‰“å·¥") || c.currentAction.includes("å–é“¶")) actionClass = "action-work"; else if (c.currentAction.includes("èººå¹³") || c.currentAction.includes("ç¡è§‰")) actionClass = "action-lieflat"; else if (c.currentAction.includes("åƒ") || c.currentAction.includes("äº«ç”¨")) actionClass = "action-eat"; else if (c.currentAction.includes("çŠ¯ç½ª") || c.currentAction.includes("æŠ¢åŠ«") || c.currentAction.includes("åŠ«è‰²")) actionClass = "action-crime"; else if (c.currentAction.includes("è´­ç‰©") || c.currentAction.includes("é€ç¤¼")) actionClass = "action-shop"; else if (c.currentAction.includes("ä½¿ç”¨") || c.currentAction.includes("æœç”¨")) actionClass = "action-use"; else actionClass = "action-social";
                let jobTitle = "æ— ä¸š"; if(c.job) { const skillType = getJobSkillType(c.job.role); const title = getLevelInfo(c.skills[skillType]||0).title; jobTitle = `${title}${c.job.role}`; }
                let jobInfo = c.job ? `<span style="font-size:0.8em;color:#666;background:#eee;padding:2px 4px;border-radius:4px;">${jobTitle}</span>` : `<span style="font-size:0.8em;color:#aaa">æ— ä¸š</span>`;
                let nameHtml = `<strong>${c.name}</strong>`; if (gameInstance && gameInstance.mayor === c.name) { nameHtml += ` <span class="tag-gov">ğŸ–ï¸é•‡é•¿</span>`; }
                const div = document.createElement('div'); div.className = `char-card ${actionClass}`; div.onclick = () => gameInstance.showCharacterDetail(c.name);
                div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;"><div>${nameHtml} <span style="font-size:0.75em;color:#888;">${c.gender}</span> ${jobInfo}</div><div style="text-align:right; font-size:0.85rem;"><span style="color:#f39c12">ğŸ’°${c.money}</span></div></div><div style="font-size:0.8em; margin-bottom:5px;">${statusHtml}</div><div class="bar-container" title="å¥åº· (Health)"><div class="bar-fill health-fill" style="width:${c.health}%"></div></div><div class="bar-container" title="é¥±é£Ÿ (Hunger)" style="height:3px;margin-top:2px;"><div class="bar-fill food-fill" style="width:${c.hunger}%"></div></div><div class="bar-container" title="å¿ƒæƒ… (Mood)" style="height:3px;margin-top:2px;"><div class="bar-fill hp-fill" style="width:${c.happiness}%"></div></div><div style="color:#555;margin-top:2px; font-size:0.85rem">${c.currentAction}</div>`;
                charList.appendChild(div);
            });
            this.buildings.forEach(b => {
                const el = document.getElementById(`build-${b.id}`);
                if (el) {
                    const pct = Math.min(100, (b.currentProgress / b.totalCost) * 100); el.querySelector('.bar-fill').style.width = `${pct}%`;
                    let staffHtml = ""; if (b.jobs.length > 0) staffHtml = `<div style="font-size:0.75rem; color:#666; margin-top:4px;">å‘˜å·¥: ${b.staff.length}/${b.jobs.length}</div>`;
                    let levelBadge = `<span class="lvl-badge">Lv.${b.level}</span>`;
                    if (b.isBuilt) { el.classList.add('built'); el.classList.remove('building'); el.classList.remove('active-project'); el.querySelector('.build-prog').innerHTML = `âœ… è¥ä¸šä¸­ ${levelBadge} <br>Price: ğŸ’°${b.price} ${staffHtml}`; } else if (b.currentProgress > 0 || b.isUnderConstruction) { if (b.isUnderConstruction) { el.classList.add('active-project'); el.classList.remove('building'); el.querySelector('.build-prog').innerText = `ğŸš§ æ–½å·¥ä¸­: ${Math.floor(pct)}%`; } else { el.classList.add('building'); el.classList.remove('active-project'); el.querySelector('.build-prog').innerText = `â³ æš‚åœæ–½å·¥: ${Math.floor(pct)}%`; } } else { el.querySelector('.build-prog').innerText = `æœªå¼€å·¥ (ğŸ’°${b.price})`; }
                    const btnContainer = el.lastElementChild;
                    const existingStartBtn = btnContainer.querySelector('.start-build');
                    const existingAccelerate = btnContainer.querySelector('.accelerate');
                    if (!b.isBuilt) { if (b.isUnderConstruction && !existingAccelerate) { btnContainer.innerHTML = `<div class="bar-container"><div class="bar-fill" style="background:#00b894; width:${pct}%"></div></div><div class="build-prog">ğŸš§ æ–½å·¥ä¸­: ${Math.floor(pct)}%</div><button class="btn accelerate" onclick="gameInstance.accelerateBuild('${b.id}')">ğŸ’¸ èµ„é‡‘åŠ é€Ÿ (50)</button><button class="btn stop-build" onclick="gameInstance.toggleConstruction('${b.id}')">â¹ æš‚åœæ–½å·¥</button>`; } else if (!b.isUnderConstruction && !existingStartBtn) { btnContainer.innerHTML = `<div class="bar-container"><div class="bar-fill" style="background:#00b894; width:${pct}%"></div></div><div class="build-prog">â³ å¾…æŠ•ç¥¨å¯åŠ¨</div><button class="btn start-build" disabled title="ç”±é•‡é•¿å‘èµ·æŠ•ç¥¨å†³å®š">ğŸ—³ï¸ å¾…å…¬æŠ•å¯åŠ¨</button>`; } }
                }
            });
            if (isRelViewOpen) this.renderRelations();
        }

        renderRelations() {
            if (!isRelViewOpen) return;
            try {
                const incomingLove = {}; this.chars.forEach(c => incomingLove[c.name] = 0); this.chars.forEach(c => { for(let tName in c.relationships) if(incomingLove[tName] !== undefined) incomingLove[tName] += c.relationships[tName].love; });
                const sortedChars = [...this.chars].sort((a,b) => (incomingLove[b.name]||0) - (incomingLove[a.name]||0));
                if (sortedChars.length > 0) { const topName = sortedChars[0].name; const botName = sortedChars[sortedChars.length - 1].name; document.getElementById('stat-pop').innerHTML = `${topName} <small>(${incomingLove[topName]||0}â¤)</small>`; document.getElementById('stat-lonely').innerHTML = `${botName} <small>(${incomingLove[botName]||0}â¤)</small>`; }
                const listEl = document.getElementById('rel-list'); listEl.innerHTML = '';
                this.chars.forEach(c => {
                    const div = document.createElement('div'); div.className = 'rel-item';
                    let rels = Object.entries(c.relationships).map(([name, data]) => ({ name, ...data })).sort((a, b) => b.love - a.love).filter(r => r.love > 0 || r.status !== 'stranger');
                    let relHtml = rels.map(r => { let tagClass = "tag-friend"; if (r.status === 'spouse') tagClass = 'tag-spouse'; else if (r.status === 'lover') tagClass = 'tag-lover'; else if (r.status === 'mistress') tagClass = 'tag-mistress'; else if (r.status === 'bestfriend') tagClass = 'tag-bestfriend'; else if (r.status === 'ex') tagClass = 'tag-ex'; else if (r.status === 'enemy') tagClass = 'tag-enemy'; const cnStatus = REL_TRANSLATE[r.status] || r.status; return `<div style="margin-top:4px;"><span class="rel-tag ${tagClass}">${cnStatus}</span><b>${r.name}</b> <span style="color:#999">(${r.love})</span></div>`; }).join('');
                    if(!relHtml) relHtml = `<div style="color:#ccc;font-size:0.8rem">æš‚æ— ç‰¹åˆ«å…³ç³»</div>`; div.innerHTML = `<strong>${c.name}</strong>${relHtml}`; listEl.appendChild(div);
                });
                const canvas = document.getElementById('rel-canvas'); const container = document.getElementById('rel-graph-container'); const w = container.clientWidth || 800; const h = container.clientHeight || 600; canvas.width = w; canvas.height = h; const ctx = canvas.getContext('2d'); const cx = w / 2; const cy = h / 2; const r = Math.min(cx, cy) - 50; ctx.clearRect(0, 0, w, h); const points = {}; this.chars.forEach((c, i) => { const angle = (i / this.chars.length) * Math.PI * 2 - Math.PI / 2; points[c.name] = { x: cx + Math.cos(angle) * r, y: cy + Math.sin(angle) * r }; });
                this.chars.forEach(c => { const p1 = points[c.name]; for (let tName in c.relationships) { const rel = c.relationships[tName]; if ((rel.love > 40 || (rel.status !== 'stranger' && rel.status !== 'friend')) && points[tName]) { const p2 = points[tName]; ctx.beginPath(); const dx = p2.x - p1.x; const dy = p2.y - p1.y; const midX = (p1.x + p2.x) / 2; const midY = (p1.y + p2.y) / 2; const offset = 20; const angle = Math.atan2(dy, dx); const cpX = midX - Math.sin(angle) * offset; const cpY = midY + Math.cos(angle) * offset; ctx.moveTo(p1.x, p1.y); ctx.quadraticCurveTo(cpX, cpY, p2.x, p2.y); let color = 'rgba(200,200,200,0.2)'; let width = 1; let dash = []; if(rel.status === 'spouse') { color = 'rgba(232,67,147,0.8)'; width = 3; } else if(rel.status === 'lover') { color = 'rgba(255,107,107,0.7)'; width = 2; } else if(rel.status === 'mistress') { color = 'rgba(255,140,0,0.7)'; width = 2; dash = [5, 5]; } else if(rel.status === 'bestfriend') { color = 'rgba(52,152,219,0.6)'; width = 2; } else if(rel.status === 'ex') { color = 'rgba(99,110,114,0.5)'; width = 1.5; dash = [2, 2]; } else if(rel.status === 'enemy') { color = 'rgba(192, 57, 43, 0.8)'; width = 2; } ctx.strokeStyle = color; ctx.lineWidth = width; ctx.setLineDash(dash); ctx.stroke(); ctx.setLineDash([]); const arrowAngle = Math.atan2(p2.y - cpY, p2.x - cpX); const arrowLen = 8; ctx.beginPath(); const endX = p2.x - Math.cos(arrowAngle) * 22; const endY = p2.y - Math.sin(arrowAngle) * 22; ctx.moveTo(endX, endY); ctx.lineTo(endX - arrowLen * Math.cos(arrowAngle - Math.PI / 6), endY - arrowLen * Math.sin(arrowAngle - Math.PI / 6)); ctx.lineTo(endX - arrowLen * Math.cos(arrowAngle + Math.PI / 6), endY - arrowLen * Math.sin(arrowAngle + Math.PI / 6)); ctx.fillStyle = color; ctx.fill(); } } });
                this.chars.forEach(c => { const p = points[c.name]; ctx.beginPath(); ctx.arc(p.x, p.y, 20, 0, Math.PI*2); ctx.fillStyle = "#fff"; ctx.fill(); ctx.strokeStyle = c.partner ? "#ff6b6b" : "#4a90e2"; ctx.lineWidth = 2; ctx.stroke(); ctx.fillStyle = "#333"; ctx.font = "11px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText(c.name, p.x, p.y); });
            } catch(e) { console.error("Render Error:", e); }
        }
    }

    // --- Helper Functions ---
    function switchTab(tabName) { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById(`tab-${tabName}`).classList.add('active'); document.querySelectorAll('.col-view').forEach(v => v.classList.remove('active-view')); document.getElementById(`view-${tabName}`).classList.add('active-view'); }
    let gameInstance = null; let isRelViewOpen = false;
    let currentEditTarget = null;
    let currentEditType = null;

    function toggleRelationView() { const main = document.getElementById('main-view'); const rel = document.getElementById('relation-view'); isRelViewOpen = !isRelViewOpen; if (isRelViewOpen) { main.style.display = 'none'; rel.classList.add('active'); setTimeout(() => { if (gameInstance) gameInstance.renderRelations(); }, 50); } else { main.style.display = 'flex'; rel.classList.remove('active'); } }
    function showLeaderboard() { renderLeaderboard('money'); document.getElementById('leaderboard-modal').classList.add('active'); }
    function closeLeaderboard() { document.getElementById('leaderboard-modal').classList.remove('active'); }
    function showAchievements() { if(gameInstance) gameInstance.showAchievements(); }
    function closeAchievements() { if(gameInstance) gameInstance.closeAchievements(); }
    function showJobBoard() { if(gameInstance) gameInstance.showJobBoard(); }
    function closeJobBoard() { document.getElementById('jobboard-modal').classList.remove('active'); }
    function showGameGuide() { if(gameInstance) gameInstance.showGameGuide(); }
    function closeGameGuide() { document.getElementById('guide-modal').classList.remove('active'); }
    function switchGuideTab(tab) { if(gameInstance) gameInstance.switchGuideTab(tab); }
    
    // New Edit Functions
    function openEditModal(title, options, currentVal, type, charName) {
        document.getElementById('edit-title').innerText = title;
        const sel = document.getElementById('edit-select');
        sel.innerHTML = '';
        options.forEach(opt => {
            const el = document.createElement('option');
            el.value = opt;
            el.innerText = opt;
            if (opt === currentVal) el.selected = true;
            sel.appendChild(el);
        });
        currentEditTarget = charName;
        currentEditType = type;
        document.getElementById('edit-modal').classList.add('active');
    }

    function confirmEdit() {
        const val = document.getElementById('edit-select').value;
        if (currentEditType === 'gender') {
            const c = gameInstance.chars.find(x => x.name === currentEditTarget);
            if(c) c.gender = val;
        } else if (currentEditType === 'personality') {
            const c = gameInstance.chars.find(x => x.name === currentEditTarget);
            if(c) c.personality = PERSONALITIES.find(p => p.name === val);
        } else if (currentEditType === 'ideology') {
            const c = gameInstance.chars.find(x => x.name === currentEditTarget);
            if(c) c.ideology = IDEOLOGIES.find(i => i.name === val);
        }
        gameInstance.showCharacterDetail(currentEditTarget);
        closeEditModal();
    }

    function closeEditModal() {
        document.getElementById('edit-modal').classList.remove('active');
        currentEditTarget = null;
        currentEditType = null;
    }

    function renderLeaderboard(type) { 
        if (!gameInstance) return; 
        const list = document.getElementById('leaderboard-list'); list.innerHTML = ''; 
        let sorted = [...gameInstance.chars];
        if (type === 'money') { sorted.sort((a, b) => b.money - a.money); } else if (type === 'happiness') { sorted.sort((a, b) => b.happiness - a.happiness); } else if (type === 'popularity') { const popMap = {}; gameInstance.chars.forEach(c => popMap[c.name] = 0); gameInstance.chars.forEach(source => { for(let target in source.relationships) { if(popMap[target] !== undefined) popMap[target] += source.relationships[target].love; } }); sorted.sort((a, b) => popMap[b.name] - popMap[a.name]); sorted.forEach(c => c._tempPop = popMap[c.name]); } else if (type === 'robbery') { sorted.sort((a, b) => (b.stat_rob || 0) - (a.stat_rob || 0)); } else if (type === 'streetwalk') { sorted.sort((a, b) => (b.stat_streetwalk || 0) - (a.stat_streetwalk || 0)); } else if (type === 'assault') { sorted.sort((a, b) => (b.stat_assault || 0) - (a.stat_assault || 0)); }
        sorted.forEach((c, index) => { 
            if (type === 'robbery' && (c.stat_rob||0) === 0 && (c.stat_be_robbed||0) === 0 && index > 5) return;
            if (type === 'streetwalk' && (c.stat_streetwalk||0) === 0 && index > 5) return;
            if (type === 'assault' && (c.stat_assault||0) === 0 && (c.stat_be_assaulted||0) === 0 && index > 5) return;
            const item = document.createElement('div'); item.className = 'rank-item'; let rankClass = ''; if (index === 0) rankClass = 'rank-1'; else if (index === 1) rankClass = 'rank-2'; else if (index === 2) rankClass = 'rank-3'; 
            let valText = '';
            if(type==='money') valText = `ğŸ’° ${c.money}`; else if(type==='happiness') valText = `â¤ ${Math.floor(c.happiness)}`; else if(type==='popularity') valText = `ğŸ”¥ ${c._tempPop}`; else if(type==='robbery') { valText = `<span style="color:#2d3436">ğŸ”ª æŠ¢:${c.stat_rob||0}</span> | <span style="color:#999">è¢«æŠ¢:${c.stat_be_robbed||0}</span>`; } else if(type==='streetwalk') { valText = `<span style="color:#e056fd">ğŸ’‹ ç«™è¡—: ${c.stat_streetwalk||0} æ¬¡</span>`; } else if(type==='assault') { valText = `<span style="color:#c0392b">ğŸ˜ˆ åŠ«:${c.stat_assault||0}</span> | <span style="color:#999">å—å®³:${c.stat_be_assaulted||0}</span>`; }
            item.innerHTML = `<div class="rank-num ${rankClass}">${index + 1}</div><div class="rank-info"><div class="rank-name">${c.name}</div></div><div class="rank-val" style="font-size:0.9rem">${valText}</div>`; list.appendChild(item); 
        }); 
    }
    
    function closeCharDetail() { document.getElementById('char-detail-modal').classList.remove('active'); }
    function showGov() { if (gameInstance) gameInstance.showGov(); }
    function closeGov() { if (gameInstance) gameInstance.closeGov(); }
    function togglePolicy(type) { if (gameInstance) gameInstance.togglePolicy(type); }
    function executeCommonProsperity() { if (gameInstance) gameInstance.executeCommonProsperity(); }
    function showEmbezzle() { if (gameInstance) gameInstance.showEmbezzle(); }
    function doEmbezzle() { if (gameInstance) gameInstance.doEmbezzle(); }
    function closeEmbezzle() { if (gameInstance) gameInstance.closeEmbezzle(); }
    function toggleSpeed() { if (gameInstance) gameInstance.toggleSpeed(); }
    function showActionSelect(name) { if(gameInstance) gameInstance.showActionSelect(name); }
    function setOverride(name, type, target, desc) { if(gameInstance) gameInstance.setOverride(name, type, target, desc); }
    function closeActionSelect() { if(gameInstance) gameInstance.closeActionSelect(); }
    function editPersonality(name) { if(gameInstance) gameInstance.editPersonality(name); }
    function editTraits(name) { if(gameInstance) gameInstance.editTraits(name); }
    function editIdeology(name) { if(gameInstance) gameInstance.editIdeology(name); }
    function showTownEvents() { if(gameInstance) gameInstance.showTownEvents(); }
    function triggerTownEvent(id) { if(gameInstance) gameInstance.triggerTownEvent(id); }
    function closeTownEvents() { if(gameInstance) gameInstance.closeTownEvents(); }
    function switchEventTab(tab) { if(gameInstance) gameInstance.switchEventTab(tab); }
    function showBuildingDetail(bid) { if(gameInstance) gameInstance.showBuildingDetail(bid); }
    function closeBuildingDetail() { document.getElementById('building-detail-modal').classList.remove('active'); }
    
    // --- Calendar Functions ---
    function showCalendar() { if(gameInstance) gameInstance.showCalendar(); }
    function closeCalendar() { document.getElementById('calendar-modal').classList.remove('active'); }
    
    function inputNewResident() { if (!gameInstance) return; const name = prompt("è¯·è¾“å…¥æ–°å±…æ°‘çš„åå­—ï¼š\n(æ€§æ ¼ã€æ€§åˆ«ã€ç‰¹è´¨å°†ç”±ç³»ç»Ÿéšæœºç”Ÿæˆ)"); if (name && name.trim() !== "") { const cleanName = name.trim().substring(0, 8); gameInstance.addNewResident(cleanName); } }

    document.addEventListener('DOMContentLoaded', () => { 
        document.getElementById('edit-modal').addEventListener('click', (e) => { if (e.target === document.getElementById('edit-modal')) closeEditModal(); });
        document.getElementById('guide-modal').addEventListener('click', (e) => { if (e.target === document.getElementById('guide-modal')) closeGameGuide(); });
        document.getElementById('char-detail-modal').addEventListener('click', (e) => { if (e.target === document.getElementById('char-detail-modal')) closeCharDetail(); }); 
        document.getElementById('leaderboard-modal').addEventListener('click', (e) => { if (e.target === document.getElementById('leaderboard-modal')) closeLeaderboard(); }); 
        document.getElementById('jobboard-modal').addEventListener('click', (e) => { if (e.target === document.getElementById('jobboard-modal')) closeJobBoard(); }); 
        document.getElementById('embezzle-modal').addEventListener('click', (e) => { if (e.target === document.getElementById('embezzle-modal')) closeEmbezzle(); }); 
        document.getElementById('action-select-modal').addEventListener('click', (e) => { if (e.target === document.getElementById('action-select-modal')) closeActionSelect(); }); 
        document.getElementById('town-event-modal').addEventListener('click', (e) => { if (e.target === document.getElementById('town-event-modal')) closeTownEvents(); });
        document.getElementById('building-detail-modal').addEventListener('click', (e) => { if (e.target === document.getElementById('building-detail-modal')) closeBuildingDetail(); });
        document.getElementById('achievements-modal').addEventListener('click', (e) => { if (e.target === document.getElementById('achievements-modal')) closeAchievements(); });
        document.getElementById('gov-modal').addEventListener('click', (e) => { if (e.target === document.getElementById('gov-modal')) closeGov(); });
        document.getElementById('calendar-modal').addEventListener('click', (e) => { if (e.target === document.getElementById('calendar-modal')) closeCalendar(); });
    });
    function manualSave() { if (gameInstance) gameInstance.saveData(); }
    function resetData() { if(confirm("ç¡®å®šè¦åˆ é™¤å­˜æ¡£å¹¶é‡ç½®æ‰€æœ‰è¿›åº¦å—ï¼Ÿ")) { localStorage.removeItem('happyTownV2_Save'); location.reload(); } }
    window.onload = () => { gameInstance = new Game(); };
</script><script type="module" src="/index.tsx"></script>
</body>
</html>