<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŒ«ã®æ¨¡æ‹Ÿå°é•‡ Ver 2.8.0 - æˆå°±ä¸æ–°å»ºç­‘ç‰ˆ</title>
    <style>
        :root { --bg: #f0f2f5; --card: #fff; --primary: #4a90e2; --love: #ff6b6b; --text: #333; --dark: #2d3436; --crime: #8e44ad; --item: #e17055; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; }
        
        /* é¡¶éƒ¨ */
        header { background: var(--card); padding: 10px 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; flex-wrap: wrap; gap: 15px; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .header-group { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        h1 { margin: 0; font-size: 1.2rem; }
        .btn { cursor: pointer; background: var(--primary); color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.9rem; transition: 0.2s; white-space: nowrap; }
        .btn:hover { opacity: 0.9; }
        .btn.save { background: #27ae60; }
        .btn.reset { background: #e74c3c; }
        .btn.gold { background: #f1c40f; color: #333; font-weight: bold; }
        .btn.cyan { background: #00b894; color: white; font-weight: bold; }
        .btn.purple { background: #9b59b6; color: white; font-weight: bold; }
        .btn.speed { background: #e67e22; font-weight: bold; width: 80px; }
        .btn.create { background: #e17055; color: white; font-weight: bold; }
        .btn.create:hover { background: #d35400; }
        .btn.achieve { background: #34495e; color: #fff; font-weight: bold; }

        .btn.fund { background: #9b59b6; font-size: 0.8rem; padding: 2px 6px; margin-left: 5px; } 
        .btn.accelerate { background: #2ecc71; color: white; font-size: 0.8rem; padding: 4px 8px; margin-top: 5px; width: 100%; border: 1px solid #27ae60; }
        .btn.accelerate:hover { background: #27ae60; }
        .btn.control { background: #34495e; width: 100%; margin-top: 10px; }
        input[type="number"] { width: 50px; padding: 4px; }

        /* æ ‡ç­¾å¯¼èˆªæ  */
        .tab-nav { display: flex; gap: 10px; margin-bottom: 15px; background: var(--card); padding: 8px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tab-btn { flex: 1; padding: 10px; cursor: pointer; border: none; background: #f0f2f5; color: #666; border-radius: 6px; font-weight: bold; font-size: 1rem; transition: 0.2s; }
        .tab-btn:hover { background: #e1e4e8; }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 2px 4px rgba(74, 144, 226, 0.3); }

        /* ä¸»åŒºåŸŸ */
        .game-container { display: flex; flex: 1; gap: 15px; overflow: hidden; }
        .col-view { display: none; flex-direction: column; gap: 10px; overflow-y: auto; flex: 2.5; } 
        .col-view.active-view { display: flex; }

        .section-title { font-weight: bold; color: #666; margin-bottom: 5px; display: flex; justify-content: space-between; font-size: 1.1rem; border-bottom: 2px solid #eee; padding-bottom: 8px; }
        
        .char-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; }
        .char-card { cursor: pointer; background: var(--card); padding: 12px; border-radius: 8px; border-left: 5px solid #ddd; font-size: 0.9rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: relative; transition: transform 0.2s, box-shadow 0.2s; }
        .char-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.15); z-index: 1; }
        .char-card.action-social { border-left-color: var(--love); }
        .char-card.action-work { border-left-color: #f1c40f; }
        .char-card.action-build { border-left-color: #e67e22; }
        .char-card.action-lieflat { border-left-color: #a29bfe; background: #f8f8ff; }
        .char-card.action-eat { border-left-color: #00b894; background: #f0fff4; }
        .char-card.action-crime { border-left-color: var(--crime); background: #fcf0ff; }
        .char-card.action-shop { border-left-color: var(--item); background: #fff5f0; } 
        .char-card.action-use { border-left-color: #00cec9; background: #e0f7fa; }
        .char-card.action-jail { border-left-color: #2d3436; background: #dcdde1; color: #636e72; }
        
        .bar-container { height: 6px; background: #eee; margin: 8px 0; border-radius: 3px; overflow: hidden; }
        .bar-fill { height: 100%; width: 0; transition: width 0.3s; }
        .hp-fill { background: #2ecc71; } 
        .food-fill { background: #fdcb6e; }
        .health-fill { background: #ff7675; }

        .build-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 12px; }
        .build-card { cursor: pointer; background: var(--card); padding: 15px; border-radius: 8px; opacity: 0.6; filter: grayscale(1); transition: 0.3s; border: 2px dashed #ccc; display: flex; flex-direction: column; justify-content: space-between; }
        .build-card:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .build-card.built { opacity: 1; filter: grayscale(0); border: 2px solid #27ae60; background: #f0fff4; }
        .build-card.building { opacity: 0.9; filter: grayscale(0.5); border: 2px solid #e67e22; }
        .build-prog { font-size: 0.85rem; color: #666; margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee; }
        .category-header { grid-column: 1 / -1; font-weight: bold; margin-top: 15px; margin-bottom: 5px; border-left: 4px solid #aaa; padding-left: 8px; background: #f0f2f5; padding: 5px; border-radius: 4px; }

        .col-right { flex: 1; background: var(--dark); color: #dfe6e9; border-radius: 10px; padding: 15px; overflow-y: auto; font-family: monospace; font-size: 0.85rem; display: flex; flex-direction: column; min-width: 250px; }
        .log-entry { margin-bottom: 8px; line-height: 1.4; border-bottom: 1px solid #444; padding-bottom: 4px; }
        .log-time { color: #74b9ff; opacity: 0.7; margin-right: 5px; font-size: 0.8em; }
        .tag-love { color: #ff7675; }
        .tag-reject { color: #a29bfe; font-weight: bold; }
        .tag-drama { color: #fdcb6e; font-weight: bold; }
        .tag-build { color: #00b894; }
        .tag-venue { color: #81ecec; font-style: italic; }
        .tag-crime { color: #e056fd; font-weight: bold; text-shadow: 0 0 2px rgba(142, 68, 173, 0.5); }
        .tag-event { color: #0984e3; font-weight: bold; background: rgba(9, 132, 227, 0.1); padding: 2px 4px; border-radius: 3px;}
        .tag-item { color: var(--item); font-weight: bold; }
        .tag-use { color: #00cec9; }
        .tag-promote { color: #f1c40f; font-weight: bold; text-shadow: 0 0 5px rgba(241, 196, 15, 0.3); }
        .tag-weather { color: #74b9ff; font-style: italic; }

        @media (max-width: 800px) { 
            .game-container { flex-direction: column; overflow-y: auto; } 
            .col-right { height: 200px; flex: none; order: 3; }
            .col-view { flex: none; }
        }

        /* æ¨¡æ€æ¡†ä¸å…³ç³»è§†å›¾ */
        .relation-view { display: none; flex: 1; background: var(--card); padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden; flex-direction: column; }
        .relation-view.active { display: flex; }
        
        .rel-layout { display: flex; gap: 20px; flex: 1; min-height: 0; height: 100%; }
        .rel-graph { flex: 2; border: 1px solid #eee; border-radius: 8px; position: relative; background: #fdfdfd; overflow: hidden; }
        .rel-list { flex: 1; overflow-y: auto; overflow-x: hidden; font-size: 0.9rem; padding-right: 5px; border-left: 1px solid #eee; padding-left: 10px; }
        .rel-item { padding: 8px; border-bottom: 1px solid #eee; }
        .rel-tag { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; margin-right: 5px; color: white; }
        .tag-spouse { background: #e84393; } .tag-lover { background: #ff7675; } .tag-mistress { background: #ff8c00; } .tag-friend { background: #74b9ff; } .tag-bestfriend { background: #3498db; } .tag-ex { background: #636e72; } .tag-stranger { background: #95a5a6; } .tag-enemy { background: #c0392b; }
        
        canvas { width: 100%; height: 100%; display: block; }

        /* æ¨¡æ€æ¡† */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: var(--card); padding: 25px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .modal-header h3 { margin: 0; font-size: 1.3rem; }
        .modal-close { cursor: pointer; font-size: 1.5rem; color: #999; background: none; border: none; padding: 0; width: 30px; height: 30px; }
        .modal-close:hover { color: #333; }

        .personality-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .personality-item { background: #f8f9fa; padding: 12px; border-radius: 8px; border-left: 4px solid #ddd; }
        .personality-item.chaos { border-left-color: #e74c3c; }
        .personality-item.peace { border-left-color: #27ae60; }
        .personality-item.neutral { border-left-color: #3498db; }
        .personality-name { font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; }
        .personality-desc { color: #666; font-size: 0.9rem; margin-bottom: 8px; }
        .personality-stats { font-size: 0.85rem; color: #555; }
        .stat-item { margin: 3px 0; }
        .stat-positive { color: #27ae60; }
        .stat-negative { color: #e74c3c; }

        .detail-group { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .detail-group:last-child { border-bottom: none; }
        .detail-label { font-weight: bold; color: #666; margin-bottom: 5px; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; }
        .detail-val { font-size: 1.05rem; }
        .detail-desc { font-size: 0.9rem; color: #888; margin-top: 4px; font-style: italic; }
        .trait-tag { display: inline-block; padding: 3px 8px; border-radius: 4px; background: #f0f0f0; color: #333; margin-right: 5px; font-size: 0.9rem; margin-bottom: 5px; }
        .ideology-box { padding: 10px; border-radius: 6px; background: #f9f9f9; border: 1px solid #eee; margin-top: 5px; }
        .edit-btn { font-size: 0.8rem; color: var(--primary); cursor: pointer; text-decoration: underline; background: none; border: none; padding: 0; }
        
        .rank-list { display: flex; flex-direction: column; gap: 10px; }
        .rank-item { display: flex; align-items: center; background: #f8f9fa; padding: 10px 15px; border-radius: 8px; border: 1px solid #eee; }
        .rank-num { width: 40px; font-weight: bold; font-size: 1.2rem; color: #999; text-align: center; margin-right: 10px; }
        .rank-1 { color: #f1c40f; font-size: 1.5rem; }
        .rank-2 { color: #bdc3c7; font-size: 1.4rem; }
        .rank-3 { color: #e67e22; font-size: 1.3rem; }
        .rank-info { flex: 1; }
        .rank-name { font-weight: bold; font-size: 1.05rem; }
        .rank-val { font-weight: bold; color: #27ae60; font-family: monospace; font-size: 1.1rem; }
        
        .job-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .job-name { font-weight: bold; }
        .job-wage { color: #e67e22; font-weight: bold; }
        .job-loc { font-size: 0.85rem; color: #999; }
        
        .job-section-header { padding: 8px; font-weight: bold; background: #f0f2f5; border-left: 4px solid #333; margin-top: 15px; margin-bottom: 5px; border-radius: 4px; }
        
        /* æ‹¨æ¬¾/æ“ä½œå¼¹çª—æ ·å¼ */
        .fund-list { display: flex; flex-direction: column; gap: 5px; }
        .fund-item { padding: 8px; background: #f9f9f9; border-radius: 4px; cursor: pointer; border: 1px solid #eee; transition: 0.2s; }
        .fund-item:hover { background: #eef5ff; border-color: var(--primary); }
        .fund-item.selected { background: var(--primary); color: white; border-color: var(--primary); }
        
        .action-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px; }
        .action-btn { padding: 8px; border: 1px solid #ddd; border-radius: 5px; background: #f8f9fa; cursor: pointer; font-size: 0.9rem; transition: 0.2s; text-align: center; }
        .action-btn:hover { background: #e1e4e8; border-color: #ccc; }

        /* æ´»åŠ¨ç­–åˆ’å¡ç‰‡ */
        .event-card { display: flex; flex-direction: column; background: #f8f9fa; border: 1px solid #eee; border-radius: 6px; padding: 10px; gap: 5px; transition: 0.2s; }
        .event-card:hover { border-color: var(--primary); background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .event-header { display: flex; justify-content: space-between; align-items: center; }
        .event-name { font-weight: bold; font-size: 1.1rem; }
        .event-cost { font-weight: bold; color: #e67e22; background: #fff3e0; padding: 2px 6px; border-radius: 4px; font-size: 0.9rem; }
        .event-desc { font-size: 0.9rem; color: #666; margin: 5px 0; min-height: 32px; }
        .event-btn { background: var(--primary); color: white; border: none; padding: 6px; border-radius: 4px; cursor: pointer; width: 100%; font-weight: bold; }
        .event-btn:hover { opacity: 0.9; }
        .event-btn:disabled { background: #ccc; cursor: not-allowed; }

        .staff-list-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee; background: #f9f9f9; align-items: center; }
        .staff-role { font-weight: bold; color: #2d3436; margin-right: 5px; }
        .staff-name { color: #0984e3; font-weight: bold; }
        
        /* ç‰©å“ä¸èƒŒåŒ… */
        .bag-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 5px; margin-top: 5px; }
        .bag-item { background: #fff5f0; border: 1px solid #e17055; border-radius: 4px; padding: 5px; text-align: center; font-size: 0.8rem; color: #d35400; cursor:help; }
        
        .history-list { font-size: 0.85rem; color: #555; background: #f8f9fa; border-radius: 6px; padding: 8px; border: 1px solid #eee; max-height: 150px; overflow-y: auto; }
        .history-item { padding: 4px 0; border-bottom: 1px dashed #e0e0e0; }
        .history-item:last-child { border-bottom: none; }
        .history-time { color: #999; font-size: 0.8em; margin-right: 5px; font-family: monospace; }

        .tooltip-item { position: relative; cursor: help; }
        .tooltip-item:hover::after {
            content: attr(data-tip);
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: #fff;
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            white-space: pre-wrap;
            z-index: 9999;
            width: max-content;
            max-width: 220px;
            line-height: 1.4;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            pointer-events: none;
        }
        .tooltip-item:hover::before {
            content: "";
            position: absolute;
            bottom: 110%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.85) transparent transparent transparent;
            z-index: 9999;
        }

        .skill-row { display: flex; align-items: center; margin-bottom: 6px; font-size: 0.85rem; }
        .skill-name { width: 60px; font-weight: bold; color: #555; }
        .skill-track { flex: 1; height: 8px; background: #eee; border-radius: 4px; overflow: hidden; margin: 0 10px; }
        .skill-bar { height: 100%; border-radius: 4px; transition: width 0.3s; }
        .skill-val { width: 30px; text-align: right; color: #777; }
        .sk-social { background: #e84393; }
        .sk-craft { background: #e67e22; }
        .sk-intel { background: #0984e3; }
        .sk-str { background: #2d3436; }
        
        /* é€‰é¡¹å¡è¿‡æ»¤å™¨æ ·å¼ */
        .tab-filter { display:flex; gap:5px; margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px; }
        .filter-btn { background:none; border:none; cursor:pointer; padding:5px 10px; font-weight:bold; color:#999; border-bottom:3px solid transparent; transition:0.2s; }
        .filter-btn.active { color:var(--primary); border-bottom-color:var(--primary); }
        .filter-btn:hover { color:#666; }

        /* æˆå°±ç³»ç»Ÿæ ·å¼ */
        .achieve-list { display: flex; flex-direction: column; gap: 10px; }
        .achieve-item { display: flex; align-items: center; background: #f8f9fa; padding: 12px; border-radius: 8px; border: 1px solid #eee; opacity: 0.5; filter: grayscale(1); transition: 0.3s; }
        .achieve-item.unlocked { opacity: 1; filter: grayscale(0); border-left: 5px solid #f1c40f; background: #fffff0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .achieve-icon { font-size: 2rem; margin-right: 15px; width: 40px; text-align: center; }
        .achieve-info { flex: 1; }
        .achieve-title { font-weight: bold; font-size: 1.1rem; margin-bottom: 4px; color: #2c3e50; }
        .achieve-desc { font-size: 0.9rem; color: #7f8c8d; }
        .achieve-reward { font-size: 0.85rem; color: #e67e22; margin-top: 4px; font-weight: bold; }

    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body>

<header>
    <div class="header-group">
        <h1>ğŸ¡ çŒ«ã®æ¨¡æ‹Ÿå°é•‡ <small>Ver 2.8.0</small></h1>
        <div style="font-size: 0.9rem;">
            <span id="calendar-display">ğŸ“… 1æœˆ1æ—¥ (å†¬)</span> <span id="weather-display" style="margin-left:5px; color:#0984e3;"></span> |
            <span id="game-day">å‘¨ä¸€</span> |
            <span>ğŸ•’ <span id="game-time">08:00</span></span> <button class="btn speed" onclick="toggleSpeed()" id="speed-btn">â¸ æ­£å¸¸</button> |
            <span>ğŸ‘¥ å±…æ°‘: <span id="resident-count">0</span></span> | 
            <span>ğŸ’° é•‡åº“: <span id="town-money">0</span> <button class="btn fund" onclick="showEmbezzle()">ğŸ’¸ æ‹¨æ¬¾</button></span>
        </div>
    </div>
    <div class="header-group">
        <button class="btn create" onclick="inputNewResident()">â• å…¥ä½æ–°å±…æ°‘</button>
        <button class="btn purple" onclick="showTownEvents()">ğŸ‰ ä¸¾åŠæ´»åŠ¨</button>
        <button class="btn achieve" onclick="showAchievements()">ğŸ† æˆå°±</button>
        <button class="btn gold" onclick="showLeaderboard()">ğŸ“Š æ’è¡Œæ¦œ</button>
        <button class="btn cyan" onclick="showJobBoard()">ğŸ“‹ å·¥ä½œæ¦œ</button>
        <button class="btn" onclick="showPersonalityInfo()">ğŸ“– æ€§æ ¼è¯´æ˜</button>
        <button class="btn" onclick="toggleRelationView()">â¤ å…³ç³»è°±</button>
        <span style="font-size:0.8rem;">è‡ªåŠ¨å­˜æ¡£: <input type="number" id="autosave-rate" value="30" min="5">ç§’</span>
        <button class="btn save" onclick="manualSave()">ğŸ’¾ å­˜æ¡£</button>
        <button class="btn reset" onclick="resetData()">ğŸ—‘ é‡ç½®</button>
    </div>
</header>

<div class="tab-nav">
    <button class="tab-btn active" onclick="switchTab('residents')" id="tab-residents">ğŸ‘¥ å±…æ°‘çŠ¶æ€</button>
    <button class="tab-btn" onclick="switchTab('buildings')" id="tab-buildings">ğŸ—ï¸ å°é•‡å»ºè®¾</button>
</div>

<div class="game-container" id="main-view">
    <div class="col-view active-view" id="view-residents">
        <div class="section-title">å±…æ°‘ç”Ÿæ´»åœˆ <small style="font-weight:normal; font-size:0.8em; color:#999;">(ç‚¹å‡»å¡ç‰‡æŸ¥çœ‹è¯¦æƒ…)</small></div>
        <div class="char-grid" id="char-list"></div>
    </div>

    <div class="col-view" id="view-buildings">
        <div class="section-title">å…¬å…±è®¾æ–½å»ºè®¾ <small style="font-weight:normal; font-size:0.8em; color:#999;">(ç‚¹å‡»å»ºç­‘æŸ¥çœ‹å‘˜å·¥ä¸å·¥èµ„)</small></div>
        <div class="build-grid" id="build-list"></div>
    </div>

    <div class="col-right" id="game-log">
        <div class="log-entry">âœ¨ æ¸¸æˆå¼€å§‹ã€‚Ver 2.8.0 æˆå°±ä¸æ–°å»ºç­‘ç‰ˆã€‚</div>
    </div>
</div>

<div class="relation-view" id="relation-view">
    <div style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:center">
        <h2 style="margin:0; font-size:1.2rem">â¤ å±…æ°‘å…³ç³»è°±</h2>
        <button class="btn" onclick="toggleRelationView()">ğŸ”™ è¿”å›å°é•‡</button>
    </div>
    <div id="rel-stats" style="background:#f8f9fa; padding:10px; border-radius:6px; margin-bottom:15px; font-size:0.9rem; display:flex; gap:20px; border:1px solid #eee;">
        <span style="color:#e17055">ğŸ”¥ <b>äººæ°”ç‹:</b> <span id="stat-pop">è®¡ç®—ä¸­...</span></span>
        <span style="color:#636e72">ğŸ‚ <b>å°é€æ˜:</b> <span id="stat-lonely">è®¡ç®—ä¸­...</span></span>
    </div>
    <div class="rel-layout">
        <div class="rel-graph" id="rel-graph-container"><canvas id="rel-canvas"></canvas></div>
        <div class="rel-list" id="rel-list"></div>
    </div>
</div>

<div class="modal-overlay" id="personality-modal"><div class="modal-content"><div class="modal-header"><h3>ğŸ“– æ€§æ ¼ç³»ç»Ÿè¯´æ˜</h3><button class="modal-close" onclick="closePersonalityInfo()">Ã—</button></div><div class="personality-list" id="personality-list"></div></div></div>
<div class="modal-overlay" id="char-detail-modal"><div class="modal-content"><div class="modal-header"><h3 id="detail-name">è§’è‰²è¯¦æƒ…</h3><button class="modal-close" onclick="closeCharDetail()">Ã—</button></div><div id="detail-content"></div></div></div>

<div class="modal-overlay" id="leaderboard-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ“Š å°é•‡æ’è¡Œæ¦œ</h3>
            <button class="modal-close" onclick="closeLeaderboard()">Ã—</button>
        </div>
        <div style="margin-bottom:15px; display:flex; gap:10px; flex-wrap: wrap;">
            <button class="btn" onclick="renderLeaderboard('money')">ğŸ’° è´¢å¯Œæ¦œ</button>
            <button class="btn" onclick="renderLeaderboard('happiness')" style="background:#2ecc71">â¤ å¹¸ç¦æ¦œ</button>
            <button class="btn" onclick="renderLeaderboard('popularity')" style="background:#a55eea">ğŸ”¥ äººæ°”æ¦œ</button>
            <button class="btn" onclick="renderLeaderboard('robbery')" style="background:#2d3436; color:white;">ğŸ”ª æŠ¢åŠ«æ¦œ</button>
            <button class="btn" onclick="renderLeaderboard('streetwalk')" style="background:#e056fd; color:white;">ğŸ’‹ ç«™è¡—æ¦œ</button>
            <button class="btn" onclick="renderLeaderboard('assault')" style="background:#c0392b; color:white;">ğŸ˜ˆ åŠ«è‰²æ¦œ</button>
        </div>
        <div id="leaderboard-list" class="rank-list"></div>
    </div>
</div>

<div class="modal-overlay" id="achievements-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ† è£èª‰æˆå°±é¦†</h3>
            <button class="modal-close" onclick="closeAchievements()">Ã—</button>
        </div>
        <div id="achievements-list" class="achieve-list"></div>
    </div>
</div>

<div class="modal-overlay" id="jobboard-modal"><div class="modal-content"><div class="modal-header"><h3>ğŸ“‹ äººæ‰å¸‚åœº & å·¥ä½œæ¦œ</h3><button class="modal-close" onclick="closeJobBoard()">Ã—</button></div><div id="jobboard-list"></div></div></div>
<div class="modal-overlay" id="embezzle-modal"><div class="modal-content"><div class="modal-header"><h3>ğŸ’¸ é•‡åº“æ‹¨æ¬¾</h3><button class="modal-close" onclick="closeEmbezzle()">Ã—</button></div><div style="margin-bottom:15px;"><p>å½“å‰é•‡åº“èµ„é‡‘: <span id="embezzle-town-money" style="font-weight:bold; color:#f1c40f;">0</span></p><p>é€‰æ‹©æ‹¨æ¬¾å¯¹è±¡:</p><div id="embezzle-list" class="fund-list" style="max-height:200px; overflow-y:auto; margin-bottom:10px; border:1px solid #eee; padding:5px;"></div><div style="display:flex; gap:10px; align-items:center;"><span>é‡‘é¢:</span><input type="number" id="embezzle-amount" value="100" style="width:100px;"><button class="btn save" onclick="doEmbezzle()">ç¡®è®¤æ‹¨æ¬¾</button></div></div></div></div>
<div class="modal-overlay" id="action-select-modal"><div class="modal-content"><div class="modal-header"><h3>ğŸ•¹ï¸ å¼ºåˆ¶å®‰æ’æ´»åŠ¨</h3><button class="modal-close" onclick="closeActionSelect()">Ã—</button></div><div id="action-select-content"></div></div></div>
<div class="modal-overlay" id="town-event-modal">
    <div class="modal-content">
        <div class="modal-header"><h3>ğŸ‰ æ´»åŠ¨ç­–åˆ’éƒ¨</h3><button class="modal-close" onclick="closeTownEvents()">Ã—</button></div>
        <div class="tab-filter">
            <button class="filter-btn active" id="evt-tab-normal" onclick="switchEventTab('normal')">å¸¸è§„æ´»åŠ¨</button>
            <button class="filter-btn" id="evt-tab-season" onclick="switchEventTab('season')">å­£èŠ‚é™å®š</button>
        </div>
        <p style="color:#666; font-size:0.9rem; margin-bottom:15px;">å½“å‰é•‡åº“: <span id="event-town-money" style="font-weight:bold; color:#f1c40f; font-size:1.1rem;">0</span> (å½“å‰å­£èŠ‚: <span id="event-season-name"></span>)</p>
        <div id="town-event-list" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(240px, 1fr)); gap:12px;"></div>
    </div>
</div>
<div class="modal-overlay" id="building-detail-modal"><div class="modal-content"><div class="modal-header"><h3 id="b-detail-name">å»ºç­‘è¯¦æƒ…</h3><button class="modal-close" onclick="closeBuildingDetail()">Ã—</button></div><div id="b-detail-content"></div></div></div>

<script>
    // --- é…ç½®æ•°æ® ---
    const NAMES = ["è€„è€‹", "æ›¼æ³¢", "å“ˆåŸºç±³", "æœçŒ«", "æš–æ³ª", "æ²å¤", "sans", "æ—¶è‹", "å°ç¿", "æ ¢æŸ“", "äº‘ç»’", "ç›å¡å·´å¡", "çŒ«å†¬", "æ— å", "æ–—ç½—", "CPU0", "é—ªæŸ ", "æ°˜é•‰æ®†", "ç©ºé›¶", "å°æ ¼è•¾ä¿®"];
    
    const ITEMS_DB = {
        "rose": { name: "ğŸŒ¹ ç«ç‘°", price: 50, type: "gift", loveBonus: 15, desc: "èµ äººç«ç‘°ï¼Œæ‰‹æœ‰ä½™é¦™" },
        "baozi_tofu": { name: "ğŸ¥Ÿ è±†è…åŒ…", price: 2, type: "food", hungerBonus: 10, desc: "ç´ é£Ÿä¸»ä¹‰è€…çš„æœ€çˆ±" },
        "baozi_pork": { name: "ğŸ¥© çŒªè‚‰åŒ…", price: 4, type: "food", hungerBonus: 20, desc: "çš®è–„é¦…å¤§æ±å¤š" },
        "baozi_beef": { name: "ğŸ® ç‰›è‚‰åŒ…", price: 5, type: "food", hungerBonus: 25, desc: "å®å®åœ¨åœ¨çš„ç‰›è‚‰" },
        "water_wahaha": { name: "ğŸ¥¤ å¨ƒå“ˆå“ˆ", price: 2, type: "drink", hungerBonus: 2, happinessBonus: 1, desc: "ç«¥å¹´çš„å‘³é“" },
        "water_ganten": { name: "ğŸ’§ ç™¾å²å±±", price: 4, type: "drink", hungerBonus: 2, happinessBonus: 3, desc: "æ°´ä¸­è´µæ—" },
        "noodle_beef": { name: "ğŸœ åº·å¸ˆå‚…", price: 5, type: "food", hungerBonus: 30, desc: "çº¢çƒ§ç‰›è‚‰é¢ï¼Œå°±æ˜¯è¿™ä¸ªå‘³" },
        "chips_lays": { name: "ğŸ¥” ä¹äº‹è–¯ç‰‡", price: 6, type: "snack", hungerBonus: 5, happinessBonus: 5, desc: "åŸå‘³æœ€ç»å…¸" },
        "cola_pepsi": { name: "ğŸ¥¤ æ—¥æœ¬ç”Ÿå¯ä¹", price: 5, type: "drink", hungerBonus: 3, happinessBonus: 4, desc: "å¬è¯´å¾ˆå¥½å–" },
        "coffee_instant": { name: "â˜• é€Ÿæº¶å’–å•¡", price: 6, type: "drink", hungerBonus: 2, happinessBonus: 5, desc: "æç¥é†’è„‘" },
        "sushi_box": { name: "ğŸ± å¯¿å¸æ‹¼ç›˜", price: 12, type: "food", hungerBonus: 35, happinessBonus: 3, desc: "ä¾¿åˆ©åº—çš„é«˜çº§è´§" },
        "beer_tsingtao": { name: "ğŸº é’å²›å•¤é…’", price: 6, type: "alcohol", hungerBonus: 2, happinessBonus: 6, desc: "å“ˆå•¤é…’åƒå˜å•¦" },
        "beer_laoshan": { name: "ğŸº å´‚å±±å•¤é…’", price: 5, type: "alcohol", hungerBonus: 2, happinessBonus: 5, desc: "ç”šè‡³èƒ½å½“æ°´å–" },
        "cocktail": { name: "ğŸ¸ é¸¡å°¾é…’", price: 25, type: "alcohol", hungerBonus: -2, happinessBonus: 15, desc: "è‰²å½©æ–‘æ–“çš„å¾®é†º" },
        "bloody_mary": { name: "ğŸ¹ è¡€è…¥ç›ä¸½", price: 30, type: "alcohol", hungerBonus: -2, happinessBonus: 18, desc: "å£å‘³ç‹¬ç‰¹çš„ç»å…¸" },
        "rum": { name: "ğŸ¥ƒ æœ—å§†é…’", price: 35, type: "alcohol", hungerBonus: -3, happinessBonus: 20, desc: "æµ·ç›—çš„æœ€çˆ±" },
        "tequila": { name: "ğŸŒµ é¾™èˆŒå…°", price: 40, type: "alcohol", hungerBonus: -3, happinessBonus: 22, desc: "èˆ”ä¸€å£ç›ï¼Œå¹²ä¸€æ¯é…’" },
        "whisky": { name: "ğŸ¥ƒ å¨å£«å¿Œ", price: 50, type: "alcohol", hungerBonus: -4, happinessBonus: 25, desc: "ç”·äººçš„æµªæ¼«" },
        "bandage": { name: "ğŸ©¹ ç»·å¸¦", price: 10, type: "medicine", healthBonus: 8, desc: "å¤„ç†è½»å¾®å¤–ä¼¤" },
        "painkiller": { name: "ğŸ’Š æ­¢ç—›è¯", price: 15, type: "medicine", healthBonus: 15, happinessBonus: 2, desc: "ç¼“è§£ç–¼ç—›ï¼Œå±…å®¶å¿…å¤‡" },
        "digestion_tablets": { name: "ğŸŒ¿ å¥èƒƒæ¶ˆé£Ÿç‰‡", price: 12, type: "medicine", healthBonus: 5, hungerBonus: 5, desc: "åƒæ’‘äº†ï¼Ÿæ¥ä¸€ç‰‡" },
        "cold_medicine": { name: "ğŸ§ª æ„Ÿå†’çµ", price: 20, type: "medicine", healthBonus: 20, desc: "æš–æš–çš„å¾ˆè´´å¿ƒ" },
        "anti_inflammatory": { name: "ğŸ”¬ æ¶ˆç‚è¯", price: 25, type: "medicine", healthBonus: 25, desc: "é’ˆå¯¹å„ç±»ç‚ç—‡" },
        "fever_medicine": { name: "ğŸŒ¡ï¸ é€€çƒ§è¯", price: 35, type: "medicine", healthBonus: 35, desc: "é«˜çƒ§ä¸é€€æ—¶çš„æ•‘æ˜Ÿ" }
    };

    const WEATHER_TYPES = {
        'Sunny': { name: 'â˜€ æ™´æœ—', mood: 0.5, health: 0, desc: 'é˜³å…‰æ˜åªšï¼Œå¿ƒæƒ…èˆ’ç•…' },
        'Cloudy': { name: 'â˜ é˜´å¤©', mood: 0, health: 0, desc: 'ä¸å†·ä¸çƒ­ï¼Œé€‚åˆå‡ºè¡Œ' },
        'Rainy': { name: 'ğŸŒ§ å°é›¨', mood: -1, health: -0.5, desc: 'å‡ºé—¨è®°å¾—å¸¦ä¼ï¼Œå¿ƒæƒ…æœ‰äº›ä½è½' },
        'Storm': { name: 'â›ˆ æš´é›¨', mood: -3, health: -1, desc: 'ç³Ÿç³•çš„å¤©æ°”ï¼Œå®¹æ˜“ç”Ÿç—…' },
        'Snowy': { name: 'â„ ä¸‹é›ª', mood: 1, health: -2, desc: 'ç¾ä¸½çš„é›ªæ™¯ï¼Œä½†å°å¿ƒç€å‡‰' },
        'Heatwave': { name: 'ğŸ”¥ çƒ­æµª', mood: -2, health: -1, desc: 'é«˜æ¸©é¢„è­¦ï¼Œæ³¨æ„é˜²æš‘' },
        'Foggy': { name: 'ğŸŒ« å¤§é›¾', mood: -0.5, health: -0.5, desc: 'èƒ½è§åº¦ä½ï¼Œç©ºæ°”ä¸å¥½' }
    };

    const ACHIEVEMENTS_DB = [
        { id: 'first_build', name: 'ğŸ—ï¸ å¥ åŸºäºº', desc: 'å»ºæˆå°é•‡çš„ç¬¬ä¸€åº§å»ºç­‘', reward: 500, icon: 'ğŸ—ï¸' },
        { id: 'first_marriage', name: 'ğŸ‘©â€â¤ï¸â€ğŸ’‹â€ğŸ‘¨ ç¥ä»™çœ·ä¾£', desc: 'è¯ç”Ÿç¬¬ä¸€å¯¹ç¡®è®¤å…³ç³»çš„æƒ…ä¾£', reward: 300, icon: 'â¤ï¸' },
        { id: 'first_crime', name: 'ğŸ˜ˆ ç½ªæ¶éƒ½å¸‚', desc: 'å‘ç”Ÿäº†ç¬¬ä¸€èµ·æŠ¢åŠ«æˆ–éªšæ‰°æ¡ˆä»¶', reward: 200, icon: 'ğŸ˜ˆ' },
        { id: 'rich_town', name: 'ğŸ’° å°åº·ç¤¾ä¼š', desc: 'é•‡åº“èµ„é‡‘è¾¾åˆ° 5000', reward: 1000, icon: 'ğŸ’°' },
        { id: 'first_gym', name: 'ğŸ’ª è‡ªå¾‹è¾¾äºº', desc: 'å»ºæˆå¥èº«æˆ¿ï¼Œå¼€å§‹å…¨æ°‘å¥èº«', reward: 300, icon: 'ğŸ’ª' },
        { id: 'culture_hub', name: 'ğŸ› æ–‡åŒ–ä¸­å¿ƒ', desc: 'å»ºæˆåšç‰©é¦†ï¼Œæå‡å°é•‡æ–‡åŒ–åº•è•´', reward: 400, icon: 'ğŸ›' }
    ];

    function getItemTooltipText(itemId) {
        const item = ITEMS_DB[itemId];
        if (!item) return "";
        let parts = [];
        parts.push(item.desc);
        parts.push("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
        if (item.type === 'gift') {
            parts.push(`ğŸ’— å¢åŠ å¥½æ„Ÿ: +${item.loveBonus || 0}`);
        } else if (item.type === 'medicine') {
            parts.push(`ğŸš‘ æ¢å¤å¥åº·: +${item.healthBonus || 0}`);
            if (item.happinessBonus) parts.push(`â¤ å¿ƒæƒ…å€¼: +${item.happinessBonus}`);
        } else {
            if (item.hungerBonus !== undefined && item.hungerBonus !== 0) {
                const sign = item.hungerBonus > 0 ? '+' : '';
                parts.push(`ğŸ— é¥±é£Ÿåº¦: ${sign}${item.hungerBonus}`);
            }
            if (item.happinessBonus !== undefined && item.happinessBonus !== 0) {
                const sign = item.happinessBonus > 0 ? '+' : '';
                parts.push(`â¤ å¿ƒæƒ…å€¼: ${sign}${item.happinessBonus}`);
            }
        }
        parts.push(`ğŸ’° ä»·å€¼: ${item.price}`);
        return parts.join('\n');
    }
    
    function getJobSkillType(role) {
        if (role.includes("å¨") || role.includes("æ‹‰é¢") || role.includes("èŠ±è‰º") || role.includes("æ—©ç‚¹") || role.includes("æŠ€å¸ˆ")) return 'craft';
        if (role.includes("åŒ»") || role.includes("è€å¸ˆ") || role.includes("ç¥çˆ¶") || role.includes("å›¾ä¹¦") || role.includes("ç½‘ç®¡") || role.includes("è®²è§£")) return 'intel';
        if (role.includes("è­¦") || role.includes("ä¿å®‰") || role.includes("æ¬ç –") || role.includes("ä¿æ´") || role.includes("è·‘å ‚") || role.includes("å¤–å–") || role.includes("æ•™ç»ƒ") || role.includes("æ£€ç¥¨")) return 'strength';
        return 'social'; 
    }

    function getLevelInfo(skillVal) {
         if (skillVal < 20) return { level: 0, multiplier: 0.8, title: "è§ä¹ ", next: 20 };
         if (skillVal < 50) return { level: 1, multiplier: 1.0, title: "æ­£å¼", next: 50 };
         if (skillVal < 80) return { level: 2, multiplier: 1.3, title: "èµ„æ·±", next: 80 };
         return { level: 3, multiplier: 1.6, title: "å¤§å¸ˆ", next: 100 };
    }

    const BUILDINGS_BLUEPRINT = [
        { id: "baozi", name: "ğŸ¥¯ åŒ…å­é“º", category: "food", cost: 100, desc: "ç‰©ç¾ä»·å»‰çš„æ—©é¤åº—", effect: "shop", price: 0, open: 5, close: 14, jobs: ["æ—©ç‚¹å·¥"], sells: ["baozi_tofu", "baozi_pork", "baozi_beef"] }, 
        { id: "ramen", name: "ğŸœ å…°å·æ‹‰é¢", category: "food", cost: 250, desc: "æ­£å®—ç‰›è‚‰é¢ï¼Œç®¡é¥±", effect: "food", price: 12, food: 35, open: 7, close: 22, jobs: ["æ‹‰é¢å¸ˆå‚…"] },
        { id: "711", name: "ğŸª 7-11ä¾¿åˆ©åº—", category: "food", cost: 300, desc: "24å°æ—¶è¥ä¸š", effect: "shop", price: 0, open: 0, close: 24, jobs: ["æ”¶é“¶å‘˜"], sells: ["water_wahaha", "water_ganten", "noodle_beef", "chips_lays", "cola_pepsi", "coffee_instant", "sushi_box", "beer_tsingtao", "beer_laoshan"] },
        { id: "kfc", name: "ğŸ— è‚¯å¾·åŸº", category: "food", cost: 600, desc: "ç–¯ç‹‚æ˜ŸæœŸå››", effect: "food", price: 30, food: 50, open: 10, close: 22, jobs: ["å‰å°", "ç‚¸é¸¡å¨å¸ˆ"] },
        { id: "gym", name: "ğŸ’ª å¥èº«æˆ¿", category: "fun", cost: 800, desc: "æŒ¥æ´’æ±—æ°´ï¼Œæå‡é¢œå€¼ä¸å¥åº·", effect: "beauty", price: 50, open: 6, close: 22, jobs: ["å¥èº«æ•™ç»ƒ", "ä¿æ´"] },
        { id: "amusement", name: "ğŸ¡ æ¸¸ä¹åœº", category: "fun", cost: 2000, desc: "å……æ»¡å°–å«ä¸æ¬¢ç¬‘çš„åœ°æ–¹", effect: "fun_high", price: 100, open: 9, close: 20, jobs: ["æ£€ç¥¨å‘˜", "ç©å¶æ‰®æ¼”"] },
        { id: "museum", name: "ğŸ› åšç‰©é¦†", category: "fun", cost: 1200, desc: "å†å²çš„æ²‰æ·€ï¼Œå¢é•¿è§è¯†", effect: "study", price: 40, open: 9, close: 17, jobs: ["è®²è§£å‘˜", "ä¿å®‰"], closedDays: [1] },
        { id: "police", name: "ğŸ‘® æ´¾å‡ºæ‰€", category: "service", cost: 800, desc: "ç»´æŠ¤å°é•‡æ²»å®‰", effect: "security", price: 0, open: 0, close: 24, jobs: ["è­¦å¯Ÿ", "è­¦å¯Ÿ"] }, 
        { id: "hospital", name: "ğŸ¥ ç»¼åˆåŒ»é™¢", category: "service", cost: 1500, desc: "è®¾å¤‡å…ˆè¿›çš„åŒ»ç–—ä¸­å¿ƒ", effect: "health", price: 80, open: 0, close: 24, jobs: ["ä¸»æ²»åŒ»å¸ˆ", "æŠ¤å£«", "ä¿æ´"] },
        { id: "clinic", name: "ğŸ’Š ç¤¾åŒºè¯Šæ‰€", category: "service", cost: 400, desc: "æ–¹ä¾¿å¿«æ·çš„å°è¯Šæ‰€", effect: "shop", price: 0, open: 8, close: 20, jobs: ["ç¤¾åŒºåŒ»ç”Ÿ", "æŠ¤å£«"], sells: ["bandage", "painkiller", "digestion_tablets", "cold_medicine", "anti_inflammatory", "fever_medicine"] },
        { id: "school", name: "ğŸ« å°é•‡å­¦æ ¡", category: "service", cost: 1000, desc: "çŸ¥è¯†å°±æ˜¯åŠ›é‡", effect: "study", price: 0, open: 7, close: 17, jobs: ["è¯­æ–‡è€å¸ˆ", "æ•°å­¦è€å¸ˆ", "ä½“è‚²è€å¸ˆ", "ä¿å®‰"], closedDays: [0, 6] },
        { id: "library", name: "ğŸ“š å›¾ä¹¦é¦†", category: "fun", cost: 500, desc: "é™è°§çš„é˜…è¯»æ—¶å…‰", effect: "study", price: 0, open: 9, close: 21, jobs: ["å›¾ä¹¦ç®¡ç†å‘˜", "ä¿æ´"] },
        { id: "church", name: "â›ª å©šç¤¼æ•™å ‚", category: "service", cost: 1200, desc: "ç¥åœ£ä¹‹åœ°", effect: "marriage", price: 20, open: 8, close: 20, jobs: ["ç¥çˆ¶"] },
        { id: "park", name: "ğŸŒ³ ä¸­å¿ƒå…¬å›­", category: "fun", cost: 200, desc: "å…è´¹ä¼‘é—²", effect: "romance", price: 0, open: 0, close: 24, jobs: [] },
        { id: "netcafe", name: "ğŸ® éº¦å…‹ç”µç«", category: "fun", cost: 450, desc: "é€šå®µå¼€é»‘", effect: "fun", price: 15, open: 0, close: 24, jobs: ["ç½‘ç®¡", "ç½‘å§ä¿æ´"] },
        { id: "cinema", name: "ğŸ¬ ç”µå½±é™¢", category: "fun", cost: 400, desc: "æ¢å¤å¿ƒæƒ…å¿«", effect: "fun", price: 40, open: 10, close: 24, jobs: ["å”®ç¥¨å‘˜"] },
        { id: "bar", name: "ğŸº æ·±å¤œé…’å§", category: "fun", cost: 500, desc: "ä¹°é†‰æ¶ˆæ„", effect: "shop", price: 50, open: 18, close: 2, jobs: ["è€æ¿", "å¤§å¨", "è·‘å ‚"], closedDays: [0], sells: ["beer_tsingtao", "cocktail", "bloody_mary", "rum", "tequila", "whisky"] },
        { id: "footshop", name: "ğŸ’† ç¥ç§˜æ´—è„šåº—", category: "fun", cost: 600, desc: "æ¶©æƒ…äº¤æ˜“åœºæ‰€", effect: "ntr", price: 0, open: 0, close: 24, jobs: ["è€æ¿"] },
        { id: "hotel", name: "ğŸ© å¿«æ·é…’åº—", category: "fun", cost: 800, desc: "æ‡‚å¾—éƒ½æ‡‚", effect: "ntr", price: 100, open: 0, close: 24, jobs: ["å‰å°", "ä¿æ´"] },
        { id: "flowershop", name: "ğŸŒ¹ æµªæ¼«èŠ±åº—", category: "shop", cost: 300, desc: "è´­ä¹°é²œèŠ±é€ç»™å¿ƒä¸Šäºº", effect: "shop", price: 50, open: 9, close: 20, jobs: ["èŠ±è‰ºå¸ˆ"], sells: ["rose"] }
    ];

    const CATEGORY_NAMES = { 'food': 'ğŸ” é¥®é£Ÿé¤é¥®', 'service': 'ğŸ¥ å…¬å…±æœåŠ¡', 'fun': 'ğŸ¡ ä¼‘é—²å¨±ä¹', 'shop': 'ğŸ›ï¸ å•†ä¸šè´­ç‰©' };

    const DAYS = ["å‘¨æ—¥", "å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­"];
    const TRAITS = [{id:"sleepy",name:"å–œæ¬¢ç¡è§‰",desc:"ç¡çœ æ—¶é—´æ›´é•¿"},{id:"promiscuous",name:"æ·«ä¹±",desc:"æ›´å®¹æ˜“äº¤æ¬¢ï¼Œå¢åŠ é¢œå€¼"},{id:"money-loving",name:"çˆ±é’±",desc:"æ›´çæƒœé‡‘é’±"}];
    const PERSONALITIES = [{name:"æ˜“æ€’",chaosBonus:0.3,loveGain:-0.5,desc:"è„¾æ°”æš´èº"},{name:"æ²‰ç€",chaosBonus:-0.2,loveGain:0.3,desc:"å†·é™ç†æ™º"},{name:"å¼€æœ—",chaosBonus:-0.1,loveGain:0.5,desc:"ä¹è§‚å¤–å‘"},{name:"å†…å‘",chaosBonus:0.1,loveGain:-0.2,desc:"ä¸å–„ç¤¾äº¤"},{name:"æ¸©æŸ”",chaosBonus:-0.15,loveGain:0.4,desc:"æ¸©å’Œå‹å–„"},{name:"åˆ»è–„",chaosBonus:0.25,loveGain:-0.3,desc:"è¯´è¯å¸¦åˆº"},{name:"å¹½é»˜",chaosBonus:-0.1,loveGain:0.3,desc:"é£è¶£å¹½é»˜"},{name:"ä¸¥è‚ƒ",chaosBonus:0.05,loveGain:0,desc:"ä¸€æœ¬æ­£ç»"}];
    const IDEOLOGIES = [{name:"å…±äº§ä¸»ä¹‰",color:"#e74c3c",chaosMod:-0.3,loveMod:0.5,wageMod:0,desc:"è¿½æ±‚å…±åŒå¯Œè£•"},{name:"ç¤¾ä¼šä¸»ä¹‰",color:"#e74c3c",chaosMod:-0.25,loveMod:0.5,wageMod:0,desc:"å…¬å¹³æ­£ä¹‰ï¼Œå›¢ç»“äº’åŠ©"},{name:"æ°‘ä¸»ä¸»ä¹‰",color:"#3498db",chaosMod:-0.2,loveMod:0.6,wageMod:0,desc:"è‡ªç”±å¹³ç­‰"},{name:"èµ„æœ¬ä¸»ä¹‰",color:"#f1c40f",chaosMod:-0.1,loveMod:0.3,wageMod:0.07,desc:"é‡‘é’±è‡³ä¸Šï¼Œæ•ˆç‡ä¼˜å…ˆ"},{name:"å›ä¸»ç«‹å®ª",color:"#9b59b6",chaosMod:-0.15,loveMod:0.6,wageMod:0,desc:"ä¼ ç»Ÿä¸ç°ä»£"},{name:"å†›å›½ä¸»ä¹‰",color:"#2c3e50",chaosMod:0.1,loveMod:0,wageMod:0.1,desc:"æ­¦åŠ›è‡³ä¸Š"}];
    
    const ODD_JOBS = [
        {name:"æ¸…æ´å·¥",wage:5,mood:-3},
        {name:"å‘ä¼ å•",wage:4,mood:-2},
        {name:"æ¬ç –",wage:6,mood:-4},
        {name:"å¤–å–å‘˜",wage:8,mood:-5}, 
        {name:"æ´—ç¢—å·¥",wage:5,mood:-3}, 
        {name:"èººå¹³",wage:-3,mood:5}
    ];
    
    const REL_TRANSLATE = { 'friend': 'æœ‹å‹', 'stranger': 'é™Œç”Ÿäºº', 'bestfriend': 'æŒšå‹', 'lover': 'æƒ…ä¾£', 'spouse': 'é…å¶', 'mistress': 'å°ä¸‰', 'ex': 'å‰ä»»', 'enemy': 'ä»‡äºº' };
    const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    const choose = (arr) => arr[Math.floor(Math.random() * arr.length)];
    
const TOWN_EVENTS = [
        { id: 'concert', name: 'ğŸ¤ å·¨æ˜Ÿæ¼”å”±ä¼š', cost: 500, desc: 'å…¨å‘˜å¿«ä¹+20ï¼Œå…³ç³»+5ã€‚10%æ¦‚ç‡ç¿»è½¦æ•ˆæœå‡åŠã€‚', emoji: 'ğŸ¤' },
        { id: 'matchmaking', name: 'ğŸ’˜ é•‡ç«‹ç›¸äº²å¤§ä¼š', cost: 200, desc: 'æ‰€æœ‰å•èº«è€…å°è¯•è¡¨ç™½(æˆåŠŸç‡up)ï¼Œæˆå¯¹åå¿«ä¹+5ã€‚', emoji: 'ğŸ’˜' },
        { id: 'charity', name: 'ğŸ—ï¸ æ…ˆå–„å‹Ÿæ', cost: 0, desc: 'å±…æ°‘è‡ªæ„¿ææ¬¾ç»™é•‡åº“ï¼Œå¿«ä¹-5ï¼Œå…³ç³»+5ã€‚', emoji: 'ğŸ—ï¸' },
        { id: 'anniversary', name: 'ğŸˆ å°é•‡çºªå¿µæ—¥', cost: 100, desc: 'å…¨å‘˜å¿«ä¹+10ï¼Œå…³ç³»å¾®é‡æå‡ã€‚', emoji: 'ğŸˆ' },
        { id: 'fireworks', name: 'ğŸ† ç››å¤§çƒŸèŠ±ä¼š', cost: 250, desc: 'å…¨å‘˜å¿«ä¹+25ï¼Œå…³ç³»+5ã€‚5%æ¦‚ç‡å¼•å‘ç«ç¾çƒ§æ¯å»ºç­‘ã€‚', emoji: 'ğŸ†' },
        { id: 'jobfair', name: 'ğŸ¤ å¤§å‹æ‹›è˜ä¼š', cost: 150, desc: 'å¸®åŠ©æ— ä¸šæ¸¸æ°‘è‡ªåŠ¨å¡«è¡¥ç©ºç¼ºå²—ä½ï¼Œå…¥èŒå¿«ä¹+10ã€‚', emoji: 'ğŸ¤' },
        { id: 'artfest', name: 'ğŸ¨ è‰ºæœ¯èŠ‚', cost: 300, desc: 'å…¨å‘˜å¿«ä¹+15ï¼Œå…³ç³»+3ã€‚10%æ¦‚ç‡å‘ç”Ÿè‰ºæœ¯å“å¤±çªƒã€‚', emoji: 'ğŸ¨' },
        { id: 'marathon', name: 'ğŸƒ å…¨æ°‘é©¬æ‹‰æ¾', cost: 200, desc: 'å¿«ä¹+10ï¼Œé¥±é£Ÿ-10ã€‚5%æ¦‚ç‡æœ‰äººå—ä¼¤(å¿«ä¹-20)ã€‚', emoji: 'ğŸƒ' },
        { id: 'reading', name: 'ğŸ“š è¯»ä¹¦ä¼š', cost: 100, desc: 'å¿«ä¹+5ï¼Œå…³ç³»+2ã€‚20%æ¦‚ç‡è§¦å‘çŸ¥è¯†ç«èµ›èµ¢å®¶ã€‚', emoji: 'ğŸ“š' },
        { id: 'planting', name: 'ğŸŒ³ æ¤æ ‘èŠ‚', cost: 150, desc: 'å¿«ä¹+5ï¼Œå…³ç³»+3ã€‚10%æ¦‚ç‡æ ‘è‹—æ¯æ­»æ•ˆæœå‡åŠã€‚', emoji: 'ğŸŒ³' },
        { id: 'shopping', name: 'ğŸ›ï¸ è´­ç‰©èŠ‚', cost: 0, desc: 'åˆºæ¿€æ¶ˆè´¹ï¼å±…æ°‘æ¦‚ç‡èŠ±é’±ï¼Œé•‡åº“è·å¾—20%ç¨æ”¶ã€‚', emoji: 'ğŸ›ï¸' },
        // å­£èŠ‚é™å®šæ´»åŠ¨
        { id: 'matsuri', name: 'ğŸ® å¤æ—¥ç¥­', cost: 400, desc: 'å…¨å‘˜ç©¿æµ´è¡£åº†ç¥å¤å¤©ï¼å¿«ä¹å¤§å¹…æå‡ï¼Œå•èº«ç‹—å®¹æ˜“è„±å•ã€‚', emoji: 'ğŸ®', season: 'Summer' },
        { id: 'snowfest', name: 'â˜ƒï¸ å†°é›ªèŠ‚', cost: 350, desc: 'å †é›ªäººã€åƒç«é”…ï¼å¿«ä¹+15ï¼Œå¥åº·+10ï¼Œé¥±é£Ÿ+10ã€‚', emoji: 'â˜ƒï¸', season: 'Winter' }
    ];

    function getJobWage(role) { 
        if (role.includes("è€æ¿") || role.includes("ä¸»æ²»åŒ»å¸ˆ")) return 35; 
        if (role.includes("ç¥çˆ¶") || role.includes("ç¤¾åŒºåŒ»ç”Ÿ") || role.includes("è®²è§£")) return 25; 
        if (role.includes("è­¦å¯Ÿ") || role.includes("è€å¸ˆ") || role.includes("æ•™ç»ƒ")) return 22; 
        if (role.includes("å–é“¶")) return 20; 
        if (role.includes("å¤§å¨") || role.includes("æŠ¤å£«") || role.includes("ç©å¶")) return 18; 
        if (role.includes("èŠ±è‰º") || role.includes("ç‚¸é¸¡")) return 16; 
        if (role.includes("ç½‘ç®¡") || role.includes("ä¿å®‰")) return 15; 
        if (role.includes("å‰å°") || role.includes("å›¾ä¹¦ç®¡ç†å‘˜") || role.includes("æ£€ç¥¨")) return 14; 
        if (role.includes("æ‹‰é¢")) return 13; 
        if (role.includes("æ”¶é“¶") || role.includes("å”®ç¥¨")) return 12; 
        if (role.includes("ç½‘å§ä¿æ´") || role.includes("ä¿æ´") || role.includes("è·‘å ‚") || role.includes("æ—©ç‚¹")) return 10; 
        return 10; 
    }
    function getBaseJobWage(role) { return getJobWage(role); }

    class Character {
        constructor(name) {
            this.name = name; this.gender = Math.random() > 0.5 ? 'â™‚ ç”·' : 'â™€ å¥³'; this.happiness = 60; this.hunger = 80; this.health = 100; this.money = 0; this.job = null; this.currentAction = "å‘å‘†"; this.relationships = {}; this.partner = null; this.interactingWith = null; 
            this.personality = choose(PERSONALITIES); this.traits = []; this.ideology = choose(IDEOLOGIES);
            this.nextActionOverride = null; 
            this.bag = []; 
            this.history = [];
            this.jailTerm = 0; 
            this.skills = { social: rand(5, 15), craft: rand(5, 15), intel: rand(5, 15), strength: rand(5, 15) };
            this.stat_rob = 0;        
            this.stat_be_robbed = 0;  
            this.stat_streetwalk = 0; 
            this.stat_assault = 0;    
            this.stat_be_assaulted = 0; 

            const traitCount = rand(0, 2); for (let i = 0; i < traitCount; i++) { const availableTraits = TRAITS.filter(t => !this.traits.find(tt => tt.id === t.id)); if (availableTraits.length > 0) this.traits.push(choose(availableTraits)); }
            this.constructionContribution = {}; this.prostitute = null; 
            
            this.appearance = rand(40, 80); 
            if (this.hasTrait('promiscuous')) this.appearance += 15; 
            if (this.hasTrait('sleepy')) this.appearance += 5; 
            if (this.personality.name === 'å¼€æœ—') this.appearance += 5;
            if (this.personality.name === 'é˜´æ²‰') this.appearance -= 5;
            if (this.personality.name === 'æ¸©æŸ”') this.appearance += 3;
            this.appearance = Math.max(0, Math.min(100, this.appearance));
        }
        hasTrait(traitId) { return this.traits.some(t => t.id === traitId); }
        
        addLog(msg) {
            this.history.unshift(msg);
            if (this.history.length > 10) this.history.pop();
        }

        getSleepSchedule() { let start, end; if (this.job && (this.job.buildingId === 'bar' || this.job.buildingId === 'netcafe')) { start = 4; end = 12; } else { start = 23; end = 7; } if (this.hasTrait('sleepy')) { if (start > end) { start = (start - 1 + 24) % 24; end = (end + 1) % 24; } else { start = Math.max(0, start - 1); end = Math.min(24, end + 1); } } return { start, end }; }
        decideProposal(askerName, type) { const rel = this.relationships[askerName]; let chance = rel.love + (this.happiness - 50) / 2; let threshold = 0; if (type === 'date') threshold = 30; if (type === 'confess') threshold = 75; if (type === 'propose') threshold = 90; chance += rand(-10, 10); return chance >= threshold; }
        
        calculateWage(baseWage, role) { 
            let bonus = this.ideology && this.ideology.wageMod ? this.ideology.wageMod : 0;
            if (role) {
                const type = getJobSkillType(role);
                const skillVal = this.skills[type] || 0;
                const info = getLevelInfo(skillVal);
                const skillBonus = skillVal * 0.005;
                return Math.floor(baseWage * info.multiplier * (1 + bonus + skillBonus)); 
            }
            return Math.floor(baseWage * (1 + bonus)); 
        }
    }

    class Building {
        constructor(blueprint) { this.id = blueprint.id; this.name = blueprint.name; this.category = blueprint.category || 'fun'; this.totalCost = blueprint.cost; this.currentProgress = 0; this.isBuilt = false; this.effect = blueprint.effect; this.desc = blueprint.desc; this.price = blueprint.price || 0; this.food = blueprint.food || 0; this.open = blueprint.open; this.close = blueprint.close; this.jobs = blueprint.jobs || []; this.staff = []; this.closedDays = blueprint.closedDays || []; this.prostitutes = []; this.sells = blueprint.sells || []; 
            this.history = [];
        }
        addLog(msg) {
            this.history.unshift(msg);
            if (this.history.length > 10) this.history.pop();
        }
        isOpen(hour, day) { if (!this.isBuilt) return false; if (this.closedDays.includes(day)) return false; if (this.jobs.length > 0 && this.staff.length === 0) return false; if (this.open === 0 && this.close === 24) return true; if (this.close < this.open) return hour >= this.open || hour < this.close; return hour >= this.open && hour < this.close; }
    }

    class Game {
        constructor() { 
            this.chars = []; this.buildings = []; this.townMoney = 0; this.gameTime = 480; this.gameDay = 1; this.autoSaveTimer = 0; this.lastSaveTime = Date.now(); 
            this.speed = 1500; this.speedLevel = 1; 
            this.dateMonth = 1;
            this.dateDay = 1;
            this.weather = 'Sunny';
            this.achievements = []; // å­˜å‚¨å·²è§£é”çš„æˆå°±ID
            
            this.loadOrInit(); 
            if(!this.weather) this.generateDailyWeather();
            this.loopId = setInterval(() => this.tick(), this.speed); 
        }
        
        getSeason() {
            const m = this.dateMonth;
            if (m >= 3 && m <= 5) return 'Spring';
            if (m >= 6 && m <= 8) return 'Summer';
            if (m >= 9 && m <= 11) return 'Autumn';
            return 'Winter';
        }

        getSeasonName() {
            const s = this.getSeason();
            const map = { 'Spring': 'æ˜¥', 'Summer': 'å¤', 'Autumn': 'ç§‹', 'Winter': 'å†¬' };
            return map[s];
        }
        
        generateDailyWeather() {
            const season = this.getSeason();
            const roll = Math.random();
            let type = 'Sunny';
            if (season === 'Spring') {
                if(roll < 0.5) type = 'Sunny';
                else if(roll < 0.8) type = 'Cloudy';
                else type = 'Rainy';
            } else if (season === 'Summer') {
                if(roll < 0.4) type = 'Sunny';
                else if(roll < 0.6) type = 'Rainy';
                else if(roll < 0.8) type = 'Heatwave';
                else type = 'Storm';
            } else if (season === 'Autumn') {
                if(roll < 0.5) type = 'Sunny';
                else if(roll < 0.7) type = 'Cloudy';
                else if(roll < 0.9) type = 'Rainy';
                else type = 'Foggy';
            } else { // Winter
                if(roll < 0.4) type = 'Sunny';
                else if(roll < 0.7) type = 'Cloudy';
                else type = 'Snowy';
            }
            this.weather = type;
            const wInfo = WEATHER_TYPES[type];
            this.log(`[ğŸŒ¦ï¸å¤©æ°”] ä»Šå¤©æ˜¯ **${wInfo.name}**ã€‚${wInfo.desc}`, "tag-event");
        }

        loadOrInit() { const saveStr = localStorage.getItem('happyTownV2_Save'); if (saveStr) { this.loadFromJSON(saveStr); this.checkAndAddNewChars(); this.log("ğŸ“‚ è¯»å–å­˜æ¡£æˆåŠŸï¼"); } else { this.initNewGame(); } this.renderUIStatic(); }
        checkAndAddNewChars() { let added = false; NAMES.forEach(name => { if (!this.chars.find(c => c.name === name)) { this.chars.push(new Character(name)); this.log(`[ğŸ‰æ–°å±…æ°‘] ${name} å…¥ä½ï¼`); added = true; } }); if (added) { this.chars.forEach(c1 => { this.chars.forEach(c2 => { if (c1.name !== c2.name && !c1.relationships[c2.name]) { c1.relationships[c2.name] = { love: 0, status: 'stranger' }; } }); }); } }
        initNewGame() { 
            this.chars = NAMES.map(n => { let c = new Character(n); NAMES.forEach(target => { if (target !== n) c.relationships[target] = { love: 0, status: 'stranger' }; }); return c; }); 
            this.buildings = BUILDINGS_BLUEPRINT.map(b => new Building(b)); 
            // Baozi shop is NO LONGER pre-built to allow for fair election and first build achievement
            const park = this.buildings.find(b => b.id === 'park'); if(park) { park.isBuilt = true; park.currentProgress = park.totalCost; }
            const clinic = this.buildings.find(b => b.id === 'clinic'); if(clinic) { clinic.isBuilt = true; clinic.currentProgress = clinic.totalCost; }
        }
        tick() { 
            this.gameTime += 10; 
            if (this.gameTime >= 1440) { 
                this.gameTime = 0; 
                this.gameDay = (this.gameDay + 1) % 7; 
                this.dateDay++;
                if (this.dateDay > 30) {
                    this.dateDay = 1;
                    this.dateMonth++;
                    if (this.dateMonth > 12) this.dateMonth = 1;
                }
                this.generateDailyWeather();
            } 
            
            if (this.townMoney >= 5000) this.unlockAchievement('rich_town');

            // æ¯å°æ—¶é€»è¾‘
            if (this.gameTime % 60 === 0) { 
                this.runElectionsAndHiring(); 
                const weatherInfo = WEATHER_TYPES[this.weather] || WEATHER_TYPES['Sunny'];

                this.chars.forEach(c => { 
                    // åç‰¢é€»è¾‘
                    if (c.jailTerm > 0) {
                        c.jailTerm -= 60; 
                        if (c.jailTerm <= 0) {
                            c.jailTerm = 0;
                            this.log(`[ğŸ”“é‡Šæ”¾] **${c.name}** åˆ‘æ»¡é‡Šæ”¾ï¼Œé‡è·è‡ªç”±ï¼`, "tag-build");
                        }
                    }

                    c.hunger = Math.max(0, c.hunger - 1); 
                    if (c.hunger === 0) c.happiness -= 2; 
                    
                    if (c.health < 30) c.happiness -= 5;

                    // å¤©æ°”å½±å“
                    c.happiness = Math.min(100, Math.max(0, c.happiness + weatherInfo.mood));
                    c.health = Math.min(100, Math.max(0, c.health + weatherInfo.health));

                    // éšæœºç”Ÿç—…/å—ä¼¤äº‹ä»¶ (æ¦‚ç‡å›è°ƒä¸º 0.5%)
                    if (Math.random() < 0.005) {
                        c.health = Math.max(0, c.health - rand(5, 15));
                        this.log(`[ğŸš‘ç”Ÿç—…] **${c.name}** çªç„¶æ„Ÿè§‰èº«ä½“ä¸é€‚ï¼Œå¥åº·åº¦ä¸‹é™äº†ã€‚`, "tag-reject");
                    }
                }); 
            } 
            this.decideAction(choose(this.chars)); 
            if (Date.now() - this.lastSaveTime > (parseInt(document.getElementById('autosave-rate').value)||30) * 1000) this.saveData(true); 
            this.updateUI(); 
        }
        
        getDateTimeStr() {
            const h = Math.floor(this.gameTime / 60); const m = this.gameTime % 60;
            return `[${this.dateMonth}æœˆ${this.dateDay}æ—¥ ${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}]`;
        }

        improveSkill(c, type, amount) {
            const oldVal = c.skills[type] || 0;
            const oldLevelInfo = getLevelInfo(oldVal);
            
            c.skills[type] = Math.min(100, oldVal + amount);
            const newVal = c.skills[type];
            const newLevelInfo = getLevelInfo(newVal);

            if (newLevelInfo.level > oldLevelInfo.level) {
                this.log(`[â­æ™‹å‡] æ­å–œ **${c.name}** çš„ ${type} æŠ€èƒ½çªç ´ï¼æ™‹å‡ä¸º **${newLevelInfo.title}** çº§åˆ«ï¼`, "tag-promote");
                c.happiness = Math.min(100, c.happiness + 20);
            }
        }

        unlockAchievement(id) {
            if (this.achievements.includes(id)) return;
            const ach = ACHIEVEMENTS_DB.find(a => a.id === id);
            if (!ach) return;
            this.achievements.push(id);
            this.townMoney += ach.reward;
            this.log(`[ğŸ†æˆå°±] æ­å–œè§£é”æˆå°±ï¼š**${ach.name}** (${ach.desc})ï¼å¥–åŠ±èµ„é‡‘ ğŸ’°${ach.reward}`, "tag-promote");
            alert(`ğŸ† æˆå°±è§£é”ï¼š${ach.name}\n${ach.desc}\nè·å¾—å¥–åŠ±: ğŸ’°${ach.reward}`);
        }

        decideAction(p) {
            if (p.jailTerm > 0) {
                p.currentAction = `[ğŸ›‘åç‰¢] é“çª—æ³ª (å‰©ä½™ ${(p.jailTerm/60).toFixed(1)}h)`;
                p.hunger = Math.max(0, p.hunger - 0.5); 
                p.happiness = Math.max(0, p.happiness - 0.5); 
                return;
            }

            if (p.nextActionOverride) {
                const cmd = p.nextActionOverride; p.nextActionOverride = null;
                this.log(`[ğŸ•¹ï¸å¼ºåˆ¶] ä¸Šå¸æ§åˆ¶ **${p.name}** å» ${cmd.desc}...`, "tag-build");
                if (cmd.type === 'work' && p.job) { const b = this.buildings.find(x => x.id === p.job.buildingId); if(b) { this.doWork(p, b); return; } }
                else if (cmd.type === 'rest') { this.doRest(p, {name:"å®¶", price:0}); return; }
                else if (cmd.type === 'build') { const b = this.buildings.find(x => x.id === cmd.target); if (b) { this.doBuild(p, b); return; } }
                else if (cmd.type === 'visit') { const b = this.buildings.find(x => x.id === cmd.target); if (b) { if(b.effect==='food') this.doEat(p, b); else if(b.effect==='shop') this.doShopping(p, b); else this.doRest(p, b); return; } }
                else if (cmd.type === 'social') { const t = this.chars.find(x => x.name === cmd.target); if (t) { const park = this.buildings.find(b=>b.id==='park'); this.doSocialTarget(p, t, park || {name:"è·¯è¾¹", effect:"none"}); return; } }
                else if (cmd.type === 'crime_rob') { const t = this.chars.find(x => x.name === cmd.target); if (t) { this.doRobbery(p, t); return; } }
                else if (cmd.type === 'crime_assault') { const t = this.chars.find(x => x.name === cmd.target); if (t) { this.doSexualAssault(p, t); return; } }
            }

            this.breakInteraction(p); const hour = Math.floor(this.gameTime / 60);
            
            if (p.health < 60) {
                const medId = p.bag.find(id => ITEMS_DB[id] && ITEMS_DB[id].type === 'medicine');
                if (medId) { this.doUseItem(p, medId); return; }
                const hospitals = this.buildings.filter(b => b.isBuilt && b.effect === 'health' && b.isOpen(hour, this.gameDay) && p.money >= b.price);
                if (hospitals.length > 0) { this.doRest(p, choose(hospitals)); return; }
                const clinic = this.buildings.find(b => b.id === 'clinic');
                if (clinic && clinic.isBuilt && clinic.isOpen(hour, this.gameDay) && p.money >= 10) {
                    this.doShopping(p, clinic); return;
                }
            }

            if (p.hunger < 50) {
                 const foodId = p.bag.find(id => ITEMS_DB[id] && (ITEMS_DB[id].type === 'food'));
                 if (foodId) { this.doUseItem(p, foodId); return; }
            }
            
            if (p.hunger < 50) { const restaurants = this.buildings.filter(b => b.isBuilt && b.effect === 'food' && b.isOpen(hour, this.gameDay) && p.money >= b.price); if (restaurants.length > 0) { this.doEat(p, choose(restaurants)); return; } }
            
            const isPoor = p.money < 10; const isGreedy = p.hasTrait('money-loving'); const isMilitant = p.ideology.name === 'å†›å›½ä¸»ä¹‰';
            const isHorny = p.hasTrait('promiscuous');
            const isUgly = p.appearance < 50;
            const isDepressed = p.happiness < 30;
            
            const policeStation = this.buildings.find(b => b.id === 'police'); const hasPolice = policeStation && policeStation.isBuilt && policeStation.staff.length > 0; const deterrent = hasPolice ? 0.02 : 0;
            
            // çŠ¯ç½ªæ¦‚ç‡å›è°ƒä¸ºåŸºç¡€ 0.5%
            let robChance = 0.005; 
            if (isPoor) robChance += 0.002; if (isGreedy) robChance += 0.001; if (isMilitant) robChance += 0.003; 
            robChance = Math.max(0, robChance - deterrent); 
            
            let assaultChance = 0.005; 
            if (isHorny) assaultChance += 0.002; 
            if (isUgly) assaultChance += 0.001; 
            if (isDepressed) assaultChance += 0.001;
            assaultChance = Math.max(0, assaultChance - deterrent);

            const roll = Math.random();
            if (roll < robChance) { 
                if (this.doRobbery(p)) return; 
            } else if (roll < robChance + assaultChance) {
                if (this.doSexualAssault(p)) return;
            }

            const sleepSchedule = p.getSleepSchedule(); let isSleepTime = (sleepSchedule.start > sleepSchedule.end) ? (hour >= sleepSchedule.start || hour < sleepSchedule.end) : (hour >= sleepSchedule.start && hour < sleepSchedule.end);
            if (isSleepTime) { p.currentAction = "ğŸ˜´ ç¡è§‰"; let recovery = p.hasTrait('sleepy') ? 4 : 2; p.happiness = Math.min(100, p.happiness + recovery); return; }
            if (p.job && p.hunger > 0) { const workplace = this.buildings.find(b => b.id === p.job.buildingId); if (workplace && workplace.isOpen(hour, this.gameDay)) { if (workplace.open === 0 && workplace.close === 24 ? Math.random() < 0.7 : true) { this.doWork(p, workplace); return; } } }
            if (p.prostitute && p.hunger > 0) { const footshop = this.buildings.find(b => b.id === p.prostitute.buildingId); if (footshop && footshop.isBuilt && footshop.isOpen(hour, this.gameDay)) { this.doProstitution(p, footshop); return; } }
            if (!p.job && p.money < 20 && p.hunger > 0) { if (p.hasTrait('promiscuous') && Math.random() < 0.6) { this.doStreetwalking(p); } else { this.doOddJob(p); } return; }
            
            if (p.happiness < 40) {
                const funItemId = p.bag.find(id => ITEMS_DB[id] && (ITEMS_DB[id].type === 'alcohol' || ITEMS_DB[id].type === 'snack' || ITEMS_DB[id].type === 'drink'));
                if (funItemId) { this.doUseItem(p, funItemId); return; }
                this.doRest(p, null); return; 
            }
            
            const multiplier = p.hasTrait('money-loving') ? 2 : 1; 
            if (p.money > 50 && p.bag.length < 5 && Math.random() < 0.2) {
                const shops = this.buildings.filter(b => b.isBuilt && b.effect === 'shop' && b.isOpen(hour, this.gameDay));
                if (shops.length > 0) { this.doShopping(p, choose(shops)); return; }
            }

            const venues = this.buildings.filter(b => b.isBuilt && b.isOpen(hour, this.gameDay) && (p.money >= b.price * multiplier)); const venue = choose(venues) || { name: "è·¯è¾¹", effect: "none", price: 0 }; const pending = this.buildings.find(b => !b.isBuilt);
            if (roll < 0.3 && p.hunger > 0) { if (pending) { this.doBuild(p, pending); } else if (!p.job) { if (p.hasTrait('promiscuous') && Math.random() < 0.6) this.doStreetwalking(p); else this.doOddJob(p); } else { this.doSocial(p, venue); } } else if (roll < 0.8) { this.doSocial(p, venue); } else { this.doRest(p, venue); }
        }
        
        doSexualAssault(p, target = null) {
            let victim = target;
            if (!victim) {
                const targets = this.chars.filter(c => c.name !== p.name && c.appearance >= 70);
                victim = targets.length > 0 ? choose(targets) : choose(this.chars.filter(c => c.name !== p.name));
            }
            if (!victim) return false;
            
            this.unlockAchievement('first_crime');

            const policeStation = this.buildings.find(b => b.id === 'police'); 
            const hasPolice = policeStation && policeStation.isBuilt && policeStation.staff.length > 0;
            let securityLevel = hasPolice ? policeStation.staff.length * 0.3 : 0;
            
            let successChance = 0.6 - securityLevel;
            if (p.appearance > 80) successChance += 0.2;

            const timeStr = this.getDateTimeStr();

            if (Math.random() < successChance) {
                p.happiness = Math.min(100, p.happiness + 40); 
                victim.happiness -= 50;
                victim.health = Math.max(0, victim.health - 15); 
                
                const pRel = p.relationships[victim.name];
                const vRel = victim.relationships[p.name];
                
                pRel.status = "enemy"; vRel.status = "enemy";
                pRel.love = -80; vRel.love = -100;

                p.stat_assault = (p.stat_assault || 0) + 1;
                victim.stat_be_assaulted = (victim.stat_be_assaulted || 0) + 1;

                this.log(`[ğŸ’‹åŠ«è‰²] éœ‡æƒŠï¼**${p.name}** å¯¹é¢œå€¼é«˜è¾¾ ${victim.appearance} çš„ **${victim.name}** å®æ–½äº†çŒ¥äºµï¼${p.name}è·å¾—äº†å˜æ€çš„æ»¡è¶³ã€‚`, "tag-crime");
                p.currentAction = `[çŠ¯ç½ª] åŠ«è‰²äº† ${victim.name}`;
                
                p.addLog(`${timeStr} åŠ«è‰²äº† ${victim.name}`);
                victim.addLog(`${timeStr} æƒ¨é­ ${p.name} åŠ«è‰² (å¿ƒæƒ…-50, å¥åº·-15)`);
                if(policeStation) policeStation.addLog(`${timeStr} æ¥åˆ°æŠ¥æ¡ˆï¼š${p.name} éªšæ‰°äº† ${victim.name}`);
                return true;
            } else {
                if (hasPolice) {
                    const fine = 200;
                    p.happiness -= 40; 
                    p.money -= fine; 
                    this.townMoney += fine; 
                    p.jailTerm = 1440; 
                    
                    this.log(`[ğŸ‘®é€®æ•] **${p.name}** è¯•å›¾å¯¹ **${victim.name}** å›¾è°‹ä¸è½¨ï¼Œè¢«è­¦å¯Ÿé€®æ•ï¼ç½šæ¬¾ğŸ’°${fine}ï¼Œåˆ¤å¤„åç‰¢24å°æ—¶ã€‚`, "tag-build");
                    const copName = choose(policeStation.staff); 
                    const cop = this.chars.find(c => c.name === copName);
                    if (cop) { cop.money += 30; } 
                    p.currentAction = `[è¢«æ•] åŠ«è‰²æœªé‚ï¼Œé”’é“›å…¥ç‹±`;
                    p.addLog(`${timeStr} åŠ«è‰² ${victim.name} å¤±è´¥ï¼Œè¢«æ•å…¥ç‹±`);
                } else {
                    p.happiness -= 20; p.appearance -= 2; 
                    p.health = Math.max(0, p.health - 5); 
                    this.log(`[ğŸ‘Šåå‡»] **${p.name}** æƒ³åŠ«è‰² **${victim.name}**ï¼Œç»“æœè¢«å¯¹æ–¹ä¸€é¡¿æš´æï¼`, "tag-reject");
                    p.currentAction = `[å¤±è´¥] åŠ«è‰²æŒ¨æï¼Œé¼»é’è„¸è‚¿`;
                    p.addLog(`${timeStr} éªšæ‰° ${victim.name} åè¢«æ‰“`);
                    victim.addLog(`${timeStr} ç—›æ‰äº†è‰²ç‹¼ ${p.name}`);
                }
                return true;
            }
        }

        doSocialTarget(p, t, venue) {
            if (p.name === t.name) return; 
            const pRel = p.relationships[t.name]; const tRel = t.relationships[p.name];
            this.breakInteraction(t);
            
            if (this.tryGift(p, t, venue)) return;

            const timeStr = this.getDateTimeStr();
            p.addLog(`${timeStr} å’Œ ${t.name} åœ¨ ${venue.name} ç¤¾äº¤`);
            t.addLog(`${timeStr} å’Œ ${p.name} åœ¨ ${venue.name} ç¤¾äº¤`);
            if(venue.addLog) venue.addLog(`${timeStr} ${p.name} ä¸ ${t.name} åœ¨è¿™é‡Œçº¦ä¼š/èŠå¤©`);

            p.currentAction = `[å¼ºåˆ¶] å’Œ ${t.name} åœ¨ ${venue.name}`; t.currentAction = `[å¼ºåˆ¶] å’Œ ${p.name} åœ¨ ${venue.name}`; 
            p.interactingWith = t.name; t.interactingWith = p.name; p.hunger -= 2; t.hunger -= 2; 
            
            this.improveSkill(p, 'social', 0.1);
            this.improveSkill(t, 'social', 0.1);

            let chaos = p.personality.chaosBonus + t.personality.chaosBonus + p.ideology.chaosMod + t.ideology.chaosMod;
            if (Math.random() < Math.max(0, Math.min(1, 0.1 + chaos))) {
                pRel.love -= 5; tRel.love -= 5; 
                // åµæ¶å¢åŠ æŠ€èƒ½
                this.improveSkill(p, 'social', 0.25); this.improveSkill(p, 'intel', 0.25);
                this.improveSkill(t, 'social', 0.25); this.improveSkill(t, 'intel', 0.25);
                
                this.log(`[ğŸ’¢äº‰åµ] ${p.name} å’Œ ${t.name} åœ¨ ${venue.name} åµæ¶äº†ã€‚ (ç¤¾äº¤/æ™ºåŠ›+0.25)`, "tag-reject");
            } else {
                let boost = rand(1, 3); boost += p.personality.loveGain + t.personality.loveGain + p.ideology.loveMod + t.ideology.loveMod; boost = Math.max(0, Math.round(boost)); pRel.love = Math.min(100, pRel.love + boost); tRel.love = Math.min(100, tRel.love + boost); this.updateRelationshipStatus(p, t, pRel, tRel);
            }
        }

        showActionSelect(name) {
            const c = this.chars.find(x => x.name === name); if (!c) return;
            const modal = document.getElementById('action-select-modal');
            const content = document.getElementById('action-select-content');
            
            let html = `<p>ä¸º <b>${c.name}</b> é€‰æ‹©ä¸‹ä¸€ä¸ªè¡ŒåŠ¨ (ç«‹å³ç”Ÿæ•ˆ):</p><div class="action-grid">`;
            html += `<button class="action-btn" onclick="setOverride('${name}', 'rest', '', 'å›å®¶ä¼‘æ¯')">ğŸ›Œ ä¼‘æ¯/èººå¹³</button>`;
            if (c.job) { html += `<button class="action-btn" style="border-color:#f1c40f" onclick="setOverride('${name}', 'work', '', 'å»ä¸Šç­')">ğŸ’¼ å»ä¸Šç­</button>`; }
            const pendings = this.buildings.filter(b => !b.isBuilt);
            pendings.forEach(b => { html += `<button class="action-btn" style="border-color:#e67e22" onclick="setOverride('${name}', 'build', '${b.id}', 'å»ºè®¾ ${b.name}')">ğŸ”¨ å»ºè®¾: ${b.name}</button>`; });
            const venues = this.buildings.filter(b => b.isBuilt);
            venues.forEach(b => { const icon = b.effect === 'food' ? 'ğŸ”' : (b.effect === 'shop' ? 'ğŸ›ï¸' : 'ğŸ¡'); html += `<button class="action-btn" onclick="setOverride('${name}', 'visit', '${b.id}', 'å» ${b.name}')">${icon} å»: ${b.name}</button>`; });
            html += `</div><p style="margin-top:10px;">å¼ºåˆ¶ç¤¾äº¤ (é€‰æ‹©å¯¹è±¡):</p><div class="action-grid">`;
            this.chars.forEach(t => { if (t.name !== c.name) { html += `<button class="action-btn" style="border-color:#ff7675" onclick="setOverride('${name}', 'social', '${t.name}', 'æ‰¾ ${t.name}')">â¤ æ‰¾: ${t.name}</button>`; } });
            
            html += `</div><p style="margin-top:10px;">å¼ºåˆ¶çŠ¯ç½ª (é€‰æ‹©å—å®³äºº):</p><div class="action-grid">`;
            this.chars.forEach(t => { 
                if (t.name !== c.name) { 
                    html += `<button class="action-btn" style="border-color:#2d3436; color:#2d3436" onclick="setOverride('${name}', 'crime_rob', '${t.name}', 'æŠ¢åŠ« ${t.name}')">ğŸ”ª æŠ¢: ${t.name}</button>`; 
                    html += `<button class="action-btn" style="border-color:#c0392b; color:#c0392b" onclick="setOverride('${name}', 'crime_assault', '${t.name}', 'åŠ«è‰² ${t.name}')">ğŸ˜ˆ åŠ«: ${t.name}</button>`; 
                } 
            });

            html += `</div>`;
            content.innerHTML = html;
            document.getElementById('char-detail-modal').classList.remove('active');
            modal.classList.add('active');
        }
        setOverride(name, type, target, desc) { const c = this.chars.find(x => x.name === name); if (c) { c.nextActionOverride = { type, target, desc }; document.getElementById('action-select-modal').classList.remove('active'); alert(`å·²å®‰æ’ ${name} ä¸‹ä¸€æ­¥ï¼š${desc}`); } }
        closeActionSelect() { document.getElementById('action-select-modal').classList.remove('active'); }

        showTownEvents() {
            const modal = document.getElementById('town-event-modal');
            document.getElementById('event-town-money').innerText = this.townMoney;
            
            const seasonName = this.getSeasonName();
            document.getElementById('event-season-name').innerText = seasonName;
            
            // åˆå§‹åŒ–Tab
            this.switchEventTab('normal');
            modal.classList.add('active');
        }
        
        switchEventTab(tab) {
            const list = document.getElementById('town-event-list');
            list.innerHTML = '';
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`evt-tab-${tab}`).classList.add('active');

            const currentSeason = this.getSeason();
            let eventsToShow = [];

            if (tab === 'normal') {
                eventsToShow = TOWN_EVENTS.filter(ev => !ev.season);
            } else {
                eventsToShow = TOWN_EVENTS.filter(ev => ev.season === currentSeason);
            }

            if (eventsToShow.length === 0) {
                list.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:20px; color:#999;">å½“å‰å­£èŠ‚æš‚æ— ç‰¹åˆ«æ´»åŠ¨ã€‚</div>`;
                return;
            }

            eventsToShow.forEach(ev => {
                const div = document.createElement('div');
                div.className = 'event-card';
                const canAfford = this.townMoney >= ev.cost;
                div.innerHTML = `
                    <div class="event-header"><span class="event-name">${ev.name}</span><span class="event-cost">-${ev.cost}</span></div>
                    <div class="event-desc">${ev.desc}</div>
                    <button class="event-btn" ${canAfford?'':'disabled'} onclick="triggerTownEvent('${ev.id}')">${canAfford?'ğŸ‰ ç«‹å³ä¸¾åŠ':'ğŸ’¸ èµ„é‡‘ä¸è¶³'}</button>
                `;
                list.appendChild(div);
            });
        }

        triggerTownEvent(id) {
            const ev = TOWN_EVENTS.find(x => x.id === id);
            if (!ev || this.townMoney < ev.cost) return;
            
            this.townMoney -= ev.cost;
            this.log(`[ğŸ‰æ´»åŠ¨] é•‡é•¿æ–¥èµ„ ğŸ’°${ev.cost} ä¸¾åŠäº† **${ev.name}**ï¼`, "tag-event");
            document.getElementById('town-event-modal').classList.remove('active');

            if (id === 'concert') {
                const fail = Math.random() < 0.1;
                if (fail) { 
                    this.log(`[ğŸ˜±æ„å¤–] éŸ³å“è®¾å¤‡çˆ†ç‚¸äº†ï¼æ¼”å”±ä¼šæ•ˆæœå¤§æ‰“æŠ˜æ‰£ï¼`, "tag-reject"); 
                    this.chars.forEach(c => { c.happiness += 5; }); 
                } else { 
                    this.chars.forEach(c => { c.happiness = Math.min(100, c.happiness + 20); }); 
                    this.chars.forEach(c1 => { 
                        this.chars.forEach(c2 => { if (c1.name !== c2.name && c1.relationships[c2.name]) { c1.relationships[c2.name].love = Math.min(100, c1.relationships[c2.name].love + 5); } }); 
                    }); 
                }
            } else if (id === 'matchmaking') {
                let pairCount = 0; this.chars.forEach(c => { if (!c.partner) { let bestT = null; let maxL = -100; for(let tName in c.relationships) { const t = this.chars.find(x=>x.name===tName); if (t && !t.partner && c.relationships[tName].love > maxL) { maxL = c.relationships[tName].love; bestT = t; } } if (bestT && maxL > 40 && Math.random() < 0.5) { if (bestT.decideProposal(c.name, 'confess') || Math.random() < 0.3) { c.partner = bestT.name; bestT.partner = c.name; c.relationships[bestT.name].status = 'lover'; bestT.relationships[c.name].status = 'lover'; c.happiness += 20; bestT.happiness += 20; this.unlockAchievement('first_marriage'); this.log(`[â¤ï¸é…å¯¹] åœ¨ç›¸äº²å¤§ä¼šä¸Šï¼Œ**${c.name}** å’Œ **${bestT.name}** ç‰µæ‰‹æˆåŠŸï¼`, "tag-love"); pairCount++; } } } }); if (pairCount > 0) { this.chars.forEach(c => c.happiness += 5); } else { this.log(`[ğŸ‚å°´å°¬] ç›¸äº²å¤§ä¼šç»“æŸäº†ï¼Œä¼¼ä¹æ²¡äººé…å¯¹æˆåŠŸ...`, "tag-reject"); }
            } else if (id === 'charity') {
                let totalRaised = 0; this.chars.forEach(c => { if (c.money > 10) { const donation = Math.min(c.money, rand(5, 20)); c.money -= donation; totalRaised += donation; c.happiness -= 5; this.chars.forEach(other => { if(other.name!==c.name) { c.relationships[other.name].love += 2; } }); } }); this.townMoney += totalRaised; this.log(`[ğŸ—ï¸å‹Ÿæ] å±…æ°‘ä»¬å…±ææ¬¾ ğŸ’°${totalRaised}ï¼Œè™½ç„¶å¿ƒç–¼é’±ä½†å…³ç³»æ›´ç´§å¯†äº†ã€‚`, "tag-build");
            } else if (id === 'anniversary') { 
                this.chars.forEach(c => { c.happiness = Math.min(100, c.happiness + 10); for(let k in c.relationships) c.relationships[k].love += 2; });
            } else if (id === 'fireworks') {
                if (Math.random() < 0.05) { const built = this.buildings.filter(b => b.isBuilt); if (built.length > 0) { const burn = choose(built); burn.isBuilt = false; burn.currentProgress = 0; burn.staff.forEach(sName => { const s = this.chars.find(x=>x.name===sName); if(s) { s.job = null; s.happiness -= 30; } }); burn.staff = []; this.log(`[ğŸ”¥ç«ç¾] å¤©å‘ï¼çƒŸèŠ±å¼•ç‡ƒäº† **${burn.name}**ï¼å»ºç­‘è¢«çƒ§æ¯ï¼Œéœ€è¦é‡å»ºï¼`, "tag-crime"); this.chars.forEach(c => c.happiness -= 10); } } else { this.chars.forEach(c => { c.happiness = Math.min(100, c.happiness + 25); for(let k in c.relationships) c.relationships[k].love += 5; }); }
            } else if (id === 'jobfair') {
                let hiredCount = 0; this.buildings.forEach(b => { if (b.isBuilt && b.staff.length < b.jobs.length) { const needed = b.jobs.length - b.staff.length; for(let i=0; i<needed; i++) { const candidates = this.chars.filter(c => !c.job); if (candidates.length > 0 && Math.random() < 0.5) { const worker = choose(candidates); const role = b.jobs[b.staff.length]; worker.job = { buildingId: b.id, role: role }; b.staff.push(worker.name); worker.happiness += 10; this.log(`[ğŸ¤å…¥èŒ] **${worker.name}** åœ¨æ‹›è˜ä¼šä¸Šæ‰¾åˆ°äº† **${b.name}** çš„å·¥ä½œï¼`, "tag-build"); hiredCount++; } } } }); if(hiredCount === 0) this.log("æ‹›è˜ä¼šç»“æŸäº†ï¼Œä¼¼ä¹æ²¡æœ‰åˆé€‚çš„å²—ä½æˆ–æ±‚èŒè€…ã€‚", "tag-reject");
            }
            else if (id === 'artfest') {
                this.chars.forEach(c => {
                    c.happiness = Math.min(100, c.happiness + 15);
                    for(let k in c.relationships) c.relationships[k].love += 3;
                });
                if (Math.random() < 0.1) {
                    const victim = choose(this.chars);
                    victim.happiness -= 10;
                    this.log(`[ğŸ¨å¤±çªƒ] ç³Ÿç³•ï¼**${victim.name}** çè—çš„è‰ºæœ¯å“åœ¨æ´»åŠ¨ä¸­è¢«å·äº†ï¼(å¿ƒæƒ…-10)`, "tag-crime");
                }
            } 
            else if (id === 'marathon') {
                this.chars.forEach(c => {
                    c.happiness = Math.min(100, c.happiness + 10);
                    c.hunger = Math.max(0, c.hunger - 10); 
                });
                if (Math.random() < 0.05) {
                    const injured = choose(this.chars);
                    injured.happiness -= 20;
                    injured.health = Math.max(0, injured.health - 20);
                    this.log(`[ğŸš‘æ„å¤–] **${injured.name}** åœ¨é©¬æ‹‰æ¾ä¸­ä¸æ…æ‰­ä¼¤äº†è„šï¼(å¿ƒæƒ…-20, å¥åº·-20)`, "tag-reject");
                }
            }
            else if (id === 'reading') {
                this.chars.forEach(c => {
                    c.happiness = Math.min(100, c.happiness + 5);
                    for(let k in c.relationships) c.relationships[k].love += 2;
                });
                if (Math.random() < 0.2) {
                    const winner = choose(this.chars);
                    winner.happiness = Math.min(100, winner.happiness + 10);
                    this.log(`[ğŸ§ ç«èµ›] **${winner.name}** èµ¢å¾—äº†è¯»ä¹¦çŸ¥è¯†ç«èµ›çš„å† å†›ï¼å¤§å®¶å‘ä»–è¡¨ç¤ºç¥è´ºã€‚`, "tag-build");
                }
            }
            else if (id === 'planting') {
                let success = true;
                if (Math.random() < 0.1) {
                    success = false;
                    this.log(`[ğŸ‚æ¯è] å“å‘€ï¼Œç”±äºå¤©æ°”åŸå› ï¼Œä¸€åŠçš„æ ‘è‹—æ²¡èƒ½å­˜æ´»...æ•ˆæœå‡åŠã€‚`, "tag-reject");
                }
                const happyBonus = success ? 5 : 2;
                const relBonus = success ? 3 : 1;
                this.chars.forEach(c => {
                    c.happiness = Math.min(100, c.happiness + happyBonus);
                    for(let k in c.relationships) c.relationships[k].love += relBonus;
                });
            }
            else if (id === 'shopping') {
                let totalSpent = 0;
                let totalTax = 0;
                let shopperCount = 0;
                this.chars.forEach(c => {
                    if (c.money > 5 && Math.random() < 0.5) {
                        const spendRatio = rand(10, 30) / 100;
                        const spent = Math.floor(c.money * spendRatio);
                        if (spent > 0) {
                            c.money -= spent;
                            c.happiness = Math.min(100, c.happiness + 10);
                            const tax = Math.floor(spent * 0.2);
                            totalTax += tax;
                            totalSpent += spent;
                            shopperCount++;
                        }
                    }
                });
                this.townMoney += totalTax;
                if (shopperCount > 0) {
                    this.log(`[ğŸ›ï¸ç‹‚æ¬¢] è´­ç‰©èŠ‚åœ†æ»¡ç»“æŸï¼${shopperCount} ä½å±…æ°‘ç–¯ç‹‚å‰æ‰‹ï¼Œæ€»æ¶ˆè´¹ ğŸ’°${totalSpent}ã€‚`, "tag-item");
                    this.log(`[ğŸ’°ç¨æ”¶] é•‡åº“ä»äº¤æ˜“ç¨ä¸­è·å¾—äº† ğŸ’°${totalTax} çš„æ”¶å…¥ï¼`, "tag-build");
                } else {
                    this.log(`[ğŸŒ¬ï¸å†·æ¸…] è´­ç‰©èŠ‚ä¼¼ä¹æ²¡æœ‰äººæ„¿æ„èŠ±é’±...`, "tag-lonely");
                }
            }
            // æ–°å¢å­£èŠ‚æ´»åŠ¨
            else if (id === 'matsuri') {
                 this.chars.forEach(c => { c.happiness = Math.min(100, c.happiness + 25); });
                 // å¢åŠ è„±å•å‡ ç‡
                 let pairs = 0;
                 this.chars.forEach(c => {
                     if (!c.partner && Math.random() < 0.2) {
                         const available = this.chars.filter(t => t.name !== c.name && !t.partner && c.relationships[t.name].love > 30);
                         if (available.length > 0) {
                             const t = choose(available);
                             c.partner = t.name; t.partner = c.name;
                             c.relationships[t.name].status = 'lover'; t.relationships[c.name].status = 'lover';
                             this.unlockAchievement('first_marriage');
                             this.log(`[ğŸ‡æµªæ¼«] çƒŸèŠ±ä¸‹ï¼Œ**${c.name}** å’Œ **${t.name}** ç¡®ç«‹äº†å…³ç³»ï¼`, "tag-love");
                             pairs++;
                         }
                     }
                 });
            }
            else if (id === 'snowfest') {
                this.chars.forEach(c => {
                    c.happiness = Math.min(100, c.happiness + 15);
                    c.health = Math.min(100, c.health + 10); // å¼ºèº«å¥ä½“
                    c.hunger = Math.min(100, c.hunger + 10); // åƒç«é”…
                });
            }

            this.updateUI();
        }
        closeTownEvents() { document.getElementById('town-event-modal').classList.remove('active'); }


        toggleSpeed() { 
            clearInterval(this.loopId); 
            this.speedLevel = (this.speedLevel + 1) % 4; 
            const btn = document.getElementById('speed-btn');
            if (this.speedLevel === 0) {
                btn.innerText = "â–¶ ç»§ç»­";
                btn.style.backgroundColor = "#7f8c8d";
            } else {
                btn.style.backgroundColor = "";
                if (this.speedLevel === 1) { 
                    this.speed = 1500; 
                    btn.innerText = "â¸ æ­£å¸¸"; 
                } else if (this.speedLevel === 2) { 
                    this.speed = 750; 
                    btn.innerText = "â© 2x"; 
                } else { 
                    this.speed = 500; 
                    btn.innerText = "â© 3x"; 
                } 
                this.loopId = setInterval(() => this.tick(), this.speed); 
            }
        }
        accelerateBuild(buildId) { const b = this.buildings.find(x => x.id === buildId); if (!b || b.isBuilt) return; if (this.townMoney >= 50) { this.townMoney -= 50; b.currentProgress += 20; this.log(`[ğŸ’¸åŠ é€Ÿ] é•‡é•¿æ–¥èµ„åŠ é€Ÿ **${b.name}** å»ºè®¾ã€‚`, "tag-build"); if (b.currentProgress >= b.totalCost) { b.isBuilt = true; this.log(`[ğŸ”¨ç«£å·¥] **${b.name}** å»ºæˆäº†ï¼`, "tag-build"); this.unlockAchievement('first_build'); if(b.id==='gym') this.unlockAchievement('first_gym'); if(b.id==='museum') this.unlockAchievement('culture_hub'); this.distributeConstructionReward(b); } this.updateUI(); } else { alert("é•‡åº“èµ„é‡‘ä¸è¶³ (éœ€è¦50)ï¼"); } }
        runElectionsAndHiring() { /* ... åŒå‰ ... */ this.buildings.forEach(b => { if (!b.isBuilt || b.jobs.length === 0) return; if (b.staff.length === 0) { const candidates = this.chars.filter(c => !c.job).sort(() => Math.random() - 0.5); if (candidates.length > 0) { const votes = {}; candidates.forEach(c => votes[c.name] = 0); this.chars.forEach(voter => { let bestC = null; let maxLove = -999; candidates.forEach(c => { let love = (c.name !== voter.name) ? (voter.relationships[c.name]?.love || 0) : 50; love += rand(-20, 20); if (love > maxLove) { maxLove = love; bestC = c; } }); if (bestC) votes[bestC.name]++; }); let winner = candidates[0]; let maxVotes = -1; for (let name in votes) { if (votes[name] > maxVotes) { maxVotes = votes[name]; winner = candidates.find(c => c.name === name); } } if (winner) { const roleName = b.jobs[0]; winner.job = { buildingId: b.id, role: roleName }; b.staff.push(winner.name); this.log(`[ğŸ—³ï¸é€‰ä¸¾] **${winner.name}** å½“é€‰ä¸º **${b.name}** çš„${roleName}ï¼`, "tag-build"); } } } else if (b.staff.length < b.jobs.length) { const managerName = b.staff[0]; const manager = this.chars.find(c => c.name === managerName); if (manager) { const roleName = b.jobs[b.staff.length]; const candidates = this.chars.filter(c => !c.job); let bestC = null; let maxLove = -999; candidates.forEach(c => { const rel = manager.relationships[c.name]; let love = rel ? rel.love : 0; if (love > maxLove) { maxLove = love; bestC = c; } }); if (bestC) { bestC.job = { buildingId: b.id, role: roleName }; b.staff.push(bestC.name); this.log(`[ğŸ¤æ‹›è˜] ${b.name}ç»ç† **${manager.name}** å½•ç”¨äº† **${bestC.name}** æ‹…ä»» ${roleName}ã€‚`); } } } if (b.id === 'footshop' && b.isBuilt && b.staff.length > 0) { const bossName = b.staff[0]; const boss = this.chars.find(c => c.name === bossName); if (boss && b.prostitutes.length < 3) { const candidates = this.chars.filter(c => !c.job && !c.prostitute && c.hasTrait('promiscuous')); if (candidates.length > 0 && Math.random() < 0.1) { const target = choose(candidates); target.prostitute = { buildingId: b.id }; b.prostitutes.push(target.name); this.log(`[ğŸ’‹æ‹‰çš®æ¡] **${boss.name}** è¯´æœäº† **${target.name}** åœ¨æ´—è„šåº—å–é“¶...`, "tag-drama"); } } } }); }
        
        doRobbery(p, target = null) { 
            let victim = target;
            if (!victim) {
                const targets = this.chars.filter(c => c.name !== p.name && c.money > 20); 
                if (targets.length === 0) return false; 
                victim = choose(targets); 
            }
            
            this.unlockAchievement('first_crime');

            const policeStation = this.buildings.find(b => b.id === 'police'); const hasPolice = policeStation && policeStation.isBuilt && policeStation.staff.length > 0; let securityLevel = hasPolice ? policeStation.staff.length * 0.3 : 0; let successChance = 0.5; if (p.ideology.name === 'å†›å›½ä¸»ä¹‰') successChance += 0.2; successChance -= securityLevel; 
            
            const timeStr = this.getDateTimeStr();
            if (Math.random() < successChance) { 
                const stolen = Math.floor(victim.money * rand(0.3, 0.6)); victim.money -= stolen; p.money += stolen; victim.happiness -= 30; 
                victim.health = Math.max(0, victim.health - 10); 
                
                const pRel = p.relationships[victim.name]; const vRel = victim.relationships[p.name]; 
                if (['lover', 'spouse', 'mistress'].includes(pRel.status)) { pRel.status = "ex"; vRel.status = "ex"; } else { pRel.status = "enemy"; vRel.status = "enemy"; } 
                pRel.love = -50; vRel.love = -50; 

                p.stat_rob = (p.stat_rob || 0) + 1;
                victim.stat_be_robbed = (victim.stat_be_robbed || 0) + 1;

                this.log(`[ğŸ”ªæŠ¢åŠ«] å¤©å‘ï¼**${p.name}** æŠ¢åŠ«äº† **${victim.name}**ï¼ŒæŠ¢èµ° ğŸ’°${stolen}ï¼ä¸¤äººåç›®æˆä»‡ï¼`, "tag-crime"); 
                p.currentAction = `[çŠ¯ç½ª] æŠ¢åŠ«äº† ${victim.name}`; 
                
                p.addLog(`${timeStr} æŠ¢åŠ«äº† ${victim.name} ğŸ’°${stolen}`);
                victim.addLog(`${timeStr} è¢« ${p.name} æŠ¢åŠ«äº† ğŸ’°${stolen} (å¥åº·-10)`);
                if(policeStation) policeStation.addLog(`${timeStr} æ¥åˆ°æŠ¥æ¡ˆï¼š${p.name} æŠ¢åŠ«äº† ${victim.name}`);
                return true; 
            } else { 
                if (hasPolice) { 
                    const fine = 100; // ç½šæ¬¾
                    p.happiness -= 30; 
                    p.money -= fine; 
                    this.townMoney += fine;
                    p.jailTerm = 1440; 

                    this.log(`[ğŸ‘®é€®æ•] **${p.name}** æŠ¢åŠ« **${victim.name}** å¤±è´¥ï¼è¢«è­¦å¯Ÿé€®æ•ï¼ç½šæ¬¾ğŸ’°${fine}å¹¶åˆ¤å¤„ç›‘ç¦24å°æ—¶ï¼`, "tag-build"); 
                    const copName = choose(policeStation.staff); const cop = this.chars.find(c => c.name === copName); 
                    if (cop) { cop.money += 20; this.log(`[ğŸš“æ²»å®‰] è­¦å®˜ **${cop.name}** å› åˆ¶æ­¢çŠ¯ç½ªè·å¾—å¥–é‡‘ ğŸ’°20ã€‚`, "tag-build"); } 
                    p.currentAction = `[è¢«æ•] æŠ¢åŠ«å¤±è´¥ï¼Œé”’é“›å…¥ç‹±`; 
                    
                    p.addLog(`${timeStr} æŠ¢åŠ« ${victim.name} å¤±è´¥ï¼Œè¢«æ•å…¥ç‹±`);
                    if(policeStation) policeStation.addLog(`${timeStr} è­¦å¯Ÿé€®æ•äº†æŠ¢åŠ«çŠ¯ ${p.name}`);
                } else { 
                    p.happiness -= 10; this.log(`[ğŸ’¨å¤±è´¥] **${p.name}** è¯•å›¾æŠ¢åŠ« **${victim.name}**ï¼Œä½†è¢«å¯¹æ–¹ä¸€è„šè¸¹é£äº†ï¼`, "tag-reject"); 
                    p.currentAction = `[å¤±è´¥] æŠ¢åŠ«æœªé‚ï¼Œè½è’è€Œé€ƒ`; 
                    p.addLog(`${timeStr} è¯•å›¾æŠ¢åŠ« ${victim.name} ä½†è¢«æ‰“é£`);
                } 
                return true; 
            } 
        }
        
        doWork(p, b) { 
            const role = p.job.role;
            p.money += p.calculateWage(getBaseJobWage(role), role); 
            p.happiness -= 1; p.hunger -= 3; 
            
            // å·¥ä½œå¢åŠ æŠ€èƒ½
            const skillType = getJobSkillType(role);
            this.improveSkill(p, skillType, 0.2);

            const skillVal = p.skills[skillType] || 0;
            const title = getLevelInfo(skillVal).title;

            p.currentAction = `[æ‰“å·¥] åœ¨ ${b.name} å½“${title}${role}`; 
            const timeStr = this.getDateTimeStr();
            p.addLog(`${timeStr} åœ¨ ${b.name} å·¥ä½œ (${title})`);
            b.addLog(`${timeStr} å‘˜å·¥ ${p.name} åœ¨æ­¤å·¥ä½œ`);
        }
        
        doOddJob(p) { 
            const job = choose(ODD_JOBS); 
            if (job.name === "èººå¹³" && p.money < 3) { 
                p.money += 4; p.happiness -= 3; p.hunger -= 4; p.currentAction = `[é›¶å·¥] æ²¡é’±èººå¹³ï¼Œè¢«è¿«æ¬ç –`; 
                p.addLog(`${this.getDateTimeStr()} è¢«è¿«å»å·¥åœ°æ¬ç –`);
                this.improveSkill(p, 'strength', 0.1);
                return; 
            } 
            
            let wage = job.wage > 0 ? p.calculateWage(job.wage) : job.wage; 
            p.money += wage; p.happiness += job.mood; p.happiness = Math.min(100, Math.max(0, p.happiness)); p.hunger -= (job.name === "èººå¹³" ? 1 : 4); 
            p.currentAction = job.name === "èººå¹³" ? `[ç”Ÿæ´»] åœ¨å®¶ èººå¹³` : `[é›¶å·¥] æ­£åœ¨ ${job.name}`; 
            p.addLog(`${this.getDateTimeStr()} æ­£åœ¨åšé›¶å·¥: ${job.name}`);

            // é›¶å·¥å¢åŠ æŠ€èƒ½
            if(job.name === 'å‘ä¼ å•' || job.name === 'å¤–å–å‘˜') this.improveSkill(p, 'social', 0.1);
            else if(job.name !== 'èººå¹³') this.improveSkill(p, 'strength', 0.1);
        }
        
        doEat(p, r) { 
            const timeStr = this.getDateTimeStr();
            if (p.money >= r.price) { 
                p.money -= r.price; p.hunger = Math.min(100, p.hunger + r.food); p.happiness = Math.min(100, p.happiness + 5); this.townMoney += r.price; p.currentAction = `[åƒé¥­] åœ¨ ${r.name} åƒå¾—é¥±é¥±`; 
                p.addLog(`${timeStr} åœ¨ ${r.name} åƒé¥­`);
                r.addLog(`${timeStr} é¡¾å®¢ ${p.name} åœ¨æ­¤ç”¨é¤`);
            } else { 
                p.currentAction = `[åƒé¥­] æ²¡é’±å» ${r.name}ï¼Œè·¯è¾¹å•ƒé¦’å¤´`; p.hunger += 10; 
                p.addLog(`${timeStr} æ²¡é’±åƒé¥­ï¼Œè·¯è¾¹å•ƒé¦’å¤´`);
            } 
        }
        
        doProstitution(p, s) { 
            const w = p.calculateWage(rand(15, 25), "æŠ€å¸ˆ"); const ps = Math.floor(w * 0.7); const bs = w - ps; p.money += ps; p.happiness -= 2; p.hunger -= 4; if (s.staff.length > 0) { const boss = this.chars.find(c => c.name === s.staff[0]); if (boss) boss.money += bs; } p.currentAction = `[ğŸ’‹å–é“¶] åœ¨ ${s.name} æ¥å®¢`; 
            const timeStr = this.getDateTimeStr();
            p.addLog(`${timeStr} åœ¨ ${s.name} æ¥å®¢`);
            s.addLog(`${timeStr} ${p.name} åœ¨æ­¤æä¾›æœåŠ¡`);
            this.improveSkill(p, 'craft', 0.2); 
        }
        
        doStreetwalking(p) { 
            p.money += p.calculateWage(rand(8, 15)); p.happiness -= 4; p.hunger -= 5; 
            
            p.stat_streetwalk = (p.stat_streetwalk || 0) + 1;

            p.currentAction = `[ğŸ’‹ç«™è¡—] åœ¨è·¯è¾¹æ‹‰å®¢`; 
            p.addLog(`${this.getDateTimeStr()} åœ¨è·¯è¾¹æ‹‰å®¢`);
            this.improveSkill(p, 'social', 0.1);
        }
        
        doBuild(p, b) { 
            b.currentProgress += rand(5, 15); p.money += 5; p.happiness -= 2; p.hunger -= 5; p.currentAction = `å»ºè®¾: ${b.name}`; if (!p.constructionContribution[b.id]) p.constructionContribution[b.id] = 0; p.constructionContribution[b.id] += 10; 
            const timeStr = this.getDateTimeStr();
            p.addLog(`${timeStr} å‚ä¸å»ºè®¾ ${b.name}`);
            b.addLog(`${timeStr} ${p.name} å‚ä¸äº†å»ºè®¾`);
            if (b.currentProgress >= b.totalCost && !b.isBuilt) { b.isBuilt = true; this.log(`[ğŸ”¨ç«£å·¥] **${b.name}** å»ºæˆäº†ï¼`, "tag-build"); this.unlockAchievement('first_build'); if(b.id==='gym') this.unlockAchievement('first_gym'); if(b.id==='museum') this.unlockAchievement('culture_hub'); this.distributeConstructionReward(b); } 
            
            // å»ºè®¾å¢åŠ æŠ€èƒ½
            this.improveSkill(p, 'craft', 0.3);
            this.improveSkill(p, 'strength', 0.1);
        }
        
        doRest(p, v) { 
            const timeStr = this.getDateTimeStr();
            if (v && v.price > 0) { 
                if (p.money >= v.price * (p.hasTrait('money-loving')?2:1)) { 
                    p.money -= v.price; this.townMoney += v.price; 
                    if (v.effect === 'food') { p.hunger = Math.min(100, p.hunger + v.food); p.currentAction = `åœ¨ ${v.name} å¤§åƒä¸€é¡¿`; }
                    else if (v.effect === 'health') { 
                        p.health = Math.min(100, p.health + 40); // å¤§å¹…å›å¤å¥åº·
                        p.happiness = Math.min(100, p.happiness + 5); 
                        p.currentAction = `[æ²»ç–—] åœ¨ ${v.name} çœ‹ç—…ç–—ä¼¤`; 
                    } 
                    else if (v.effect === 'beauty') {
                        p.health = Math.min(100, p.health + 5);
                        p.appearance = Math.min(100, p.appearance + 2);
                        p.happiness = Math.min(100, p.happiness + 10);
                        p.currentAction = `[å¥èº«] åœ¨ ${v.name} æ’¸é“å¡‘å½¢`;
                        this.improveSkill(p, 'strength', 0.2);
                    }
                    else if (v.effect === 'fun_high') {
                        p.happiness = Math.min(100, p.happiness + 30); // å¤§å¹…å¢åŠ å¿«ä¹
                        p.currentAction = `[æ¸¸ç©] åœ¨ ${v.name} å°½æƒ…å°–å«`;
                    }
                    else if (v.effect === 'study') {
                        p.happiness = Math.min(100, p.happiness + 5);
                        p.currentAction = `[å‚è§‚] åœ¨ ${v.name} å¢é•¿è§é—»`;
                        this.improveSkill(p, 'intel', 0.5);
                    }
                    else p.currentAction = `åœ¨ ${v.name} æ”¾æ¾`; 
                    
                    p.addLog(`${timeStr} åœ¨ ${v.name} æ¶ˆè´¹ä¼‘æ¯`);
                    v.addLog(`${timeStr} é¡¾å®¢ ${p.name} åœ¨æ­¤æ¶ˆè´¹`);
                } else { 
                    p.currentAction = `åœ¨ è·¯è¾¹ é—²é€›`; 
                    p.addLog(`${timeStr} åœ¨è·¯è¾¹é—²é€›`);
                    return; 
                } 
            } else {
                if (v) {
                    if (v.effect === 'study') {
                        p.happiness = Math.min(100, p.happiness + 8);
                        p.currentAction = `[å­¦ä¹ ] åœ¨ ${v.name} æ±²å–çŸ¥è¯†`;
                        this.improveSkill(p, 'intel', 0.5); // å­¦ä¹ å¢åŠ æ™ºåŠ›
                    } else {
                        p.currentAction = `åœ¨ ${v.name} æ”¾æ¾`; 
                    }
                    p.addLog(`${timeStr} åœ¨ ${v.name} ä¼‘æ¯`);
                    v.addLog(`${timeStr} ${p.name} æ¥è®¿`);
                } else {
                     p.currentAction = `åœ¨ è·¯è¾¹ é—²é€›`;
                     p.addLog(`${timeStr} åœ¨è·¯è¾¹é—²é€›`);
                }
            }
            p.happiness = Math.min(100, p.happiness + rand(5, 10)); p.hunger -= 1; 
        }

        doShopping(p, shop) {
            const timeStr = this.getDateTimeStr();
            if (shop.sells.length > 0 && p.money >= 5) { 
                const affordableItems = shop.sells.filter(id => ITEMS_DB[id] && p.money >= ITEMS_DB[id].price);
                if (affordableItems.length > 0) {
                    const itemId = choose(affordableItems);
                    const itemInfo = ITEMS_DB[itemId];
                    p.money -= itemInfo.price;
                    this.townMoney += itemInfo.price;
                    p.bag.push(itemId);
                    p.happiness += 5;
                    p.currentAction = `[è´­ç‰©] åœ¨ ${shop.name} ä¹°äº† ${itemInfo.name}`;
                    
                    p.addLog(`${timeStr} åœ¨ ${shop.name} ä¹°äº† ${itemInfo.name}`);
                    shop.addLog(`${timeStr} é¡¾å®¢ ${p.name} è´­ä¹°äº† ${itemInfo.name}`);
                } else {
                    this.doRest(p, shop); 
                }
            } else {
                this.doRest(p, shop);
            }
        }

        doUseItem(p, itemId) {
            const item = ITEMS_DB[itemId];
            if (!item) return;
            const idx = p.bag.indexOf(itemId);
            if (idx > -1) p.bag.splice(idx, 1);
            if (item.hungerBonus) p.hunger = Math.min(100, p.hunger + item.hungerBonus);
            if (item.happinessBonus) p.happiness = Math.min(100, p.happiness + item.happinessBonus);
            if (item.healthBonus) p.health = Math.min(100, p.health + item.healthBonus); 

            let actionVerb = "ä½¿ç”¨";
            if (item.type === 'food' || item.type === 'snack') actionVerb = "åƒ";
            if (item.type === 'drink' || item.type === 'alcohol') actionVerb = "å–";
            if (item.type === 'medicine') actionVerb = "æœç”¨";
            p.currentAction = `[${actionVerb}] ç”¨äº† ${item.name}`;
            
            p.addLog(`${this.getDateTimeStr()} ${actionVerb}äº† ${item.name}`);
        }

        tryGift(p, t, venue) {
            const giftIndex = p.bag.findIndex(id => ITEMS_DB[id] && ITEMS_DB[id].type === 'gift');
            if (giftIndex !== -1) {
                const giftId = p.bag[giftIndex];
                const gift = ITEMS_DB[giftId];
                p.bag.splice(giftIndex, 1);
                const pRel = p.relationships[t.name];
                const tRel = t.relationships[p.name];
                const bonus = gift.loveBonus || 10;
                pRel.love = Math.min(100, pRel.love + bonus);
                tRel.love = Math.min(100, tRel.love + bonus);
                p.currentAction = `[ğŸé€ç¤¼] é€äº† ${t.name} ${gift.name}`;
                t.currentAction = `[ğŸæ”¶ç¤¼] æ”¶åˆ°äº† ${p.name} çš„ç¤¼ç‰©`;
                this.log(`[ğŸé€ç¤¼] **${p.name}** åœ¨ ${venue.name} é€ç»™äº† **${t.name}** ä¸€ä¸ª ${gift.name}ï¼Œæ„Ÿæƒ…å‡æ¸©äº†ï¼`, "tag-item");
                
                const timeStr = this.getDateTimeStr();
                p.addLog(`${timeStr} é€ç»™ ${t.name} ä¸€ä¸ª ${gift.name}`);
                t.addLog(`${timeStr} æ”¶åˆ°äº† ${p.name} çš„ ${gift.name}`);
                if(venue.addLog) venue.addLog(`${timeStr} ${p.name} åœ¨æ­¤é€ç¤¼ç»™ ${t.name}`);

                this.updateRelationshipStatus(p, t, pRel, tRel);
                this.checkRomanceEvent(p, t, pRel, tRel, venue); 
                return true;
            }
            return false;
        }
        
        doSocial(p, v) { 
            const timeStr = this.getDateTimeStr();
            if (v.price > 0) { if (p.money < v.price) { this.doRest(p, {name:"è·¯è¾¹",price:0}); return; } p.money -= v.price; this.townMoney += v.price; } 
            const t = choose(this.chars.filter(c => c.name !== p.name)); const pRel = p.relationships[t.name]; const tRel = t.relationships[p.name]; this.breakInteraction(t); 
            
            if (this.tryGift(p, t, v)) return;

            p.addLog(`${timeStr} å’Œ ${t.name} åœ¨ ${v.name} ç¤¾äº¤`);
            t.addLog(`${timeStr} å’Œ ${p.name} åœ¨ ${v.name} ç¤¾äº¤`);
            v.addLog(`${timeStr} ${p.name} ä¸ ${t.name} æ¥è®¿`);

            p.currentAction = `å’Œ ${t.name} åœ¨ ${v.name}`; t.currentAction = `å’Œ ${p.name} åœ¨ ${v.name}`; p.interactingWith = t.name; t.interactingWith = p.name; p.hunger -= 2; t.hunger -= 2; 
            
            this.improveSkill(p, 'social', 0.1);

            if (this.checkRomanceEvent(p, t, pRel, tRel, v)) return; 
            let chaos = p.personality.chaosBonus + t.personality.chaosBonus + p.ideology.chaosMod + t.ideology.chaosMod; if (v.effect === 'chaos') chaos += 0.2; if (v.effect === 'ntr') chaos += 0.4; if (Math.random() < Math.max(0, Math.min(1, 0.1 + chaos))) { 
                pRel.love -= 5; tRel.love -= 5; 
                // åµæ¶å¢åŠ æŠ€èƒ½
                this.improveSkill(p, 'social', 0.25); this.improveSkill(p, 'intel', 0.25);
                this.improveSkill(t, 'social', 0.25); this.improveSkill(t, 'intel', 0.25);
                this.log(`[ğŸ’¢äº‰åµ] ${p.name} å’Œ ${t.name} åœ¨ ${v.name} åµæ¶äº†ã€‚`, "tag-reject"); 
            } else { let boost = rand(1, 3); if (v.effect === 'romance') boost += 2; boost += p.personality.loveGain + t.personality.loveGain + p.ideology.loveMod + t.ideology.loveMod; boost = Math.max(0, Math.round(boost)); pRel.love = Math.min(100, pRel.love + boost); tRel.love = Math.min(100, tRel.love + boost); this.updateRelationshipStatus(p, t, pRel, tRel); } 
        }

        distributeConstructionReward(b) { let total = 0; this.chars.forEach(c => total += (c.constructionContribution[b.id] || 0)); if (total === 0) return; const reward = Math.floor(b.totalCost * 0.3); this.chars.forEach(c => { const share = c.constructionContribution[b.id] || 0; if (share > 0) { const m = Math.floor(reward * (share / total)); c.money += m; if(m>0) this.log(`[ğŸ’°å¥–åŠ±] **${c.name}** è·å»ºè®¾å¥–åŠ± ğŸ’°${m}`, "tag-build"); } }); }
        updateRelationshipStatus(p, t, pRel, tRel) { if (pRel.status === 'stranger' && pRel.love > 10) { pRel.status = 'friend'; tRel.status = 'friend'; } else if (pRel.status === 'friend' && pRel.love > 60 && !['lover','spouse','mistress','enemy','ex'].includes(pRel.status)) { pRel.status = 'bestfriend'; tRel.status = 'bestfriend'; } }
        checkRomanceEvent(p, t, pRel, tRel, v) { if (!p.partner && !t.partner && pRel.love > 70 && pRel.status !== 'spouse') { if (Math.random() < 0.2) { if (t.decideProposal(p.name, 'confess')) { p.partner = t.name; t.partner = p.name; pRel.status = "lover"; tRel.status = "lover"; p.happiness += 20; t.happiness += 20; this.unlockAchievement('first_marriage'); this.log(`[â¤ï¸è¡¨ç™½] ${p.name} å‘ ${t.name} è¡¨ç™½æˆåŠŸï¼`, "tag-love"); } else { p.happiness -= 20; pRel.love -= 10; this.log(`[ğŸ’”æ‹’ç»] ${p.name} è¡¨ç™½å¤±è´¥...`, "tag-reject"); } return true; } } return false; }
        breakInteraction(c) { if (c.interactingWith) { const partner = this.chars.find(x => x.name === c.interactingWith); if (partner) { partner.interactingWith = null; partner.currentAction = "å‘å‘†"; } c.interactingWith = null; } }
        saveData(isAuto = false) { const data = { chars: this.chars, buildings: this.buildings, townMoney: this.townMoney, gameTime: this.gameTime, gameDay: this.gameDay, dateMonth: this.dateMonth, dateDay: this.dateDay, weather: this.weather, achievements: this.achievements, ts: Date.now() }; localStorage.setItem('happyTownV2_Save', JSON.stringify(data)); this.lastSaveTime = Date.now(); if (!isAuto) alert("âœ… å­˜æ¡£æˆåŠŸï¼"); }
        
        loadFromJSON(jsonStr) { 
            try { 
                const data = JSON.parse(jsonStr); 
                this.townMoney = data.townMoney || 0; 
                this.gameTime = data.gameTime || 480; 
                this.gameDay = data.gameDay !== undefined ? data.gameDay : 1;
                this.dateMonth = data.dateMonth || 1;
                this.dateDay = data.dateDay || 1;
                this.weather = data.weather || 'Sunny';
                this.achievements = data.achievements || [];

                this.buildings = data.buildings.map(bData => { 
                    const bp = BUILDINGS_BLUEPRINT.find(x => x.id === bData.id); 
                    let b = bp ? new Building(bp) : new Building(bData); 
                    if (bData.currentProgress !== undefined) b.currentProgress = bData.currentProgress; 
                    if (bData.isBuilt !== undefined) b.isBuilt = bData.isBuilt; 
                    if (bData.staff !== undefined) b.staff = bData.staff; 
                    if (!b.staff) b.staff = []; 
                    if (bData.prostitutes !== undefined) b.prostitutes = bData.prostitutes; 
                    if (!b.prostitutes) b.prostitutes = []; 
                    if(bData.history) b.history = bData.history; 
                    return b; 
                }); 
                this.chars = data.chars.map(cData => { 
                    let c = new Character(cData.name); 
                    Object.assign(c, cData); 
                    if (c.money === undefined) c.money = 0; 
                    if (!c.personality) c.personality = choose(PERSONALITIES); 
                    if (!c.ideology) c.ideology = choose(IDEOLOGIES); 
                    if (!c.gender) c.gender = Math.random() > 0.5 ? 'â™‚ ç”·' : 'â™€ å¥³'; 
                    if (c.hunger === undefined) c.hunger = 80; 
                    if (c.health === undefined) c.health = 100;

                    if (c.nextActionOverride === undefined) c.nextActionOverride = null; 
                    if(!c.bag) c.bag = []; 
                    if(!c.history) c.history = []; 
                    
                    if (c.jailTerm === undefined) c.jailTerm = 0;

                    if (c.stat_rob === undefined) c.stat_rob = 0;
                    if (c.stat_be_robbed === undefined) c.stat_be_robbed = 0;
                    if (c.stat_streetwalk === undefined) c.stat_streetwalk = 0;
                    if (c.stat_assault === undefined) c.stat_assault = 0;
                    if (c.stat_be_assaulted === undefined) c.stat_be_assaulted = 0;

                    if (!c.skills) c.skills = { social: rand(5, 15), craft: rand(5, 15), intel: rand(5, 15), strength: rand(5, 15) };

                    if (!c.traits || c.traits.length === 0) { 
                        c.traits = []; 
                        const traitCount = rand(0, 2); 
                        for (let i = 0; i < traitCount; i++) { 
                            const availableTraits = TRAITS.filter(t => !c.traits.find(tt => tt.id === t.id)); 
                            if (availableTraits.length > 0) c.traits.push(choose(availableTraits)); 
                        } 
                    } 
                    if (!c.constructionContribution) c.constructionContribution = {}; 
                    if (c.prostitute === undefined) c.prostitute = null; 
                    if(c.appearance === undefined) c.appearance = rand(40, 80); 
                    for (let name in c.relationships) { 
                        const rel = c.relationships[name]; 
                        if (!rel.status || !['stranger', 'friend', 'bestfriend', 'lover', 'spouse', 'mistress', 'ex','enemy'].includes(rel.status)) { 
                            rel.status = rel.love > 10 ? 'friend' : 'stranger'; 
                        } 
                        if (rel.intimacyCount === undefined) rel.intimacyCount = 0; 
                    } 
                    return c; 
                }); 
                this.runElectionsAndHiring(); 
            } catch(e) { 
                console.error("å­˜æ¡£æŸå", e); 
                this.initNewGame(); 
            } 
        }

        log(msg, type = "") { const el = document.getElementById('game-log'); const div = document.createElement('div'); div.className = `log-entry ${type}`; div.innerHTML = `<span class="log-time">[${new Date().toLocaleTimeString()}]</span> ${msg}`; el.prepend(div); if (el.children.length > 60) el.lastChild.remove(); }
        
        addNewResident(name) {
            if (this.chars.some(c => c.name === name)) {
                alert(`å±…æ°‘ "${name}" å·²ç»ä½åœ¨å°é•‡é‡Œäº†ï¼`);
                return;
            }

            const newChar = new Character(name);
            this.chars.forEach(existingChar => {
                newChar.relationships[existingChar.name] = { love: 0, status: 'stranger' };
                existingChar.relationships[newChar.name] = { love: 0, status: 'stranger' };
            });

            this.chars.push(newChar);
            newChar.money = 50; 
            this.log(`[ğŸšå…¥ä½] æ¬¢è¿æ–°å±…æ°‘ **${name}** æ¬å…¥çŒ«ã®æ¨¡æ‹Ÿå°é•‡ï¼å¤§å®¶çƒ­çƒˆæ¬¢è¿ï¼`, "tag-event");
            newChar.addLog(`[${this.getDateTimeStr()}] åˆšåˆšæ¬è¿›çŒ«ã®æ¨¡æ‹Ÿå°é•‡`);

            this.updateUI();
            setTimeout(() => {
                const charList = document.getElementById('char-list');
                if(charList) charList.scrollTop = charList.scrollHeight;
            }, 100);
        }

        renderUIStatic() { 
            const bList = document.getElementById('build-list'); bList.innerHTML = ''; 
            const categories = ['food', 'fun', 'service', 'shop'];
            categories.forEach(cat => {
                const catHeader = document.createElement('div');
                catHeader.className = 'category-header';
                catHeader.innerText = CATEGORY_NAMES[cat] || cat;
                bList.appendChild(catHeader);

                this.buildings.filter(b => b.category === cat).forEach(b => { 
                    const div = document.createElement('div'); div.className = 'build-card'; div.id = `build-${b.id}`; 
                    div.onclick = (e) => { if(e.target.tagName !== 'BUTTON') gameInstance.showBuildingDetail(b.id); };
                    let btnHtml = ''; if (!b.isBuilt && b.currentProgress > 0) { btnHtml = `<button class="btn accelerate" onclick="gameInstance.accelerateBuild('${b.id}')">ğŸ’¸ èµ„é‡‘åŠ é€Ÿ (50)</button>`; }
                    div.innerHTML = `<div><div style="font-weight:bold; font-size:1.05rem">${b.name}</div><div style="font-size:0.8rem; color:#666">${b.desc}</div></div><div><div class="bar-container"><div class="bar-fill" style="background:#00b894; width:0%"></div></div><div class="build-prog">æœªå»ºæˆ</div>${btnHtml}</div>`; bList.appendChild(div); 
                });
            });
        }
        
        showEmbezzle() { document.getElementById('embezzle-town-money').innerText = this.townMoney; const list = document.getElementById('embezzle-list'); list.innerHTML = ''; this.chars.forEach(c => { const div = document.createElement('div'); div.className = 'fund-item'; div.innerHTML = `${c.name} <small>(ğŸ’°${c.money})</small>`; div.onclick = () => { document.querySelectorAll('.fund-item').forEach(el=>el.classList.remove('selected')); div.classList.add('selected'); window.selectedFundTarget = c.name; }; list.appendChild(div); }); document.getElementById('embezzle-modal').classList.add('active'); }
        doEmbezzle() { const name = window.selectedFundTarget; const amt = parseInt(document.getElementById('embezzle-amount').value); if (!name || isNaN(amt) || amt <= 0) return alert("è¯·é€‰æ‹©å±…æ°‘å¹¶è¾“å…¥æœ‰æ•ˆé‡‘é¢"); if (this.townMoney < amt) return alert("é•‡åº“èµ„é‡‘ä¸è¶³ï¼"); const c = this.chars.find(x => x.name === name); if (c) { c.money += amt; this.townMoney -= amt; this.log(`[ğŸ’¸æ‹¨æ¬¾] é•‡é•¿å‘ **${c.name}** æ‹¨æ¬¾ ğŸ’°${amt}ã€‚`, "tag-build"); this.updateUI(); this.closeEmbezzle(); } }
        closeEmbezzle() { document.getElementById('embezzle-modal').classList.remove('active'); }
        
        showJobBoard() {
            const list = document.getElementById('jobboard-list'); list.innerHTML = '';
            const oddHeader = document.createElement('div'); oddHeader.className = 'job-section-header'; oddHeader.style.borderLeftColor = '#3498db'; oddHeader.innerText = "ğŸ›  ä¸´æ—¶é›¶å·¥ / è‡ªç”±èŒä¸š"; list.appendChild(oddHeader);
            ODD_JOBS.forEach(job => { const item = document.createElement('div'); item.className = 'job-item'; item.innerHTML = `<div><div class="job-name">${job.name}</div><div class="job-loc" style="font-size:0.8em; color:gray;">Mood: ${job.mood}</div></div><div class="job-wage" style="color:${job.wage<0?'#e74c3c':'#27ae60'}">ğŸ’° ${job.wage}</div>`; list.appendChild(item); });
            const hookerItem = document.createElement('div'); hookerItem.className = 'job-item'; hookerItem.innerHTML = `<div><div class="job-name">ğŸ’‹ ç«™è¡—</div></div><div class="job-wage">ğŸ’° 8-15</div>`; list.appendChild(hookerItem);
            const formalHeader = document.createElement('div'); formalHeader.className = 'job-section-header'; formalHeader.style.borderLeftColor = '#f1c40f'; formalHeader.innerText = "ğŸ¢ ä¼ä¸š / æœºæ„å²—ä½"; list.appendChild(formalHeader);
            this.buildings.forEach(b => { if (b.jobs.length > 0) { b.jobs.forEach(role => { const item = document.createElement('div'); item.className = 'job-item'; item.innerHTML = `<div><div class="job-name">ğŸ‘” ${role}</div><div class="job-loc">${b.name}</div></div><div class="job-wage">ğŸ’° ${getJobWage(role)}</div>`; list.appendChild(item); }); } });
            document.getElementById('jobboard-modal').classList.add('active');
        }
        
        showAchievements() {
            const modal = document.getElementById('achievements-modal');
            const list = document.getElementById('achievements-list');
            list.innerHTML = '';
            ACHIEVEMENTS_DB.forEach(ach => {
                const isUnlocked = this.achievements.includes(ach.id);
                const div = document.createElement('div');
                div.className = `achieve-item ${isUnlocked ? 'unlocked' : ''}`;
                div.innerHTML = `
                    <div class="achieve-icon">${ach.icon}</div>
                    <div class="achieve-info">
                        <div class="achieve-title">${ach.name} ${isUnlocked ? 'âœ…' : ''}</div>
                        <div class="achieve-desc">${isUnlocked ? ach.desc : '??? (ç»§ç»­æ¢ç´¢å°é•‡ä»¥è§£é”)'}</div>
                        ${isUnlocked ? `<div class="achieve-reward">å¥–åŠ±: ğŸ’°${ach.reward}</div>` : ''}
                    </div>
                `;
                list.appendChild(div);
            });
            modal.classList.add('active');
        }
        closeAchievements() { document.getElementById('achievements-modal').classList.remove('active'); }

        showCharacterDetail(name) {
            const c = this.chars.find(x => x.name === name); if (!c) return;
            const modal = document.getElementById('char-detail-modal');
            const content = document.getElementById('detail-content'); document.getElementById('detail-name').innerText = `${c.name} çš„ä¸ªäººæ¡£æ¡ˆ`;
            
            let jobText = "æ— ä¸š";

            if (c.prostitute) {
                jobText = "å¤±è¶³";
            } else if (c.job) {
                const skillType = getJobSkillType(c.job.role);
                const skillVal = c.skills[skillType] || 0;
                const levelInfo = getLevelInfo(skillVal);
                jobText = `${levelInfo.title}${c.job.role}`;
            }

            let wage = c.job ? c.calculateWage(getBaseJobWage(c.job.role), c.job.role) : 0;
            let traitsHtml = c.traits.map(t => `<div class="trait-tag" title="${t.desc}">${t.name}</div>`).join('') || "æ— ";
            const ideology = c.ideology || { name: "æ— ", color: "#999", desc: "", chaosMod:0, loveMod:0, wageMod:0 };
            
            let bagHtml = '<div style="color:#999; font-size:0.85rem;">èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿ</div>';
            if (c.bag && c.bag.length > 0) {
                bagHtml = '<div class="bag-grid">';
                c.bag.forEach(itemId => { 
                    const item = ITEMS_DB[itemId]; 
                    if(item) {
                        const tooltipText = getItemTooltipText(itemId);
                        bagHtml += `<div class="bag-item tooltip-item" data-tip="${tooltipText}">${item.name}</div>`; 
                    }
                });
                bagHtml += '</div>';
            }

            let historyHtml = '<div class="history-list">';
            if (!c.history || c.history.length === 0) {
                historyHtml += '<div class="history-item">æš‚æ— æ´»åŠ¨è®°å½•</div>';
            } else {
                c.history.forEach(h => { historyHtml += `<div class="history-item">${h}</div>`; });
            }
            historyHtml += '</div>';

            const ideologyHtml = `
                <div class="ideology-box">
                    <div style="color:${ideology.color}; font-weight:bold; font-size:1.1rem;">${ideology.name}</div>
                    <div style="font-size:0.9rem; color:#555; margin:4px 0;">${ideology.desc}</div>
                    <div style="font-size:0.85rem;">
                        <span class="stat-positive">â¤ +${ideology.loveMod} å¥½æ„Ÿ</span> | 
                        <span class="stat-positive">ğŸ’¢ ${Math.floor(ideology.chaosMod * 100)}% åµæ¶</span> |
                        <span class="stat-positive">ğŸ’° ${Math.floor(ideology.wageMod * 100)}% å·¥èµ„</span>
                    </div>
                </div>
            `;
            
            let jailStatus = "";
            if (c.jailTerm > 0) {
                jailStatus = `<div style="margin-top:5px; color:#e74c3c; font-weight:bold;">â›“ï¸ æœåˆ‘ä¸­: å‰©ä½™ ${(c.jailTerm/60).toFixed(1)} å°æ—¶</div>`;
            }

            const skillsHtml = `
                <div class="skill-row"><span class="skill-name">ç¤¾äº¤</span><div class="skill-track"><div class="skill-bar sk-social" style="width:${c.skills.social}%"></div></div><span class="skill-val">${Math.floor(c.skills.social)}</span></div>
                <div class="skill-row"><span class="skill-name">æ‰‹è‰º</span><div class="skill-track"><div class="skill-bar sk-craft" style="width:${c.skills.craft}%"></div></div><span class="skill-val">${Math.floor(c.skills.craft)}</span></div>
                <div class="skill-row"><span class="skill-name">æ™ºåŠ›</span><div class="skill-track"><div class="skill-bar sk-intel" style="width:${c.skills.intel}%"></div></div><span class="skill-val">${Math.floor(c.skills.intel)}</span></div>
                <div class="skill-row"><span class="skill-name">ä½“èƒ½</span><div class="skill-track"><div class="skill-bar sk-str" style="width:${c.skills.strength}%"></div></div><span class="skill-val">${Math.floor(c.skills.strength)}</span></div>
            `;

            content.innerHTML = `
                <div class="detail-group">
                    <div class="detail-label">åŸºæœ¬çŠ¶æ€ <button class="edit-btn" onclick="editGender('${c.name}')">[ä¿®æ”¹æ€§åˆ«]</button></div>
                    <div class="detail-val">æ€§åˆ«: ${c.gender} | ğŸ’° ${c.money} | â¤ ${Math.floor(c.happiness)} | ğŸ— ${Math.floor(c.hunger)} | ğŸš‘ ${Math.floor(c.health)}</div>
                    <div class="detail-val" style="margin-top:5px; color:#8e44ad">âœ¨ é¢œå€¼: ${Math.floor(c.appearance)}</div>
                    
                    <div style="background:#f8f9fa; padding:8px; border-radius:6px; margin-top:8px; border:1px solid #eee;">
                        <div class="detail-val">ğŸ‘· ${jobText} <span style="color:#27ae60;font-size:0.9em">(æ—¥è–ª:ğŸ’°${wage})</span></div>
                    </div>

                    ${jailStatus}
                    <button class="btn control" onclick="showActionSelect('${c.name}')">ğŸ•¹ï¸ å¼ºåˆ¶å®‰æ’æ´»åŠ¨</button>
                </div>
                <div class="detail-group">
                    <div class="detail-label">ğŸ”§ èŒä¸šæŠ€èƒ½</div>
                    ${skillsHtml}
                </div>
                <div class="detail-group">
                    <div class="detail-label">ğŸ‘£ æœ€è¿‘è¶³è¿¹</div>
                    ${historyHtml}
                </div>
                <div class="detail-group">
                    <div class="detail-label">ğŸ’ èƒŒåŒ…</div>
                    ${bagHtml}
                </div>
                <div class="detail-group">
                    <div class="detail-label">æ€§æ ¼ <button class="edit-btn" onclick="editPersonality('${c.name}')">[ä¿®æ”¹]</button></div>
                    <div class="detail-val">${c.personality.name}</div><div class="detail-desc">${c.personality.desc}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">ç‰¹æ€§ <button class="edit-btn" onclick="editTraits('${c.name}')">[é‡ç½®]</button></div>
                    <div>${traitsHtml}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">ä¿¡ä»° <button class="edit-btn" onclick="editIdeology('${c.name}')">[ä¿®æ”¹]</button></div>
                    ${ideologyHtml}
                </div>
            `;
            modal.classList.add('active');
        }
        
        showBuildingDetail(bid) {
            const b = this.buildings.find(x => x.id === bid);
            if (!b) return;
            const modal = document.getElementById('building-detail-modal');
            document.getElementById('b-detail-name').innerText = b.name;
            const content = document.getElementById('b-detail-content');
            
            let statusHtml = b.isBuilt ? `<span style="color:#27ae60">âœ… è¥ä¸šä¸­</span>` : `<span style="color:#e67e22">ğŸš§ å»ºè®¾ä¸­ (${Math.floor(b.currentProgress/b.totalCost*100)}%)</span>`;
            let staffListHtml = '';
            if (b.jobs.length === 0) {
                staffListHtml = '<div style="padding:10px; color:#999;">æ­¤å»ºç­‘ä¸æä¾›å·¥ä½œå²—ä½</div>';
            } else {
                b.jobs.forEach((role, index) => {
                    const workerName = b.staff[index] || "ã€ç©ºç¼ºã€‘";
                    let wage = getJobWage(role);
                    let extraInfo = "";
                    let progressBarHtml = "";
                    
                    if (b.staff[index]) {
                        const worker = this.chars.find(c => c.name === workerName);
                        if (worker) {
                             wage = worker.calculateWage(wage, role);
                             const skillType = getJobSkillType(role);
                             const skillVal = worker.skills[skillType] || 0;
                             const levelInfo = getLevelInfo(skillVal);
                             extraInfo = `<span style="font-size:0.8em; color:#2ecc71">(${levelInfo.title})</span>`;

                             // æ™‹å‡è¿›åº¦æ¡ç”Ÿæˆ
                             if (levelInfo.level < 3) {
                                let prevThreshold = 0;
                                if (levelInfo.level === 1) prevThreshold = 20;
                                if (levelInfo.level === 2) prevThreshold = 50;
                                const range = levelInfo.next - prevThreshold;
                                const progress = skillVal - prevThreshold;
                                const pct = Math.max(0, Math.min(100, Math.floor((progress / range) * 100)));
                                
                                progressBarHtml = `
                                <div style="margin-top:4px; background:#eee; height:4px; border-radius:2px; width:100%; position:relative; margin-bottom:2px;" title="æ™‹å‡è¿›åº¦: ${Math.floor(skillVal)}/${levelInfo.next}">
                                    <div style="background:#f1c40f; height:100%; width:${pct}%; border-radius:2px; transition:width 0.3s;"></div>
                                </div>
                                <div style="font-size:0.7rem; color:#999; text-align:right;">æ™‹å‡è¿›åº¦: ${pct}%</div>`;
                            } else {
                                progressBarHtml = `<div style="font-size:0.7rem; color:#f1c40f; text-align:right; margin-top:4px;">âœ¨ å¤§å¸ˆçº§</div>`;
                            }
                        }
                    }

                    const color = b.staff[index] ? "#0984e3" : "#ccc";
                    staffListHtml += `
                        <div class="staff-list-item" style="flex-direction:column; align-items:stretch;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div><span class="staff-role">${role}</span>${extraInfo}<div style="font-size:0.8rem; color:#666;">æ—¥è–ª: ğŸ’°${wage}</div></div>
                                <div style="font-weight:bold; color:${color};">${workerName}</div>
                            </div>
                            ${progressBarHtml}
                        </div>`;
                });
            }
            if (b.id === 'footshop' && b.prostitutes.length > 0) {
                 staffListHtml += `<div style="margin-top:10px; font-weight:bold; color:#e056fd;">ğŸ’‹ ç‰¹æ®ŠæœåŠ¡äººå‘˜:</div>`;
                 b.prostitutes.forEach(name => { staffListHtml += `<div class="staff-list-item"><span class="staff-role">æŠ€å¸ˆ</span><span class="staff-name" style="color:#e056fd">${name}</span></div>`; });
            }

            let sellsHtml = '';
            if (b.sells && b.sells.length > 0) {
                sellsHtml = `<div style="margin-top:10px; font-weight:bold;">ğŸ›ï¸ å”®å–å•†å“:</div><div style="display:flex; flex-wrap:wrap; gap:5px; margin-top:5px;">`;
                
                b.sells.forEach(itemId => { 
                    const item = ITEMS_DB[itemId]; 
                    if (item) {
                        const tooltipText = getItemTooltipText(itemId);
                        sellsHtml += `<span class="tooltip-item" data-tip="${tooltipText}" style="cursor:help; background:#fff5f0; border:1px solid #e17055; color:#d35400; padding:2px 6px; border-radius:4px; font-size:0.8rem;">${item.name} (ğŸ’°${item.price})</span>`; 
                    }
                });

                sellsHtml += `</div>`;
            }

            let historyHtml = '<div class="history-list">';
            if (!b.history || b.history.length === 0) {
                historyHtml += '<div class="history-item">æš‚æ— è®¿å®¢è®°å½•</div>';
            } else {
                b.history.forEach(h => { historyHtml += `<div class="history-item">${h}</div>`; });
            }
            historyHtml += '</div>';

            content.innerHTML = `
                <div style="margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid #eee;">
                    <div style="font-size:0.9rem; color:#666; margin-bottom:5px;">${b.desc}</div>
                    <div>çŠ¶æ€: ${statusHtml}</div>
                    <div>æ¶ˆè´¹ä»·æ ¼: ğŸ’°${b.price}</div>
                    <div>è¥ä¸šæ—¶é—´: ${b.open}:00 - ${b.close}:00</div>
                    ${sellsHtml}
                </div>
                <div style="font-weight:bold; margin-bottom:5px;">ğŸ‘£ æœ€è¿‘è®¿å®¢è®°å½•</div>
                ${historyHtml}
                <div style="font-weight:bold; margin-bottom:5px; margin-top:10px;">ğŸ‘¥ å²—ä½ä¸å‘˜å·¥</div>
                <div style="border:1px solid #eee; border-radius:6px; overflow:hidden;">${staffListHtml}</div>
            `;
            modal.classList.add('active');
        }

        editGender(name) { const c = this.chars.find(x=>x.name===name); if(c){ c.gender = c.gender==='â™‚ ç”·'?'â™€ å¥³':'â™‚ ç”·'; this.showCharacterDetail(name); } }
        editPersonality(name) { const c = this.chars.find(x=>x.name===name); if(c){ const n = prompt("è¾“å…¥æ€§æ ¼(æ˜“æ€’/æ²‰ç€/å¼€æœ—/å†…å‘/æ¸©æŸ”/åˆ»è–„/å¹½é»˜/ä¸¥è‚ƒ):"); const p = PERSONALITIES.find(x=>x.name===n); if(p){c.personality=p;this.showCharacterDetail(name);}else alert("æ— æ•ˆ"); } }
        editIdeology(name) { const c = this.chars.find(x=>x.name===name); if(c){ const n = prompt("è¾“å…¥ä¿¡ä»°(å…±äº§ä¸»ä¹‰/ç¤¾ä¼šä¸»ä¹‰/æ°‘ä¸»ä¸»ä¹‰/èµ„æœ¬ä¸»ä¹‰/å›ä¸»ç«‹å®ª/å†›å›½ä¸»ä¹‰):"); const i = IDEOLOGIES.find(x=>x.name.includes(n)); if(i){c.ideology=i;this.showCharacterDetail(name);}else alert("æ— æ•ˆ"); } }
        editTraits(name) { const c = this.chars.find(x=>x.name===name); if(c){ c.traits=[]; const count=rand(0,2); for(let i=0;i<count;i++){ const t=TRAITS.filter(x=>!c.traits.includes(x)); if(t.length) c.traits.push(choose(t)); } this.showCharacterDetail(name); } }
        
        updateUI() {
            document.getElementById('town-money').innerText = this.townMoney;
            const h = Math.floor(this.gameTime / 60); const m = this.gameTime % 60;
            document.getElementById('game-time').innerText = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
            document.getElementById('game-day').innerText = DAYS[this.gameDay];
            
            // æ›´æ–°æ—¥æœŸæ˜¾ç¤º
            const seasonName = this.getSeasonName();
            document.getElementById('calendar-display').innerText = `ğŸ“… ${this.dateMonth}æœˆ${this.dateDay}æ—¥ (${seasonName})`;
            const wInfo = WEATHER_TYPES[this.weather];
            document.getElementById('weather-display').innerText = wInfo ? wInfo.name : '';
            
            document.getElementById('resident-count').innerText = this.chars.length;
            const charList = document.getElementById('char-list'); charList.innerHTML = ''; 
            this.chars.forEach(c => {
                let lovedOne = "æ— "; let maxL = 0; for(let name in c.relationships) { if(c.relationships[name].love > maxL) { maxL = c.relationships[name].love; lovedOne = name; } }
                let statusHtml = c.partner ? `<span style="color:var(--love)">â¤ ${c.partner}</span>` : `<span style="color:#999">å–œæ¬¢: ${lovedOne}</span>`;
                
                let actionClass = "";
                if (c.jailTerm > 0) actionClass = "action-jail"; 
                else if (c.currentAction.includes("å»ºè®¾")) actionClass = "action-build";
                else if (c.currentAction.includes("å·¥ä½œ") || c.currentAction.includes("æ‰“å·¥") || c.currentAction.includes("å–é“¶")) actionClass = "action-work";
                else if (c.currentAction.includes("èººå¹³")) actionClass = "action-lieflat";
                else if (c.currentAction.includes("åƒ") || c.currentAction.includes("äº«ç”¨")) actionClass = "action-eat";
                else if (c.currentAction.includes("çŠ¯ç½ª") || c.currentAction.includes("æŠ¢åŠ«") || c.currentAction.includes("åŠ«è‰²")) actionClass = "action-crime";
                else if (c.currentAction.includes("è´­ç‰©") || c.currentAction.includes("é€ç¤¼")) actionClass = "action-shop";
                else if (c.currentAction.includes("ä½¿ç”¨") || c.currentAction.includes("æœç”¨")) actionClass = "action-use";
                else actionClass = "action-social";

                let jobTitle = "æ— ä¸š";
                if(c.job) {
                    const skillType = getJobSkillType(c.job.role);
                    const title = getLevelInfo(c.skills[skillType]||0).title;
                    jobTitle = `${title}${c.job.role}`;
                }

                let jobInfo = c.job ? `<span style="font-size:0.8em;color:#666;background:#eee;padding:2px 4px;border-radius:4px;">${jobTitle}</span>` : `<span style="font-size:0.8em;color:#aaa">æ— ä¸š</span>`;
                const div = document.createElement('div'); div.className = `char-card ${actionClass}`; div.onclick = () => gameInstance.showCharacterDetail(c.name);
                
                div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;"><div><strong>${c.name}</strong> <span style="font-size:0.75em;color:#888;">${c.gender}</span> ${jobInfo}</div><div style="text-align:right; font-size:0.85rem;"><span style="color:#f39c12">ğŸ’°${c.money}</span></div></div><div style="font-size:0.8em; margin-bottom:5px;">${statusHtml}</div>
                
                <div class="bar-container" title="å¥åº· (Health)"><div class="bar-fill health-fill" style="width:${c.health}%"></div></div>
                <div class="bar-container" title="é¥±é£Ÿ (Hunger)" style="height:3px;margin-top:2px;"><div class="bar-fill food-fill" style="width:${c.hunger}%"></div></div>
                <div class="bar-container" title="å¿ƒæƒ… (Mood)" style="height:3px;margin-top:2px;"><div class="bar-fill hp-fill" style="width:${c.happiness}%"></div></div>
                
                <div style="color:#555;margin-top:2px; font-size:0.85rem">${c.currentAction}</div>`;
                charList.appendChild(div);
            });
            this.buildings.forEach(b => {
                const el = document.getElementById(`build-${b.id}`);
                if (el) {
                    const pct = Math.min(100, (b.currentProgress / b.totalCost) * 100); el.querySelector('.bar-fill').style.width = `${pct}%`;
                    let staffHtml = ""; if (b.jobs.length > 0) staffHtml = `<div style="font-size:0.75rem; color:#666; margin-top:4px;">å‘˜å·¥: ${b.staff.length}/${b.jobs.length}</div>`;
                    if (b.isBuilt) { el.classList.add('built'); el.classList.remove('building'); el.querySelector('.build-prog').innerHTML = `âœ… è¥ä¸šä¸­ Price: ğŸ’°${b.price} ${staffHtml}`; } 
                    else if (b.currentProgress > 0) { el.classList.add('building'); el.querySelector('.build-prog').innerText = `ğŸš§ å»ºè®¾ä¸­: ${Math.floor(pct)}%`; } 
                    else { el.querySelector('.build-prog').innerText = `æœªå»ºæˆ (ğŸ’°${b.price})`; }
                    if(!b.isBuilt && b.currentProgress > 0) {
                        if(!el.querySelector('.accelerate')) {
                           el.innerHTML = `<div><div style="font-weight:bold; font-size:1.05rem">${b.name}</div><div style="font-size:0.8rem; color:#666">${b.desc}</div></div><div><div class="bar-container"><div class="bar-fill" style="background:#00b894; width:${pct}%"></div></div><div class="build-prog">ğŸš§ å»ºè®¾ä¸­: ${Math.floor(pct)}%</div><button class="btn accelerate" onclick="gameInstance.accelerateBuild('${b.id}')">ğŸ’¸ èµ„é‡‘åŠ é€Ÿ (50)</button></div>`;
                           el.classList.add('building');
                        } else {
                            el.querySelector('.bar-fill').style.width = `${pct}%`;
                            el.querySelector('.build-prog').innerText = `ğŸš§ å»ºè®¾ä¸­: ${Math.floor(pct)}%`;
                        }
                    }
                }
            });
            if (isRelViewOpen) this.renderRelations();
        }

        renderRelations() {
            if (!isRelViewOpen) return;
            try {
                const incomingLove = {}; 
                this.chars.forEach(c => incomingLove[c.name] = 0);
                this.chars.forEach(c => { for(let tName in c.relationships) if(incomingLove[tName] !== undefined) incomingLove[tName] += c.relationships[tName].love; });
                const sortedChars = [...this.chars].sort((a,b) => (incomingLove[b.name]||0) - (incomingLove[a.name]||0));
                if (sortedChars.length > 0) { 
                    const topName = sortedChars[0].name; const botName = sortedChars[sortedChars.length - 1].name;
                    document.getElementById('stat-pop').innerHTML = `${topName} <small>(${incomingLove[topName]||0}â¤)</small>`; 
                    document.getElementById('stat-lonely').innerHTML = `${botName} <small>(${incomingLove[botName]||0}â¤)</small>`; 
                }
            } catch(e) { console.error("Stats Error:", e); }

            try {
                const listEl = document.getElementById('rel-list'); listEl.innerHTML = '';
                this.chars.forEach(c => {
                    const div = document.createElement('div'); div.className = 'rel-item';
                    let rels = Object.entries(c.relationships).map(([name, data]) => ({ name, ...data })).sort((a, b) => b.love - a.love).filter(r => r.love > 0 || r.status !== 'stranger');
                    let relHtml = rels.map(r => {
                        let tagClass = "tag-friend"; 
                        if (r.status === 'spouse') tagClass = 'tag-spouse'; else if (r.status === 'lover') tagClass = 'tag-lover'; else if (r.status === 'mistress') tagClass = 'tag-mistress'; else if (r.status === 'bestfriend') tagClass = 'tag-bestfriend'; else if (r.status === 'ex') tagClass = 'tag-ex'; else if (r.status === 'enemy') tagClass = 'tag-enemy';
                        const cnStatus = REL_TRANSLATE[r.status] || r.status;
                        return `<div style="margin-top:4px;"><span class="rel-tag ${tagClass}">${cnStatus}</span><b>${r.name}</b> <span style="color:#999">(${r.love})</span></div>`;
                    }).join('');
                    if(!relHtml) relHtml = `<div style="color:#ccc;font-size:0.8rem">æš‚æ— ç‰¹åˆ«å…³ç³»</div>`;
                    div.innerHTML = `<strong>${c.name}</strong>${relHtml}`; listEl.appendChild(div);
                });

                const canvas = document.getElementById('rel-canvas'); const container = document.getElementById('rel-graph-container');
                const w = container.clientWidth || 800; const h = container.clientHeight || 600;
                canvas.width = w; canvas.height = h;
                const ctx = canvas.getContext('2d'); const cx = w / 2; const cy = h / 2; const r = Math.min(cx, cy) - 50; 
                ctx.clearRect(0, 0, w, h);
                const points = {}; this.chars.forEach((c, i) => { const angle = (i / this.chars.length) * Math.PI * 2 - Math.PI / 2; points[c.name] = { x: cx + Math.cos(angle) * r, y: cy + Math.sin(angle) * r }; });

                this.chars.forEach(c => {
                     const p1 = points[c.name];
                     for (let tName in c.relationships) {
                         const rel = c.relationships[tName];
                         if ((rel.love > 40 || (rel.status !== 'stranger' && rel.status !== 'friend')) && points[tName]) {
                             const p2 = points[tName];
                             ctx.beginPath(); 
                             const dx = p2.x - p1.x; const dy = p2.y - p1.y; const dist = Math.sqrt(dx*dx + dy*dy);
                             const midX = (p1.x + p2.x) / 2; const midY = (p1.y + p2.y) / 2;
                             const offset = 20; const angle = Math.atan2(dy, dx);
                             const cpX = midX - Math.sin(angle) * offset; const cpY = midY + Math.cos(angle) * offset;
                             ctx.moveTo(p1.x, p1.y); ctx.quadraticCurveTo(cpX, cpY, p2.x, p2.y);
                             let color = 'rgba(200,200,200,0.2)'; let width = 1; let dash = [];
                             if(rel.status === 'spouse') { color = 'rgba(232,67,147,0.8)'; width = 3; }
                             else if(rel.status === 'lover') { color = 'rgba(255,107,107,0.7)'; width = 2; }
                             else if(rel.status === 'mistress') { color = 'rgba(255,140,0,0.7)'; width = 2; dash = [5, 5]; }
                             else if(rel.status === 'bestfriend') { color = 'rgba(52,152,219,0.6)'; width = 2; }
                             else if(rel.status === 'ex') { color = 'rgba(99,110,114,0.5)'; width = 1.5; dash = [2, 2]; }
                             else if(rel.status === 'enemy') { color = 'rgba(192, 57, 43, 0.8)'; width = 2; } 
                             ctx.strokeStyle = color; ctx.lineWidth = width; ctx.setLineDash(dash); ctx.stroke(); ctx.setLineDash([]);
                             const arrowAngle = Math.atan2(p2.y - cpY, p2.x - cpX); const arrowLen = 8;
                             ctx.beginPath(); const endX = p2.x - Math.cos(arrowAngle) * 22; const endY = p2.y - Math.sin(arrowAngle) * 22;
                             ctx.moveTo(endX, endY); ctx.lineTo(endX - arrowLen * Math.cos(arrowAngle - Math.PI / 6), endY - arrowLen * Math.sin(arrowAngle - Math.PI / 6)); ctx.lineTo(endX - arrowLen * Math.cos(arrowAngle + Math.PI / 6), endY - arrowLen * Math.sin(arrowAngle + Math.PI / 6)); ctx.fillStyle = color; ctx.fill();
                         }
                     }
                });
                this.chars.forEach(c => {
                    const p = points[c.name];
                    ctx.beginPath(); ctx.arc(p.x, p.y, 20, 0, Math.PI*2); ctx.fillStyle = "#fff"; ctx.fill(); ctx.strokeStyle = c.partner ? "#ff6b6b" : "#4a90e2"; ctx.lineWidth = 2; ctx.stroke();
                    ctx.fillStyle = "#333"; ctx.font = "11px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText(c.name, p.x, p.y);
                });
            } catch(e) { console.error("Render Error:", e); }
        }
    }

    // --- å…¨å±€å‡½æ•° ---
    function switchTab(tabName) { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById(`tab-${tabName}`).classList.add('active'); document.querySelectorAll('.col-view').forEach(v => v.classList.remove('active-view')); document.getElementById(`view-${tabName}`).classList.add('active-view'); }
    let gameInstance = null; let isRelViewOpen = false;
    function toggleRelationView() { const main = document.getElementById('main-view'); const rel = document.getElementById('relation-view'); isRelViewOpen = !isRelViewOpen; if (isRelViewOpen) { main.style.display = 'none'; rel.classList.add('active'); setTimeout(() => { if (gameInstance) gameInstance.renderRelations(); }, 50); } else { main.style.display = 'flex'; rel.classList.remove('active'); } }
    function showLeaderboard() { renderLeaderboard('money'); document.getElementById('leaderboard-modal').classList.add('active'); }
    function closeLeaderboard() { document.getElementById('leaderboard-modal').classList.remove('active'); }
    function showAchievements() { if(gameInstance) gameInstance.showAchievements(); }
    function closeAchievements() { if(gameInstance) gameInstance.closeAchievements(); }
    function showJobBoard() { if(gameInstance) gameInstance.showJobBoard(); }
    function closeJobBoard() { document.getElementById('jobboard-modal').classList.remove('active'); }
    
    function renderLeaderboard(type) { 
        if (!gameInstance) return; 
        const list = document.getElementById('leaderboard-list'); 
        list.innerHTML = ''; 
        let sorted = [...gameInstance.chars];
        
        if (type === 'money') { 
            sorted.sort((a, b) => b.money - a.money); 
        } else if (type === 'happiness') { 
            sorted.sort((a, b) => b.happiness - a.happiness); 
        } else if (type === 'popularity') {
             const popMap = {}; 
             gameInstance.chars.forEach(c => popMap[c.name] = 0);
             gameInstance.chars.forEach(source => { 
                 for(let target in source.relationships) { 
                     if(popMap[target] !== undefined) popMap[target] += source.relationships[target].love; 
                 } 
             });
             sorted.sort((a, b) => popMap[b.name] - popMap[a.name]);
             sorted.forEach(c => c._tempPop = popMap[c.name]);
        } 
        else if (type === 'robbery') {
            sorted.sort((a, b) => (b.stat_rob || 0) - (a.stat_rob || 0));
        } else if (type === 'streetwalk') {
            sorted.sort((a, b) => (b.stat_streetwalk || 0) - (a.stat_streetwalk || 0));
        } else if (type === 'assault') {
            sorted.sort((a, b) => (b.stat_assault || 0) - (a.stat_assault || 0));
        }

        sorted.forEach((c, index) => { 
            if (type === 'robbery' && (c.stat_rob||0) === 0 && (c.stat_be_robbed||0) === 0 && index > 5) return;
            if (type === 'streetwalk' && (c.stat_streetwalk||0) === 0 && index > 5) return;
            if (type === 'assault' && (c.stat_assault||0) === 0 && (c.stat_be_assaulted||0) === 0 && index > 5) return;

            const item = document.createElement('div'); 
            item.className = 'rank-item'; 
            let rankClass = ''; 
            if (index === 0) rankClass = 'rank-1'; 
            else if (index === 1) rankClass = 'rank-2'; 
            else if (index === 2) rankClass = 'rank-3'; 
            
            let valText = '';
            if(type==='money') valText = `ğŸ’° ${c.money}`;
            else if(type==='happiness') valText = `â¤ ${Math.floor(c.happiness)}`;
            else if(type==='popularity') valText = `ğŸ”¥ ${c._tempPop}`;
            else if(type==='robbery') {
                valText = `<span style="color:#2d3436">ğŸ”ª æŠ¢:${c.stat_rob||0}</span> | <span style="color:#999">è¢«æŠ¢:${c.stat_be_robbed||0}</span>`;
            }
            else if(type==='streetwalk') {
                valText = `<span style="color:#e056fd">ğŸ’‹ ç«™è¡—: ${c.stat_streetwalk||0} æ¬¡</span>`;
            }
            else if(type==='assault') {
                valText = `<span style="color:#c0392b">ğŸ˜ˆ åŠ«:${c.stat_assault||0}</span> | <span style="color:#999">å—å®³:${c.stat_be_assaulted||0}</span>`;
            }

            item.innerHTML = `<div class="rank-num ${rankClass}">${index + 1}</div><div class="rank-info"><div class="rank-name">${c.name}</div></div><div class="rank-val" style="font-size:0.9rem">${valText}</div>`; 
            list.appendChild(item); 
        }); 
    }
    
    function showPersonalityInfo() { document.getElementById('personality-modal').classList.add('active'); const list = document.getElementById('personality-list'); list.innerHTML = ''; PERSONALITIES.forEach(p => { const item = document.createElement('div'); item.className = 'personality-item'; if (p.chaosBonus > 0.1) item.classList.add('chaos'); else if (p.chaosBonus < -0.1) item.classList.add('peace'); else item.classList.add('neutral'); const chaosText = p.chaosBonus > 0 ? `<span class="stat-negative">+${(p.chaosBonus * 100).toFixed(0)}% åµæ¶ç‡</span>` : `<span class="stat-positive">${(p.chaosBonus * 100).toFixed(0)}% åµæ¶ç‡</span>`; const loveText = p.loveGain > 0 ? `<span class="stat-positive">+${p.loveGain.toFixed(1)} å¥½æ„Ÿå¢é•¿</span>` : p.loveGain < 0 ? `<span class="stat-negative">${p.loveGain.toFixed(1)} å¥½æ„Ÿå¢é•¿</span>` : `<span>0 å¥½æ„Ÿå¢é•¿</span>`; item.innerHTML = `<div class="personality-name">${p.name}</div><div class="personality-desc">${p.desc}</div><div class="personality-stats"><div class="stat-item">${chaosText}</div><div class="stat-item">${loveText}</div></div>`; list.appendChild(item); }); }
    function closePersonalityInfo() { document.getElementById('personality-modal').classList.remove('active'); }
    function closeCharDetail() { document.getElementById('char-detail-modal').classList.remove('active'); }
    
    function showEmbezzle() { if (gameInstance) gameInstance.showEmbezzle(); }
    function doEmbezzle() { if (gameInstance) gameInstance.doEmbezzle(); }
    function closeEmbezzle() { if (gameInstance) gameInstance.closeEmbezzle(); }
    function toggleSpeed() { if (gameInstance) gameInstance.toggleSpeed(); }
    function showActionSelect(name) { if(gameInstance) gameInstance.showActionSelect(name); }
    function setOverride(name, type, target, desc) { if(gameInstance) gameInstance.setOverride(name, type, target, desc); }
    function closeActionSelect() { if(gameInstance) gameInstance.closeActionSelect(); }
    function editGender(name) { if(gameInstance) gameInstance.editGender(name); }
    function editPersonality(name) { if(gameInstance) gameInstance.editPersonality(name); }
    function editTraits(name) { if(gameInstance) gameInstance.editTraits(name); }
    function editIdeology(name) { if(gameInstance) gameInstance.editIdeology(name); }

    function showTownEvents() { if(gameInstance) gameInstance.showTownEvents(); }
    function triggerTownEvent(id) { if(gameInstance) gameInstance.triggerTownEvent(id); }
    function closeTownEvents() { if(gameInstance) gameInstance.closeTownEvents(); }
    function switchEventTab(tab) { if(gameInstance) gameInstance.switchEventTab(tab); }

    function showBuildingDetail(bid) { if(gameInstance) gameInstance.showBuildingDetail(bid); }
    function closeBuildingDetail() { document.getElementById('building-detail-modal').classList.remove('active'); }

    function inputNewResident() {
        if (!gameInstance) return;
        const name = prompt("è¯·è¾“å…¥æ–°å±…æ°‘çš„åå­—ï¼š\n(æ€§æ ¼ã€æ€§åˆ«ã€ç‰¹è´¨å°†ç”±ç³»ç»Ÿéšæœºç”Ÿæˆ)");
        if (name && name.trim() !== "") {
            const cleanName = name.trim().substring(0, 8); 
            gameInstance.addNewResident(cleanName);
        }
    }

    document.addEventListener('DOMContentLoaded', () => { 
        document.getElementById('personality-modal').addEventListener('click', (e) => { if (e.target === document.getElementById('personality-modal')) closePersonalityInfo(); }); 
        document.getElementById('char-detail-modal').addEventListener('click', (e) => { if (e.target === document.getElementById('char-detail-modal')) closeCharDetail(); }); 
        document.getElementById('leaderboard-modal').addEventListener('click', (e) => { if (e.target === document.getElementById('leaderboard-modal')) closeLeaderboard(); }); 
        document.getElementById('jobboard-modal').addEventListener('click', (e) => { if (e.target === document.getElementById('jobboard-modal')) closeJobBoard(); }); 
        document.getElementById('embezzle-modal').addEventListener('click', (e) => { if (e.target === document.getElementById('embezzle-modal')) closeEmbezzle(); }); 
        document.getElementById('action-select-modal').addEventListener('click', (e) => { if (e.target === document.getElementById('action-select-modal')) closeActionSelect(); }); 
        document.getElementById('town-event-modal').addEventListener('click', (e) => { if (e.target === document.getElementById('town-event-modal')) closeTownEvents(); });
        document.getElementById('building-detail-modal').addEventListener('click', (e) => { if (e.target === document.getElementById('building-detail-modal')) closeBuildingDetail(); });
        document.getElementById('achievements-modal').addEventListener('click', (e) => { if (e.target === document.getElementById('achievements-modal')) closeAchievements(); });
    });
    function manualSave() { if (gameInstance) gameInstance.saveData(); }
    function resetData() { if(confirm("ç¡®å®šè¦åˆ é™¤å­˜æ¡£å¹¶é‡ç½®æ‰€æœ‰è¿›åº¦å—ï¼Ÿ")) { localStorage.removeItem('happyTownV2_Save'); location.reload(); } }
    window.onload = () => { gameInstance = new Game(); };
</script>
<script type="module" src="/index.tsx"></script>
</body>
</html>