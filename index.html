
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŒ«ã®æ¨¡æ‹Ÿå°é•‡ Ver 2.1.0 - æ·±åº¦äººæ ¼ä¸ç”Ÿç†ç‰ˆ</title>
    <style>
        :root { --bg: #f0f2f5; --card: #fff; --primary: #4a90e2; --love: #ff6b6b; --text: #333; --dark: #2d3436; --crime: #8e44ad; --item: #e17055; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; }
        header { background: var(--card); padding: 10px 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; flex-wrap: wrap; gap: 15px; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .header-group { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        h1 { margin: 0; font-size: 1.2rem; }
        .btn { cursor: pointer; background: var(--primary); color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.9rem; transition: 0.2s; white-space: nowrap; }
        .btn:hover { opacity: 0.9; }
        .btn.save { background: #27ae60; }
        .btn.reset { background: #e74c3c; }
        .btn.gold { background: #f1c40f; color: #333; font-weight: bold; }
        .btn.cyan { background: #00b894; color: white; font-weight: bold; }
        .btn.purple { background: #9b59b6; color: white; font-weight: bold; }
        .btn.speed { background: #e67e22; font-weight: bold; width: 80px; }
        .btn.create { background: #e17055; color: white; font-weight: bold; }
        .btn.create:hover { background: #d35400; }
        .btn.achieve { background: #34495e; color: #fff; font-weight: bold; }
        .btn.gov { background: #2c3e50; color: white; font-weight: bold; border: 1px solid #34495e; }
        .btn.guide { background: #0984e3; color: white; font-weight: bold; }
        .btn.fund { background: #9b59b6; font-size: 0.8rem; padding: 4px 8px; margin-left: 5px; } 
        .btn.accelerate, .btn.start-build, .btn.resume-build, .btn.stop-build { font-size: 0.8rem; padding: 4px 8px; margin-top: 5px; width: 100%; }
        .btn.accelerate { background: #2ecc71; color: white; border: 1px solid #27ae60; }
        .btn.start-build { background: #95a5a6; color: white; border: 1px solid #7f8c8d; cursor: not-allowed; }
        .btn.resume-build { background: #3498db; color: white; border: 1px solid #2980b9; cursor: pointer; font-weight: bold; }
        .btn.stop-build { background: #e74c3c; color: white; border: 1px solid #c0392b; }
        .btn.control { background: #34495e; width: 100%; margin-top: 10px; }
        .btn.upgrade, .btn.train { color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 0.85rem; cursor: pointer; }
        .btn.upgrade { background: #8e44ad; }
        .btn.train { background: #e67e22; margin-left: 5px; }
        #calendar-display { cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: background 0.2s; }
        #calendar-display:hover { background: #e1e4e8; }
        input[type="number"] { width: 50px; padding: 4px; }
        select { padding: 6px; border-radius: 4px; border: 1px solid #ddd; }
        .tab-nav { display: flex; gap: 10px; margin-bottom: 15px; background: var(--card); padding: 8px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tab-btn { flex: 1; padding: 10px; cursor: pointer; border: none; background: #f0f2f5; color: #666; border-radius: 6px; font-weight: bold; font-size: 1rem; transition: 0.2s; }
        .tab-btn:hover { background: #e1e4e8; }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 2px 4px rgba(74, 144, 226, 0.3); }
        .game-container { display: flex; flex: 1; gap: 15px; overflow: hidden; }
        .col-view { display: none; flex-direction: column; gap: 10px; overflow-y: auto; flex: 2.5; } 
        .col-view.active-view { display: flex; }
        .section-title { font-weight: bold; color: #666; margin-bottom: 5px; display: flex; justify-content: space-between; font-size: 1.1rem; border-bottom: 2px solid #eee; padding-bottom: 8px; }
        .char-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(190px, 1fr)); gap: 12px; }
        .char-card { cursor: pointer; background: var(--card); padding: 12px; border-radius: 8px; border-left: 5px solid #ddd; font-size: 0.9rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: relative; transition: transform 0.2s, box-shadow 0.2s; }
        .char-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.15); z-index: 1; }
        .char-card.action-social { border-left-color: var(--love); }
        .char-card.action-work { border-left-color: #f1c40f; }
        .char-card.action-build { border-left-color: #e67e22; }
        .char-card.action-lieflat { border-left-color: #a29bfe; background: #f8f8ff; }
        .char-card.action-eat { border-left-color: #00b894; background: #f0fff4; }
        .char-card.action-crime { border-left-color: var(--crime); background: #fcf0ff; }
        .char-card.action-shop { border-left-color: var(--item); background: #fff5f0; } 
        .char-card.action-use { border-left-color: #00cec9; background: #e0f7fa; }
        .char-card.action-jail { border-left-color: #2d3436; background: #dcdde1; color: #636e72; }
        .char-card.action-sleep { border-left-color: #7f8c8d; background: #f5f6fa; opacity: 0.8; }
        .char-card.mayor { border: 2px solid #f1c40f; background: #fffce0; box-shadow: 0 0 10px rgba(241, 196, 15, 0.4); }
        .bar-container { height: 6px; background: #eee; margin: 8px 0; border-radius: 3px; overflow: hidden; }
        .bar-fill { height: 100%; width: 0; transition: width 0.3s; }
        .hp-fill { background: #2ecc71; }
        .food-fill { background: #fdcb6e; }
        .health-fill { background: #ff7675; }
        .stamina-fill { background: #0984e3; }
        #char-detail-modal .bar-container { height: 10px; background: #e0e0e0; border-radius: 5px; border: 1px solid rgba(74, 144, 226, 0.2); box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1); margin: 10px 0; }
        #char-detail-modal .bar-fill { border-radius: 4px; box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.3); }
        #char-detail-modal .hp-fill { background: linear-gradient(90deg, #2ecc71, #27ae60); }
        #char-detail-modal .food-fill { background: linear-gradient(90deg, #fdcb6e, #f39c12); }
        #char-detail-modal .health-fill { background: linear-gradient(90deg, #ff7675, #e74c3c); }
        #char-detail-modal .stamina-fill { background: linear-gradient(90deg, #0984e3, #74b9ff); }
        .build-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 12px; }
        .build-card { cursor: pointer; background: var(--card); padding: 15px; border-radius: 8px; opacity: 0.6; filter: grayscale(1); transition: 0.3s; border: 2px dashed #ccc; display: flex; flex-direction: column; justify-content: space-between; }
        .build-card:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .build-card.built { opacity: 1; filter: grayscale(0); border: 2px solid #27ae60; background: #f0fff4; }
        .build-card.building { opacity: 0.9; filter: grayscale(0.5); border: 2px solid #e67e22; }
        .build-card.active-project { opacity: 1; filter: grayscale(0); border: 2px solid #3498db; background: #f0f8ff; }
        .build-prog { font-size: 0.85rem; color: #666; margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee; }
        .lvl-badge { background: #8e44ad; color: white; padding: 1px 5px; border-radius: 3px; font-size: 0.75rem; margin-left: 5px; vertical-align: middle; }
        .category-header { grid-column: 1 / -1; font-weight: bold; margin-top: 15px; margin-bottom: 5px; border-left: 4px solid #aaa; padding-left: 8px; background: #f0f2f5; padding: 5px; border-radius: 4px; }
        .col-right { flex: 1; display: flex; flex-direction: column; min-width: 280px; gap: 10px; overflow: hidden;}
        .log-container { background: var(--dark); color: #dfe6e9; border-radius: 10px; padding: 10px; overflow-y: auto; font-family: monospace; font-size: 0.85rem; display: flex; flex-direction: column; flex: 1; }
        .log-header { font-weight: bold; margin-bottom: 5px; border-bottom: 1px solid #555; padding-bottom: 5px; color: #b2bec3; display: flex; justify-content: space-between; }
        #interaction-log { background: #dfe6e9; color: #2d3436; border: 1px solid #b2bec3; }
        #interaction-log .log-entry { border-bottom: 1px solid #ccc; }
        #interaction-log .log-time { color: #636e72; }
        .log-entry { margin-bottom: 8px; line-height: 1.4; border-bottom: 1px solid #444; padding-bottom: 4px; }
        .log-time { color: #74b9ff; opacity: 0.7; margin-right: 5px; font-size: 0.8em; }
        .tag-love { color: #ff7675; }
        .tag-reject { color: #a29bfe; font-weight: bold; }
        .tag-drama { color: #fdcb6e; font-weight: bold; }
        .tag-build { color: #00b894; }
        .tag-venue { color: #81ecec; font-style: italic; }
        .tag-crime { color: #e056fd; font-weight: bold; text-shadow: 0 0 2px rgba(142, 68, 173, 0.5); }
        .tag-event { color: #0984e3; font-weight: bold; background: rgba(9, 132, 227, 0.1); padding: 2px 4px; border-radius: 3px;}
        .tag-item { color: var(--item); font-weight: bold; }
        .tag-use { color: #00cec9; }
        .tag-promote { color: #f1c40f; font-weight: bold; text-shadow: 0 0 5px rgba(241, 196, 15, 0.3); }
        .tag-weather { color: #74b9ff; font-style: italic; }
        .tag-gov { color: #f39c12; font-weight: bold; border: 1px solid #f39c12; padding: 1px 4px; border-radius: 3px; }
        .tag-gossip { color: #6c5ce7; font-style: italic; }
        .tag-ai { color: #00b894; font-weight: bold; }
        @media (max-width: 800px) { 
            .game-container { flex-direction: column; overflow-y: auto; } 
            .col-right { height: 400px; flex: none; order: 3; }
            .col-view { flex: none; }
        }
        /* æ¨¡æ€æ¡† */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: var(--card); padding: 25px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        #char-detail-modal .modal-overlay { background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); }
        #char-detail-modal .modal-content { 
            max-width: 1000px; width: 95%; max-height: 90vh; padding: 0; background: #ffffff;
            box-shadow: 0 0 0 6px #e0e0e0, 0 0 0 10px #f5f5f5, 0 8px 40px rgba(0, 0, 0, 0.15), 0 0 30px rgba(74, 144, 226, 0.1);
            border: 2px solid #4a90e2; border-radius: 16px; position: relative; 
            display: flex; flex-direction: column; overflow: hidden;
        }
        #char-detail-modal .modal-content::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            border: 1px solid rgba(74, 144, 226, 0.3); border-radius: 14px; pointer-events: none;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        #char-detail-modal .modal-header { padding: 20px 30px; border-bottom: 2px solid rgba(74, 144, 226, 0.2); background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); position: relative; z-index: 1; flex-shrink: 0; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        #char-detail-modal .modal-header::before { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 2px; background: linear-gradient(to right, transparent, #4a90e2, transparent); }
        #char-detail-modal .modal-header h3 { font-size: 1.5rem; font-weight: 700; color: #2c3e50; flex: 0 0 auto; min-width: 0; letter-spacing: 0.5px; margin: 0; }
        #char-detail-modal #detail-ideology { flex: 1; min-width: 0; font-size: 0.9rem; flex-wrap: wrap; gap: 8px; justify-content: flex-start; display: flex; align-items: center; overflow-x: auto; overflow-y: visible; max-width: 100%; }
        #char-detail-modal #detail-ideology::-webkit-scrollbar { height: 4px; }
        #char-detail-modal #detail-ideology::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.05); border-radius: 2px; }
        #char-detail-modal #detail-ideology::-webkit-scrollbar-thumb { background: rgba(74, 144, 226, 0.3); border-radius: 2px; }
        #char-detail-modal #detail-ideology span {
            white-space: nowrap; padding: 4px 10px; background: rgba(74, 144, 226, 0.1);
            border: 1px solid rgba(74, 144, 226, 0.3); border-radius: 4px; color: #4a90e2; flex-shrink: 0;
        }
        #char-detail-modal .edit-btn {
            padding: 4px 10px; border-radius: 4px; background: rgba(74, 144, 226, 0.1);
            border: 1px solid rgba(74, 144, 226, 0.3); color: #4a90e2; transition: all 0.3s ease; text-decoration: none;
        }
        #char-detail-modal .edit-btn:hover {
            background: rgba(74, 144, 226, 0.2); border-color: #4a90e2;
            box-shadow: 0 2px 6px rgba(74, 144, 226, 0.3); text-decoration: none;
        }
        #char-detail-modal #detail-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; padding: 30px; background: #ffffff; position: relative; z-index: 1; overflow-y: auto; overflow-x: hidden; flex: 1; min-height: 0; }
        #char-detail-modal #detail-content::-webkit-scrollbar { width: 8px; }
        #char-detail-modal #detail-content::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.05); border-radius: 4px; }
        #char-detail-modal #detail-content::-webkit-scrollbar-thumb { background: rgba(74, 144, 226, 0.4); border-radius: 4px; }
        #char-detail-modal #detail-content::-webkit-scrollbar-thumb:hover { background: rgba(74, 144, 226, 0.6); }
        @media (max-width: 768px) { #char-detail-modal #detail-content { grid-template-columns: 1fr; } }
        .modal-header h3 { margin: 0; font-size: 1.3rem; }
        .modal-close { cursor: pointer; font-size: 1.5rem; color: #999; background: none; border: none; padding: 0; width: 30px; height: 30px; }
        .modal-close:hover { color: #333; }
        #char-detail-modal .modal-close { color: #4a90e2; font-size: 1.8rem; width: 35px; height: 35px; border-radius: 50%; border: 1px solid rgba(74, 144, 226, 0.3); background: rgba(74, 144, 226, 0.1); transition: all 0.3s ease; }
        #char-detail-modal .modal-close:hover { color: #ffffff; background: #4a90e2; border-color: #4a90e2; box-shadow: 0 2px 8px rgba(74, 144, 226, 0.4); transform: rotate(90deg); }
        .guide-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .guide-item { background: #f8f9fa; padding: 12px; border-radius: 8px; border: 1px solid #eee; position: relative; overflow: hidden; }
        .guide-item::before { content: ''; position: absolute; top:0; left:0; bottom:0; width:5px; background: #ccc; }
        .guide-name { font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; display: flex; justify-content: space-between; }
        .guide-desc { color: #666; font-size: 0.9rem; margin-bottom: 8px; min-height: 2.5em; }
        .guide-stats { font-size: 0.85rem; color: #555; background: #fff; padding: 5px; border-radius: 4px; }
        .stat-row { display: flex; justify-content: space-between; margin: 2px 0; }
        .detail-group { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .detail-group:last-child { border-bottom: none; }
        #char-detail-modal .detail-group { margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px; border: 1px solid rgba(74, 144, 226, 0.2); border-left: 3px solid #4a90e2; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); transition: all 0.3s ease; position: relative; }
        #char-detail-modal .detail-group:hover { border-color: rgba(74, 144, 226, 0.4); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12); transform: translateY(-2px); }
        #char-detail-modal .detail-group:last-child { border-bottom: 1px solid rgba(74, 144, 226, 0.2); }
        .detail-label { font-weight: bold; color: #666; margin-bottom: 5px; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; }
        #char-detail-modal .detail-label { font-size: 1.05rem; color: #2c3e50; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid rgba(74, 144, 226, 0.2); font-weight: 700; letter-spacing: 0.5px; }
        .detail-val { font-size: 1.05rem; }
        #char-detail-modal .detail-val { font-size: 1.1rem; line-height: 1.8; color: #34495e; }
        .detail-desc { font-size: 0.9rem; color: #888; margin-top: 4px; font-style: italic; }
        #char-detail-modal .detail-desc { font-size: 0.95rem; color: #7f8c8d; margin-top: 8px; font-style: normal; line-height: 1.6; }
        .trait-tag { display: inline-block; padding: 3px 8px; border-radius: 4px; background: #f0f0f0; color: #333; margin-right: 5px; font-size: 0.9rem; margin-bottom: 5px; }
        /* ä¸ªäººæ¡£æ¡ˆç‰¹è´¨æ ‡ç­¾ */
        #char-detail-modal .trait-container { display: flex; flex-wrap: nowrap; gap: 8px; overflow-x: auto; overflow-y: visible; padding-bottom: 5px; min-width: min-content; }
        #char-detail-modal .trait-container::-webkit-scrollbar { height: 6px; }
        #char-detail-modal .trait-container::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.05); border-radius: 3px; }
        #char-detail-modal .trait-container::-webkit-scrollbar-thumb { background: rgba(74, 144, 226, 0.4); border-radius: 3px; }
        #char-detail-modal .trait-container::-webkit-scrollbar-thumb:hover { background: rgba(74, 144, 226, 0.6); }
        #char-detail-modal .trait-tag { padding: 6px 14px; border-radius: 6px; background: rgba(74, 144, 226, 0.1); color: #4a90e2; margin: 0; font-size: 0.9rem; border: 1px solid rgba(74, 144, 226, 0.3); box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08); transition: all 0.3s ease; white-space: nowrap; flex-shrink: 0; }
        #char-detail-modal .trait-tag:hover { transform: translateY(-2px); background: rgba(74, 144, 226, 0.2); border-color: #4a90e2; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.12); }
        .ideology-box { padding: 10px; border-radius: 6px; background: #f9f9f9; border: 1px solid #eee; margin-top: 5px; }
        #char-detail-modal .ideology-box { padding: 12px; border-radius: 8px; background: rgba(74, 144, 226, 0.08); border: 1px solid rgba(74, 144, 226, 0.3); margin-top: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); }
        .edit-btn { font-size: 0.8rem; color: var(--primary); cursor: pointer; text-decoration: underline; background: none; border: none; padding: 0; }
        .relation-view { display: none; flex: 1; background: var(--card); padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden; flex-direction: column; }
        .relation-view.active { display: flex; }
        .rel-layout { display: flex; gap: 20px; flex: 1; min-height: 0; height: 100%; }
        .rel-graph { flex: 2; border: 1px solid #eee; border-radius: 8px; position: relative; background: #fdfdfd; overflow: hidden; }
        .rel-list { flex: 1; overflow-y: auto; overflow-x: hidden; font-size: 0.9rem; padding-right: 5px; border-left: 1px solid #eee; padding-left: 10px; }
        .rel-item { padding: 8px; border-bottom: 1px solid #eee; }
        .rel-tag { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; margin-right: 5px; color: white; }
        .tag-spouse { background: #e84393; } .tag-lover { background: #ff7675; } .tag-mistress { background: #ff8c00; } .tag-friend { background: #74b9ff; } .tag-bestfriend { background: #3498db; } .tag-ex { background: #636e72; } .tag-stranger { background: #95a5a6; } .tag-enemy { background: #c0392b; }
        #char-detail-modal .rel-tag { padding: 4px 10px; border-radius: 6px; font-size: 0.85rem; margin: 0 8px 6px 0; border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); transition: all 0.3s ease; }
        #char-detail-modal .rel-tag:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); }
        #char-detail-modal .tag-spouse { background: linear-gradient(135deg, #e84393, #fd79a8); }
        #char-detail-modal .tag-lover { background: linear-gradient(135deg, #ff7675, #fab1a0); }
        #char-detail-modal .tag-mistress { background: linear-gradient(135deg, #ff8c00, #ffa500); }
        #char-detail-modal .tag-friend { background: linear-gradient(135deg, #74b9ff, #a29bfe); }
        #char-detail-modal .tag-bestfriend { background: linear-gradient(135deg, #3498db, #74b9ff); }
        #char-detail-modal .tag-ex { background: linear-gradient(135deg, #636e72, #95a5a6); }
        #char-detail-modal .tag-stranger { background: linear-gradient(135deg, #95a5a6, #b2bec3); }
        #char-detail-modal .tag-enemy { background: linear-gradient(135deg, #c0392b, #e74c3c); }
        canvas { width: 100%; height: 100%; display: block; }
        /* æ’è¡Œæ¦œ */
        .rank-list { display: flex; flex-direction: column; gap: 10px; }
        .rank-item { display: flex; align-items: center; background: #f8f9fa; padding: 10px 15px; border-radius: 8px; border: 1px solid #eee; }
        .rank-num { width: 40px; font-weight: bold; font-size: 1.2rem; color: #999; text-align: center; margin-right: 10px; }
        .rank-1 { color: #f1c40f; font-size: 1.5rem; }
        .rank-2 { color: #bdc3c7; font-size: 1.4rem; }
        .rank-3 { color: #e67e22; font-size: 1.3rem; }
        .rank-info { flex: 1; }
        .rank-name { font-weight: bold; font-size: 1.05rem; }
        .rank-val { font-weight: bold; color: #27ae60; font-family: monospace; font-size: 1.1rem; }
        /* å·¥ä½œæ¦œ */
        .job-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .job-name { font-weight: bold; }
        .job-wage { color: #e67e22; font-weight: bold; }
        .job-loc { font-size: 0.85rem; color: #999; }
        .job-section-header { padding: 8px; font-weight: bold; background: #f0f2f5; border-left: 4px solid #333; margin-top: 15px; margin-bottom: 5px; border-radius: 4px; }
        /* æ‹¨æ¬¾/æ“ä½œå¼¹çª—æ ·å¼ */
        .fund-list { display: flex; flex-direction: column; gap: 5px; }
        .fund-item { padding: 8px; background: #f9f9f9; border-radius: 4px; cursor: pointer; border: 1px solid #eee; transition: 0.2s; }
        .fund-item.hover { background: #eef5ff; border-color: var(--primary); }
        .fund-item.selected { background: var(--primary); color: white; border-color: var(--primary); }
        .action-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px; }
        .action-btn { padding: 8px; border: 1px solid #ddd; border-radius: 5px; background: #f8f9fa; cursor: pointer; font-size: 0.9rem; transition: 0.2s; text-align: center; }
        .action-btn:hover { background: #e1e4e8; border-color: #ccc; }
        /* æ´»åŠ¨ç­–åˆ’å¡ç‰‡ */
        .event-card { display: flex; flex-direction: column; background: #f8f9fa; border: 1px solid #eee; border-radius: 6px; padding: 10px; gap: 5px; transition: 0.2s; }
        .event-card:hover { border-color: var(--primary); background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .event-header { display: flex; justify-content: space-between; align-items: center; }
        .event-name { font-weight: bold; font-size: 1.1rem; }
        .event-cost { font-weight: bold; color: #e67e22; background: #fff3e0; padding: 2px 6px; border-radius: 4px; font-size: 0.9rem; }
        .event-desc { font-size: 0.9rem; color: #666; margin: 5px 0; min-height: 32px; }
        .event-btn { background: var(--primary); color: white; border: none; padding: 6px; border-radius: 4px; cursor: pointer; width: 100%; font-weight: bold; }
        .event-btn:hover { opacity: 0.9; }
        .event-btn:disabled { background: #ccc; cursor: not-allowed; }
        .staff-list-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee; background: #f9f9f9; align-items: center; }
        .staff-role { font-weight: bold; color: #2d3436; margin-right: 5px; }
        .staff-name { color: #0984e3; font-weight: bold; }
        /* ç‰©å“ä¸èƒŒåŒ… */
        .bag-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 5px; margin-top: 5px; }
        /* ä¸ªäººæ¡£æ¡ˆèƒŒåŒ…ç½‘æ ¼ç¾åŒ– - ç™½è‰²ç§‘æŠ€é£æ ¼ */
        #char-detail-modal .bag-grid { 
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); 
            gap: 12px; 
            margin-top: 10px;
        }
        .bag-item { background: #fff5f0; border: 1px solid #e17055; border-radius: 4px; padding: 5px; text-align: center; font-size: 0.8rem; color: #d35400; cursor:help; }
        #char-detail-modal .bag-item { background: rgba(255, 165, 0, 0.1); border: 1px solid rgba(255, 165, 0, 0.4); border-radius: 8px; padding: 12px; font-size: 0.85rem; color: #e67e22; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08); transition: all 0.3s ease; }
        #char-detail-modal .bag-item:hover { transform: translateY(-2px); border-color: #e67e22; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.12); background: rgba(255, 165, 0, 0.15); }
        .history-list { font-size: 0.85rem; color: #555; background: #f8f9fa; border-radius: 6px; padding: 8px; border: 1px solid #eee; max-height: 150px; overflow-y: auto; }
        #char-detail-modal .history-list { font-size: 0.9rem; background: #f8f9fa; border-radius: 8px; padding: 15px; border: 1px solid rgba(74, 144, 226, 0.2); max-height: 200px; box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05); overflow-y: auto; }
        #char-detail-modal .history-list::-webkit-scrollbar { width: 6px; }
        #char-detail-modal .history-list::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.05); border-radius: 3px; }
        #char-detail-modal .history-list::-webkit-scrollbar-thumb { background: rgba(74, 144, 226, 0.4); border-radius: 3px; }
        #char-detail-modal .history-list::-webkit-scrollbar-thumb:hover { background: rgba(74, 144, 226, 0.6); }
        .history-item { padding: 4px 0; border-bottom: 1px dashed #e0e0e0; }
        #char-detail-modal .history-item { padding: 10px 8px; border-bottom: 1px dashed rgba(74, 144, 226, 0.15); transition: all 0.3s ease; border-radius: 4px; margin: 3px 0; color: #555; }
        #char-detail-modal .history-item:hover { background: rgba(74, 144, 226, 0.1); border-left: 3px solid #4a90e2; padding-left: 12px; color: #2c3e50; }
        .history-item:last-child { border-bottom: none; }
        .history-time { color: #999; font-size: 0.8em; margin-right: 5px; font-family: monospace; }
        #char-detail-modal .history-time { color: #4a90e2; }
        .tooltip-item { position: relative; cursor: help; }
        .tooltip-item:hover::after {
            content: attr(data-tip);
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: #fff;
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            white-space: pre-wrap;
            z-index: 9999;
            width: max-content;
            max-width: 220px;
            line-height: 1.4;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            pointer-events: none;
        }
        .tooltip-item:hover::before {
            content: "";
            position: absolute;
            bottom: 110%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.85) transparent transparent transparent;
            z-index: 9999;
        }
        .skill-row { display: flex; align-items: center; margin-bottom: 6px; font-size: 0.85rem; }
        /* ä¸ªäººæ¡£æ¡ˆæŠ€èƒ½æ¡ */
        #char-detail-modal .skill-row { margin-bottom: 12px; font-size: 0.9rem; padding: 10px; background: #f8f9fa; border-radius: 6px; border: 1px solid rgba(74, 144, 226, 0.15); transition: all 0.3s ease; }
        #char-detail-modal .skill-row:hover { background: rgba(74, 144, 226, 0.05); border-color: rgba(74, 144, 226, 0.3); box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08); }
        .skill-name { width: 60px; font-weight: bold; color: #555; }
        #char-detail-modal .skill-name { width: 80px; font-weight: 600; color: #2c3e50; }
        .skill-track { flex: 1; height: 8px; background: #eee; border-radius: 4px; overflow: hidden; margin: 0 10px; }
        #char-detail-modal .skill-track { height: 12px; background: #e0e0e0; border-radius: 6px; margin: 0 15px; box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1); border: 1px solid rgba(74, 144, 226, 0.2); }
        .skill-bar { height: 100%; border-radius: 4px; transition: width 0.3s; }
        #char-detail-modal .skill-bar { border-radius: 5px; box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.3); }
        .skill-val { width: 30px; text-align: right; color: #777; }
        #char-detail-modal .skill-val { color: #4a90e2; font-weight: 700; }
        .sk-social { background: #e84393; }
        #char-detail-modal .sk-social { background: linear-gradient(90deg, #e84393, #fd79a8); }
        .sk-culture { background: #00b894; }
        #char-detail-modal .sk-culture { background: linear-gradient(90deg, #00b894, #55efc4); }
        .sk-integrity { background: #0984e3; }
        #char-detail-modal .sk-integrity { background: linear-gradient(90deg, #0984e3, #74b9ff); }
        .sk-malice { background: #8e44ad; }
        #char-detail-modal .sk-malice { background: linear-gradient(90deg, #8e44ad, #a29bfe); }
        /* é€‰é¡¹å¡è¿‡æ»¤å™¨æ ·å¼ */
        .tab-filter { display:flex; gap:5px; margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px; }
        .filter-btn { background:none; border:none; cursor:pointer; padding:5px 10px; font-weight:bold; color:#999; border-bottom:3px solid transparent; transition:0.2s; }
        .filter-btn.active { color:var(--primary); border-bottom-color:var(--primary); }
        .filter-btn:hover { color:#666; }
        /* æˆå°±ç³»ç»Ÿæ ·å¼ */
        .achieve-list { display: flex; flex-direction: column; gap: 10px; }
        .achieve-item { display: flex; align-items: center; background: #f8f9fa; padding: 12px; border-radius: 8px; border: 1px solid #eee; opacity: 0.5; filter: grayscale(1); transition: 0.3s; }
        .achieve-item.unlocked { opacity: 1; filter: grayscale(0); border-left: 5px solid #f1c40f; background: #fffff0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .achieve-icon { font-size: 2rem; margin-right: 15px; width: 40px; text-align: center; }
        .achieve-info { flex: 1; }
        .achieve-title { font-weight: bold; font-size: 1.1rem; margin-bottom: 4px; color: #2c3e50; }
        .achieve-desc { font-size: 0.9rem; color: #7f8c8d; }
        .achieve-reward { font-size: 0.85rem; color: #e67e22; margin-top: 4px; font-weight: bold; }
        /* æ”¿åºœé¢æ¿æ ·å¼ */
        .gov-panel { display: flex; flex-direction: column; gap: 15px; }
        .gov-stat-row { display: flex; gap: 15px; flex-wrap: wrap; }
        .gov-stat-card { flex: 1; background: #f8f9fa; border: 1px solid #e1e4e8; padding: 15px; border-radius: 8px; text-align: center; min-width: 140px; }
        .gov-stat-card .label { font-size: 0.9rem; color: #666; margin-bottom: 5px; }
        .gov-stat-card .value { font-size: 1.5rem; font-weight: bold; color: #2c3e50; margin-bottom: 10px; }
        .gov-policy-section { background: #fffcf0; padding: 15px; border: 1px solid #f1c40f; border-radius: 8px; }
        .gov-policy-section h4 { margin: 0 0 10px 0; color: #7f8c8d; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .policy-item { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 10px; }
        .policy-desc { font-size: 0.85rem; color: #666; margin-top: 5px; line-height: 1.4; }
        .checkbox-container { display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none; }
        .policy-name { font-weight: bold; }
        .gov-mayor-section { background: #f0f8ff; padding: 15px; border: 1px solid #bcdff1; border-radius: 8px; }
        .mayor-avatar { font-size: 2.5rem; }
        .mayor-details { flex: 1; }
        .mayor-name { font-weight: bold; font-size: 1.2rem; color: #2c3e50; }
        .mayor-ideology { font-size: 0.9rem; padding: 2px 6px; border-radius: 4px; color: white; background: #999; display: inline-block; margin-top: 2px; }
        .mayor-effect { margin-top: 8px; font-size: 0.9rem; color: #555; font-style: italic; }
        /* æŠ•ç¥¨æ¨¡æ€æ¡† */
        .voting-candidate { background: #f8f9fa; border: 2px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 10px; position: relative; overflow: hidden; }
        .voting-candidate.winner { border-color: #27ae60; background: #eaffea; }
        .vote-bar-container { height: 10px; background: #eee; border-radius: 5px; margin-top: 8px; overflow: hidden; }
        .vote-bar-fill { height: 100%; background: #3498db; width: 0%; transition: width 0.3s; }
        .voting-log { max-height: 100px; overflow-y: auto; font-size: 0.85rem; background: #333; color: #fff; padding: 8px; border-radius: 6px; font-family: monospace; margin-top: 15px; }
        /* æ—¥å†æ ·å¼ */
        .calendar-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; }
        .month-card { background: #fff; border: 1px solid #eee; border-radius: 6px; padding: 5px; }
        .month-title { text-align: center; font-weight: bold; background: #f0f2f5; padding: 4px; border-radius: 4px; margin-bottom: 5px; font-size: 0.9rem; color: #2c3e50; }
        .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; font-size: 0.7rem; text-align: center; }
        .day-cell { padding: 2px 0; border-radius: 3px; position: relative; }
        .day-cell.today { background: var(--primary); color: white; font-weight: bold; }
        .day-cell.event-day { background: #ff7675; color: white; cursor: help; }
        .day-cell.event-day:hover::after {
            content: attr(data-evt);
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 4px 6px; border-radius: 4px;
            white-space: nowrap; z-index: 10;
        }
        @keyframes achievementPopIn { 0% { transform: scale(0.3) translateY(-50px); opacity: 0; } 50% { transform: scale(1.05) translateY(0); } 100% { transform: scale(1) translateY(0); opacity: 1; } }
        @keyframes achievementIconBounce { 0%, 100% { transform: translateY(0) scale(1); } 25% { transform: translateY(-20px) scale(1.1); } 50% { transform: translateY(0) scale(1); } 75% { transform: translateY(-10px) scale(1.05); } }
        @keyframes achievementShine { 0% { background-position: -200% center; } 100% { background-position: 200% center; } }
        #achievement-popup-content { background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%); border: 4px solid #f1c40f; box-shadow: 0 15px 50px rgba(0,0,0,0.4), 0 0 40px rgba(241,196,15,0.4), inset 0 0 20px rgba(255,255,255,0.5); position: relative; overflow: hidden; padding: 30px; }
        #achievement-popup-content::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent); animation: achievementShine 3s infinite; pointer-events: none; }
        #achievement-popup-modal { background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(3px); }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body>
<header>
    <div class="header-group">
        <h1>ğŸ¡ çŒ«ã®æ¨¡æ‹Ÿå°é•‡ <small>Ver 2.1.0 ç”Ÿç†éœ€æ±‚ç‰ˆ</small></h1>
        <div style="font-size: 0.9rem;">
            <span id="calendar-display" onclick="gameInstance.showCalendar()" title="ç‚¹å‡»æŸ¥çœ‹å…¨å¹´æ—¥å†">ğŸ“… 1æœˆ1æ—¥ (å†¬)</span> <span id="weather-display" style="margin-left:5px; color:#0984e3;"></span> |
            <span id="game-day">å‘¨ä¸€</span> |
            <span>ğŸ•’ <span id="game-time">08:00</span></span> <button class="btn speed" onclick="gameInstance.toggleSpeed()" id="speed-btn">â¸ æ­£å¸¸</button>
        </div>
    </div>
    <div class="header-group">
        <button class="btn gov" onclick="gameInstance.showGov()">ğŸ› æ”¿åºœ</button>
        <button class="btn" style="background: #27ae60; color: white; font-weight: bold;" onclick="gameInstance.showFinance()">ğŸ’° è´¢æ”¿</button>
        <button class="btn purple" onclick="gameInstance.showTownEvents()">ğŸ‰ ä¸¾åŠæ´»åŠ¨</button>
        <button class="btn achieve" onclick="gameInstance.showAchievements()">ğŸ† æˆå°±</button>
        <button class="btn gold" onclick="gameInstance.showLeaderboard()">ğŸ“Š æ’è¡Œæ¦œ</button>
        <button class="btn cyan" onclick="gameInstance.showJobBoard()">ğŸ“‹ å·¥ä½œæ¦œ</button>
        <button class="btn guide" onclick="gameInstance.showGameGuide()">ğŸ“˜ æ¸¸æˆå›¾é‰´</button>
        <button class="btn" onclick="toggleRelationView()">â¤ å…³ç³»è°±</button>
        <span style="font-size:0.8rem;">è‡ªåŠ¨å­˜æ¡£: <input type="number" id="autosave-rate" value="30" min="5">ç§’</span>
        <button class="btn save" onclick="gameInstance.manualSave()">ğŸ’¾ å­˜æ¡£</button>
    </div>
</header>
<div class="tab-nav">
    <button class="tab-btn active" onclick="switchTab('residents')" id="tab-residents">ğŸ‘¥ å±…æ°‘çŠ¶æ€</button>
    <button class="tab-btn" onclick="switchTab('buildings')" id="tab-buildings">ğŸ—ï¸ å°é•‡å»ºè®¾</button>
</div>
<div class="game-container" id="main-view">
    <div class="col-view active-view" id="view-residents">
        <div class="section-title">å±…æ°‘ç”Ÿæ´»åœˆ <small style="font-weight:normal; font-size:0.8em; color:#999;">(ç‚¹å‡»å¡ç‰‡æŸ¥çœ‹è¯¦æƒ…)</small></div>
        <div class="char-grid" id="char-list"></div>
    </div>
    <div class="col-view" id="view-buildings">
        <div class="section-title">å…¬å…±è®¾æ–½å»ºè®¾ <small style="font-weight:normal; font-size:0.8em; color:#999;">(æ‰€æœ‰å»ºè®¾å‡ç”±é•‡é•¿å‘èµ·æŠ•ç¥¨å†³å®š)</small></div>
        <div class="build-grid" id="build-list"></div>
    </div>
    <div class="col-right">
        <div class="log-container">
            <div class="log-header">ğŸ“¡ ç³»ç»Ÿå…¬å‘Š</div>
            <div id="game-log">
                <div class="log-entry">âœ¨ æ¸¸æˆå¼€å§‹ã€‚Ver 2.1.0 ç”Ÿç†éœ€æ±‚ç‰ˆï¼å››ç»´æ›´æ–°ï¼šç¤¾äº¤/æ–‡åŒ–/è¯šä¿¡/æ¶æ„ã€‚</div>
            </div>
        </div>
        <div class="log-container" id="interaction-log-container">
             <div class="log-header" style="color:#2d3436">ğŸ’¬ å±…æ°‘äº’åŠ¨</div>
             <div id="interaction-log"></div>
        </div>
    </div>
</div>
<div class="relation-view" id="relation-view">
    <div style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:center">
        <h2 style="margin:0; font-size:1.2rem">â¤ å±…æ°‘å…³ç³»è°±</h2>
        <button class="btn" onclick="toggleRelationView()">ğŸ”™ è¿”å›å°é•‡</button>
    </div>
    <div id="rel-stats" style="background:#f8f9fa; padding:10px; border-radius:6px; margin-bottom:15px; font-size:0.9rem; display:flex; gap:20px; border:1px solid #eee;">
        <span style="color:#e17055">ğŸ”¥ <b>äººæ°”ç‹:</b> <span id="stat-pop">è®¡ç®—ä¸­...</span></span>
        <span style="color:#636e72">ğŸ‚ <b>å°é€æ˜:</b> <span id="stat-lonely">è®¡ç®—ä¸­...</span></span>
    </div>
    <div class="rel-layout">
        <div class="rel-graph" id="rel-graph-container"><canvas id="rel-canvas"></canvas></div>
        <div class="rel-list" id="rel-list"></div>
    </div>
</div>
<!-- å•ä¸ªå±…æ°‘å…³ç³»è°±æ¨¡æ€æ¡† -->
<div class="modal-overlay" id="single-char-relation-modal">
    <div class="modal-content" style="max-width:900px; width:95%;">
        <div class="modal-header">
            <h3 id="single-char-relation-name">å±…æ°‘å…³ç³»è¯¦æƒ…</h3>
            <button class="modal-close" onclick="closeSingleCharRelation()">Ã—</button>
        </div>
        <div style="display:flex; gap:20px; min-height:500px; max-height:70vh;">
            <div style="flex:2; border:1px solid #eee; border-radius:8px; position:relative; background:#fdfdfd; overflow:hidden; min-height:500px;">
                <canvas id="single-char-relation-canvas" style="width:100%; height:100%; display:block;"></canvas>
            </div>
            <div style="flex:1; overflow-y:auto; font-size:0.9rem; padding-left:10px; border-left:1px solid #eee; max-height:70vh;">
                <div style="color:#666; font-size:0.85rem; margin-bottom:10px; padding-bottom:8px; border-bottom:1px solid #eee;">
                    ç‚¹å‡»å…³ç³»è°±ä¸­çš„èŠ‚ç‚¹å¯æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
                </div>
                <div id="single-char-relation-list"></div>
            </div>
        </div>
    </div>
</div>
<!-- æˆå°±è§£é”å¼¹çª— -->
<div class="modal-overlay" id="achievement-popup-modal" style="z-index:2000;" onclick="if(event.target.id === 'achievement-popup-modal') closeAchievementPopup();">
    <div class="modal-content" id="achievement-popup-content" style="max-width:500px; width:90%; text-align:center; animation:achievementPopIn 0.5s ease-out; position:relative;" onclick="event.stopPropagation();">
        <div style="font-size:4rem; margin-bottom:15px; animation:achievementIconBounce 0.6s ease-out 0.2s both; filter:drop-shadow(0 4px 8px rgba(241,196,15,0.5));">ğŸ†</div>
        <div style="font-size:1.8rem; font-weight:bold; color:#f1c40f; margin-bottom:15px; text-shadow:2px 2px 4px rgba(0,0,0,0.2); letter-spacing:2px;">æˆå°±è§£é”ï¼</div>
        <div id="achievement-popup-icon" style="font-size:4rem; margin:20px 0; animation:achievementIconBounce 0.6s ease-out 0.3s both; filter:drop-shadow(0 2px 4px rgba(0,0,0,0.2));"></div>
        <div id="achievement-popup-name" style="font-size:1.6rem; font-weight:bold; color:#2c3e50; margin-bottom:12px; padding:0 10px;"></div>
        <div id="achievement-popup-desc" style="font-size:1rem; color:#7f8c8d; margin-bottom:25px; line-height:1.6; padding:0 15px;"></div>
        <div style="background:linear-gradient(135deg, #f1c40f 0%, #f39c12 100%); color:white; padding:15px 30px; border-radius:30px; font-size:1.2rem; font-weight:bold; display:inline-block; box-shadow:0 6px 20px rgba(241,196,15,0.5); margin-bottom:15px;">
            <span id="achievement-popup-reward">ğŸ’° +0</span>
        </div>
        <button class="btn" onclick="closeAchievementPopup()" style="margin-top:10px; background:#3498db; width:100%; font-size:1rem; padding:12px; border-radius:8px; font-weight:bold; box-shadow:0 4px 10px rgba(52,152,219,0.3);">å¤ªæ£’äº†ï¼</button>
    </div>
</div>
<!-- æ¨¡æ€æ¡†å®šä¹‰ -->
<div class="modal-overlay" id="guide-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ“˜ æ¸¸æˆå›¾é‰´</h3>
            <button class="modal-close" onclick="gameInstance.closeGameGuide()">Ã—</button>
        </div>
        <div class="tab-filter">
            <button class="filter-btn active" id="guide-tab-trait" onclick="gameInstance.switchGuideTab('trait')">ç‰¹è´¨å›¾é‰´</button>
            <button class="filter-btn" id="guide-tab-ideology" onclick="gameInstance.switchGuideTab('ideology')">ä¿¡ä»°ä¸»ä¹‰</button>
        </div>
        <div id="guide-content" class="guide-grid"></div>
    </div>
</div>
<div class="modal-overlay" id="edit-modal">
    <div class="modal-content" style="max-width:400px;">
        <div class="modal-header">
            <h3 id="edit-title">ä¿®æ”¹å±æ€§</h3>
            <button class="modal-close" onclick="gameInstance.closeEditModal()">Ã—</button>
        </div>
        <div style="margin-bottom:15px;">
            <select id="edit-select" style="width:100%; padding:8px; font-size:1rem; border-radius:4px; border:1px solid #ddd;"></select>
        </div>
        <button class="btn save" style="width:100%" onclick="gameInstance.confirmEdit()">ğŸ’¾ ä¿å­˜ä¿®æ”¹</button>
    </div>
</div>
<div class="modal-overlay" id="voting-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="voting-title">ğŸ—³ï¸ å…¨æ°‘æŠ•ç¥¨</h3>
        </div>
        <div style="margin-bottom:15px; color:#555; font-size:0.9rem;">
            <span id="voting-mayor-msg"></span>
            <span id="voting-instruction">è¯·æŠ•å‡ºç¥åœ£çš„ä¸€ç¥¨ï¼</span>
        </div>
        <div id="voting-candidates-list"></div>
        <div class="voting-log" id="voting-realtime-log"></div>
    </div>
</div>
<div class="modal-overlay" id="char-detail-modal" onclick="if(event.target.id === 'char-detail-modal') gameInstance.closeCharDetail();"><div class="modal-content" onclick="event.stopPropagation();"><div class="modal-header"><h3 id="detail-name">è§’è‰²è¯¦æƒ…</h3><div id="detail-ideology" style="margin-left:20px; display:flex; align-items:center; gap:8px;"></div><button class="modal-close" onclick="gameInstance.closeCharDetail()">Ã—</button></div><div id="detail-content"></div></div></div>
<div class="modal-overlay" id="gov-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ› å°é•‡æ”¿åºœ</h3>
            <button class="modal-close" onclick="gameInstance.closeGov()">Ã—</button>
        </div>
        <div class="gov-panel">
            <div class="gov-mayor-section">
                <h4 style="margin:0 0 10px 0; color:#2980b9; border-bottom:1px solid #d6eaf8; padding-bottom:5px;">ğŸ–ï¸ ç°ä»»é•‡é•¿</h4>
                <div id="mayor-info" style="display:flex; align-items:center; gap:15px;">
                    <div class="mayor-avatar">ğŸ–ï¸</div>
                    <div class="mayor-details">
                        <div id="mayor-name-display" class="mayor-name">æš‚æ— é•‡é•¿</div>
                        <div id="mayor-ideology-display" class="mayor-ideology" style="background:#ccc">--</div>
                        <div id="mayor-policy-display" class="mayor-effect">æ¯å‘¨ (å‘¨æ—¥) ä¸¾è¡Œä¸€æ¬¡é€‰ä¸¾</div>
                    </div>
                </div>
                <div style="margin-top:15px; border-top:1px dashed #bcdff1; padding-top:10px;">
                    <div style="font-weight:bold; font-size:0.9rem; margin-bottom:5px; color:#2c3e50;">âš–ï¸ é•‡é•¿å†³ç­–:</div>
                    <button class="btn" style="background:#e67e22; font-size:0.85rem; width:100%" onclick="gameInstance.executeCommonProsperity()">ğŸ¤ å…±åŒå¯Œè£• (å‡è´«å¯Œ)</button>
                    <div style="font-size:0.8rem; color:#666; margin-top:4px;">å¼ºåˆ¶æ”¶ç¼´å‰3åå¯Œè±ªéƒ¨åˆ†èµ„äº§ï¼Œå¹³åˆ†ç»™æ‰€æœ‰è´«å›°æˆ·(<50)ã€‚</div>
                </div>
            </div>
            <div class="gov-stat-row">
                <div class="gov-stat-card">
                    <div class="label">ğŸ‘¥ å°é•‡å¸¸ä½äººå£</div>
                    <div class="value" id="resident-count">0</div>
                    <button class="btn create" onclick="inputNewResident()">â• æ‹›å‹Ÿæ–°å±…æ°‘</button>
                </div>
            </div>
            <div class="gov-policy-section">
                <h4>ğŸ“œ ç¤¾ä¼šä¿éšœæ”¿ç­–</h4>
                <div class="policy-item">
                    <div style="flex:1">
                        <label class="checkbox-container">
                            <input type="checkbox" id="policy-social-security" onchange="gameInstance.togglePolicy('social')">
                            <span class="policy-name">ç¤¾ä¼šæœ€ä½ä¿éšœé‡‘</span>
                        </label>
                        <div class="policy-desc">
                            <small>æ¯æ—¥å‡Œæ™¨æ£€æµ‹ã€‚è‹¥èµ„é‡‘>10ï¼Œä¸ºå­˜æ¬¾<15çš„å±…æ°‘å‘æ”¾10æ•‘æµé‡‘ã€‚</small>
                        </div>
                    </div>
                </div>
                <div class="policy-item">
                    <div style="flex:1">
                        <label class="checkbox-container">
                            <input type="checkbox" id="policy-housing" onchange="gameInstance.togglePolicy('housing')">
                            <span class="policy-name">ä¿éšœæ€§ä½æˆ¿è®¡åˆ’</span>
                        </label>
                        <div class="policy-desc">
                            <small>æ¯æ—¥ä¸ºæ— ä¸šå±…æ°‘æä¾›å…è´¹ä½æˆ¿è¡¥è´´ï¼ˆå¿ƒæƒ…+5ï¼‰ï¼Œæ¯äººæ¶ˆè€—é•‡åº“ğŸ’°5ã€‚</small>
                        </div>
                    </div>
                </div>
                <div class="policy-item">
                    <div style="flex:1">
                        <label class="checkbox-container">
                            <input type="checkbox" id="policy-food" onchange="gameInstance.togglePolicy('food')">
                            <span class="policy-name">æœ€ä½é£Ÿå“ä¿éšœ</span>
                        </label>
                        <div class="policy-desc">
                            <small>æ¯æ—¥ä¸ºæåº¦é¥¥é¥¿(<20)çš„å±…æ°‘å‘æ”¾çŒªè‚‰åŒ…ï¼ˆé¥±é£Ÿ+20ï¼‰ï¼Œæ¯äººæ¶ˆè€—é•‡åº“ğŸ’°4ã€‚</small>
                        </div>
                    </div>
                </div>
            </div>
            <div style="border-top:1px solid #eee; padding-top:15px;">
                <button class="btn reset" style="width:100%" onclick="gameInstance.resetData()">ğŸ—‘ é‡ç½®å°é•‡æ•°æ® (æ…ç”¨)</button>
            </div>
        </div>
    </div>
</div>
<div class="modal-overlay" id="finance-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ’° è´¢æ”¿ä¸­å¿ƒ</h3>
            <button class="modal-close" onclick="gameInstance.closeFinance()">Ã—</button>
        </div>
        <div class="gov-panel">
            <div class="gov-stat-row">
                <div class="gov-stat-card">
                    <div class="label">ğŸ’° é•‡åº“èµ„é‡‘</div>
                    <div class="value" id="finance-town-money">0</div>
                </div>
                <div class="gov-stat-card">
                    <div class="label">ğŸ“Š å½“å‰ç¨ç‡</div>
                    <div class="value" id="tax-rate-display">5%</div>
                    <div style="margin-top:10px; display:flex; gap:5px; align-items:center;">
                        <input type="range" id="tax-rate-slider" min="0" max="20" value="5" step="1" style="flex:1;" oninput="gameInstance.updateTaxRate(this.value)">
                        <span id="tax-rate-value" style="font-weight:bold; color:#27ae60; min-width:40px;">5%</span>
                    </div>
                    <div style="font-size:0.75rem; color:#666; margin-top:5px;">æ‰€æœ‰æ”¶å…¥å’Œæ”¯å‡ºå°†æŒ‰æ­¤ç¨ç‡æ”¶çº³åˆ°é•‡åº“</div>
                </div>
            </div>
            <div class="gov-policy-section" style="margin-top:15px;">
                <h4>ğŸ’¸ è´¢æ”¿æ“ä½œ</h4>
                <button class="btn fund" style="width:100%; margin-bottom:10px;" onclick="gameInstance.showEmbezzle()">ğŸ’¸ è´¢æ”¿æ‹¨æ¬¾</button>
                <div style="font-size:0.85rem; color:#666; padding:10px; background:#f8f9fa; border-radius:6px; margin-bottom:15px;">
                    <div style="font-weight:bold; margin-bottom:5px;">ğŸ“‹ ç¨ç‡è¯´æ˜ï¼š</div>
                    <div>â€¢ å±…æ°‘æ”¶å…¥ï¼ˆå·¥èµ„ã€å¥–åŠ±ç­‰ï¼‰ï¼šæŒ‰ç¨ç‡æ”¶çº³åˆ°é•‡åº“</div>
                    <div>â€¢ å±…æ°‘æ”¯å‡ºï¼ˆè´­ç‰©ã€æ¶ˆè´¹ç­‰ï¼‰ï¼šæŒ‰ç¨ç‡æ”¶çº³åˆ°é•‡åº“</div>
                    <div>â€¢ å»ºç­‘æ”¶å…¥ï¼ˆé—¨ç¥¨ã€æœåŠ¡è´¹ç­‰ï¼‰ï¼šæŒ‰ç¨ç‡æ”¶çº³åˆ°é•‡åº“</div>
                    <div style="margin-top:8px; color:#e67e22; font-weight:bold;">å½“å‰ç¨ç‡ï¼š<span id="tax-rate-info">5%</span></div>
                </div>
                <h4 style="margin-top:15px; margin-bottom:10px;">ğŸ“Š æœ€è¿‘15ç¬”èµ„é‡‘æ¥æº</h4>
                <div id="finance-history-list" style="max-height:400px; overflow-y:auto; border:1px solid #ddd; border-radius:6px; background:#fff; padding:10px;">
                    <div style="text-align:center; color:#999; padding:20px;">æš‚æ— èµ„é‡‘æµåŠ¨è®°å½•</div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal-overlay" id="leaderboard-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ“Š å°é•‡æ’è¡Œæ¦œ</h3>
            <button class="modal-close" onclick="gameInstance.closeLeaderboard()">Ã—</button>
        </div>
        <div style="margin-bottom:15px; display:flex; gap:10px; flex-wrap: wrap;">
            <button class="btn" onclick="gameInstance.renderLeaderboard('money')">ğŸ’° è´¢å¯Œæ¦œ</button>
            <button class="btn" onclick="gameInstance.renderLeaderboard('happiness')" style="background:#2ecc71">â¤ å¹¸ç¦æ¦œ</button>
            <button class="btn" onclick="gameInstance.renderLeaderboard('popularity')" style="background:#a55eea">ğŸ”¥ äººæ°”æ¦œ</button>
            <button class="btn" onclick="gameInstance.renderLeaderboard('robbery')" style="background:#2d3436; color:white;">ğŸ”ª æŠ¢åŠ«æ¦œ</button>
            <button class="btn" onclick="gameInstance.renderLeaderboard('streetwalk')" style="background:#e056fd; color:white;">ğŸ’‹ ç«™è¡—æ¦œ</button>
            <button class="btn" onclick="gameInstance.renderLeaderboard('assault')" style="background:#c0392b; color:white;">ğŸ˜ˆ åŠ«è‰²æ¦œ</button>
        </div>
        <div id="leaderboard-list" class="rank-list"></div>
    </div>
</div>
<div class="modal-overlay" id="achievements-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ† è£èª‰æˆå°±é¦†</h3>
            <button class="modal-close" onclick="gameInstance.closeAchievements()">Ã—</button>
        </div>
        <div id="achievements-list" class="achieve-list"></div>
    </div>
</div>
<div class="modal-overlay" id="jobboard-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ“‹ äººæ‰å¸‚åœº & å·¥ä½œæ¦œ</h3>
            <button class="modal-close" onclick="gameInstance.closeJobBoard()">Ã—</button>
        </div>
        <div class="tab-filter" id="jobboard-tabs"></div>
        <div id="jobboard-list"></div>
    </div>
</div>
<div class="modal-overlay" id="embezzle-modal"><div class="modal-content"><div class="modal-header"><h3>ğŸ’¸ é•‡åº“æ‹¨æ¬¾</h3><button class="modal-close" onclick="gameInstance.closeEmbezzle()">Ã—</button></div><div style="margin-bottom:15px;"><p>å½“å‰é•‡åº“èµ„é‡‘: <span id="embezzle-town-money" style="font-weight:bold; color:#f1c40f;">0</span></p><p>é€‰æ‹©æ‹¨æ¬¾å¯¹è±¡:</p><div id="embezzle-list" class="fund-list" style="max-height:200px; overflow-y:auto; margin-bottom:10px; border:1px solid #eee; padding:5px;"></div><div style="display:flex; gap:10px; align-items:center;"><span>é‡‘é¢:</span><input type="number" id="embezzle-amount" value="100" style="width:100px;"><button class="btn save" onclick="gameInstance.doEmbezzle()">ç¡®è®¤æ‹¨æ¬¾</button></div></div></div></div>
<div class="modal-overlay" id="action-select-modal"><div class="modal-content"><div class="modal-header"><h3>ğŸ•¹ï¸ å¼ºåˆ¶å®‰æ’æ´»åŠ¨</h3><button class="modal-close" onclick="gameInstance.closeActionSelect()">Ã—</button></div><div id="action-select-content"></div></div></div>
<div class="modal-overlay" id="town-event-modal">
    <div class="modal-content">
        <div class="modal-header"><h3>ğŸ‰ æ´»åŠ¨ç­–åˆ’éƒ¨</h3><button class="modal-close" onclick="gameInstance.closeTownEvents()">Ã—</button></div>
        <div class="tab-filter">
            <button class="filter-btn active" id="evt-tab-normal" onclick="gameInstance.switchEventTab('normal')">å¸¸è§„æ´»åŠ¨</button>
            <button class="filter-btn" id="evt-tab-season" onclick="gameInstance.switchEventTab('season')">ğŸ—“ï¸ ä»Šæ—¥èŠ‚æ—¥/é™å®š</button>
        </div>
        <p style="color:#666; font-size:0.9rem; margin-bottom:15px;">å½“å‰é•‡åº“: <span id="event-town-money" style="font-weight:bold; color:#f1c40f; font-size:1.1rem;">0</span> (å½“å‰æ—¥æœŸ: <span id="event-season-name"></span>)</p>
        <div id="town-event-list" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(240px, 1fr)); gap:12px;"></div>
    </div>
</div>
<div class="modal-overlay" id="building-detail-modal"><div class="modal-content"><div class="modal-header"><h3 id="b-detail-name">å»ºç­‘è¯¦æƒ…</h3><button class="modal-close" onclick="gameInstance.closeBuildingDetail()">Ã—</button></div><div id="b-detail-content"></div></div></div>
<!-- æ—¥å†æ¨¡æ€æ¡† -->
<div class="modal-overlay" id="calendar-modal">
    <div class="modal-content" style="max-width:800px;">
        <div class="modal-header">
            <h3>ğŸ“… å°é•‡å¹´å†</h3>
            <button class="modal-close" onclick="gameInstance.closeCalendar()">Ã—</button>
        </div>
        <div style="margin-bottom:10px; color:#666; font-size:0.9rem;">
            é¼ æ ‡æ‚¬åœçº¢è‰²æ—¥æœŸå¯æŸ¥çœ‹èŠ‚æ—¥åç§°ã€‚ç‰¹å®šèŠ‚æ—¥å½“å¤©å¯åœ¨æ´»åŠ¨ä¸­å¿ƒä¸¾åŠåº†å…¸ã€‚
        </div>
        <div id="calendar-container" class="calendar-grid"></div>
    </div>
</div>
<script>
    const NAMES = ["è€„è€‹", "æ›¼æ³¢", "å“ˆåŸºç±³", "æœçŒ«", "æš–æ³ª", "æ²å¤", "sans", "æ—¶è‹", "å°ç¿", "æ ¢æŸ“", "äº‘ç»’", "ç›å¡å·´å¡", "çŒ«å†¬", "æ— å", "æ–—ç½—", "CPU0", "é—ªæŸ ", "æ°˜é•‰æ®†", "ç©ºé›¶", "çŒ«çŒ«", "å°æ ¼è•¾ä¿®"];
    // å®šä¹‰æ¯ä¸ªæœˆçš„å¤©æ•° (0æ˜¯å ä½ç¬¦)
    const MONTH_DAYS = [0, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
    const ITEMS_DB = {
        "rose": { name: "ğŸŒ¹ ç«ç‘°", price: 50, type: "gift", loveBonus: 15, desc: "èµ äººç«ç‘°ï¼Œæ‰‹æœ‰ä½™é¦™" },
        "huoshao_meat": { name: "ğŸ¥™ è‚‰ç«çƒ§", price: 3.5, type: "food", hungerBonus: 30, staminaBonus: 30, desc: "å¤–é…¥é‡Œå«©ï¼Œå›è¡€å›è“" },
        "huoshao_veg": { name: "ğŸ¥¬ èœç«çƒ§", price: 3, type: "food", hungerBonus: 20, staminaBonus: 20, desc: "æ¸…æ·¡å¯å£" },
        "tofu_pudding": { name: "ğŸ¥£ è±†è…è„‘", price: 2.5, type: "food", hungerBonus: 15, staminaBonus: 15, desc: "å’¸ç”œä¹‹äº‰" },
        "book_novel": { name: "ğŸ“– æµè¡Œå°è¯´", price: 25, type: "book", happinessBonus: 15, cultureBonus: 2, desc: "çœ‹å¾—å¾ˆçˆ½" },
        "book_manga": { name: "ğŸ“š çƒ­è¡€æ¼«ç”»", price: 15, type: "book", happinessBonus: 10, cultureBonus: 1, desc: "äºŒæ¬¡å…ƒçš„å¿«ä¹" },
        "book_h": { name: "ğŸ“• Hä¹¦", price: 50, type: "book", happinessBonus: 20, maliceBonus: 5, integrityBonus: -5, desc: "å°‘å„¿ä¸å®œï¼Œå¢åŠ æ¶æ„å€¼" },
        "book_53": { name: "ğŸ“‘ 5å¹´é«˜è€ƒ3å¹´æ¨¡æ‹Ÿ", price: 40, type: "book", happinessBonus: -10, cultureBonus: 10, desc: "çŸ¥è¯†å°±æ˜¯åŠ›é‡ï¼Œä½†å¾ˆç—›è‹¦" },
        "baozi_tofu": { name: "ğŸ¥Ÿ è±†è…åŒ…", price: 2, type: "food", hungerBonus: 10, staminaBonus: 10, desc: "ç´ é£Ÿä¸»ä¹‰è€…çš„æœ€çˆ±" },
        "baozi_pork": { name: "ğŸ¥© çŒªè‚‰åŒ…", price: 4, type: "food", hungerBonus: 20, staminaBonus: 20, desc: "çš®è–„é¦…å¤§æ±å¤š" },
        "baozi_beef": { name: "ğŸ® ç‰›è‚‰åŒ…", price: 5, type: "food", hungerBonus: 25, staminaBonus: 25, desc: "å®å®åœ¨åœ¨çš„ç‰›è‚‰" },
        "water_wahaha": { name: "ğŸ¥¤ å¨ƒå“ˆå“ˆ", price: 2, type: "drink", hungerBonus: 2, happinessBonus: 1, staminaBonus: 3, desc: "ç«¥å¹´çš„å‘³é“" },
        "water_ganten": { name: "ğŸ’§ ç™¾å²å±±", price: 4, type: "drink", hungerBonus: 2, happinessBonus: 3, staminaBonus: 5, desc: "æ°´ä¸­è´µæ—" },
        "noodle_beef": { name: "ğŸœ åº·å¸ˆå‚…", price: 5, type: "food", hungerBonus: 30, staminaBonus: 30, desc: "çº¢çƒ§ç‰›è‚‰é¢ï¼Œå°±æ˜¯è¿™ä¸ªå‘³" },
        "chips_lays": { name: "ğŸ¥” ä¹äº‹è–¯ç‰‡", price: 6, type: "snack", hungerBonus: 5, happinessBonus: 5, staminaBonus: 5, desc: "åŸå‘³æœ€ç»å…¸" },
        "chocolate": { name: "ğŸ« å¾·èŠ™å·§å…‹åŠ›", price: 8, type: "snack", hungerBonus: 3, happinessBonus: 8, staminaBonus: 8, desc: "çºµäº«ä¸æ»‘" },
        "cola_pepsi": { name: "ğŸ¥¤ æ—¥æœ¬ç”Ÿå¯ä¹", price: 5, type: "drink", hungerBonus: 3, happinessBonus: 4, staminaBonus: 8, desc: "å¬è¯´å¾ˆå¥½å–" },
        "coffee_instant": { name: "â˜• é€Ÿæº¶å’–å•¡", price: 6, type: "drink", hungerBonus: 2, happinessBonus: 5, staminaBonus: 10, desc: "æç¥é†’è„‘" },
        "sushi_box": { name: "ğŸ± å¯¿å¸æ‹¼ç›˜", price: 12, type: "food", hungerBonus: 35, happinessBonus: 3, staminaBonus: 30, desc: "ä¾¿åˆ©åº—çš„é«˜çº§è´§" },
        "beer_tsingtao": { name: "ğŸº é’å²›å•¤é…’", price: 6, type: "alcohol", hungerBonus: 2, happinessBonus: 6, desc: "å“ˆå•¤é…’åƒå˜å•¦" },
        "beer_laoshan": { name: "ğŸº å´‚å±±å•¤é…’", price: 5, type: "alcohol", hungerBonus: 2, happinessBonus: 5, desc: "ç”šè‡³èƒ½å½“æ°´å–" },
        "cocktail": { name: "ğŸ¸ é¸¡å°¾é…’", price: 25, type: "alcohol", hungerBonus: -2, happinessBonus: 15, desc: "è‰²å½©æ–‘æ–“çš„å¾®é†º" },
        "bloody_mary": { name: "ğŸ¹ è¡€è…¥ç›ä¸½", price: 30, type: "alcohol", hungerBonus: -2, happinessBonus: 18, desc: "å£å‘³ç‹¬ç‰¹çš„ç»å…¸" },
        "rum": { name: "ğŸ¥ƒ æœ—å§†é…’", price: 35, type: "alcohol", hungerBonus: -3, happinessBonus: 20, desc: "æµ·ç›—çš„æœ€çˆ±" },
        "tequila": { name: "ğŸŒµ é¾™èˆŒå…°", price: 40, type: "alcohol", hungerBonus: -3, happinessBonus: 22, desc: "èˆ”ä¸€å£ç›ï¼Œå¹²ä¸€æ¯é…’" },
        "whisky": { name: "ğŸ¥ƒ å¨å£«å¿Œ", price: 50, type: "alcohol", hungerBonus: -4, happinessBonus: 25, desc: "ç”·äººçš„æµªæ¼«" },
        "bandage": { name: "ğŸ©¹ ç»·å¸¦", price: 10, type: "medicine", healthBonus: 8, desc: "å¤„ç†è½»å¾®å¤–ä¼¤" },
        "painkiller": { name: "ğŸ’Š æ­¢ç—›è¯", price: 15, type: "medicine", healthBonus: 15, happinessBonus: 2, desc: "ç¼“è§£ç–¼ç—›ï¼Œå±…å®¶å¿…å¤‡" },
        "digestion_tablets": { name: "ğŸŒ¿ å¥èƒƒæ¶ˆé£Ÿç‰‡", price: 12, type: "medicine", healthBonus: 5, hungerBonus: 5, desc: "åƒæ’‘äº†ï¼Ÿæ¥ä¸€ç‰‡" },
        "cold_medicine": { name: "ğŸ§ª æ„Ÿå†’çµ", price: 20, type: "medicine", healthBonus: 20, desc: "æš–æš–çš„å¾ˆè´´å¿ƒ" },
        "anti_inflammatory": { name: "ğŸ”¬ æ¶ˆç‚è¯", price: 25, type: "medicine", healthBonus: 25, desc: "é’ˆå¯¹å„ç±»ç‚ç—‡" },
        "fever_medicine": { name: "ğŸŒ¡ï¸ é€€çƒ§è¯", price: 35, type: "medicine", healthBonus: 35, desc: "é«˜çƒ§ä¸é€€æ—¶çš„æ•‘æ˜Ÿ" }
    };
    const WEATHER_TYPES = {
        'Sunny': { name: 'â˜€ æ™´æœ—', mood: 0.5, health: 0, desc: 'é˜³å…‰æ˜åªšï¼Œå¿ƒæƒ…èˆ’ç•…' },
        'Cloudy': { name: 'â˜ é˜´å¤©', mood: 0, health: 0, desc: 'ä¸å†·ä¸çƒ­ï¼Œé€‚åˆå‡ºè¡Œ' },
        'Rainy': { name: 'ğŸŒ§ å°é›¨', mood: -1, health: -0.2, desc: 'å‡ºé—¨è®°å¾—å¸¦ä¼ï¼Œå¿ƒæƒ…æœ‰äº›ä½è½' },
        'Storm': { name: 'â›ˆ æš´é›¨', mood: -3, health: -0.5, desc: 'ç³Ÿç³•çš„å¤©æ°”ï¼Œå®¹æ˜“ç”Ÿç—…' },
        'Snowy': { name: 'â„ ä¸‹é›ª', mood: 1, health: -1, desc: 'ç¾ä¸½çš„é›ªæ™¯ï¼Œä½†å°å¿ƒç€å‡‰' },
        'Heatwave': { name: 'ğŸ”¥ çƒ­æµª', mood: -2, health: -0.5, desc: 'é«˜æ¸©é¢„è­¦ï¼Œæ³¨æ„é˜²æš‘' },
        'Foggy': { name: 'ğŸŒ« å¤§é›¾', mood: -0.5, health: -0.2, desc: 'èƒ½è§åº¦ä½ï¼Œç©ºæ°”ä¸å¥½' }
    };
    const SOCIAL_SCENARIOS = [
        { text: "{A} æ­£åœ¨å‘ {B} ç–¯ç‹‚å®‰åˆ©ä¸€æ¬¾æ–°æ¸¸æˆ", effect: (a,b) => { a.happiness+=2; b.happiness+=2; a.skills.social+=0.2; } },
        { text: "{A} å·å·å‘Šè¯‰ {B} ä¸€ä¸ªæƒŠå¤©å¤§å…«å¦", effect: (a,b) => { a.happiness+=3; b.happiness+=3; a.skills.social+=0.2; } },
        { text: "{A} å‘ {B} æŠ±æ€¨æœ€è¿‘çš„å·¥èµ„å¤ªä½äº†", effect: (a,b) => { a.happiness+=1; b.happiness-=1; } },
        { text: "{A} è¯•å›¾ç»™ {B} è®²ä¸€ä¸ªå†·ç¬‘è¯ï¼Œæ°”æ°›å°´å°¬", effect: (a,b) => { a.happiness+=1; b.happiness-=1; } },
        { text: "{A} ç§°èµ {B} ä»Šå¤©çš„ç©¿æ­å¾ˆæœ‰å“å‘³", effect: (a,b) => { a.happiness+=2; b.happiness+=5; a.skills.social+=0.3; } },
        { text: "{A} å’Œ {B} æ¿€çƒˆè®¨è®ºå°é•‡çš„æœªæ¥å‘å±•", effect: (a,b) => { a.happiness+=1; b.happiness+=1; a.skills.culture+=0.2; b.skills.culture+=0.2; } },
        { text: "{A} é‚€è¯· {B} ä¸€èµ·å»å–å¥¶èŒ¶", effect: (a,b) => { a.happiness+=3; b.happiness+=3; } },
        { text: "{A} å¯¹ {B} ä¹‹å‰çš„è¡Œä¸ºè¡¨ç¤ºäº†ä¸æ»¡", effect: (a,b) => { a.happiness-=2; b.happiness-=2; } },
        { text: "{A} å®‰æ…°äº†çœ‹èµ·æ¥ä¸å¤ªå¼€å¿ƒçš„ {B}", effect: (a,b) => { a.happiness+=2; b.happiness+=5; a.skills.social+=0.4; } },
        { text: "{A} è¯¢é—® {B} æ˜¯å¦æœ‰å¤šä½™çš„æ„Ÿå†’è¯", effect: (a,b) => { } }
    ];
    const ACHIEVEMENTS_DB = [
        { id: 'first_build', name: 'ğŸ—ï¸ å¥ åŸºäºº', desc: 'å»ºæˆå°é•‡çš„ç¬¬ä¸€åº§å»ºç­‘', reward: 500, icon: 'ğŸ—ï¸' },
        { id: 'first_marriage', name: 'ğŸ‘©â€â¤ï¸â€ğŸ’‹â€ğŸ‘¨ ç¥ä»™çœ·ä¾£', desc: 'è¯ç”Ÿç¬¬ä¸€å¯¹ç¡®è®¤å…³ç³»çš„æƒ…ä¾£', reward: 300, icon: 'â¤ï¸' },
        { id: 'first_crime', name: 'ğŸ˜ˆ ç½ªæ¶éƒ½å¸‚', desc: 'å‘ç”Ÿäº†ç¬¬ä¸€èµ·æŠ¢åŠ«æˆ–éªšæ‰°æ¡ˆä»¶', reward: 200, icon: 'ğŸ˜ˆ' },
        { id: 'rich_town', name: 'ğŸ’° å°åº·ç¤¾ä¼š', desc: 'é•‡åº“èµ„é‡‘è¾¾åˆ° 5000', reward: 1000, icon: 'ğŸ’°' },
        { id: 'first_gym', name: 'ğŸ’ª è‡ªå¾‹è¾¾äºº', desc: 'å»ºæˆå¥èº«æˆ¿ï¼Œå¼€å§‹å…¨æ°‘å¥èº«', reward: 300, icon: 'ğŸ’ª' },
        { id: 'culture_hub', name: 'ğŸ› æ–‡åŒ–ä¸­å¿ƒ', desc: 'å»ºæˆåšç‰©é¦†ï¼Œæå‡å°é•‡æ–‡åŒ–åº•è•´', reward: 400, icon: 'ğŸ›' },
        { id: 'first_pot', name: 'ğŸ’° ç¬¬ä¸€æ¡¶é‡‘', desc: 'å­˜æ¬¾è¾¾åˆ°100', reward: 150, icon: 'ğŸ’°' },
        { id: 'financial_freedom', name: 'ğŸ¦ è´¢å¯Œè‡ªç”±', desc: 'å­˜æ¬¾è¾¾åˆ°1000', reward: 500, icon: 'ğŸ¦' },
        { id: 'common_prosperity', name: 'ğŸ¤ å…±åŒå¯Œè£•', desc: 'æ‰€æœ‰å±…æ°‘å¹³å‡å­˜æ¬¾è¶…è¿‡50', reward: 300, icon: 'ğŸ¤' },
        { id: 'workaholic', name: 'ğŸ’¼ å·¥ä½œç‹‚äºº', desc: 'è¿ç»­å·¥ä½œè¶…è¿‡12å°æ—¶', reward: 250, icon: 'ğŸ’¼' },
        { id: 'perfect_day', name: 'âœ¨ å®Œç¾ä¸€å¤©', desc: 'å¿ƒæƒ…ã€é¥±é£Ÿã€å¥åº·åŒæ—¶è¾¾åˆ°80ä»¥ä¸Š', reward: 300, icon: 'âœ¨' }
    ];
    function getItemTooltipText(itemId) {
        const item = ITEMS_DB[itemId];
        if (!item) return "";
        let parts = [];
        parts.push(item.desc);
        parts.push("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
        if (item.type === 'gift') {
            parts.push(`ğŸ’— å¢åŠ å¥½æ„Ÿ: +${item.loveBonus || 0}`);
        } else if (item.type === 'medicine') {
            parts.push(`ğŸš‘ æ¢å¤å¥åº·: +${item.healthBonus || 0}`);
            if (item.happinessBonus) parts.push(`â¤ å¿ƒæƒ…å€¼: +${item.happinessBonus}`);
        } else if (item.type === 'book') {
            if (item.happinessBonus) parts.push(`â¤ å¿ƒæƒ…: ${item.happinessBonus}`);
            if (item.cultureBonus) parts.push(`ğŸ“š æ–‡åŒ–: +${item.cultureBonus}`);
            if (item.maliceBonus) parts.push(`ğŸ˜ˆ æ¶æ„: +${item.maliceBonus}`);
            if (item.integrityBonus) parts.push(`âš–ï¸ è¯šä¿¡: ${item.integrityBonus}`);
        } else {
            if (item.hungerBonus !== undefined && item.hungerBonus !== 0) {
                const sign = item.hungerBonus > 0 ? '+' : '';
                parts.push(`ğŸ— é¥±é£Ÿåº¦: ${sign}${item.hungerBonus}`);
            }
            if (item.staminaBonus !== undefined && item.staminaBonus !== 0) {
                const sign = item.staminaBonus > 0 ? '+' : '';
                parts.push(`âš¡ ä½“åŠ›: ${sign}${item.staminaBonus}`);
            }
            if (item.happinessBonus !== undefined && item.happinessBonus !== 0) {
                const sign = item.happinessBonus > 0 ? '+' : '';
                parts.push(`â¤ å¿ƒæƒ…å€¼: ${sign}${item.happinessBonus}`);
            }
        }
        parts.push(`ğŸ’° ä»·å€¼: ${item.price}`);
        return parts.join('\n');
    }
    function getJobSkillType(role) {
        if (role.includes("è€å¸ˆ") || role.includes("å›¾ä¹¦") || role.includes("è®²è§£")) return 'culture';
        if (role.includes("ç¥çˆ¶") || role.includes("åŒ»ç”Ÿ") || role.includes("æŠ¤å£«")) return 'integrity'; 
        if (role.includes("å¨") || role.includes("ç«çƒ§") || role.includes("èŠ±è‰º") || role.includes("æŠ€å¸ˆ")) return 'social'; 
        if (role.includes("è­¦å¯Ÿ") || role.includes("ä¿å®‰") || role.includes("æ¬ç –")) return 'malice'; // è­¦å¯Ÿéœ€è¦æ‡‚ç½ªçŠ¯ï¼Ÿæˆ–è€…æš‚æ—¶å…³è”è¿™ä¸ª
        return 'social'; 
    }
    function getLevelInfo(skillVal) {
         if (skillVal < 20) return { level: 0, multiplier: 1.0, title: "è§ä¹ ", next: 20 };
         if (skillVal < 50) return { level: 1, multiplier: 1.2, title: "æ­£å¼", next: 50 };
         if (skillVal < 80) return { level: 2, multiplier: 1.4, title: "èµ„æ·±", next: 80 };
         return { level: 3, multiplier: 1.6, title: "å¤§å¸ˆ", next: 100 };
    }
    const BUILDINGS_BLUEPRINT = [
        { id: "huoshao", name: "ğŸ¥™ ç«çƒ§é“º", category: "food", cost: 150, desc: "3.5å…ƒåƒé¥±ï¼Œä½“åŠ›æ¢å¤åœ£åœ°", effect: "food", price: 3.5, food: 35, open: 6, close: 20, jobs: ["ç«çƒ§å¸ˆå‚…"], sells: ["huoshao_meat", "huoshao_veg", "tofu_pudding"], isBuilt: true },
        { id: "baozi", name: "ğŸ¥¯ åŒ…å­é“º", category: "food", cost: 100, desc: "ç‰©ç¾ä»·å»‰çš„æ—©é¤åº—", effect: "shop", price: 0, open: 5, close: 14, jobs: ["æ—©ç‚¹å·¥"], sells: ["baozi_tofu", "baozi_pork", "baozi_beef"], isBuilt: true }, 
        { id: "bookstore", name: "ğŸ“š çŸ¥è¯†ä¹¦åº—", category: "shop", cost: 400, desc: "ç²¾ç¥é£Ÿç²®ä¸å •è½ä¹‹æº", effect: "shop", price: 0, open: 9, close: 21, jobs: ["å›¾ä¹¦ç®¡ç†å‘˜"], sells: ["book_novel", "book_manga", "book_h", "book_53"], studyBonus: 0.6 },
        { id: "ramen", name: "ğŸœ å…°å·æ‹‰é¢", category: "food", cost: 250, desc: "æ­£å®—ç‰›è‚‰é¢ï¼Œç®¡é¥±", effect: "food", price: 12, food: 35, open: 7, close: 22, jobs: ["æ‹‰é¢å¸ˆå‚…"] },
        { id: "711", name: "ğŸª 7-11ä¾¿åˆ©åº—", category: "food", cost: 300, desc: "24å°æ—¶è¥ä¸š", effect: "shop", price: 0, open: 0, close: 24, jobs: ["æ”¶é“¶å‘˜"], sells: ["water_wahaha", "water_ganten", "noodle_beef", "chips_lays", "chocolate", "cola_pepsi", "coffee_instant", "sushi_box", "beer_tsingtao", "beer_laoshan"] },
        { id: "kfc", name: "ğŸ— è‚¯å¾·åŸº", category: "food", cost: 600, desc: "ç–¯ç‹‚æ˜ŸæœŸå››", effect: "food", price: 30, food: 50, open: 10, close: 22, jobs: ["å‰å°", "ç‚¸é¸¡å¨å¸ˆ"] },
        { id: "gym", name: "ğŸ’ª å¥èº«æˆ¿", category: "fun", cost: 800, desc: "æŒ¥æ´’æ±—æ°´ï¼Œæå‡é¢œå€¼ä¸å¥åº·", effect: "beauty", price: 50, open: 6, close: 22, jobs: ["å¥èº«æ•™ç»ƒ", "ä¿æ´"] },
        { id: "amusement", name: "ğŸ¡ æ¸¸ä¹åœº", category: "fun", cost: 2000, desc: "å……æ»¡å°–å«ä¸æ¬¢ç¬‘çš„åœ°æ–¹", effect: "fun_high", price: 100, open: 9, close: 20, jobs: ["æ£€ç¥¨å‘˜", "ç©å¶æ‰®æ¼”"] },
        { id: "museum", name: "ğŸ› åšç‰©é¦†", category: "fun", cost: 1200, desc: "å†å²çš„æ²‰æ·€ï¼Œå¢é•¿è§è¯†", effect: "study", price: 40, open: 9, close: 17, jobs: ["è®²è§£å‘˜", "ä¿å®‰"], closedDays: [1] },
        { id: "police", name: "ğŸ‘® æ´¾å‡ºæ‰€", category: "service", cost: 800, desc: "ç»´æŠ¤å°é•‡æ²»å®‰", effect: "security", price: 0, open: 0, close: 24, jobs: ["è­¦å¯Ÿ", "è­¦å¯Ÿ"] }, 
        { id: "hospital", name: "ğŸ¥ ç»¼åˆåŒ»é™¢", category: "service", cost: 1500, desc: "è®¾å¤‡å…ˆè¿›çš„åŒ»ç–—ä¸­å¿ƒ", effect: "health", price: 80, open: 0, close: 24, jobs: ["ä¸»æ²»åŒ»å¸ˆ", "æŠ¤å£«", "ä¿æ´"] },
        { id: "clinic", name: "ğŸ’Š ç¤¾åŒºè¯Šæ‰€", category: "service", cost: 400, desc: "æ–¹ä¾¿å¿«æ·çš„å°è¯Šæ‰€", effect: "shop", price: 0, open: 8, close: 20, jobs: ["ç¤¾åŒºåŒ»ç”Ÿ", "æŠ¤å£«"], sells: ["bandage", "painkiller", "digestion_tablets", "cold_medicine", "anti_inflammatory", "fever_medicine"] },
        { id: "school", name: "ğŸ« å°é•‡å­¦æ ¡", category: "service", cost: 1000, desc: "çŸ¥è¯†å°±æ˜¯åŠ›é‡", effect: "study", price: 0, open: 7, close: 17, jobs: ["è¯­æ–‡è€å¸ˆ", "æ•°å­¦è€å¸ˆ", "ä½“è‚²è€å¸ˆ", "ä¿å®‰"], closedDays: [0, 6] },
        { id: "library", name: "ğŸ“š å›¾ä¹¦é¦†", category: "fun", cost: 500, desc: "é™è°§çš„é˜…è¯»æ—¶å…‰", effect: "study", price: 0, open: 9, close: 21, jobs: ["å›¾ä¹¦ç®¡ç†å‘˜", "ä¿æ´"] },
        { id: "church", name: "â›ª å©šç¤¼æ•™å ‚", category: "service", cost: 1200, desc: "ç¥åœ£ä¹‹åœ°", effect: "marriage", price: 20, open: 8, close: 20, jobs: ["ç¥çˆ¶"] },
        { id: "park", name: "ğŸŒ³ ä¸­å¿ƒå…¬å›­", category: "fun", cost: 200, desc: "å…è´¹ä¼‘é—²", effect: "romance", price: 0, open: 0, close: 24, jobs: [] },
        { id: "netcafe", name: "ğŸ® éº¦å…‹ç”µç«", category: "fun", cost: 450, desc: "é€šå®µå¼€é»‘", effect: "fun", price: 15, open: 0, close: 24, jobs: ["ç½‘ç®¡", "ç½‘å§ä¿æ´"] },
        { id: "cinema", name: "ğŸ¬ ç”µå½±é™¢", category: "fun", cost: 400, desc: "æ¢å¤å¿ƒæƒ…å¿«", effect: "fun", price: 40, open: 10, close: 24, jobs: ["å”®ç¥¨å‘˜"] },
        { id: "bar", name: "ğŸº æ·±å¤œé…’å§", category: "fun", cost: 500, desc: "ä¹°é†‰æ¶ˆæ„", effect: "shop", price: 50, open: 18, close: 2, jobs: ["è€æ¿", "å¤§å¨", "è·‘å ‚"], closedDays: [0], sells: ["beer_tsingtao", "cocktail", "bloody_mary", "rum", "tequila", "whisky"] },
        { id: "footshop", name: "ğŸ’† ç¥ç§˜æ´—è„šåº—", category: "fun", cost: 600, desc: "æ¶©æƒ…äº¤æ˜“åœºæ‰€", effect: "ntr", price: 0, open: 0, close: 24, jobs: ["è€æ¿"] },
        { id: "hotel", name: "ğŸ© å¿«æ·é…’åº—", category: "fun", cost: 800, desc: "æ‡‚å¾—éƒ½æ‡‚", effect: "ntr", price: 100, open: 0, close: 24, jobs: ["å‰å°", "ä¿æ´"] },
        { id: "flowershop", name: "ğŸŒ¹ æµªæ¼«èŠ±åº—", category: "shop", cost: 300, desc: "è´­ä¹°é²œèŠ±é€ç»™å¿ƒä¸Šäºº", effect: "shop", price: 50, open: 9, close: 20, jobs: ["èŠ±è‰ºå¸ˆ"], sells: ["rose"] },
        { id: "statue", name: "ğŸ± é»„é‡‘çŒ«åƒ", category: "landmark", cost: 5000, desc: "çº¯é‡‘æ‰“é€ çš„çŒ«ç¥åƒï¼Œå¸å¼•æ¸¸å®¢æ‰“å¡ (ç¨æ”¶+50/h)", effect: "tourist", price: 50, open: 0, close: 24, jobs: ["ä¿å®‰"] },
        { id: "skytower", name: "ğŸ—¼ é€šå¤©å¡”", category: "landmark", cost: 8000, desc: "ä¿¯ç°å…¨é•‡çš„è§‚å…‰å¡” (ç¨æ”¶+100/h, å¹¸ç¦UP)", effect: "tourist_high", price: 100, open: 8, close: 22, jobs: ["æ£€ç¥¨å‘˜", "ç”µæ¢¯å‘˜", "ä¿æ´"] },
        { id: "hotspring", name: "â™¨ï¸ çŒ«å±±æ¸©æ³‰", category: "landmark", cost: 6000, desc: "è‘—åçš„ç–—å…»èƒœåœ° (ç¨æ”¶+80/h, å¥åº·UP)", effect: "tourist_health", price: 80, open: 10, close: 23, jobs: ["å‰å°", "æŠ€å¸ˆ"] },
        { id: "bank", name: "ğŸ¦ é“¶è¡Œ", category: "government", cost: 3000, desc: "é‡‘èä¸­å¿ƒï¼Œæä¾›å­˜æ¬¾å’Œè´·æ¬¾æœåŠ¡ (ç¨æ”¶+60/h)", effect: "finance", price: 60, open: 9, close: 17, jobs: ["é“¶è¡Œç»ç†", "æŸœå‘˜", "ä¿å®‰"], closedDays: [0, 6] },
        { id: "govbuilding", name: "ğŸ›ï¸ æ”¿åºœå¤§æ¥¼", category: "government", cost: 5000, desc: "å°é•‡è¡Œæ”¿ä¸­å¿ƒï¼Œæå‡æ”¿åºœæ•ˆç‡ (ç¨æ”¶+100/h, æ”¿ç­–æ•ˆæœ+20%)", effect: "government", price: 100, open: 8, close: 18, jobs: ["é•‡é•¿åŠ©ç†", "è¡Œæ”¿äººå‘˜", "ä¿å®‰"], closedDays: [0, 6] }
    ];
    const CATEGORY_NAMES = { 'food': 'ğŸ” é¥®é£Ÿé¤é¥®', 'service': 'ğŸ¥ å…¬å…±æœåŠ¡', 'fun': 'ğŸ¡ ä¼‘é—²å¨±ä¹', 'shop': 'ğŸ›ï¸ å•†ä¸šè´­ç‰©', 'landmark': 'ğŸš© åœ°æ ‡å»ºç­‘', 'government': 'ğŸ›ï¸ æ”¿åºœå»ºç­‘' };
    const DAYS = ["å‘¨æ—¥", "å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­"];
    // æ–°ç‰ˆç‰¹è´¨ç³»ç»Ÿ (å·²å¹¶å…¥æ€§æ ¼)
    const TRAITS = [
        {id:"sleepy", name:"çˆ±ç¡è§‰", desc:"åªæƒ³ç¡è§‰ï¼Œä½“åŠ›æ¢å¤å¿«ä½†ä¸Šé™ä½ï¼Œè¯­æ°”æ…µæ‡’", tone:"æ…µæ‡’ã€å›°å€¦ã€æ…¢åå"},
        {id:"lustful", name:"æ·«ä¹±", desc:"é«˜é¢œå€¼ï¼Œæ¸´æœ›äº²å¯†ï¼Œå®¹æ˜“å‘ç”Ÿæ¡ƒè‰²äº‹ä»¶ï¼Œè¯­æ°”æŒ‘é€—", tone:"å¼€æ”¾ã€æŒ‘é€—ã€æš§æ˜§ã€ä¸å®³è‡Š"},
        {id:"greedy", name:"çˆ±é’±", desc:"çœ‹é‡é‡‘é’±ï¼ŒæŠ¢åŠ«æ¦‚ç‡é«˜ï¼Œè¯­æ°”åŠ¿åˆ©", tone:"åŠ¿åˆ©ã€ä¸‰å¥ä¸ç¦»é’±ã€ç²¾æ˜"},
        {id:"estrous", name:"æ˜“å‘æƒ…", desc:"å®¹æ˜“åŠ¨æƒ…ï¼Œæ‹çˆ±è„‘ï¼Œè¯­æ°”ç¾æ¶©åˆæœŸå¾…", tone:"ç¾æ¶©ã€æœŸå¾…ã€æ‹çˆ±è„‘"},
        {id:"hardworking", name:"å‹¤åŠ³", desc:"å·¥ä½œæ”¶ç›Š+20%ï¼Œä½“åŠ›æ¶ˆè€—ç•¥å¿«ï¼Œè¯­æ°”è¸å®", tone:"å¹²ç»ƒã€è¸å®ã€è®¤çœŸ"},
        {id:"optimistic", name:"ä¹è§‚", desc:"å¿ƒæƒ…ä¸‹é™æ…¢ï¼Œå®¹æ˜“æ¢å¤ï¼Œè¯­æ°”ç§¯æ", tone:"ç§¯æã€é˜³å…‰ã€å……æ»¡å¸Œæœ›"},
        {id:"kind", name:"å–„è‰¯", desc:"ç¤¾äº¤å®¹æ˜“è·å¾—å¥½æ„Ÿï¼Œè¯šä¿¡é«˜ï¼Œè¯­æ°”æ¸©æŸ”", tone:"æ¸©æŸ”ã€ä½“è´´ã€å…³å¿ƒäºº"},
        {id:"smart", name:"èªæ˜", desc:"æ–‡åŒ–æå‡å¿«ï¼Œå·¥ä½œè¡¨ç°å¥½ï¼Œè¯­æ°”ç†æ™º", tone:"ç†æ™ºã€èªæ˜ã€é€»è¾‘æ¸…æ™°"},
        {id:"healthy", name:"å…»ç”Ÿ", desc:"å¥åº·ä¸‹é™æ…¢ï¼Œæ¢å¤å¿«ï¼Œè¯­æ°”æœ‰æ´»åŠ›", tone:"æœ‰æ´»åŠ›ã€æ³¨é‡å¥åº·"},
        {id:"workaholic", name:"å·¥ä½œç‹‚", desc:"æ”¶ç›Šå¤§å¹…å¢åŠ ï¼Œä½†å¥åº·ä¸‹é™å¿«ï¼Œè¯­æ°”åŒ†å¿™", tone:"åŒ†å¿™ã€é›·å‰é£è¡Œ"},
        {id:"frugal", name:"èŠ‚ä¿­", desc:"è´­ç‰©çœé’±ä½†å¿ƒæƒ…æå‡å°‘ï¼Œè¯­æ°”æŠ é—¨", tone:"ç²¾æ‰“ç»†ç®—ã€æŠ é—¨"},
        {id:"lavish", name:"æŒ¥éœ", desc:"è´­ç‰©èŠ±é’±å¤šå¿ƒæƒ…æå‡å¤§ï¼Œè¯­æ°”ç‚«è€€", tone:"è±ªæ¨ªã€ç‚«è€€"},
        {id:"irritable", name:"æ˜“æ€’", desc:"æ¶æ„å€¼å®¹æ˜“å‡é«˜ï¼Œå®¹æ˜“åµæ¶ï¼Œè¯­æ°”æš´èº", tone:"æš´èºã€ä¸è€çƒ¦ã€æ˜“æ€’"},
        {id:"calm", name:"æ²‰ç€", desc:"æƒ…ç»ªæ³¢åŠ¨å°ï¼Œè¯šä¿¡é«˜ï¼Œè¯­æ°”å¹³é™", tone:"å¹³é™ã€æ·¡å®š"},
        {id:"introvert", name:"ç¤¾æ", desc:"ä¸å–„ç¤¾äº¤ï¼Œç¤¾äº¤å€¼å¢é•¿æ…¢ï¼Œè¯­æ°”ç¾æ¶©", tone:"ç¾æ¶©ã€ç´§å¼ ã€è¯å°‘"},
        {id:"humorous", name:"å¹½é»˜", desc:"å®¹æ˜“é€—äººå¼€å¿ƒï¼Œç¤¾äº¤å€¼å¢é•¿å¿«ï¼Œè¯­æ°”é£è¶£", tone:"å¹½é»˜ã€é£è¶£ã€çˆ±å¼€ç©ç¬‘"}
    ];
    const IDEOLOGIES = [
        // å·¦æ´¾ (Left)
        {name:"å…±äº§ä¸»ä¹‰",color:"#c0392b",chaosMod:-0.2,loveMod:0.6,wageMod:0.1,desc:"å„å°½æ‰€èƒ½ï¼Œå„å–æ‰€éœ€"},
        {name:"ç¤¾ä¼šä¸»ä¹‰",color:"#e74c3c",chaosMod:-0.15,loveMod:0.5,wageMod:0.1,desc:"å…¬å¹³æ­£ä¹‰ï¼Œç¤¾ä¼šäº’åŠ©"},
        {name:"æ¯›ä¸»ä¹‰",color:"#e17055",chaosMod:0.05,loveMod:0.6,wageMod:0.05,desc:"é€ åæœ‰ç†ï¼Œç»§ç»­é©å‘½"},
        {name:"åˆ—å®ä¸»ä¹‰",color:"#d63031",chaosMod:-0.05,loveMod:0.4,wageMod:0.1,desc:"èŒä¸šé©å‘½ï¼Œå…ˆé”‹å¸¦å¤´"},
        {name:"æ–¯å¤§æ—ä¸»ä¹‰",color:"#636e72",chaosMod:-0.35,loveMod:-0.1,wageMod:0.2,desc:"é’¢é“æ„å¿—ï¼Œé«˜åº¦é›†æƒ"},
        {name:"è¶…è§†ç¤¾ä¼šä¸»ä¹‰",color:"#00cec9",chaosMod:-0.1,loveMod:0.3,wageMod:0.2,desc:"ç§‘å­¦æ‰§æ”¿ï¼Œç†æ€§è§„åˆ’"},
        // ä¸­é—´/æ¸©å’Œ (Center)
        {name:"æ°‘ä¸»ä¸»ä¹‰",color:"#3498db",chaosMod:0.02,loveMod:0.2,wageMod:0.1,desc:"å°Šé‡å¤šå…ƒï¼Œå´‡å°šè¡¨è¾¾"},
        {name:"å…±å’Œåˆ¶",color:"#2980b9",chaosMod:-0.05,loveMod:0.1,wageMod:0.15,desc:"å¤©ä¸‹ä¸ºå…¬ï¼Œæ³•æ²»ç¤¾ä¼š"},
        {name:"å›ä¸»ç«‹å®ª",color:"#9b59b6",chaosMod:-0.25,loveMod:0.2,wageMod:0.05,desc:"æ‹¥æŠ¤ä¼ ç»Ÿï¼Œæ¸©å’Œæ”¹è‰¯"},
        {name:"ä¿å®ˆä¸»ä¹‰",color:"#7f8c8d",chaosMod:-0.1,loveMod:0.2,wageMod:0.02,desc:"å°Šé‡ä¼ ç»Ÿï¼Œå¾ªåºæ¸è¿›"},
        // å³æ´¾ (Right)
        {name:"èµ„æœ¬ä¸»ä¹‰",color:"#f1c40f",chaosMod:0.1,loveMod:-0.4,wageMod:0.6,desc:"é‡‘é’±è‡³ä¸Šï¼Œæ•ˆç‡ä¼˜å…ˆ"},
        {name:"è‡ªç”±ä¸»ä¹‰",color:"#0984e3",chaosMod:0.15,loveMod:-0.1,wageMod:0.3,desc:"å¤©èµ‹äººæƒï¼Œå°æ”¿åºœ"},
        {name:"é‡å•†ä¸»ä¹‰",color:"#f39c12",chaosMod:0.02,loveMod:-0.3,wageMod:0.4,desc:"è´¸æ˜“é¡ºå·®ï¼Œè´¢å¯Œç§¯ç´¯"},
        {name:"å¯¡å¤´æ”¿æ²»",color:"#d35400",chaosMod:-0.1,loveMod:-0.5,wageMod:0.5,desc:"æŒæ¡èµ„æºï¼Œç²¾è‹±ç‰¹æƒ"},
        // æç«¯/å…¶ä»–
        {name:"æ— æ”¿åºœä¸»ä¹‰",color:"#2d3436",chaosMod:0.25,loveMod:0.2,wageMod:-0.2,desc:"æ‹’ç»æƒå¨ï¼Œç»å¯¹è‡ªç”±"},
        {name:"æ³•è¥¿æ–¯ä¸»ä¹‰",color:"#000000",chaosMod:-0.4,loveMod:-0.6,wageMod:0.1,desc:"æç«¯æ°‘æ—ï¼Œææƒæœä»"},
        {name:"å†›å›½ä¸»ä¹‰",color:"#2c3e50",chaosMod:-0.15,loveMod:-0.2,wageMod:0.2,desc:"æ­¦åŠ›è‡³ä¸Šï¼Œé“è¡€æ‰©å¼ "},
        {name:"å°å»ºåˆ¶",color:"#8e44ad",chaosMod:-0.25,loveMod:0,wageMod:-0.2,desc:"ç­‰çº§æ£®ä¸¥ï¼Œå¿ è¯šç¬¬ä¸€"},
        {name:"å†›äº‹ç‹¬è£",color:"#34495e",chaosMod:-0.15,loveMod:-0.3,wageMod:0.2,desc:"é“è¡€çºªå¾‹ï¼Œæ­¦åŠ›å´‡æ‹œ"},
        {name:"æ€»ç»Ÿåˆ¶",color:"#34495e",chaosMod:-0.05,loveMod:0,wageMod:0.2,desc:"å¼ºåŠ›è¡Œæ”¿ï¼Œè¡Œèƒœäºè¨€"},
        {name:"é€‰ä¸¾åˆ¶",color:"#16a085",chaosMod:0.1,loveMod:0.2,wageMod:0.05,desc:"çƒ­è¡·æŠ•ç¥¨ï¼Œæ”¿æ²»åŠ¨ç‰©"},
        // æ–°å¢ä¸»ä¹‰
        {name:"æŠ€æœ¯åŠ é€Ÿä¸»ä¹‰",color:"#00d2d3",chaosMod:0.2,loveMod:-0.1,wageMod:0.5,desc:"æŠ€æœ¯çˆ†ç‚¸ï¼Œä¸æƒœä¸€åˆ‡ä»£ä»·è¿½æ±‚è¿›æ­¥"},
        {name:"é›†æƒä¸»ä¹‰",color:"#2d3436",chaosMod:-0.4,loveMod:-0.3,wageMod:-0.1,desc:"ç»å¯¹æœä»ï¼ŒæŠ¹æ€ä¸ªæ€§ä»¥æ¢å–ç§©åº"},
        {name:"å¸å›½ä¸»ä¹‰",color:"#6D214F",chaosMod:0.1,loveMod:-0.4,wageMod:0.4,desc:"å¯¹å¤–æ‰©å¼ ï¼Œæ å¤ºèµ„æº"},
        {name:"ä¸–ç•Œå¤§åŒä¸»ä¹‰",color:"#55efc4",chaosMod:-0.3,loveMod:0.5,wageMod:0.1,desc:"å››æµ·ä¸€å®¶ï¼Œæ¶ˆé™¤éš”é˜‚"},
        {name:"äººé“ä¸»ä¹‰",color:"#fab1a0",chaosMod:-0.2,loveMod:0.6,wageMod:0.05,desc:"ä»¥äººä¸ºæœ¬ï¼Œå…³æ€€å¼±è€…"},
        {name:"æ¿€è¿›ä¸»ä¹‰",color:"#ff7675",chaosMod:0.4,loveMod:0,wageMod:0.3,desc:"æ‰“ç ´å¸¸è§„ï¼Œå‰§çƒˆå˜é©"},
    ];
    // Map for logic to look up effects easily
    const MAYOR_EFFECTS = {};
    IDEOLOGIES.forEach(i => {
        MAYOR_EFFECTS[i.name] = { wage: 1 + i.wageMod, happy: i.loveMod, chaos: i.chaosMod, desc: i.desc };
    });
    const ODD_JOBS = [
        {name:"æ¸…æ´å·¥",wage:8,mood:-3},
        {name:"å‘ä¼ å•",wage:7,mood:-2},
        {name:"æ¬ç –",wage:9,mood:-4},
        {name:"å¤–å–å‘˜",wage:11,mood:-5}, 
        {name:"æ´—ç¢—å·¥",wage:8,mood:-3}, 
        {name:"èººå¹³",wage:-3,mood:5}
    ];
    const REL_TRANSLATE = { 'friend': 'æœ‹å‹', 'stranger': 'é™Œç”Ÿäºº', 'bestfriend': 'æŒšå‹', 'lover': 'æƒ…ä¾£', 'spouse': 'é…å¶', 'mistress': 'å°ä¸‰', 'ex': 'å‰ä»»', 'enemy': 'ä»‡äºº' };
    const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    const choose = (arr) => arr[Math.floor(Math.random() * arr.length)];
const TOWN_EVENTS = [
        { id: 'concert', name: 'ğŸ¤ å·¨æ˜Ÿæ¼”å”±ä¼š', cost: 500, desc: 'å…¨å‘˜å¿«ä¹+20ï¼Œå…³ç³»+5ã€‚10%æ¦‚ç‡ç¿»è½¦æ•ˆæœå‡åŠã€‚', emoji: 'ğŸ¤' },
        { id: 'matchmaking', name: 'ğŸ’˜ é•‡ç«‹ç›¸äº²å¤§ä¼š', cost: 200, desc: 'æ‰€æœ‰å•èº«è€…å°è¯•è¡¨ç™½(æˆåŠŸç‡up)ï¼Œæˆå¯¹åå¿«ä¹+5ã€‚', emoji: 'ğŸ’˜' },
        { id: 'charity', name: 'ğŸ—ï¸ æ…ˆå–„å‹Ÿæ', cost: 0, desc: 'å±…æ°‘è‡ªæ„¿ææ¬¾ç»™é•‡åº“ï¼Œå¿«ä¹-5ï¼Œå…³ç³»+5ã€‚', emoji: 'ğŸ—ï¸' },
        { id: 'anniversary', name: 'ğŸˆ å°é•‡çºªå¿µæ—¥', cost: 100, desc: 'å…¨å‘˜å¿«ä¹+10ï¼Œå…³ç³»å¾®é‡æå‡ã€‚', emoji: 'ğŸˆ' },
        { id: 'fireworks', name: 'ğŸ† ç››å¤§çƒŸèŠ±ä¼š', cost: 250, desc: 'å…¨å‘˜å¿«ä¹+25ï¼Œå…³ç³»+5ã€‚5%æ¦‚ç‡å¼•å‘ç«ç¾çƒ§æ¯å»ºç­‘ã€‚', emoji: 'ğŸ†' },
        { id: 'jobfair', name: 'ğŸ¤ å¤§å‹æ‹›è˜ä¼š', cost: 150, desc: 'å¸®åŠ©æ— ä¸šæ¸¸æ°‘è‡ªåŠ¨å¡«è¡¥ç©ºç¼ºå²—ä½ï¼Œå…¥èŒå¿«ä¹+10ã€‚', emoji: 'ğŸ¤' },
        { id: 'artfest', name: 'ğŸ¨ è‰ºæœ¯èŠ‚', cost: 300, desc: 'å…¨å‘˜å¿«ä¹+15ï¼Œå…³ç³»+3ã€‚10%æ¦‚ç‡å‘ç”Ÿè‰ºæœ¯å“å¤±çªƒã€‚', emoji: 'ğŸ¨' },
        { id: 'marathon', name: 'ğŸƒ å…¨æ°‘é©¬æ‹‰æ¾', cost: 200, desc: 'å¿«ä¹+10ï¼Œé¥±é£Ÿ-10ã€‚5%æ¦‚ç‡æœ‰äººå—ä¼¤(å¿«ä¹-20)ã€‚', emoji: 'ğŸƒ' },
        { id: 'reading', name: 'ğŸ“š è¯»ä¹¦ä¼š', cost: 100, desc: 'å¿«ä¹+5ï¼Œå…³ç³»+2ã€‚20%æ¦‚ç‡æ ‘è‹—æ¯æ­»æ•ˆæœå‡åŠã€‚', emoji: 'ğŸ“š' },
        { id: 'shopping', name: 'ğŸ›ï¸ è´­ç‰©èŠ‚', cost: 0, desc: 'åŒ11ç‹‚æ¬¢ï¼å±…æ°‘ç–¯ç‹‚è´­ç‰©ï¼Œé•‡åº“è·å¾—å…¨é¢å•†å“æ”¶å…¥ï¼', emoji: 'ğŸ›ï¸' },
        // èŠ‚æ—¥ / ç‰¹å®šæ—¥æœŸ
        { id: 'new_year', name: 'ğŸ§¨ å…ƒæ—¦ä½³èŠ‚', cost: 300, desc: 'æ–°å¹´æ–°æ°”è±¡ï¼å…¨å‘˜å¿«ä¹+20ï¼Œæ¶ˆè´¹æ¬²æœ›æå‡ã€‚', emoji: 'ğŸ§¨', date: {m:1, d:1} },
        { id: 'cat_return', name: 'ğŸ± çŒ«å’ªæŠ¥æ©æ—¥', cost: 0, desc: 'ä¼ è¯´ä¸­çŒ«ç¥æ˜¾çµçš„æ—¥å­ï¼Œæ¯ä½å±…æ°‘éƒ½ä¼šé‡åˆ°éšæœºå¥½äº‹ï¼', emoji: 'ğŸ±', date: {m:2, d:22} },
        { id: 'sakura', name: 'ğŸŒ¸ æ¨±èŠ±ç¥­', cost: 200, desc: 'ç²‰è‰²çš„æµªæ¼«å­£èŠ‚ã€‚å•èº«å±…æ°‘åœ¨æ ‘ä¸‹æ›´å®¹æ˜“å å…¥çˆ±æ²³ã€‚', emoji: 'ğŸŒ¸', date: {m:3, d:1} },
        { id: 'planting', name: 'ğŸŒ³ æ¤æ ‘èŠ‚', cost: 150, desc: 'å¿«ä¹+5ï¼Œå…³ç³»+3ã€‚10%æ¦‚ç‡æ ‘è‹—æ¯æ­»æ•ˆæœå‡åŠã€‚', emoji: 'ğŸŒ³', date: {m:3, d:12} },
        { id: 'fools_day', name: 'ğŸ¤¡ æ„šäººèŠ‚', cost: 100, desc: 'å°å¿ƒæ¶ä½œå‰§ï¼å…¨å‘˜å¿«ä¹+10ï¼Œä½†å®¹æ˜“å‘ç”Ÿäº‰åµã€‚', emoji: 'ğŸ¤¡', date: {m:4, d:1} },
        { id: 'labor_day', name: 'ğŸ› ï¸ åŠ³åŠ¨èŠ‚', cost: 200, desc: 'åŠ³åŠ¨æœ€å…‰è£ï¼ä»Šæ—¥å·¥ä½œæ”¶ç›Šæå‡20%ã€‚', emoji: 'ğŸ› ï¸', date: {m:5, d:1} },
        { id: 'children_day', name: 'ğŸˆ å„¿ç«¥èŠ‚', cost: 250, desc: 'ç«¥å¿ƒæœªæ³¯ã€‚æ¸¸ä¹åœºæ•ˆæœç¿»å€ã€‚', emoji: 'ğŸˆ', date: {m:6, d:1} },
        { id: 'music_fest', name: 'ğŸµ éŸ³ä¹èŠ‚', cost: 400, desc: 'éœ²å¤©éŸ³ä¹ç‹‚æ¬¢ï¼å…¨å‘˜å¿ƒæƒ…å¤§å¹…æå‡ï¼Œå‹åŠ›é‡Šæ”¾ã€‚', emoji: 'ğŸµ', date: {m:6, d:21} },
        { id: 'matsuri', name: 'ğŸ® å¤æ—¥ç¥­', cost: 400, desc: 'å…¨å‘˜ç©¿æµ´è¡£åº†ç¥å¤å¤©ï¼å¿«ä¹å¤§å¹…æå‡ï¼Œå•èº«ç‹—å®¹æ˜“è„±å•ã€‚', emoji: 'ğŸ®', date: {m:7, d:15} },
        { id: 'charity_day', name: 'ğŸ’ å›½é™…æ…ˆå–„æ—¥', cost: 0, desc: 'é¼“åŠ±å±…æ°‘é€šè¿‡ææ¬¾å¸®åŠ©ä»–äººï¼Œæå‡ç¤¾ä¼šè´£ä»»æ„Ÿã€‚', emoji: 'ğŸ’', date: {m:9, d:5} },
        { id: 'harvest', name: 'ğŸŒ¾ ä¸°æ”¶èŠ‚', cost: 300, desc: 'åº†ç¥ä¸°æ”¶ï¼é¤å…é£Ÿç‰©ä»·æ ¼åŠä»·(ç”±é•‡åº“è¡¥è´´)ï¼Œå±…æ°‘é¥±é£Ÿåº¦å®¹æ˜“æ¢å¤ã€‚', emoji: 'ğŸŒ¾', date: {m:9, d:23} },
        { id: 'halloween', name: 'ğŸƒ ä¸‡åœ£èŠ‚', cost: 350, desc: 'äº’æ¢ç³–æœï¼Œæ£è›‹é¬¼å‡ºæ²¡ï¼å¿«ä¹+15ï¼Œè·å¾—éšæœºé›¶é£Ÿã€‚', emoji: 'ğŸƒ', date: {m:10, d:31} },
        { id: 'christmas', name: 'ğŸ„ åœ£è¯èŠ‚', cost: 500, desc: 'äº’é€ç¤¼ç‰©ï¼Œå…¨å‘˜å¿«ä¹+20ï¼Œå¥åº·+10ã€‚', emoji: 'ğŸ„', date: {m:12, d:25} },
        { id: 'new_year_eve', name: 'ğŸ† è·¨å¹´æ™šä¼š', cost: 600, desc: 'è¾æ—§è¿æ–°ï¼å…¨å‘˜èšé›†å€’è®¡æ—¶ï¼Œå¿«ä¹ä¸å…³ç³»å¤§å¹…æå‡ã€‚', emoji: 'ğŸ†', date: {m:12, d:31} },
        // å­£èŠ‚æ€§ (æ— ç‰¹å®šæ—¥æœŸï¼Œæ•´ä¸ªå­£èŠ‚éƒ½å¯èƒ½å‡ºç°)
        { id: 'snowfest', name: 'â˜ƒï¸ å†°é›ªèŠ‚', cost: 350, desc: 'å †é›ªäººã€åƒç«é”…ï¼å¿«ä¹+15ï¼Œå¥åº·+10ï¼Œé¥±é£Ÿ+10ã€‚', emoji: 'â˜ƒï¸', season: 'Winter' }
    ];
    function getJobWage(role) { 
        if (role.includes("è€æ¿") || role.includes("ä¸»æ²»åŒ»å¸ˆ")) return 35; 
        if (role.includes("ç¥çˆ¶") || role.includes("ç¤¾åŒºåŒ»ç”Ÿ") || role.includes("è®²è§£")) return 25; 
        if (role.includes("è­¦å¯Ÿ") || role.includes("è€å¸ˆ") || role.includes("æ•™ç»ƒ")) return 22; 
        if (role.includes("å–é“¶")) return 20; 
        if (role.includes("å¤§å¨") || role.includes("ç«çƒ§") || role.includes("æŠ¤å£«") || role.includes("ç©å¶")) return 18; 
        if (role.includes("èŠ±è‰º") || role.includes("ç‚¸é¸¡")) return 16; 
        if (role.includes("ç½‘ç®¡") || role.includes("ä¿å®‰")) return 15; 
        if (role.includes("å‰å°") || role.includes("å›¾ä¹¦ç®¡ç†å‘˜") || role.includes("æ£€ç¥¨") || role.includes("ç”µæ¢¯")) return 15; 
        if (role.includes("æ‹‰é¢")) return 15; 
        if (role.includes("æ”¶é“¶") || role.includes("å”®ç¥¨")) return 15; 
        if (role.includes("ç½‘å§ä¿æ´") || role.includes("ä¿æ´") || role.includes("è·‘å ‚") || role.includes("æ—©ç‚¹")) return 15; 
        return 15; 
    }
    function getBaseJobWage(role) { return getJobWage(role); }
    class Character {
        constructor(name) {
            this.name = name; this.gender = Math.random() > 0.5 ? 'â™‚ ç”·' : 'â™€ å¥³'; 
            // ç”Ÿç†éœ€æ±‚
            this.happiness = 60; this.hunger = 80; this.health = 100; this.stamina = 100;
            // å±æ€§ä¸Šé™ï¼ˆå¯é€šè¿‡å»ºç­‘äº’åŠ¨æå‡ï¼‰
            this.staminaMax = 100;
            this.healthMax = 100;
            this.money = 0; this.job = null; this.currentAction = "å‘å‘†"; this.relationships = {}; this.partner = null; this.interactingWith = null; 
            this.traits = []; this.ideology = choose(IDEOLOGIES);
            this.nextActionOverride = null; 
            this.bag = []; 
            this.history = [];
            this.jailTerm = 0; 
            this.lastMealTime = -999;
            this.consecutiveWork = 0;
            this.workHoursToday = 0; // ä»Šæ—¥å·¥ä½œå°æ—¶æ•°ï¼Œç”¨äºæ¯æ—¥å·¥èµ„ç»“ç®—
            this.incomeHistory = []; // èµ„é‡‘æ”¶å…¥å†å²è®°å½•ï¼Œæœ€å¤šä¿å­˜10æ¡
            // æ–°å››ç»´ï¼šç¤¾äº¤ã€æ–‡åŒ–ã€è¯šä¿¡ã€æ¶æ„å€¼
            this.skills = { 
                social: rand(10, 30), 
                culture: rand(10, 30), 
                integrity: rand(50, 80), // åˆå§‹è¯šä¿¡è¾ƒé«˜
                malice: rand(0, 10)     // åˆå§‹æ¶æ„è¾ƒä½
            };
            this.stat_rob = 0;        
            this.stat_be_robbed = 0;  
            this.stat_streetwalk = 0; 
            this.stat_assault = 0;    
            this.stat_be_assaulted = 0; 
            this.dailySleepOffset = rand(-2, 4); 
            this.stayUpLate = false;
            const traitCount = rand(1, 3); for (let i = 0; i < traitCount; i++) { const availableTraits = TRAITS.filter(t => !this.traits.find(tt => tt.id === t.id)); if (availableTraits.length > 0) this.traits.push(choose(availableTraits)); }
            this.constructionContribution = {}; this.prostitute = null; 
            this.appearance = rand(40, 80); 
            if (this.hasTrait('estrous') || this.hasTrait('lustful')) this.appearance += 15; // æ·«ä¹±/æ˜“å‘æƒ…ç‰¹è´¨åŠ æˆ
            if (this.hasTrait('sleepy')) this.appearance += 5; 
            if (this.hasTrait('optimistic')) this.appearance += 5;
            if (this.hasTrait('kind')) this.appearance += 3;
            this.appearance = Math.max(0, Math.min(100, this.appearance));
        }
        hasTrait(traitId) { return this.traits.some(t => t.id === traitId); }
        addLog(msg) {
            this.history.unshift(msg);
            if (this.history.length > 10) this.history.pop();
        }
        getSleepSchedule() { 
            if (this.stayUpLate) return { start: 4, end: 8 }; 
            let baseStart = 22; let baseEnd = 7;
            if (this.job && (this.job.buildingId === 'bar' || this.job.buildingId === 'netcafe')) { 
                baseStart = 5; baseEnd = 13; 
            } else {
                baseStart = (baseStart + this.dailySleepOffset + 24) % 24; 
                baseEnd = (baseEnd + Math.floor(this.dailySleepOffset/2) + 24) % 24;
            }
            if (this.hasTrait('sleepy')) { baseStart = (baseStart - 1 + 24) % 24; baseEnd = (baseEnd + 1) % 24; }
            if (Math.random() < 0.1) baseStart = (baseStart + 2) % 24;
            return { start: baseStart, end: baseEnd }; 
        }
        decideProposal(askerName, type) { const rel = this.relationships[askerName]; let chance = rel.love + (this.happiness - 50) / 2; let threshold = 0; if (type === 'date') threshold = 30; if (type === 'confess') threshold = 75; if (type === 'propose') threshold = 90; chance += rand(-10, 10); return chance >= threshold; }
        calculateWage(baseWage, role) { 
            // å‘˜å·¥è‡ªå·±çš„ä¸»ä¹‰åŠ æˆ
            let bonus = (this.ideology && this.ideology.wageMod) ? this.ideology.wageMod : 0;
            // ç‰¹è´¨åŠ æˆ
            if (this.hasTrait('hardworking')) bonus += 0.2; // å‹¤åŠ³ +20%
            if (this.hasTrait('workaholic')) bonus += 0.3; // å·¥ä½œç‹‚ +30%
            if (this.hasTrait('smart')) bonus += 0.1; // èªæ˜ +10%
            // é•‡é•¿æ”¿ç­–åŠ æˆï¼ˆå…¨é•‡ç»Ÿä¸€ï¼‰
            let mayorMult = 1.0;
            const g = (typeof gameInstance !== 'undefined' && gameInstance) ? gameInstance : window.gameInstance;
            if (g && g.mayor) {
                const mayorChar = g.chars.find(c => c.name === g.mayor);
                if (mayorChar && mayorChar.ideology) {
                   let effect = MAYOR_EFFECTS[mayorChar.ideology.name];
                   if (effect && effect.wage !== undefined) mayorMult = effect.wage;
                }
            }
            // å»ºç­‘ç­‰çº§åŠ æˆ
            let buildLevelBonus = 1.0;
            if (this.job && g) {
                const b = g.buildings.find(x => x.id === this.job.buildingId);
                if (b && b.level > 1) {
                    buildLevelBonus = 1 + (b.level - 1) * 0.1;
                }
            }
            if (role) {
                // æŠ€èƒ½ç­‰çº§åŠ æˆï¼ˆé€šè¿‡multiplierä½“ç°ï¼‰
                // æ³¨æ„ï¼šinfo.multiplierå·²ç»æ ¹æ®æŠ€èƒ½ç­‰çº§ç»™å‡ºäº†åŠ æˆï¼ˆ1.0, 1.2, 1.4, 1.6ï¼‰
                // ä¸å†é¢å¤–åŠ skillBonusï¼Œé¿å…é‡å¤è®¡ç®—
                const type = getJobSkillType(role);
                const skillVal = this.skills[type] || 0;
                const info = getLevelInfo(skillVal);
                return Math.floor(baseWage * info.multiplier * (1 + bonus) * mayorMult * buildLevelBonus); 
            }
            return Math.floor(baseWage * (1 + bonus) * mayorMult); 
        }
    }
    class Building {
        constructor(blueprint) { 
            this.id = blueprint.id; this.name = blueprint.name; this.category = blueprint.category || 'fun'; this.totalCost = blueprint.cost; this.currentProgress = 0; 
            this.isBuilt = blueprint.isBuilt || false; 
            this.effect = blueprint.effect; this.desc = blueprint.desc; this.price = blueprint.price || 0; this.food = blueprint.food || 0; this.open = blueprint.open; this.close = blueprint.close; this.jobs = blueprint.jobs || []; this.staff = []; this.closedDays = blueprint.closedDays || []; this.prostitutes = []; this.sells = blueprint.sells || []; 
            this.studyBonus = blueprint.studyBonus || 0;
            this.history = [];
            this.level = 1; 
            this.isUnderConstruction = false; 
            this.hasPermit = false;
            if (this.isBuilt) {
                this.currentProgress = this.totalCost;
                this.hasPermit = true;
            }
        }
        addLog(msg) {
            this.history.unshift(msg);
            if (this.history.length > 10) this.history.pop();
        }
        isOpen(hour, day) { if (!this.isBuilt) return false; if (this.closedDays.includes(day)) return false; if (this.jobs.length > 0 && this.staff.length === 0) return false; if (this.open === 0 && this.close === 24) return true; if (this.close < this.open) return hour >= this.open || hour < this.close; return hour >= this.open && hour < this.close; }
    }
    class Game {
        constructor() { 
            this.chars = []; this.buildings = []; this.townMoney = 0; this.gameTime = 480; this.gameDay = 1; this.autoSaveTimer = 0; this.lastSaveTime = Date.now(); 
            this.speed = 1500; this.speedLevel = 1; 
            this.dateMonth = 1;
            this.dateDay = 1;
            this.weather = 'Sunny';
            this.achievements = []; 
            this.policySocialSecurity = false; 
            this.policyHousing = false; 
            this.policyFood = false; 
            this.mayor = null;
            this.taxRate = 5; // ç¨ç‡ç™¾åˆ†æ¯”ï¼Œé»˜è®¤5%
            this.financeHistory = []; // èµ„é‡‘æµåŠ¨å†å²è®°å½•ï¼Œæœ€å¤šä¿å­˜15æ¡ 
            this.votingInProgress = false;
            this.voteTimer = null;
            // DeepSeek API é…ç½®
            this.deepseekApiKey = 'sk-b1bd6106f5824ace86bca34c1402717e';
            this.deepseekApiUrl = 'https://api.deepseek.com/v1/chat/completions';
            this.aiInteractionEnabled = true; // æ˜¯å¦å¯ç”¨AIäº’åŠ¨
            this.aiInteractionProbability = 0.5; // AIäº’åŠ¨æ¦‚ç‡
            this.loadOrInit(); 
            if(!this.weather) this.generateDailyWeather();
            this.loopId = setInterval(() => this.tick(), this.speed); 
            window.gameInstance = this;
        }
        getSeason() {
            const m = this.dateMonth;
            if (m >= 3 && m <= 5) return 'Spring';
            if (m >= 6 && m <= 8) return 'Summer';
            if (m >= 9 && m <= 11) return 'Autumn';
            return 'Winter';
        }
        getSeasonName() {
            const s = this.getSeason();
            const map = { 'Spring': 'æ˜¥', 'Summer': 'å¤', 'Autumn': 'ç§‹', 'Winter': 'å†¬' };
            return map[s];
        }
        getIdeologyNames() { return IDEOLOGIES.map(i => i.name); }
        getTraitNames() { return TRAITS.map(t => t.name); }
        generateDailyWeather() {
            const season = this.getSeason();
            const roll = Math.random();
            let type = 'Sunny';
            if (season === 'Spring') { if(roll < 0.5) type = 'Sunny'; else if(roll < 0.8) type = 'Cloudy'; else type = 'Rainy'; } else if (season === 'Summer') { if(roll < 0.4) type = 'Sunny'; else if(roll < 0.6) type = 'Rainy'; else if(roll < 0.8) type = 'Heatwave'; else type = 'Storm'; } else if (season === 'Autumn') { if(roll < 0.5) type = 'Sunny'; else if(roll < 0.7) type = 'Cloudy'; else if(roll < 0.9) type = 'Rainy'; else type = 'Foggy'; } else { if(roll < 0.4) type = 'Sunny'; else if(roll < 0.7) type = 'Cloudy'; else type = 'Snowy'; }
            this.weather = type;
            const wInfo = WEATHER_TYPES[type];
            this.log(`[ğŸŒ¦ï¸å¤©æ°”] ä»Šå¤©æ˜¯ **${wInfo.name}**ã€‚${wInfo.desc}`, "tag-event");
        }
        loadOrInit() { 
            const saveStr = localStorage.getItem('happyTownV2_Save'); 
            const isNewGame = !saveStr; // åˆ¤æ–­æ˜¯å¦æ˜¯æ–°æ¸¸æˆ
            if (saveStr) { 
                this.loadFromJSON(saveStr); 
                this.checkAndAddNewChars(); 
                this.log("ğŸ“‚ è¯»å–å­˜æ¡£æˆåŠŸï¼"); 
            } else { 
                this.initNewGame(); 
            } 
            // åªæœ‰æ–°æ¸¸æˆæ—¶æ‰è§¦å‘é€‰ä¸¾å’Œå»ºè®¾å…¬æŠ•
            if (isNewGame) {
                if (!this.mayor) {
                    // ä¼˜å…ˆè§¦å‘é•‡é•¿é€‰ä¸¾ï¼Œé€‰ä¸¾å®Œæˆåå†è§¦å‘å»ºè®¾å…¬æŠ•
                    setTimeout(() => this.triggerMayorElection(), 1500);
                } else {
                    // å¦‚æœæœ‰é•‡é•¿ï¼Œå»¶è¿Ÿè§¦å‘å»ºè®¾å…¬æŠ•
                    setTimeout(() => this.triggerConstructionVote(), 2000);
                }
            }
            this.renderUIStatic(); 
        }
        checkAndAddNewChars() { let added = false; NAMES.forEach(name => { if (!this.chars.find(c => c.name === name)) { this.chars.push(new Character(name)); this.log(`[ğŸ‰æ–°å±…æ°‘] ${name} å…¥ä½ï¼`); added = true; } }); if (added) { this.chars.forEach(c1 => { this.chars.forEach(c2 => { if (c1.name !== c2.name && !c1.relationships[c2.name]) { c1.relationships[c2.name] = { love: 0, status: 'stranger' }; } }); }); } }
        initNewGame() { 
            this.mayor = null; // é‡ç½®é•‡é•¿
            this.votingInProgress = false; // é‡ç½®æŠ•ç¥¨çŠ¶æ€
            if (this.voteTimer) {
                clearInterval(this.voteTimer);
                this.voteTimer = null;
            }
            // å…ˆåˆ›å»ºæ‰€æœ‰è§’è‰²
            this.chars = NAMES.map(n => { let c = new Character(n); NAMES.forEach(target => { if (target !== n) c.relationships[target] = { love: 0, status: 'stranger' }; }); return c; }); 
            this.buildings = BUILDINGS_BLUEPRINT.map(b => new Building(b)); 
            // ç¡®ä¿æ‰€æœ‰å»ºç­‘çš„å‘˜å·¥æ•°ç»„è¢«æ¸…ç©º
            this.buildings.forEach(b => {
                b.staff = [];
                b.prostitutes = [];
            });
            // ç¡®ä¿æ‰€æœ‰è§’è‰²çš„å·¥ä½œè¢«æ¸…ç©ºï¼Œå¹¶å¼ºåˆ¶é‡ç½®æŠ€èƒ½ä¸ºåˆå§‹å€¼ï¼ˆè§ä¹ ç­‰çº§ï¼‰
            this.chars.forEach(c => {
                c.job = null;
                // å¼ºåˆ¶é‡ç½®æ‰€æœ‰æŠ€èƒ½ä¸ºåˆå§‹å€¼ï¼ˆè§ä¹ ç­‰çº§ï¼‰ï¼Œç¡®ä¿å·¥ä½œç›¸å…³æŠ€èƒ½å€¼éƒ½åœ¨è§ä¹ èŒƒå›´å†…ï¼ˆ< 20ï¼‰
                // social å’Œ culture ç”¨äºå·¥ä½œæŠ€èƒ½ï¼Œåº”è¯¥ < 20
                // integrity å’Œ malice ä¸æ˜¯å·¥ä½œæŠ€èƒ½ï¼Œä¿æŒåŸèŒƒå›´
                c.skills = {
                    social: rand(10, 19),      // è§ä¹ èŒƒå›´ï¼š10-19
                    culture: rand(10, 19),     // è§ä¹ èŒƒå›´ï¼š10-19
                    integrity: rand(50, 80),   // éå·¥ä½œæŠ€èƒ½ï¼Œä¿æŒåŸèŒƒå›´
                    malice: rand(0, 10)        // éå·¥ä½œæŠ€èƒ½ï¼Œä¿æŒåŸèŒƒå›´
                };
            });
            const park = this.buildings.find(b => b.id === 'park'); if(park) { park.isBuilt = true; park.currentProgress = park.totalCost; park.hasPermit = true; }
            const clinic = this.buildings.find(b => b.id === 'clinic'); if(clinic) { clinic.isBuilt = true; clinic.currentProgress = clinic.totalCost; clinic.hasPermit = true; }
            const baozi = this.buildings.find(b => b.id === 'baozi'); if(baozi) { baozi.isBuilt = true; baozi.currentProgress = baozi.totalCost; baozi.hasPermit = true; }
            const huoshao = this.buildings.find(b => b.id === 'huoshao'); if(huoshao) { huoshao.isBuilt = true; huoshao.currentProgress = huoshao.totalCost; huoshao.hasPermit = true; }
            // ä¸åœ¨è¿™é‡Œè§¦å‘å»ºè®¾å…¬æŠ•ï¼Œç­‰é•‡é•¿é€‰ä¸¾å®Œæˆåå†è§¦å‘
        }
        tick() { 
            if(this.votingInProgress) return; 
            this.gameTime += 10; 
            if (this.gameTime % 60 === 0) {
                this.applyMayorEffects();
                this.checkAchievements();
                this.buildings.forEach(b => {
                    if (b.isBuilt && b.category === 'landmark') {
                        this.collectTax(b.price, `åœ°æ ‡å»ºç­‘æ”¶å…¥ - ${b.name}`); 
                        if (b.effect === 'tourist_high') { this.chars.forEach(c => c.happiness = Math.min(100, c.happiness + 0.5)); } else if (b.effect === 'tourist_health') { this.chars.forEach(c => c.health = Math.min(c.healthMax || 100, c.health + 0.5)); }
                    }
                });
                if (this.gameDay === 0 && this.gameTime === 720) {
                    this.triggerMayorElection();
                }
                const h = Math.floor(this.gameTime / 60);
                if ((h === 9 || h === 14) && !this.votingInProgress && !this.buildings.some(b => b.isUnderConstruction) && this.buildings.some(b => !b.isBuilt && !b.isUnderConstruction)) {
                     this.triggerConstructionVote();
                }
            }
            if (this.gameTime >= 1440) { 
                // æ¯æ—¥å·¥èµ„ç»“ç®—ï¼ˆåœ¨æ—¥æœŸå˜æ›´å‰ï¼‰
                this.settleDailyWages();
                this.gameTime = 0; 
                this.gameDay = (this.gameDay + 1) % 7; 
                this.dateDay++;
                // Update Month logic based on MONTH_DAYS
                const daysInMonth = MONTH_DAYS[this.dateMonth];
                if (this.dateDay > daysInMonth) { 
                    this.dateDay = 1; 
                    this.dateMonth++; 
                    if (this.dateMonth > 12) this.dateMonth = 1; 
                }
                this.runDailyPolicies();
                this.chars.forEach(c => { 
                    c.dailySleepOffset = rand(-2, 4); 
                    c.stayUpLate = Math.random() < 0.05;
                    c.workHoursToday = 0; // é‡ç½®æ¯æ—¥å·¥ä½œå°æ—¶æ•°
                });
                this.generateDailyWeather();
                // æ£€æŸ¥ä»Šæ—¥æ˜¯å¦æœ‰èŠ‚æ—¥
                const todayEvent = TOWN_EVENTS.find(ev => ev.date && ev.date.m === this.dateMonth && ev.date.d === this.dateDay);
                if (todayEvent) {
                    this.log(`[ğŸ—“ï¸èŠ‚æ—¥] éšç€æ—¥å‡ºï¼Œ**${todayEvent.name}** åˆ°äº†ï¼è¯·å‰å¾€æ´»åŠ¨ç­–åˆ’éƒ¨ä¸¾åŠåº†å…¸ï¼`, "tag-event");
                }
            } 
            if (this.townMoney >= 5000) this.unlockAchievement('rich_town');
            if (this.gameTime % 60 === 0) { 
                this.runElectionsAndHiring(); 
                const weatherInfo = WEATHER_TYPES[this.weather] || WEATHER_TYPES['Sunny'];
                this.chars.forEach(c => { 
                    if (c.jailTerm > 0) { c.jailTerm -= 60; if (c.jailTerm <= 0) { c.jailTerm = 0; this.log(`[ğŸ”“é‡Šæ”¾] **${c.name}** åˆ‘æ»¡é‡Šæ”¾ï¼Œé‡è·è‡ªç”±ï¼`, "tag-build"); } }
                    c.hunger = Math.max(0, c.hunger - 0.4); 
                    if (c.hunger === 0) c.happiness -= 2; 
                    if (c.health < 30) c.happiness -= 5;
                    let moodDecay = weatherInfo.mood;
                    if (c.hasTrait('optimistic') && moodDecay < 0) moodDecay *= 0.5; // ä¹è§‚ï¼šå¿ƒæƒ…ä¸‹é™å‡åŠ
                    let healthDecay = weatherInfo.health;
                    if (c.hasTrait('healthy') && healthDecay < 0) healthDecay *= 0.5; // å…»ç”Ÿï¼šå¥åº·ä¸‹é™å‡åŠ
                    c.happiness = Math.min(100, Math.max(0, c.happiness + moodDecay));
                    c.health = Math.min(c.healthMax || 100, Math.max(0, c.health + healthDecay));
                    c.stamina = Math.max(0, Math.min(c.staminaMax || 100, c.stamina - 0.15));
                    if (Math.random() < 0.001) { c.health = Math.max(0, c.health - rand(5, 15)); this.log(`[ğŸš‘ç”Ÿç—…] **${c.name}** çªç„¶æ„Ÿè§‰èº«ä½“ä¸é€‚ï¼Œå¥åº·åº¦ä¸‹é™äº†ã€‚`, "tag-reject"); }
                }); 
            } 
            this.decideAction(choose(this.chars)); 
            if (Date.now() - this.lastSaveTime > (parseInt(document.getElementById('autosave-rate').value)||30) * 1000) this.saveData(true); 
            this.updateUI(); 
        }
        triggerVoting(title, candidates, onComplete, instruction="è¯·æŠ•ç¥¨") {
             // å¦‚æœå·²ç»æœ‰æŠ•ç¥¨åœ¨è¿›è¡Œï¼Œå…ˆæ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
             if (this.voteTimer) {
                 clearInterval(this.voteTimer);
                 this.voteTimer = null;
             }
             this.votingInProgress = true;
             const modal = document.getElementById('voting-modal');
             if(modal) {
                 const titleEl = document.getElementById('voting-title'); if(titleEl) titleEl.innerText = title;
                 const msgEl = document.getElementById('voting-mayor-msg'); if(msgEl) msgEl.innerText = "";
                 const instEl = document.getElementById('voting-instruction'); if(instEl) instEl.innerText = instruction;
                 const list = document.getElementById('voting-candidates-list');
                 const log = document.getElementById('voting-realtime-log');
                 if(list) list.innerHTML = '';
                 if(log) log.innerHTML = '';
                 candidates.forEach(c => {
                    c.votes = 0;
                    const div = document.createElement('div');
                    div.className = 'voting-candidate';
                    div.id = `vote-c-${c.id}`;
                    div.innerHTML = `
                        <div style="display:flex; justify-content:space-between; font-weight:bold;">
                            <span>${c.name} ${c.extra ? `<small style="font-weight:normal">(${c.extra})</small>` : ''}</span>
                            <span id="vote-count-${c.id}">0 ç¥¨</span>
                        </div>
                        <div style="font-size:0.8rem; color:#666;">${c.desc}</div>
                        <div class="vote-bar-container"><div class="vote-bar-fill" id="vote-bar-${c.id}"></div></div>
                    `;
                    if(list) list.appendChild(div);
                });
                 modal.classList.add('active');
                 let voterIndex = 0;
                 const voters = [...this.chars];
                 let completed = false; // é˜²æ­¢é‡å¤è°ƒç”¨ onComplete
                 this.voteTimer = setInterval(() => {
                    if (voterIndex >= voters.length) {
                        clearInterval(this.voteTimer);
                        this.voteTimer = null;
                        this.votingInProgress = false;
                        if (completed) return; // é˜²æ­¢é‡å¤æ‰§è¡Œ
                        completed = true;
                        candidates.sort((a, b) => b.votes - a.votes);
                        const winner = candidates[0];
                        const winnerEl = document.getElementById(`vote-c-${winner.id}`);
                        if(winnerEl) winnerEl.classList.add('winner');
                        setTimeout(() => {
                            modal.classList.remove('active');
                            if (onComplete) onComplete(winner);
                        }, 3000);
                        return;
                    }
                    const voter = voters[voterIndex];
                    const choice = candidates[Math.floor(Math.random() * candidates.length)];
                    choice.votes++;
                    const countEl = document.getElementById(`vote-count-${choice.id}`);
                    if(countEl) countEl.innerText = `${choice.votes} ç¥¨`;
                    const totalVotes = voterIndex + 1;
                    candidates.forEach(c => {
                        const pct = (c.votes / totalVotes) * 100;
                        const bar = document.getElementById(`vote-bar-${c.id}`);
                        if(bar) bar.style.width = `${pct}%`;
                    });
                    if(log) {
                        const logEntry = document.createElement('div');
                        logEntry.innerText = `ğŸ—³ï¸ ${voter.name} æŠ•ç¥¨ç»™ ${choice.name}`;
                        log.prepend(logEntry);
                    }
                    voterIndex++;
                }, 100);
            }
        }
        triggerConstructionVote() {
            // é˜²æ­¢é‡å¤è§¦å‘
            if (this.votingInProgress) return;
            const unbuilt = this.buildings.filter(b => !b.isBuilt && !b.isUnderConstruction);
            if (unbuilt.length === 0) return;
            const candidates = [];
            const tempUnbuilt = [...unbuilt];
            const count = Math.min(3, tempUnbuilt.length);
            for(let i=0; i<count; i++) {
                const idx = Math.floor(Math.random() * tempUnbuilt.length);
                const b = tempUnbuilt[idx];
                candidates.push({ id: b.id, name: b.name, desc: `${b.desc} (ğŸ’°${b.totalCost})`, extra: CATEGORY_NAMES[b.category] });
                tempUnbuilt.splice(idx, 1);
            }
            this.triggerVoting("ğŸ—ï¸ å»ºè®¾å…¬æŠ•", candidates, (winner) => {
                const building = this.buildings.find(b => b.id === winner.id);
                if(building && !building.isUnderConstruction) {
                    building.isUnderConstruction = true;
                    building.hasPermit = true;
                    this.log(`[ğŸ—³ï¸å…¬æŠ•] æŠ•ç¥¨ç»“æŸï¼**${building.name}** èƒœå‡ºï¼Œæ­£å¼åŠ¨å·¥ï¼`, "tag-gov");
                    this.updateUI();
                }
            }, "è¯·å±…æ°‘æ ¹æ®è‡ªèº«éœ€æ±‚æŠ•å‡ºç¥åœ£çš„ä¸€ç¥¨ï¼");
        }
        triggerMayorElection() {
            // é˜²æ­¢é‡å¤è§¦å‘
            if (this.votingInProgress) return;
            if (this.chars.length < 3) return;
            const scoredChars = this.chars.map(c => {
                let popularity = 0;
                this.chars.forEach(other => { if (other.name !== c.name && other.relationships[c.name]) { popularity += other.relationships[c.name].love; } });
                const wealthScore = Math.floor(c.money / 10);
                const score = popularity + wealthScore + rand(0, 50);
                return { char: c, score: score };
            });
            scoredChars.sort((a, b) => b.score - a.score);
            const candidates = scoredChars.slice(0, 3).map(item => ({
                id: item.char.name, 
                name: item.char.name,
                desc: `ä¿¡ä»°: ${item.char.ideology.name} | èµ„é‡‘: ğŸ’°${Math.floor(item.char.money)}`,
                extra: "å€™é€‰äºº"
            }));
            this.triggerVoting("ğŸ© é•‡é•¿æ¢å±Šé€‰ä¸¾", candidates, (winner) => {
                 if (winner && winner.name) {
                     this.mayor = winner.name;
                     const m = this.chars.find(c => c.name === this.mayor);
                     this.log(`[ğŸ—³ï¸å¤§é€‰] é€‰ä¸¾ç»“æŸï¼**${winner.name}** å½“é€‰ä¸ºæ–°ä»»é•‡é•¿ï¼`, "tag-gov");
                     if(m) this.log(`[ğŸ“¢æ”¿ç­–] é•‡é•¿ ${winner.name} å°†æ¨è¡Œ [${m.ideology.name}] æ”¿ç­–ã€‚`, "tag-gov");
                     this.updateUI();
                     if (document.getElementById('gov-modal').classList.contains('active')) this.showGov();
                     // é•‡é•¿é€‰ä¸¾å®Œæˆåï¼Œå»¶è¿Ÿè§¦å‘å»ºè®¾å…¬æŠ•
                     setTimeout(() => this.triggerConstructionVote(), 2000);
                 }
            }, "è°èƒ½å¸¦é¢†å°é•‡èµ°å‘ç¹è£ï¼Ÿè¯·æŠ•ç¥¨ï¼");
        }
        checkAchievements() {
            this.chars.forEach(c => {
                if (c.money >= 100) this.unlockAchievement('first_pot');
                if (c.money >= 1000) this.unlockAchievement('financial_freedom');
                if (c.happiness >= 80 && c.hunger >= 80 && c.health >= 80) this.unlockAchievement('perfect_day');
            });
            const totalMoney = this.chars.reduce((acc, c) => acc + c.money, 0);
            const avgMoney = totalMoney / this.chars.length;
            if (avgMoney > 50) this.unlockAchievement('common_prosperity');
        }
        applyMayorEffects() {
            if (!this.mayor) return;
            const m = this.chars.find(c => c.name === this.mayor);
            if (!m) return;
            let effect = MAYOR_EFFECTS[m.ideology.name];
            if (effect && effect.happy !== 0) {
                this.chars.forEach(c => { c.happiness = Math.min(100, Math.max(0, c.happiness + effect.happy)); });
            }
        }
        runDailyPolicies() {
            if (this.policySocialSecurity) {
                let count = 0; let totalPayout = 0; const subsidy = 10; const threshold = 15;
                this.chars.forEach(c => { if (c.money < threshold) { if (this.townMoney >= subsidy) { this.townMoney -= subsidy; c.money += subsidy; this.addCharIncome(c, subsidy, 'ä½ä¿é‡‘'); count++; totalPayout += subsidy; c.addLog(`[ğŸ›ç¤¾ä¿] æ”¶åˆ°æ”¿åºœå‘æ”¾çš„ä½ä¿é‡‘ ğŸ’°${subsidy}`); } } });
                if (count > 0) { this.log(`[ğŸ“œç¤¾ä¿] ç¤¾ä¼šä½ä¿é‡‘ç”Ÿæ•ˆï¼Œä¸º ${count} ä½è´«å›°å±…æ°‘å‘æ”¾è¡¥åŠ© ğŸ’°${totalPayout}ã€‚`, "tag-promote"); }
            }
            if (this.policyHousing) {
                let housingCost = 5; let count = 0; let totalCost = 0;
                this.chars.forEach(c => { if (!c.job && !c.prostitute) { if (this.townMoney >= housingCost) { this.townMoney -= housingCost; totalCost += housingCost; c.happiness = Math.min(100, c.happiness + 5); count++; } } });
                if (count > 0) { this.log(`[ğŸ ä½æˆ¿] ä¿éšœæ€§ä½æˆ¿è®¡åˆ’ä¸º ${count} ä½æ— ä¸šå±…æ°‘æä¾›äº†ä½æ‰€(å¿ƒæƒ…+5)ï¼Œè€—èµ„ ğŸ’°${totalCost}ã€‚`, "tag-promote"); }
            }
            if (this.policyFood) {
                let foodCost = 4; let count = 0; let totalCost = 0;
                this.chars.forEach(c => { if (c.hunger < 20) { if (this.townMoney >= foodCost) { this.townMoney -= foodCost; totalCost += foodCost; c.hunger = Math.min(100, c.hunger + 20); c.bag.push('baozi_pork'); c.addLog(`[ğŸä½ä¿] é¢†å–äº†æ”¿åºœå‘æ”¾çš„æ•‘æµç²® (çŒªè‚‰åŒ…)`); count++; } } });
                if (count > 0) { this.log(`[ğŸé£Ÿå“] æœ€ä½é£Ÿå“ä¿éšœä¸º ${count} ä½é¥¥é¥¿å±…æ°‘å‘æ”¾äº†æ•‘æµç²®ï¼Œè€—èµ„ ğŸ’°${totalCost}ã€‚`, "tag-promote"); }
            }
        }
        getDateTimeStr() { const h = Math.floor(this.gameTime / 60); const m = this.gameTime % 60; return `[${this.dateMonth}æœˆ${this.dateDay}æ—¥ ${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}]`; }
        improveSkill(c, type, amount) {
            let finalAmount = amount;
            if (c.hasTrait('smart')) finalAmount *= 1.5; 
            const oldVal = c.skills[type] || 0;
            const oldLevelInfo = getLevelInfo(oldVal);
            c.skills[type] = Math.min(100, oldVal + finalAmount);
            const newVal = c.skills[type];
            const newLevelInfo = getLevelInfo(newVal);
            if (newLevelInfo.level > oldLevelInfo.level) { this.log(`[â­æ™‹å‡] æ­å–œ **${c.name}** çš„ ${type} æŠ€èƒ½çªç ´ï¼æ™‹å‡ä¸º **${newLevelInfo.title}** çº§åˆ«ï¼`, "tag-promote"); c.happiness = Math.min(100, c.happiness + 20); }
        }
        unlockAchievement(id) { 
            if (this.achievements.includes(id)) return; 
            const ach = ACHIEVEMENTS_DB.find(a => a.id === id); 
            if (!ach || !ach.reward) return; // ç¡®ä¿æˆå°±å­˜åœ¨ä¸”æœ‰å¥–åŠ±
            this.achievements.push(id); 
            // æˆå°±å¥–åŠ±å…¨é¢è·å–ï¼Œä¸æ”¶ç¨
            this.townMoney += ach.reward;
            this.addFinanceRecord(ach.reward, `æˆå°±å¥–åŠ± - ${ach.name}`);
            this.log(`[ğŸ†æˆå°±] æ­å–œè§£é”æˆå°±ï¼š**${ach.name}** (${ach.desc})ï¼å¥–åŠ±èµ„é‡‘ ğŸ’°${ach.reward}`, "tag-promote"); 
            showAchievementPopup(ach);
        }
        findItemInBag(p, type) { return p.bag.find(id => ITEMS_DB[id] && ITEMS_DB[id].type === type); }
        decideAction(p) {
            if (p.jailTerm > 0) { p.currentAction = `[ğŸ›‘åç‰¢] é“çª—æ³ª (å‰©ä½™ ${(p.jailTerm/60).toFixed(1)}h)`; p.hunger = Math.max(0, p.hunger - 0.5); p.happiness = Math.max(0, p.happiness - 0.5); p.consecutiveWork = 0; return; }
            if (p.nextActionOverride) { const cmd = p.nextActionOverride; p.nextActionOverride = null; this.log(`[ğŸ•¹ï¸å¼ºåˆ¶] ä¸Šå¸æ§åˆ¶ **${p.name}** å» ${cmd.desc}...`, "tag-build"); if (cmd.type === 'work' && p.job) { const b = this.buildings.find(x => x.id === p.job.buildingId); const hour = Math.floor(this.gameTime / 60); if(b && b.isOpen(hour, this.gameDay)) { this.doWork(p, b); return; } else if(b && !b.isOpen(hour, this.gameDay)) { this.log(`[âš ï¸] ${b.name}å½“å‰ä¸åœ¨è¥ä¸šæ—¶é—´ï¼Œæ— æ³•å·¥ä½œ`, "tag-reject"); return; } } else if (cmd.type === 'rest') { this.doRest(p, {name:"å®¶", price:0}); return; } else if (cmd.type === 'build') { const b = this.buildings.find(x => x.id === cmd.target); if (b) { this.doBuild(p, b); return; } } else if (cmd.type === 'visit') { const b = this.buildings.find(x => x.id === cmd.target); if (b) { if(b.effect==='food') this.doEat(p, b); else if(b.effect==='shop') this.doShopping(p, b); else this.doRest(p, b); return; } } else if (cmd.type === 'social') { const t = this.chars.find(x => x.name === cmd.target); if (t) { const park = this.buildings.find(b=>b.id==='park'); this.doSocialTarget(p, t, park || {name:"è·¯è¾¹", effect:"none"}); return; } } else if (cmd.type === 'crime_rob') { const t = this.chars.find(x => x.name === cmd.target); if (t) { this.doRobbery(p, t); return; } } else if (cmd.type === 'crime_assault') { const t = this.chars.find(x => x.name === cmd.target); if (t) { this.doSexualAssault(p, t); return; } } }
            this.breakInteraction(p); 
            const hour = Math.floor(this.gameTime / 60);
            // ç”Ÿç†éœ€æ±‚åˆ¤æ–­
            if (p.stamina < 20) {
                const huoshao = this.buildings.find(b => b.id === 'huoshao');
                if (huoshao && huoshao.isBuilt && huoshao.isOpen(hour, this.gameDay) && p.money >= 3.5) {
                    this.doEat(p, huoshao); return;
                }
                // æ²¡é’±åƒç«çƒ§æˆ–è€…æ²¡å¼€é—¨ï¼Œç¡è§‰/ä¼‘æ¯
                this.doRest(p, {name:"è·¯è¾¹", price:0});
                p.currentAction = "ä½“åŠ›è€—å°½ï¼Œè¢«è¿«ä¼‘æ¯";
                return;
            }
            if (p.health < 40) { const medId = this.findItemInBag(p, 'medicine'); if (medId) { this.doUseItem(p, medId); return; } const clinic = this.buildings.find(b => b.id === 'clinic'); if (clinic && clinic.isBuilt && clinic.isOpen(hour, this.gameDay) && p.money >= 10) { this.doShopping(p, clinic, 'medicine'); return; } const hospitals = this.buildings.filter(b => b.isBuilt && b.effect === 'health' && b.isOpen(hour, this.gameDay) && p.money >= b.price); if (hospitals.length > 0) { this.doRest(p, choose(hospitals)); return; } this.doRest(p, {name:"å®¶", price:0}); return; }
            if (p.hunger < 30) { const foodId = this.findItemInBag(p, 'food') || this.findItemInBag(p, 'snack'); if (foodId) { this.doUseItem(p, foodId); return; } const restaurants = this.buildings.filter(b => b.isBuilt && b.effect === 'food' && b.isOpen(hour, this.gameDay) && p.money >= b.price); if (restaurants.length > 0) { this.doEat(p, choose(restaurants)); return; } const shops = this.buildings.filter(b => b.isBuilt && b.effect === 'shop' && b.sells.some(id => ITEMS_DB[id].type === 'food') && b.isOpen(hour, this.gameDay)); if (shops.length > 0 && p.money >= 5) { this.doShopping(p, choose(shops), 'food'); return; } }
            const isMealTime = (hour >= 6 && hour < 9) || (hour >= 11 && hour < 14) || (hour >= 17 && hour < 20);
            const timeSinceLastMeal = this.gameTime - (p.lastMealTime || -999); 
            if (isMealTime && p.hunger < 80 && (timeSinceLastMeal > 180 || timeSinceLastMeal < 0)) { const foodId = this.findItemInBag(p, 'food'); if (foodId) { this.doUseItem(p, foodId); return; } const restaurants = this.buildings.filter(b => b.isBuilt && b.effect === 'food' && b.isOpen(hour, this.gameDay) && p.money >= b.price); if (restaurants.length > 0) { this.doEat(p, choose(restaurants)); return; } const shops = this.buildings.filter(b => b.isBuilt && b.effect === 'shop' && b.sells.some(id => ITEMS_DB[id].type === 'food') && b.isOpen(hour, this.gameDay)); if (shops.length > 0 && p.money >= 5) { this.doShopping(p, choose(shops), 'food'); return; } }
            const isPoor = p.money < 10; const isGreedy = p.hasTrait('greedy'); const isMilitant = p.ideology.name === 'å†›å›½ä¸»ä¹‰';
            const isHorny = p.hasTrait('estrous') || p.hasTrait('lustful'); const isUgly = p.appearance < 50; const isDepressed = p.happiness < 30;
            const policeStation = this.buildings.find(b => b.id === 'police'); const hasPolice = policeStation && policeStation.isBuilt && policeStation.staff.length > 0; const deterrent = hasPolice ? 0.02 : 0;
            const maliceFactor = (p.skills.malice || 0) * 0.001;
            const integrityDebt = Math.max(0, 50 - (p.skills.integrity || 0)) * 0.001;
            const integrityShield = Math.max(0, (p.skills.integrity || 0) - 60) * 0.001;
            let robChance = 0.005 + maliceFactor + integrityDebt; if (isPoor) robChance += 0.002; if (isGreedy) robChance += 0.003; if (isMilitant) robChance += 0.003; robChance = Math.max(0, robChance - deterrent - integrityShield); 
            let assaultChance = 0.005 + maliceFactor + integrityDebt; if (isHorny) assaultChance += 0.003; if (isUgly) assaultChance += 0.001; if (isDepressed) assaultChance += 0.001; assaultChance = Math.max(0, assaultChance - deterrent - integrityShield);
            const roll = Math.random();
            if (roll < robChance) { if (this.doRobbery(p)) return; } else if (roll < robChance + assaultChance) { if (this.doSexualAssault(p)) return; }
            const sleepSchedule = p.getSleepSchedule(); let isSleepTime = (sleepSchedule.start > sleepSchedule.end) ? (hour >= sleepSchedule.start || hour < sleepSchedule.end) : (hour >= sleepSchedule.start && hour < sleepSchedule.end);
            if (isSleepTime) { 
                p.currentAction = "ğŸ˜´ ç¡è§‰"; 
                let recovery = p.hasTrait('sleepy') ? 4 : 2; 
                let staminaRec = p.hasTrait('sleepy') ? 30 : 15; 
                p.happiness = Math.min(100, p.happiness + recovery); 
                p.stamina = Math.min(100, p.stamina + staminaRec); 
                p.consecutiveWork = 0; return; 
            }
            if (p.stamina < 25) { this.doRest(p, {name:"å®¶", price:0}); return; }
            // å‘˜å·¥å·¥ä½œé€»è¾‘ï¼šä¸¥æ ¼æ£€æŸ¥è¥ä¸šæ—¶é—´
            if (p.job) {
                const workplace = this.buildings.find(b => b.id === p.job.buildingId); 
                if (workplace && workplace.isBuilt) {
                    if (workplace.isOpen(hour, this.gameDay)) {
                        // åœ¨è¥ä¸šæ—¶é—´å†…ï¼Œå¦‚æœæ»¡è¶³å·¥ä½œæ¡ä»¶å°±å·¥ä½œ
                        if (p.hunger > 0 && p.stamina >= 30) {
                            this.doWork(p, workplace); 
                            return;
                        } else {
                            // ä¸æ»¡è¶³å·¥ä½œæ¡ä»¶ï¼Œä½†ä»åœ¨å·¥ä½œåœºæ‰€
                            p.currentAction = `[å¾…å²—] åœ¨ ${workplace.name} å¾…å‘½`;
                            return; // é‡è¦ï¼šå¿…é¡»returnï¼Œé¿å…åç»­é€»è¾‘è¦†ç›–å·¥ä½œçŠ¶æ€
                        }
                    } else {
                        // ä¸åœ¨è¥ä¸šæ—¶é—´ï¼Œå‘˜å·¥ç¦»å¼€å·¥ä½œå²—ä½
                        p.currentAction = `[ä¸‹ç­] ${workplace.name}å·²å…³é—¨`;
                        return; // é‡è¦ï¼šå¿…é¡»returnï¼Œé¿å…åç»­é€»è¾‘è¦†ç›–å·¥ä½œçŠ¶æ€
                    }
                }
            }
            if (p.prostitute && p.hunger > 0) { const footshop = this.buildings.find(b => b.id === p.prostitute.buildingId); if (footshop && footshop.isBuilt && footshop.isOpen(hour, this.gameDay)) { this.doProstitution(p, footshop); return; } }
            if (!p.job && p.money < 20 && p.hunger > 0) { if ((p.hasTrait('estrous') || p.hasTrait('lustful')) && Math.random() < 0.6) { this.doStreetwalking(p); } else { this.doOddJob(p); } return; }
            if (p.happiness < 40) { const funItemId = p.bag.find(id => ITEMS_DB[id] && (ITEMS_DB[id].type === 'alcohol' || ITEMS_DB[id].type === 'snack' || ITEMS_DB[id].type === 'drink' || ITEMS_DB[id].type === 'book')); if (funItemId) { this.doUseItem(p, funItemId); return; } const venues = this.buildings.filter(b => b.isBuilt && (b.category === 'fun' || b.effect === 'fun_high') && b.isOpen(hour, this.gameDay) && p.money >= b.price); if (venues.length > 0) { this.doRest(p, choose(venues)); return; } }
            if (p.bag.length < 2 && p.money > 80 && Math.random() < 0.3) { const shops = this.buildings.filter(b => b.isBuilt && b.effect === 'shop' && b.isOpen(hour, this.gameDay)); if (shops.length > 0) { let intention = 'food'; if (this.findItemInBag(p, 'food')) intention = 'medicine'; if (this.findItemInBag(p, 'medicine')) intention = 'gift'; this.doShopping(p, choose(shops), intention); return; } }
            const multiplier = p.hasTrait('frugal') ? 0.5 : (p.hasTrait('lavish') ? 2 : 1); 
            const venues = this.buildings.filter(b => b.isBuilt && b.isOpen(hour, this.gameDay) && (p.money >= b.price * multiplier)); const venue = choose(venues) || { name: "è·¯è¾¹", effect: "none", price: 0 }; 
            const pendingProject = choose(this.buildings.filter(b => !b.isBuilt && b.isUnderConstruction));
            if (roll < 0.3 && p.hunger > 0) { 
                if (pendingProject) { this.doBuild(p, pendingProject); } 
                else if (!p.job) { 
                    if ((p.hasTrait('estrous')||p.hasTrait('lustful')) && Math.random() < 0.6) this.doStreetwalking(p); 
                    else this.doOddJob(p); 
                } else { this.doSocial(p, venue); } 
            } else if (roll < 0.8) { this.doSocial(p, venue); } else { this.doRest(p, venue); }
        }
        doSexualAssault(p, target = null) {
            p.consecutiveWork = 0;
            p.stamina = Math.max(0, p.stamina - 10);
            let victim = target;
            if (!victim) { const targets = this.chars.filter(c => c.name !== p.name && c.appearance >= 70); victim = targets.length > 0 ? choose(targets) : choose(this.chars.filter(c => c.name !== p.name)); }
            if (!victim) return false;
            this.unlockAchievement('first_crime');
            const policeStation = this.buildings.find(b => b.id === 'police'); const hasPolice = policeStation && policeStation.isBuilt && policeStation.staff.length > 0; let securityLevel = hasPolice ? policeStation.staff.length * 0.3 : 0; let successChance = 0.6 - securityLevel; if (p.appearance > 80) successChance += 0.2;
            const timeStr = this.getDateTimeStr();
            // çŠ¯ç½ªå¢åŠ æ¶æ„å€¼ï¼Œå‡å°‘è¯šä¿¡
            p.skills.malice = Math.min(100, (p.skills.malice||0) + 5);
            p.skills.integrity = Math.max(0, (p.skills.integrity||0) - 10);
            if (Math.random() < successChance) {
                p.happiness = Math.min(100, p.happiness + 40); victim.happiness -= 50; victim.health = Math.max(0, victim.health - 15); 
                const pRel = p.relationships[victim.name]; const vRel = victim.relationships[p.name]; pRel.status = "enemy"; vRel.status = "enemy"; pRel.love = -80; vRel.love = -100;
                p.stat_assault = (p.stat_assault || 0) + 1; victim.stat_be_assaulted = (victim.stat_be_assaulted || 0) + 1;
                p.stamina = Math.max(0, p.stamina - 12);
                this.logInteraction(`[ğŸ’‹åŠ«è‰²] éœ‡æƒŠï¼**${p.name}** å¯¹é¢œå€¼é«˜è¾¾ ${victim.appearance} çš„ **${victim.name}** å®æ–½äº†çŒ¥äºµï¼`, "tag-crime"); p.currentAction = `[çŠ¯ç½ª] åŠ«è‰²äº† ${victim.name}`; 
                p.addLog(`${timeStr} åŠ«è‰²äº† ${victim.name}`); victim.addLog(`${timeStr} æƒ¨é­ ${p.name} åŠ«è‰² (å¿ƒæƒ…-50, å¥åº·-15)`); if(policeStation) policeStation.addLog(`${timeStr} æ¥åˆ°æŠ¥æ¡ˆï¼š${p.name} éªšæ‰°äº† ${victim.name}`);
                return true;
            } else {
                if (hasPolice) { const fine = 200; p.happiness -= 40; p.money -= fine; this.collectTax(fine, `ç½šæ¬¾ - ${p.name}åŠ«è‰²è¢«æ•`); p.jailTerm = 1440; this.logInteraction(`[ğŸ‘®é€®æ•] **${p.name}** è¯•å›¾å¯¹ **${victim.name}** å›¾è°‹ä¸è½¨ï¼Œè¢«è­¦å¯Ÿé€®æ•ï¼`, "tag-build"); const copName = choose(policeStation.staff); const cop = this.chars.find(c => c.name === copName); if (cop) { const copBonus = 30; this.collectTax(copBonus, `è­¦å¯Ÿå¥–é‡‘ - ${cop.name}`); cop.money += copBonus; this.addCharIncome(cop, copBonus, 'è­¦å¯Ÿå¥–é‡‘'); } p.currentAction = `[è¢«æ•] åŠ«è‰²æœªé‚ï¼Œé”’é“›å…¥ç‹±`; p.addLog(`${timeStr} åŠ«è‰² ${victim.name} å¤±è´¥ï¼Œè¢«æ•å…¥ç‹±`); } else { p.happiness -= 20; p.appearance -= 2; p.health = Math.max(0, p.health - 5); this.logInteraction(`[ğŸ‘Šåå‡»] **${p.name}** æƒ³åŠ«è‰² **${victim.name}**ï¼Œç»“æœè¢«å¯¹æ–¹ä¸€é¡¿æš´æï¼`, "tag-reject"); p.currentAction = `[å¤±è´¥] åŠ«è‰²æŒ¨æï¼Œé¼»é’è„¸è‚¿`; p.addLog(`${timeStr} éªšæ‰° ${victim.name} åè¢«æ‰“`); victim.addLog(`${timeStr} ç—›æ‰äº†è‰²ç‹¼ ${p.name}`); }
                p.stamina = Math.max(0, p.stamina - 8);
                return true;
            }
        }
        showActionSelect(name) {
            const c = this.chars.find(x => x.name === name); if (!c) return;
            const modal = document.getElementById('action-select-modal');
            const content = document.getElementById('action-select-content');
            let html = `<p>ä¸º <b>${c.name}</b> é€‰æ‹©ä¸‹ä¸€ä¸ªè¡ŒåŠ¨ (ç«‹å³ç”Ÿæ•ˆ):</p><div class="action-grid">`;
            html += `<button class="action-btn" onclick="gameInstance.setOverride('${name}', 'rest', '', 'å›å®¶ä¼‘æ¯')">ğŸ›Œ ä¼‘æ¯/èººå¹³</button>`;
            if (c.job) { html += `<button class="action-btn" style="border-color:#f1c40f" onclick="gameInstance.setOverride('${name}', 'work', '', 'å»ä¸Šç­')">ğŸ’¼ å»ä¸Šç­</button>`; }
            const pendings = this.buildings.filter(b => !b.isBuilt);
            pendings.forEach(b => { html += `<button class="action-btn" style="border-color:#e67e22" onclick="gameInstance.setOverride('${name}', 'build', '${b.id}', 'å»ºè®¾ ${b.name}')">ğŸ”¨ å»ºè®¾: ${b.name}</button>`; });
            const venues = this.buildings.filter(b => b.isBuilt);
            venues.forEach(b => { const icon = b.effect === 'food' ? 'ğŸ”' : (b.effect === 'shop' ? 'ğŸ›ï¸' : 'ğŸ¡'); html += `<button class="action-btn" onclick="gameInstance.setOverride('${name}', 'visit', '${b.id}', 'å» ${b.name}')">${icon} å»: ${b.name}</button>`; });
            html += `</div><p style="margin-top:10px;">å¼ºåˆ¶ç¤¾äº¤ (é€‰æ‹©å¯¹è±¡):</p><div class="action-grid">`;
            this.chars.forEach(t => { if (t.name !== c.name) { html += `<button class="action-btn" style="border-color:#ff7675" onclick="gameInstance.setOverride('${name}', 'social', '${t.name}', 'æ‰¾ ${t.name}')">â¤ æ‰¾: ${t.name}</button>`; } });
            html += `</div><p style="margin-top:10px;">å¼ºåˆ¶çŠ¯ç½ª (é€‰æ‹©å—å®³äºº):</p><div class="action-grid">`;
            this.chars.forEach(t => { if (t.name !== c.name) { html += `<button class="action-btn" style="border-color:#2d3436; color:#2d3436" onclick="gameInstance.setOverride('${name}', 'crime_rob', '${t.name}', 'æŠ¢åŠ« ${t.name}')">ğŸ”ª æŠ¢: ${t.name}</button>`; html += `<button class="action-btn" style="border-color:#c0392b; color:#c0392b" onclick="gameInstance.setOverride('${name}', 'crime_assault', '${t.name}', 'åŠ«è‰² ${t.name}')">ğŸ˜ˆ åŠ«: ${t.name}</button>`; } });
            html += `</div>`;
            content.innerHTML = html;
            document.getElementById('char-detail-modal').classList.remove('active');
            modal.classList.add('active');
        }
        setOverride(name, type, target, desc) { const c = this.chars.find(x => x.name === name); if (c) { c.nextActionOverride = { type, target, desc }; document.getElementById('action-select-modal').classList.remove('active'); alert(`å·²å®‰æ’ ${name} ä¸‹ä¸€æ­¥ï¼š${desc}`); } }
        closeActionSelect() { document.getElementById('action-select-modal').classList.remove('active'); }
        showGov() {
            document.getElementById('gov-modal').classList.add('active');
            document.getElementById('policy-social-security').checked = this.policySocialSecurity;
            document.getElementById('policy-housing').checked = this.policyHousing;
            document.getElementById('policy-food').checked = this.policyFood;
            if (this.mayor) {
                const m = this.chars.find(c => c.name === this.mayor);
                if (m) {
                    const nameEl = document.getElementById('mayor-name-display'); if(nameEl) nameEl.innerText = m.name;
                    const ideoEl = document.getElementById('mayor-ideology-display'); if(ideoEl) { ideoEl.innerText = m.ideology.name; ideoEl.style.backgroundColor = m.ideology.color; }
                    const i = m.ideology;
                    let effectDesc = i.desc;
                    let statsArr = [];
                    if (i.wageMod !== 0) statsArr.push(`${i.wageMod > 0 ? 'ğŸ“ˆ' : 'ğŸ“‰'}å·¥èµ„${(i.wageMod > 0 ? '+' : '')}${Math.round(i.wageMod * 100)}%`);
                    if (i.loveMod !== 0) statsArr.push(`${i.loveMod > 0 ? 'ğŸ¥°' : 'ğŸ˜’'}å¥½æ„Ÿ${(i.loveMod > 0 ? '+' : '')}${i.loveMod}/h`);
                    if (i.chaosMod !== 0) statsArr.push(`${i.chaosMod < 0 ? 'ğŸ•Šï¸' : 'ğŸ’¥'}å†²çª${(i.chaosMod > 0 ? '+' : '')}${Math.round(i.chaosMod * 100)}%`);
                    if(statsArr.length > 0) {
                         effectDesc += `<div style="margin-top:5px; padding-top:5px; border-top:1px dashed #ccc; font-weight:bold; font-size:0.85rem; color:#27ae60;">${statsArr.join(' | ')}</div>`;
                    }
                    const policyEl = document.getElementById('mayor-policy-display'); if(policyEl) policyEl.innerHTML = effectDesc;
                }
            }
        }
        closeGov() { document.getElementById('gov-modal').classList.remove('active'); }
        showFinance() {
            const modal = document.getElementById('finance-modal');
            document.getElementById('finance-town-money').innerText = Math.floor(this.townMoney);
            document.getElementById('tax-rate-display').innerText = this.taxRate + '%';
            const slider = document.getElementById('tax-rate-slider');
            const display = document.getElementById('tax-rate-value');
            const info = document.getElementById('tax-rate-info');
            if(slider) slider.value = this.taxRate;
            if(display) display.innerText = this.taxRate + '%';
            if(info) info.innerText = this.taxRate + '%';
            // æ¸²æŸ“èµ„é‡‘æµåŠ¨å†å²
            this.renderFinanceHistory();
            modal.classList.add('active');
        }
        renderFinanceHistory() {
            const listEl = document.getElementById('finance-history-list');
            if(!listEl) return;
            if(this.financeHistory.length === 0) {
                listEl.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">æš‚æ— èµ„é‡‘æµåŠ¨è®°å½•</div>';
                return;
            }
            let html = '';
            this.financeHistory.forEach((record, index) => {
                html += `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; border-bottom:1px solid #eee; ${index === this.financeHistory.length - 1 ? 'border-bottom:none;' : ''}">
                        <div style="flex:1;">
                            <div style="font-weight:bold; color:#2c3e50; font-size:0.9rem;">${record.source}</div>
                            <div style="font-size:0.75rem; color:#999; margin-top:2px;">${record.time}</div>
                        </div>
                        <div style="font-weight:bold; color:#27ae60; font-size:1rem; min-width:60px; text-align:right;">+ğŸ’°${record.amount}</div>
                    </div>
                `;
            });
            listEl.innerHTML = html;
        }
        closeFinance() { document.getElementById('finance-modal').classList.remove('active'); }
        updateTaxRate(value) {
            this.taxRate = parseInt(value);
            const display = document.getElementById('tax-rate-value');
            const info = document.getElementById('tax-rate-info');
            if(display) display.innerText = this.taxRate + '%';
            if(info) info.innerText = this.taxRate + '%';
            document.getElementById('tax-rate-display').innerText = this.taxRate + '%';
        }
        // ç¨ç‡è®¡ç®—å‡½æ•°ï¼šä»é‡‘é¢ä¸­æå–ç¨æ¬¾åˆ°é•‡åº“
        collectTax(amount, source = 'æœªçŸ¥æ¥æº') {
            if(amount <= 0 || this.taxRate <= 0) return 0;
            const tax = Math.floor(amount * this.taxRate / 100);
            if(tax > 0) {
                this.townMoney += tax;
                this.addFinanceRecord(tax, source);
            }
            return tax;
        }
        // æ·»åŠ èµ„é‡‘æµåŠ¨è®°å½•
        addFinanceRecord(amount, source) {
            const record = {
                amount: amount,
                source: source,
                time: this.getDateTimeStr(),
                timestamp: this.gameTime
            };
            this.financeHistory.unshift(record); // æ·»åŠ åˆ°å¼€å¤´
            if(this.financeHistory.length > 15) {
                this.financeHistory.pop(); // åªä¿ç•™æœ€è¿‘15æ¡
            }
            // å¦‚æœè´¢æ”¿ç•Œé¢æ˜¯æ‰“å¼€çš„ï¼Œå®æ—¶æ›´æ–°æ˜¾ç¤º
            const financeModal = document.getElementById('finance-modal');
            if(financeModal && financeModal.classList.contains('active')) {
                this.renderFinanceHistory();
                // åŒæ—¶æ›´æ–°é•‡åº“èµ„é‡‘æ˜¾ç¤º
                const moneyEl = document.getElementById('finance-town-money');
                if(moneyEl) moneyEl.innerText = Math.floor(this.townMoney);
            }
        }
        // è®°å½•å±…æ°‘æ”¶å…¥
        addCharIncome(c, amount, source) {
            if (!c.incomeHistory) c.incomeHistory = [];
            const record = {
                amount: amount,
                source: source,
                time: this.getDateTimeStr(),
                timestamp: this.gameTime
            };
            c.incomeHistory.unshift(record);
            if(c.incomeHistory.length > 10) {
                c.incomeHistory.pop(); // åªä¿ç•™æœ€è¿‘10æ¡
            }
        }
        // æ¯æ—¥å·¥èµ„ç»“ç®—ï¼ˆ24ç‚¹ç»“ç®—ï¼‰
        settleDailyWages() {
            this.chars.forEach(c => {
                if (c.job) {
                    const b = this.buildings.find(x => x.id === c.job.buildingId);
                    if (b && b.isBuilt) {
                        const role = c.job.role;
                        // è·å–åŸºç¡€æ¯æ—¥å·¥èµ„ï¼ˆå»ºç­‘å²—ä½æ ‡æ³¨çš„å·¥èµ„ï¼‰
                        const baseDailyWage = getBaseJobWage(role);
                        // è®¡ç®—å®é™…æ¯æ—¥å·¥èµ„ï¼ˆè€ƒè™‘æŠ€èƒ½ã€ç‰¹è´¨ã€é•‡é•¿ç­‰åŠ æˆï¼‰
                        const dailyWage = c.calculateWage(baseDailyWage, role);
                        if (dailyWage > 0) {
                            this.collectTax(dailyWage, `å·¥èµ„æ”¶å…¥ - ${c.name}(${b.name})`);
                            c.money += dailyWage;
                            this.addCharIncome(c, dailyWage, `å·¥èµ„ - ${b.name}`);
                            c.addLog(`[ğŸ’°å·¥èµ„] æ”¶åˆ°ä»Šæ—¥å·¥èµ„ ğŸ’°${dailyWage}`);
                        }
                    }
                }
            });
        }
        executeCommonProsperity() {
            if (!this.mayor) { alert("å½“å‰æ²¡æœ‰é•‡é•¿ï¼Œæ— æ³•æ‰§è¡Œå†³ç­–ã€‚"); return; }
            if (this.chars.length < 5) { alert("äººå£å¤ªå°‘ï¼Œæ— æ³•æ‰§è¡Œã€‚"); return; }
            const sorted = [...this.chars].sort((a, b) => b.money - a.money);
            const richList = sorted.slice(0, 3);
            const poorList = sorted.filter(c => c.money < 50);
            if (poorList.length === 0) { alert("å°é•‡å·²ç»å…¨é¢è„±è´«ï¼Œæ— éœ€æ‰§è¡Œæ­¤æ”¿ç­–ï¼"); return; }
            let totalPool = 0; let msg = "ğŸ© é•‡é•¿å‘èµ· [å…±åŒå¯Œè£•] è¿åŠ¨ï¼š\n";
            richList.forEach(c => { const tax = Math.floor(c.money * 0.2); if (tax > 0) { c.money -= tax; this.collectTax(tax, `å…±åŒå¯Œè£• - å‘${c.name}å¾ç¨`); totalPool += tax; c.happiness -= 10; c.addLog(`[ğŸ’¸è¢«åŠ«å¯Œ] è¢«å¼ºåˆ¶æ”¶ç¼´äº† ğŸ’°${tax} ç”¨äºå…±åŒå¯Œè£•`); msg += `- å‘å¯Œè±ª ${c.name} å¾æ”¶ ğŸ’°${tax}\n`; } });
            if (totalPool > 0) { const share = Math.floor(totalPool / poorList.length); poorList.forEach(c => { c.money += share; this.collectTax(share, `å…±åŒå¯Œè£• - ${c.name}åˆ†çº¢`); this.addCharIncome(c, share, 'å…±åŒå¯Œè£•åˆ†çº¢'); c.happiness += 10; c.addLog(`[ğŸ’°æµè´«] æ”¶åˆ°äº†å…±åŒå¯Œè£•åˆ†çº¢ ğŸ’°${share}`); }); msg += `\nğŸ’° å…±è®¡æ”¶ç¼´ ${totalPool}ï¼Œå¹³åˆ†ç»™ ${poorList.length} ä½å›°éš¾æˆ· (æ¯äººå¾— ${share})ã€‚`; this.log(`[âš–ï¸å†³ç­–] é•‡é•¿æ‰§è¡Œäº†"å…±åŒå¯Œè£•"å†³ç­–ï¼å‘å¯Œäººå¾ç¨è¡¥è´´ç©·äººã€‚`, "tag-gov"); alert(msg); this.updateUI(); } else { alert("å¯Œè±ªä»¬ä¹Ÿæ²¡é’±äº†ï¼Œæ¦¨ä¸å‡ºæ²¹æ°´ï¼"); }
        }
        togglePolicy(type) { if (type === 'social') this.policySocialSecurity = document.getElementById('policy-social-security').checked; if (type === 'housing') this.policyHousing = document.getElementById('policy-housing').checked; if (type === 'food') this.policyFood = document.getElementById('policy-food').checked; }
        showTownEvents() {
            const modal = document.getElementById('town-event-modal');
            document.getElementById('event-town-money').innerText = Math.floor(this.townMoney);
            const seasonName = this.getSeasonName();
            document.getElementById('event-season-name').innerText = `${seasonName} (${this.dateMonth}æœˆ${this.dateDay}æ—¥)`;
            this.switchEventTab('normal');
            modal.classList.add('active');
        }
        switchEventTab(tab) {
            const list = document.getElementById('town-event-list');
            list.innerHTML = '';
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`evt-tab-${tab}`).classList.add('active');
            const currentSeason = this.getSeason();
            let eventsToShow = [];
            if (tab === 'normal') {
                eventsToShow = TOWN_EVENTS.filter(ev => !ev.season && !ev.date);
            } else {
                eventsToShow = TOWN_EVENTS.filter(ev => {
                    if (ev.date) {
                        return ev.date.m === this.dateMonth && ev.date.d === this.dateDay;
                    }
                    return ev.season === currentSeason;
                });
            }
            if (eventsToShow.length === 0) { list.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:20px; color:#999;">å½“å‰æ—¶æ®µæš‚æ— ç‰¹æ®Šæ´»åŠ¨ã€‚</div>`; return; }
            eventsToShow.forEach(ev => { const div = document.createElement('div'); div.className = 'event-card'; const canAfford = this.townMoney >= ev.cost; div.innerHTML = `<div class="event-header"><span class="event-name">${ev.name}</span><span class="event-cost">-${ev.cost}</span></div><div class="event-desc">${ev.desc}</div><button class="event-btn" ${canAfford?'':'disabled'} onclick="gameInstance.triggerTownEvent('${ev.id}')">${canAfford?'ğŸ‰ ç«‹å³ä¸¾åŠ':'ğŸ’¸ èµ„é‡‘ä¸è¶³'}</button>`; list.appendChild(div); });
        }
        triggerTownEvent(id) {
            const ev = TOWN_EVENTS.find(x => x.id === id); if (!ev || this.townMoney < ev.cost) return;
            this.townMoney -= ev.cost; this.log(`[ğŸ‰æ´»åŠ¨] é•‡é•¿æ–¥èµ„ ğŸ’°${ev.cost} ä¸¾åŠäº† **${ev.name}**ï¼`, "tag-event");
            document.getElementById('town-event-modal').classList.remove('active');
            if (id === 'concert') { const fail = Math.random() < 0.1; if (fail) { this.logInteraction(`[ğŸ˜±æ„å¤–] éŸ³å“è®¾å¤‡çˆ†ç‚¸äº†ï¼æ¼”å”±ä¼šæ•ˆæœå¤§æ‰“æŠ˜æ‰£ï¼`, "tag-reject"); this.chars.forEach(c => { c.happiness += 5; }); } else { this.chars.forEach(c => { c.happiness = Math.min(100, c.happiness + 20); }); this.chars.forEach(c1 => { this.chars.forEach(c2 => { if (c1.name !== c2.name && c1.relationships[c2.name]) { c1.relationships[c2.name].love = Math.min(100, c1.relationships[c2.name].love + 5); } }); }); } }
            else if (id === 'matchmaking' || id === 'sakura' || id === 'valentines') { 
                let pairCount = 0; 
                this.chars.forEach(c => { 
                    if (!c.partner) { 
                        let bestT = null; let maxL = -100; 
                        for(let tName in c.relationships) { 
                            const t = this.chars.find(x=>x.name===tName); 
                            if (t && !t.partner && c.relationships[tName].love > maxL) { maxL = c.relationships[tName].love; bestT = t; } 
                        } 
                        const threshold = (id === 'sakura' || id === 'valentines') ? 25 : 40;
                        if (bestT && maxL > threshold && Math.random() < 0.5) { 
                            if (bestT.decideProposal(c.name, 'confess') || Math.random() < (id!=='matchmaking'?0.4:0.3)) { 
                                c.partner = bestT.name; bestT.partner = c.name; 
                                c.relationships[bestT.name].status = 'lover'; bestT.relationships[c.name].status = 'lover'; 
                                c.happiness += 20; bestT.happiness += 20; 
                                this.unlockAchievement('first_marriage'); 
                                const action = id === 'sakura' ? 'åœ¨æ¨±èŠ±æ ‘ä¸‹' : (id === 'valentines' ? 'åœ¨æƒ…äººèŠ‚' : 'åœ¨æ´»åŠ¨ä¸­');
                                this.logInteraction(`[â¤ï¸æµªæ¼«] ${action}ï¼Œ**${c.name}** å’Œ **${bestT.name}** äº’è¯‰è¡·è‚ ï¼Œç¡®ç«‹äº†å…³ç³»ï¼`, "tag-love"); 
                                pairCount++; 
                            } 
                        } 
                    } 
                }); 
                if (pairCount > 0) { this.chars.forEach(c => c.happiness += 5); } 
                else { this.logInteraction(`[ğŸ‚å¹³é™] è™½æœ‰ç¾æ™¯è‰¯è¾°ï¼Œä½†ä¼¼ä¹æ²¡äººé…å¯¹æˆåŠŸ...`, "tag-reject"); } 
                if (id === 'sakura') this.chars.forEach(c => c.happiness += 10); 
            }
            else if (id === 'charity' || id === 'charity_day') { 
                let totalRaised = 0; 
                const isSpecialDay = id === 'charity_day';
                this.chars.forEach(c => { 
                    if (c.money > 10) { 
                        const base = isSpecialDay ? 50 : 20;
                        const donation = Math.min(c.money, rand(5, base)); 
                        c.money -= donation; this.collectTax(donation, `æ…ˆå–„å‹Ÿæ - ${c.name}`); totalRaised += donation; 
                        c.happiness = isSpecialDay ? c.happiness + 5 : c.happiness - 5; 
                        this.chars.forEach(other => { if(other.name!==c.name) { c.relationships[other.name].love += 2; } }); 
                        if (isSpecialDay) c.addLog(`[ğŸ’æ…ˆå–„æ—¥] ææ¬¾ ğŸ’°${donation} å¸®åŠ©ä»–äºº`);
                    } 
                }); 
                // æ…ˆå–„å‹Ÿæå·²ç»åœ¨ææ¬¾æ—¶æ”¶ç¨ï¼Œè¿™é‡Œä¸éœ€è¦å†æ”¶ 
                this.logInteraction(`[ğŸ—ï¸å‹Ÿæ] å±…æ°‘ä»¬å…±ææ¬¾ ğŸ’°${totalRaised}ï¼Œ${isSpecialDay?'çˆ±å¿ƒå……æ»¡äº†å°é•‡ï¼':'è™½ç„¶å¿ƒç–¼é’±ä½†å…³ç³»æ›´ç´§å¯†äº†ã€‚'}`, "tag-build"); 
            }
            else if (id === 'anniversary') { this.chars.forEach(c => { c.happiness = Math.min(100, c.happiness + 10); for(let k in c.relationships) c.relationships[k].love += 2; }); }
            else if (id === 'fireworks') { if (Math.random() < 0.05) { const built = this.buildings.filter(b => b.isBuilt); if (built.length > 0) { const burn = choose(built); burn.isBuilt = false; burn.currentProgress = 0; burn.staff.forEach(sName => { const s = this.chars.find(x=>x.name===sName); if(s) { s.job = null; s.happiness -= 30; } }); burn.staff = []; this.log(`[ğŸ”¥ç«ç¾] å¤©å‘ï¼çƒŸèŠ±å¼•ç‡ƒäº† **${burn.name}**ï¼å»ºç­‘è¢«çƒ§æ¯ï¼Œéœ€è¦é‡å»ºï¼`, "tag-crime"); this.chars.forEach(c => c.happiness -= 10); } } else { this.chars.forEach(c => { c.happiness = Math.min(100, c.happiness + 25); for(let k in c.relationships) c.relationships[k].love += 5; }); } }
            else if (id === 'jobfair') { let hiredCount = 0; this.buildings.forEach(b => { if (b.isBuilt && b.staff.length < b.jobs.length) { const needed = b.jobs.length - b.staff.length; for(let i=0; i<needed; i++) { const candidates = this.chars.filter(c => !c.job); if (candidates.length > 0 && Math.random() < 0.5) { const worker = choose(candidates); const role = b.jobs[b.staff.length]; worker.job = { buildingId: b.id, role: role }; b.staff.push(worker.name); worker.happiness += 10; this.logInteraction(`[ğŸ¤å…¥èŒ] **${worker.name}** åœ¨æ‹›è˜ä¼šä¸Šæ‰¾åˆ°äº† **${b.name}** çš„å·¥ä½œï¼`, "tag-build"); hiredCount++; } } } }); if(hiredCount === 0) this.log("æ‹›è˜ä¼šç»“æŸäº†ï¼Œä¼¼ä¹æ²¡æœ‰åˆé€‚çš„å²—ä½æˆ–æ±‚èŒè€…ã€‚", "tag-reject"); }
            else if (id === 'artfest') { this.chars.forEach(c => { c.happiness = Math.min(100, c.happiness + 15); for(let k in c.relationships) c.relationships[k].love += 3; }); if (Math.random() < 0.1) { const victim = choose(this.chars); victim.happiness -= 10; this.logInteraction(`[ğŸ¨å¤±çªƒ] ç³Ÿç³•ï¼**${victim.name}** çè—çš„è‰ºæœ¯å“åœ¨æ´»åŠ¨ä¸­è¢«å·äº†ï¼(å¿ƒæƒ…-10)`, "tag-crime"); } } 
            else if (id === 'marathon') { this.chars.forEach(c => { c.happiness = Math.min(100, c.happiness + 10); c.hunger = Math.max(0, c.hunger - 10); }); if (Math.random() < 0.05) { const injured = choose(this.chars); injured.happiness -= 20; injured.health = Math.max(0, injured.health - 20); this.logInteraction(`[ğŸš‘æ„å¤–] **${injured.name}** åœ¨é©¬æ‹‰æ¾ä¸­ä¸æ…æ‰­ä¼¤äº†è„šï¼(å¿ƒæƒ…-20, å¥åº·-20)`, "tag-reject"); } }
            else if (id === 'reading') { this.chars.forEach(c => { c.happiness = Math.min(100, c.happiness + 5); for(let k in c.relationships) c.relationships[k].love += 2; }); if (Math.random() < 0.2) { const winner = choose(this.chars); winner.happiness = Math.min(100, winner.happiness + 10); this.logInteraction(`[ğŸ§ ç«èµ›] **${winner.name}** èµ¢å¾—äº†è¯»ä¹¦çŸ¥è¯†ç«èµ›çš„å† å†›ï¼å¤§å®¶å‘ä»–è¡¨ç¤ºç¥è´ºã€‚`, "tag-build"); } }
            else if (id === 'planting') { let success = true; if (Math.random() < 0.1) { success = false; this.log(`[ğŸ‚æ¯è] å“å‘€ï¼Œç”±äºå¤©æ°”åŸå› ï¼Œä¸€åŠçš„æ ‘è‹—æ²¡èƒ½å­˜æ´»...æ•ˆæœå‡åŠã€‚`, "tag-reject"); } const happyBonus = success ? 5 : 2; const relBonus = success ? 3 : 1; this.chars.forEach(c => { c.happiness = Math.min(100, c.happiness + happyBonus); for(let k in c.relationships) c.relationships[k].love += relBonus; }); }
            else if (id === 'shopping') {
                const shops = this.buildings.filter(b => b.isBuilt && b.effect === 'shop' && b.sells.length > 0); if (shops.length === 0) { this.log("âš ï¸ é•‡ä¸Šæ²¡æœ‰è¥ä¸šçš„å•†åº—ï¼Œè´­ç‰©èŠ‚å–æ¶ˆäº†ã€‚", "tag-reject"); return; }
                let shopperCount = 0; let totalSpent = 0;
                this.chars.forEach(c => { if (c.money >= 10) { const shop = choose(shops); const affordables = shop.sells.filter(sid => ITEMS_DB[sid] && ITEMS_DB[sid].price <= c.money); if (affordables.length > 0) { const itemId = choose(affordables); const item = ITEMS_DB[itemId]; c.money -= item.price; 
                this.collectTax(item.price, `è´­ç‰©èŠ‚ - ${item.name}`); 
                c.bag.push(itemId); c.happiness = Math.min(100, c.happiness + 15); totalSpent += item.price; shopperCount++; c.addLog(`[ğŸ›ï¸è´­ç‰©èŠ‚] åœ¨ ${shop.name} æŠ¢è´­äº† ${item.name}`); } } });
                if (shopperCount > 0) { this.logInteraction(`[ğŸ›ï¸ç‹‚æ¬¢] è´­ç‰©èŠ‚åœ†æ»¡ç»“æŸï¼${shopperCount} ä½å±…æ°‘æŠ¢è´­äº†å•†å“ï¼Œé•‡åº“æ”¶å…¥ ğŸ’°${totalSpent}ã€‚`, "tag-item"); } else { this.logInteraction(`[ğŸŒ¬ï¸å†·æ¸…] è´­ç‰©èŠ‚å¤§å®¶å›Šä¸­ç¾æ¶©ï¼Œæ— äººæ¶ˆè´¹...`, "tag-lonely"); }
            }
            else if (id === 'matsuri') { this.chars.forEach(c => { c.happiness = Math.min(100, c.happiness + 25); }); let pairs = 0; this.chars.forEach(c => { if (!c.partner && Math.random() < 0.2) { const available = this.chars.filter(t => t.name !== c.name && !t.partner && c.relationships[t.name].love > 30); if (available.length > 0) { const t = choose(available); c.partner = t.name; t.partner = c.name; c.relationships[t.name].status = 'lover'; t.relationships[c.name].status = 'lover'; this.unlockAchievement('first_marriage'); this.logInteraction(`[ğŸ‡æµªæ¼«] çƒŸèŠ±ä¸‹ï¼Œ**${c.name}** å’Œ **${t.name}** ç¡®ç«‹äº†å…³ç³»ï¼`, "tag-love"); pairs++; } } }); }
            else if (id === 'snowfest' || id === 'christmas') { this.chars.forEach(c => { c.happiness = Math.min(100, c.happiness + 20); c.health = Math.min(100, c.health + 10); c.hunger = Math.min(100, c.hunger + 10); }); }
            else if (id === 'new_year') { this.chars.forEach(c => { c.happiness = Math.min(100, c.happiness + 20); c.money = Math.floor(c.money * 1.1); }); this.log("æ–°å¹´æ–°æ°”è±¡ï¼Œå¤§å®¶å¿ƒæƒ…å¤§å¥½ï¼Œå­˜æ¬¾ä¼¼ä¹ä¹Ÿå˜å¤šäº†ï¼Ÿ", "tag-promote"); }
            else if (id === 'fools_day') { this.chars.forEach(c => { c.happiness = Math.min(100, c.happiness + 10); }); if(Math.random()<0.5) { const v = choose(this.chars); v.happiness -= 15; this.logInteraction(`[ğŸ¤¡æ¶æ] **${v.name}** è¢«äººè´´äº†"æˆ‘æ˜¯ç¬¨è›‹"çš„çº¸æ¡ï¼Œæ°”å¾—ä¸è¡Œï¼`, "tag-reject"); } }
            else if (id === 'labor_day') { this.chars.forEach(c => { if(c.job) { const bonus = 50; this.collectTax(bonus, `åŠ³åŠ¨èŠ‚å¥–é‡‘ - ${c.name}`); c.money += bonus; this.addCharIncome(c, bonus, 'åŠ³åŠ¨èŠ‚å¥–é‡‘'); c.addLog(`è·å¾—åŠ³åŠ¨èŠ‚å¥–é‡‘ ğŸ’°50`); } else { c.happiness += 5; } }); this.log("åŠ³åŠ¨èŠ‚å¿«ä¹ï¼æ‰€æœ‰åœ¨èŒå‘˜å·¥è·å¾—äº†50å¥–é‡‘ã€‚", "tag-build"); }
            else if (id === 'children_day') { this.chars.forEach(c => { c.happiness = Math.min(100, c.happiness + 15); }); }
            else if (id === 'harvest') { this.chars.forEach(c => { c.hunger = Math.min(100, c.hunger + 30); }); this.log("ä¸°æ”¶èŠ‚å¤§é¤ï¼æ‰€æœ‰äººé¥±é£Ÿåº¦å¤§å¹…æå‡ï¼", "tag-eat"); }
            else if (id === 'halloween') { 
                this.chars.forEach(c => { 
                    c.happiness = Math.min(100, c.happiness + 15); 
                    if(c.bag.length < 5) { c.bag.push('chocolate'); c.addLog("ğŸƒ è·å¾—äº†ä¸‡åœ£èŠ‚ç³–æœ (å·§å…‹åŠ›)"); }
                }); 
                if(Math.random()<0.3) { this.townMoney = Math.max(0, this.townMoney - 100); this.log("ä¸ç»™ç³–å°±æ£è›‹ï¼ä¸€ç¾¤ç†Šå­©å­ä»é•‡åº“æ‹¿èµ°äº†ä¸€äº›ç³–æœé’±...", "tag-crime"); } 
            }
            else if (id === 'music_fest') { this.chars.forEach(c => { c.happiness = Math.min(100, c.happiness + 30); }); this.log("ğŸµ éŸ³ä¹èŠ‚å—¨ç¿»å…¨åœºï¼å¤§å®¶çš„å‹åŠ›éƒ½æ¶ˆå¤±äº†ã€‚", "tag-event"); }
            else if (id === 'cat_return') { 
                this.chars.forEach(c => {
                    const r = Math.random();
                    if(r < 0.33) { const found = 100; this.collectTax(found, `çŒ«ç¥èŠ‚ - ${c.name}æ¡åˆ°é’±`); c.money += found; this.addCharIncome(c, found, 'çŒ«ç¥èŠ‚æ¡åˆ°é’±'); c.addLog("ğŸ± çŒ«ç¥æ˜¾çµï¼Œæ¡åˆ°äº† ğŸ’°100"); }
                    else if(r < 0.66) { c.health = 100; c.happiness = 100; c.addLog("ğŸ± çŒ«ç¥æ˜¾çµï¼Œèº«ä½“æ¢å¤äº†æœ€ä½³çŠ¶æ€ï¼"); }
                    else { c.bag.push('rose'); c.addLog("ğŸ± çŒ«ç¥æ˜¾çµï¼ŒèƒŒåŒ…é‡Œå¤šäº†ä¸€æœµç«ç‘°ï¼"); }
                });
                this.log("ğŸ± çŒ«å’ªæŠ¥æ©æ—¥ï¼Œç¥å¥‡çš„äº‹æƒ…åœ¨å°é•‡å„åœ°å‘ç”Ÿï¼", "tag-promote");
            }
            else if (id === 'new_year_eve') {
                this.chars.forEach(c => { 
                    c.happiness = 100; 
                    for(let k in c.relationships) c.relationships[k].love += 10; 
                });
                this.log("ğŸ† 5..4..3..2..1.. æ–°å¹´å¿«ä¹ï¼æ‰€æœ‰äººæ¬¢èšä¸€å ‚ï¼Œå…³ç³»å¤§å¹…å¢è¿›ï¼", "tag-event");
            }
            this.updateUI();
        }
        closeTownEvents() { document.getElementById('town-event-modal').classList.remove('active'); }
        toggleSpeed() { 
            clearInterval(this.loopId); this.speedLevel = (this.speedLevel + 1) % 4; const btn = document.getElementById('speed-btn');
            if (this.speedLevel === 0) { btn.innerText = "â–¶ ç»§ç»­"; btn.style.backgroundColor = "#7f8c8d"; } 
            else { btn.style.backgroundColor = ""; if (this.speedLevel === 1) { this.speed = 1500; btn.innerText = "â¸ æ­£å¸¸"; } else if (this.speedLevel === 2) { this.speed = 750; btn.innerText = "â© 2x"; } else { this.speed = 500; btn.innerText = "â© 3x"; } this.loopId = setInterval(() => this.tick(), this.speed); }
        }
        toggleConstruction(buildId) { 
            const b = this.buildings.find(x => x.id === buildId); 
            if (!b || b.isBuilt) return; 
            b.isUnderConstruction = !b.isUnderConstruction; 
            this.updateUI(); 
        }
        accelerateBuild(buildId) { const b = this.buildings.find(x => x.id === buildId); if (!b || b.isBuilt) return; if (this.townMoney >= 50) { this.townMoney -= 50; b.currentProgress += 20; this.log(`[ğŸ’¸åŠ é€Ÿ] é•‡é•¿æ–¥èµ„åŠ é€Ÿ **${b.name}** å»ºè®¾ã€‚`, "tag-build"); if (b.currentProgress >= b.totalCost) { b.isBuilt = true; this.log(`[ğŸ”¨ç«£å·¥] **${b.name}** å»ºæˆäº†ï¼`, "tag-build"); this.unlockAchievement('first_build'); if(b.id==='gym') this.unlockAchievement('first_gym'); if(b.id==='museum') this.unlockAchievement('culture_hub'); this.distributeConstructionReward(b); setTimeout(() => this.triggerConstructionVote(), 5000); } this.updateUI(); } else { alert("é•‡åº“èµ„é‡‘ä¸è¶³ (éœ€è¦50)ï¼"); } }
        upgradeBuilding(bid) { const b = this.buildings.find(x => x.id === bid); if(!b || !b.isBuilt) return; if(b.level >= 3) { alert("å·²è¾¾åˆ°æœ€é«˜ç­‰çº§ï¼"); return; } const cost = Math.floor(b.totalCost * b.level); if(this.townMoney >= cost) { this.townMoney -= cost; b.level++; this.log(`[ğŸ—ï¸å‡çº§] **${b.name}** å‡çº§åˆ°äº† Lv.${b.level}ï¼å‘˜å·¥æ”¶å…¥å°†è·å¾—æå‡ï¼`, "tag-build"); this.showBuildingDetail(bid); this.updateUI(); } else { alert(`èµ„é‡‘ä¸è¶³ï¼Œå‡çº§éœ€è¦ ğŸ’°${cost}`); } }
        boostTraining(bid) { const b = this.buildings.find(x => x.id === bid); if(!b || !b.isBuilt) return; const cost = 200; if(this.townMoney >= cost) { this.townMoney -= cost; let trained = 0; b.staff.forEach(sName => { const s = this.chars.find(c => c.name === sName); if(s) { const role = s.job.role; const skillType = getJobSkillType(role); this.improveSkill(s, skillType, 5); trained++; } }); if(trained > 0) { this.log(`[ğŸ“šåŸ¹è®­] æ”¿åºœæ‹¨æ¬¾ ğŸ’°${cost} ä¸º **${b.name}** çš„å‘˜å·¥è¿›è¡Œäº†æŠ€èƒ½åŸ¹è®­ï¼`, "tag-study"); } else { this.log(`[ğŸ“šåŸ¹è®­] è™½ç„¶æ‹¨æ¬¾äº†ï¼Œä½†æ˜¯è¿™é‡Œå¹¶æ²¡æœ‰å‘˜å·¥...`, "tag-reject"); } this.showBuildingDetail(bid); this.updateUI(); } else { alert(`èµ„é‡‘ä¸è¶³ï¼ŒåŸ¹è®­éœ€è¦ ğŸ’°${cost}`); } }
        // ç¡®ä¿å‘˜å·¥æŠ€èƒ½ä¸ºåˆå§‹å€¼ï¼ˆè§ä¹ ç­‰çº§ï¼‰
        ensureEmployeeSkillsReset(char, role) {
            if (!char || !char.skills || !role) return;
            const skillType = getJobSkillType(role);
            const skillVal = char.skills[skillType] || 0;
            // å¦‚æœå·¥ä½œç›¸å…³æŠ€èƒ½å€¼ >= 20ï¼ˆä¸åœ¨è§ä¹ èŒƒå›´å†…ï¼‰ï¼Œåˆ™é‡ç½®ä¸ºè§ä¹ èŒƒå›´ï¼ˆ10-19ï¼‰
            if (skillVal >= 20) {
                char.skills[skillType] = rand(10, 19);
            }
        }
        runElectionsAndHiring() { this.buildings.forEach(b => { if (!b.isBuilt || b.jobs.length === 0) return; if (b.staff.length === 0) { const candidates = this.chars.filter(c => !c.job).sort(() => Math.random() - 0.5); if (candidates.length > 0) { const votes = {}; candidates.forEach(c => votes[c.name] = 0); this.chars.forEach(voter => { let bestC = null; let maxLove = -999; candidates.forEach(c => { let love = (c.name !== voter.name) ? (voter.relationships[c.name]?.love || 0) : 50; love += rand(-20, 20); if (love > maxLove) { maxLove = love; bestC = c; } }); if (bestC) votes[bestC.name]++; }); let winner = candidates[0]; let maxVotes = -1; for (let name in votes) { if (votes[name] > maxVotes) { maxVotes = votes[name]; winner = candidates.find(c => c.name === name); } } if (winner) { const roleName = b.jobs[0]; this.ensureEmployeeSkillsReset(winner, roleName); winner.job = { buildingId: b.id, role: roleName }; b.staff.push(winner.name); this.log(`[ğŸ—³ï¸é€‰ä¸¾] **${winner.name}** å½“é€‰ä¸º **${b.name}** çš„${roleName}ï¼`, "tag-build"); } } } else if (b.staff.length < b.jobs.length) { const managerName = b.staff[0]; const manager = this.chars.find(c => c.name === managerName); if (manager) { const roleName = b.jobs[b.staff.length]; const candidates = this.chars.filter(c => !c.job); let bestC = null; let maxLove = -999; candidates.forEach(c => { const rel = manager.relationships[c.name]; let love = rel ? rel.love : 0; if (love > maxLove) { maxLove = love; bestC = c; } }); if (bestC) { this.ensureEmployeeSkillsReset(bestC, roleName); bestC.job = { buildingId: b.id, role: roleName }; b.staff.push(bestC.name); this.log(`[ğŸ¤æ‹›è˜] ${b.name}ç»ç† **${manager.name}** å½•ç”¨äº† **${bestC.name}** æ‹…ä»» ${roleName}ã€‚`); } } } if (b.id === 'footshop' && b.isBuilt && b.staff.length > 0) { const bossName = b.staff[0]; const boss = this.chars.find(c => c.name === bossName); if (boss && b.prostitutes.length < 3) { const candidates = this.chars.filter(c => !c.job && !c.prostitute && (c.hasTrait('estrous') || c.hasTrait('lustful'))); if (candidates.length > 0 && Math.random() < 0.1) { const target = choose(candidates); target.prostitute = { buildingId: b.id }; b.prostitutes.push(target.name); this.logInteraction(`[ğŸ’‹æ‹‰çš®æ¡] **${boss.name}** è¯´æœäº† **${target.name}** åœ¨æ´—è„šåº—å–é“¶...`, "tag-drama"); } } } }); }
        doRobbery(p, target = null) { 
            p.consecutiveWork = 0;
            let victim = target; if (!victim) { const targets = this.chars.filter(c => c.name !== p.name && c.money > 20); if (targets.length === 0) return false; victim = choose(targets); }
            this.unlockAchievement('first_crime');
            const policeStation = this.buildings.find(b => b.id === 'police'); const hasPolice = policeStation && policeStation.isBuilt && policeStation.staff.length > 0; let securityLevel = hasPolice ? policeStation.staff.length * 0.3 : 0; let successChance = 0.5; if (p.ideology.name === 'å†›å›½ä¸»ä¹‰') successChance += 0.2; successChance -= securityLevel; 
            const timeStr = this.getDateTimeStr();
            // æŠ¢åŠ«å¢åŠ æ¶æ„å€¼ï¼Œå¤§å¹…å‡å°‘è¯šä¿¡
            p.skills.malice = Math.min(100, (p.skills.malice||0) + 10);
            p.skills.integrity = Math.max(0, (p.skills.integrity||0) - 20);
            if (Math.random() < successChance) { const stolen = Math.floor(victim.money * rand(0.3, 0.6)); victim.money -= stolen; this.collectTax(stolen, `æŠ¢åŠ«æ”¶å…¥ - ${p.name}æŠ¢åŠ«${victim.name}`); p.money += stolen; this.addCharIncome(p, stolen, `æŠ¢åŠ«${victim.name}`); victim.happiness -= 30; victim.health = Math.max(0, victim.health - 10); const pRel = p.relationships[victim.name]; const vRel = victim.relationships[p.name]; if (['lover', 'spouse', 'mistress'].includes(pRel.status)) { pRel.status = "ex"; vRel.status = "ex"; } else { pRel.status = "enemy"; vRel.status = "enemy"; } pRel.love = -50; vRel.love = -50; p.stat_rob = (p.stat_rob || 0) + 1; victim.stat_be_robbed = (victim.stat_be_robbed || 0) + 1; p.stamina = Math.max(0, p.stamina - 10); this.logInteraction(`[ğŸ”ªæŠ¢åŠ«] å¤©å‘ï¼**${p.name}** æŠ¢åŠ«äº† **${victim.name}**ï¼ŒæŠ¢èµ° ğŸ’°${stolen}ï¼ä¸¤äººåç›®æˆä»‡ï¼`, "tag-crime"); p.currentAction = `[çŠ¯ç½ª] æŠ¢åŠ«äº† ${victim.name}`; p.addLog(`${timeStr} æŠ¢åŠ«äº† ${victim.name} ğŸ’°${stolen}`); victim.addLog(`${timeStr} è¢« ${p.name} æŠ¢åŠ«äº† ğŸ’°${stolen} (å¥åº·-10)`); if(policeStation) policeStation.addLog(`${timeStr} æ¥åˆ°æŠ¥æ¡ˆï¼š${p.name} æŠ¢åŠ«äº† ${victim.name}`); return true; 
            } else { if (hasPolice) { const fine = 100; p.happiness -= 30; p.money -= fine; this.collectTax(fine, `ç½šæ¬¾ - ${p.name}æŠ¢åŠ«è¢«æ•`); p.jailTerm = 1440; this.logInteraction(`[ğŸ‘®é€®æ•] **${p.name}** æŠ¢åŠ« **${victim.name}** å¤±è´¥ï¼è¢«è­¦å¯Ÿé€®æ•ï¼ç½šæ¬¾ğŸ’°${fine}å¹¶åˆ¤å¤„ç›‘ç¦24å°æ—¶ï¼`, "tag-build"); const copName = choose(policeStation.staff); const cop = this.chars.find(c => c.name === copName); if (cop) { const copBonus = 20; this.collectTax(copBonus, `è­¦å¯Ÿå¥–é‡‘ - ${cop.name}`); cop.money += copBonus; this.addCharIncome(cop, copBonus, 'è­¦å¯Ÿå¥–é‡‘'); this.log(`[ğŸš“æ²»å®‰] è­¦å®˜ **${cop.name}** å› åˆ¶æ­¢çŠ¯ç½ªè·å¾—å¥–é‡‘ ğŸ’°20ã€‚`, "tag-build"); } p.currentAction = `[è¢«æ•] æŠ¢åŠ«å¤±è´¥ï¼Œé”’é“›å…¥ç‹±`; p.addLog(`${timeStr} æŠ¢åŠ« ${victim.name} å¤±è´¥ï¼Œè¢«æ•å…¥ç‹±`); if(policeStation) policeStation.addLog(`${timeStr} è­¦å¯Ÿé€®æ•äº†æŠ¢åŠ«çŠ¯ ${p.name}`); } else { p.happiness -= 10; this.logInteraction(`[ğŸ’¨å¤±è´¥] **${p.name}** è¯•å›¾æŠ¢åŠ« **${victim.name}**ï¼Œä½†è¢«å¯¹æ–¹ä¸€è„šè¸¹é£äº†ï¼`, "tag-reject"); p.currentAction = `[å¤±è´¥] æŠ¢åŠ«æœªé‚ï¼Œè½è’è€Œé€ƒ`; p.addLog(`${timeStr} è¯•å›¾æŠ¢åŠ« ${victim.name} ä½†è¢«æ‰“é£`); } p.stamina = Math.max(0, p.stamina - 6); return true; } 
        }
        doWork(p, b) { 
            // æ£€æŸ¥æ˜¯å¦åœ¨è¥ä¸šæ—¶é—´å†…
            const hour = Math.floor(this.gameTime / 60);
            if (!b.isOpen(hour, this.gameDay)) {
                // ä¸åœ¨è¥ä¸šæ—¶é—´ï¼Œå‘˜å·¥åº”è¯¥ç¦»å¼€å·¥ä½œå²—ä½
                p.currentAction = `[ä¸‹ç­] ${b.name}å·²å…³é—¨`;
                return;
            }
            const role = p.job.role;
            // å·¥ä½œä¸å†è®°å½•å°æ—¶æ•°ï¼Œå·¥èµ„æŒ‰æ¯æ—¥å›ºå®šå·¥èµ„ç»“ç®—
            p.happiness -= 1; p.hunger -= 3; p.stamina = Math.max(0, p.stamina - 12);
            p.consecutiveWork = (p.consecutiveWork || 0) + 1;
            if (p.hasTrait('workaholic')) {
                p.health = Math.max(0, p.health - 2); // å·¥ä½œç‹‚å¥åº·ä¸‹é™æ›´å¿«
            }
            if (p.consecutiveWork >= 12) this.unlockAchievement('workaholic');
            const skillType = getJobSkillType(role); this.improveSkill(p, skillType, 0.2);
            const skillVal = p.skills[skillType] || 0; const title = getLevelInfo(skillVal).title;
            p.currentAction = `[æ‰“å·¥] åœ¨ ${b.name} è¿›è¡Œ ${role} å·¥ä½œ`; const timeStr = this.getDateTimeStr(); p.addLog(`${timeStr} åœ¨ ${b.name} å·¥ä½œ (${title})`); b.addLog(`${timeStr} å‘˜å·¥ ${p.name} åœ¨æ­¤å·¥ä½œ`);
        }
        doOddJob(p) { 
            if (p.stamina < 15) { this.doRest(p, {name:"å®¶", price:0}); return; }
            const job = choose(ODD_JOBS); 
            if (job.name === "èººå¹³" && p.money < 3) { const tempWage = 4; this.collectTax(tempWage, `é›¶å·¥æ”¶å…¥ - ${p.name}(è¢«è¿«æ¬ç –)`); p.money += tempWage; this.addCharIncome(p, tempWage, 'é›¶å·¥-è¢«è¿«æ¬ç –'); p.happiness -= 3; p.hunger -= 4; p.stamina = Math.min(100, p.stamina + 6); p.currentAction = `[é›¶å·¥] æ²¡é’±èººå¹³ï¼Œè¢«è¿«æ¬ç –`; p.addLog(`${this.getDateTimeStr()} è¢«è¿«å»å·¥åœ°æ¬ç –`); this.improveSkill(p, 'integrity', 0.1); p.consecutiveWork = 0; return; } 
            let wage = job.wage > 0 ? p.calculateWage(job.wage) : job.wage; if(wage > 0) { this.collectTax(wage, `é›¶å·¥æ”¶å…¥ - ${p.name}(${job.name})`); p.money += wage; this.addCharIncome(p, wage, `é›¶å·¥-${job.name}`); } p.happiness += job.mood; p.happiness = Math.min(100, Math.max(0, p.happiness)); p.hunger -= (job.name === "èººå¹³" ? 1 : 4); 
            if (job.name === "èººå¹³") { 
                p.consecutiveWork = 0; p.currentAction = `[ç”Ÿæ´»] åœ¨å®¶ èººå¹³`; 
                p.stamina = Math.min(100, p.stamina + 12); 
            } else { 
                p.consecutiveWork = (p.consecutiveWork || 0) + 1; if (p.consecutiveWork >= 12) this.unlockAchievement('workaholic'); p.currentAction = `[é›¶å·¥] æ­£åœ¨ ${job.name}`; 
                p.stamina = Math.max(0, p.stamina - 8); 
            }
            p.addLog(`${this.getDateTimeStr()} æ­£åœ¨åšé›¶å·¥: ${job.name}`);
            if(job.name === 'å‘ä¼ å•' || job.name === 'å¤–å–å‘˜') this.improveSkill(p, 'social', 0.1); 
            if(job.name !== 'èººå¹³') this.improveSkill(p, 'integrity', 0.1);
        }
        doEat(p, r) { 
            p.consecutiveWork = 0; const timeStr = this.getDateTimeStr();
            if (p.money >= r.price) { 
                p.money -= r.price; 
                p.hunger = Math.min(100, p.hunger + r.food); 
                p.happiness = Math.min(100, p.happiness + 5); 
                const staminaGain = Math.max(8, Math.floor((r.food || 20) / 2));
                p.stamina = Math.min(100, p.stamina + staminaGain);
                this.collectTax(r.price, `é¤é¥®æ¶ˆè´¹ - ${p.name}åœ¨${r.name}`); 
                p.currentAction = `[åƒé¥­] åœ¨ ${r.name} åƒå¾—é¥±é¥±`; 
                p.lastMealTime = this.gameTime; 
                p.addLog(`${timeStr} åœ¨ ${r.name} åƒé¥­`); 
                r.addLog(`${timeStr} é¡¾å®¢ ${p.name} åœ¨æ­¤ç”¨é¤`); 
            } else { 
                p.currentAction = `[åƒé¥­] æ²¡é’±å» ${r.name}ï¼Œè·¯è¾¹å•ƒé¦’å¤´`; 
                p.hunger = Math.min(100, p.hunger + 10); 
                p.stamina = Math.min(100, p.stamina + 5);
                p.lastMealTime = this.gameTime; 
                p.addLog(`${timeStr} æ²¡é’±åƒé¥­ï¼Œè·¯è¾¹å•ƒé¦’å¤´`); 
            } 
        }
        doProstitution(p, s) { 
            p.consecutiveWork = 0; p.stamina = Math.max(0, p.stamina - 15);
            const w = p.calculateWage(rand(15, 25), "æŠ€å¸ˆ"); const ps = Math.floor(w * 0.7); const bs = w - ps; this.collectTax(ps, `å–æ·«æ”¶å…¥ - ${p.name}åœ¨${s.name}`); if(bs > 0) this.collectTax(bs, `å–æ·«æ”¶å…¥ - ${s.name}è€æ¿`); p.money += ps; this.addCharIncome(p, ps, `å–æ·«-${s.name}`); p.happiness -= 2; p.hunger -= 4; if (s.staff.length > 0) { const boss = this.chars.find(c => c.name === s.staff[0]); if (boss) { boss.money += bs; this.addCharIncome(boss, bs, `å–æ·«è€æ¿-${s.name}`); } } p.currentAction = `[ğŸ’‹å–é“¶] åœ¨ ${s.name} æ¥å®¢`; const timeStr = this.getDateTimeStr(); p.addLog(`${timeStr} åœ¨ ${s.name} æ¥å®¢`); s.addLog(`${timeStr} ${p.name} åœ¨æ­¤æä¾›æœåŠ¡`); this.improveSkill(p, 'social', 0.2); this.improveSkill(p, 'malice', 0.2);
        }
        doStreetwalking(p) { p.consecutiveWork = 0; p.stamina = Math.max(0, p.stamina - 12); const wage = p.calculateWage(rand(8, 15)); this.collectTax(wage, `ç«™è¡—æ”¶å…¥ - ${p.name}`); p.money += wage; this.addCharIncome(p, wage, 'ç«™è¡—æ”¶å…¥'); p.happiness -= 4; p.hunger -= 5; p.stat_streetwalk = (p.stat_streetwalk || 0) + 1; p.currentAction = `[ğŸ’‹ç«™è¡—] åœ¨è·¯è¾¹æ‹‰å®¢`; p.addLog(`${this.getDateTimeStr()} åœ¨è·¯è¾¹æ‹‰å®¢`); this.improveSkill(p, 'social', 0.05); this.improveSkill(p, 'malice', 0.15); }
        doBuild(p, b) { 
            p.consecutiveWork = 0; p.stamina = Math.max(0, p.stamina - 15);
            b.currentProgress += rand(5, 15); const buildWage = 5; this.collectTax(buildWage, `å»ºè®¾å·¥èµ„ - ${p.name}å»ºè®¾${b.name}`); p.money += buildWage; this.addCharIncome(p, buildWage, `å»ºè®¾-${b.name}`); p.happiness -= 2; p.hunger -= 5; p.currentAction = `å»ºè®¾: ${b.name}`; if (!p.constructionContribution[b.id]) p.constructionContribution[b.id] = 0; p.constructionContribution[b.id] += 10; const timeStr = this.getDateTimeStr(); p.addLog(`${timeStr} å‚ä¸å»ºè®¾ ${b.name}`); b.addLog(`${timeStr} ${p.name} å‚ä¸äº†å»ºè®¾`);
            if (b.currentProgress >= b.totalCost && !b.isBuilt) { b.isBuilt = true; this.log(`[ğŸ”¨ç«£å·¥] **${b.name}** å»ºæˆäº†ï¼`, "tag-build"); this.unlockAchievement('first_build'); if(b.id==='gym') this.unlockAchievement('first_gym'); if(b.id==='museum') this.unlockAchievement('culture_hub'); this.distributeConstructionReward(b); setTimeout(() => this.triggerConstructionVote(), 5000); } 
            this.improveSkill(p, 'culture', 0.05); // å»ºè®¾ä¹Ÿè®¸èƒ½å­¦åˆ°ç‚¹ä¸œè¥¿
        }
        doRest(p, v) { 
            p.consecutiveWork = 0; const timeStr = this.getDateTimeStr();
            let cost = v.price;
            if (p.hasTrait('frugal')) cost *= 0.8;
            if (p.hasTrait('lavish')) cost *= 1.5; 
            cost = Math.max(0, Math.round(cost * 100) / 100);
            let staminaGain = 15;
            if (v && v.price > 0) { 
                if (p.money >= cost) { 
                    p.money -= cost; this.collectTax(cost, `å¨±ä¹æ¶ˆè´¹ - ${p.name}åœ¨${v.name}`); 
                    let happyGain = 0;
                    const buildingId = v.id;
                    // æ ¹æ®å»ºç­‘IDæ·»åŠ ç‰¹æ®Šæ•ˆæœ
                    if (buildingId === 'school') {
                        // å­¦æ ¡ï¼šä¸Šè¯¾æå‡æ–‡åŒ–ã€ç¤¾äº¤
                        happyGain = 8;
                        staminaGain += 5;
                        p.currentAction = `[ğŸ“šä¸Šè¯¾] åœ¨ ${v.name} è®¤çœŸå­¦ä¹ `;
                        this.improveSkill(p, 'culture', 1.5);
                        this.improveSkill(p, 'social', 0.3);
                        p.hunger -= 2; // å­¦ä¹ æ¶ˆè€—ä½“åŠ›
                    }
                    else if (buildingId === 'gym') {
                        // å¥èº«æˆ¿ï¼šé”»ç‚¼æå‡ä½“åŠ›ä¸Šé™ã€å¥åº·ã€é¢œå€¼
                        p.health = Math.min(p.healthMax || 100, p.health + 8);
                        p.appearance = Math.min(100, p.appearance + 3);
                        happyGain = 12;
                        staminaGain += 15;
                        p.currentAction = `[ğŸ’ªé”»ç‚¼] åœ¨ ${v.name} æŒ¥æ´’æ±—æ°´`;
                        // é•¿æœŸé”»ç‚¼å¯èƒ½æå‡ä½“åŠ›ä¸Šé™
                        if (Math.random() < 0.1 && p.staminaMax < 120) {
                            p.staminaMax = Math.min(120, p.staminaMax + 1);
                            p.addLog(`${timeStr} é•¿æœŸé”»ç‚¼ï¼Œä½“åŠ›ä¸Šé™æå‡äº†ï¼`);
                        }
                        // é•¿æœŸé”»ç‚¼å¯èƒ½æå‡å¥åº·ä¸Šé™
                        if (Math.random() < 0.05 && p.healthMax < 120) {
                            p.healthMax = Math.min(120, p.healthMax + 1);
                            p.addLog(`${timeStr} èº«ä½“æ›´å¥åº·äº†ï¼Œå¥åº·ä¸Šé™æå‡äº†ï¼`);
                        }
                        p.hunger -= 3; // é”»ç‚¼æ¶ˆè€—ä½“åŠ›
                    }
                    else if (buildingId === 'library') {
                        // å›¾ä¹¦é¦†ï¼šé˜…è¯»æå‡æ–‡åŒ–
                        happyGain = 6;
                        staminaGain += 5;
                        p.currentAction = `[ğŸ“–é˜…è¯»] åœ¨ ${v.name} é™å¿ƒè¯»ä¹¦`;
                        this.improveSkill(p, 'culture', 1.2);
                        this.improveSkill(p, 'integrity', 0.2); // é˜…è¯»æå‡è¯šä¿¡
                    }
                    else if (buildingId === 'museum') {
                        // åšç‰©é¦†ï¼šå‚è§‚æå‡æ–‡åŒ–
                        happyGain = 8;
                        staminaGain += 5;
                        p.currentAction = `[ğŸ›å‚è§‚] åœ¨ ${v.name} å¢é•¿è§é—»`;
                        this.improveSkill(p, 'culture', 1.0);
                        this.improveSkill(p, 'social', 0.2);
                    }
                    else if (buildingId === 'hospital') {
                        // åŒ»é™¢ï¼šæ²»ç–—æ¢å¤å¥åº·ï¼Œå¯èƒ½æå‡å¥åº·ä¸Šé™
                        p.health = Math.min(p.healthMax || 100, p.health + 50);
                        happyGain = 5;
                        staminaGain += 5;
                        p.currentAction = `[ğŸ¥æ²»ç–—] åœ¨ ${v.name} çœ‹ç—…ç–—ä¼¤`;
                        // å®šæœŸä½“æ£€å¯èƒ½æå‡å¥åº·ä¸Šé™
                        if (Math.random() < 0.05 && p.healthMax < 120) {
                            p.healthMax = Math.min(120, p.healthMax + 1);
                            p.addLog(`${timeStr} ä½“æ£€å‘ç°èº«ä½“æ›´å¥åº·äº†ï¼`);
                        }
                    }
                    else if (buildingId === 'hotspring') {
                        // æ¸©æ³‰ï¼šç–—å…»æå‡å¥åº·ä¸Šé™ã€æ¢å¤å¥åº·
                        p.health = Math.min(p.healthMax || 100, p.health + 30);
                        happyGain = 15;
                        staminaGain += 20;
                        p.currentAction = `[â™¨ï¸ç–—å…»] åœ¨ ${v.name} æ³¡æ¸©æ³‰æ”¾æ¾`;
                        // æ¸©æ³‰ç–—å…»å¯èƒ½æå‡å¥åº·ä¸Šé™
                        if (Math.random() < 0.15 && p.healthMax < 120) {
                            p.healthMax = Math.min(120, p.healthMax + 1);
                            p.addLog(`${timeStr} æ¸©æ³‰ç–—å…»ï¼Œèº«ä½“æ›´å¥åº·äº†ï¼`);
                        }
                    }
                    else if (buildingId === 'church') {
                        // æ•™å ‚ï¼šç¥ˆç¥·æå‡è¯šä¿¡ï¼Œé™ä½æ¶æ„
                        happyGain = 10;
                        staminaGain += 5;
                        p.currentAction = `[â›ªç¥ˆç¥·] åœ¨ ${v.name} è™”è¯šç¥·å‘Š`;
                        this.improveSkill(p, 'integrity', 1.0);
                        p.skills.malice = Math.max(0, (p.skills.malice || 0) - 0.5);
                    }
                    else if (buildingId === 'netcafe') {
                        // ç½‘å§ï¼šæ¸¸æˆæå‡å¿ƒæƒ…ï¼Œä½†å¯èƒ½é™ä½æ–‡åŒ–
                        happyGain = 20;
                        staminaGain += 5;
                        p.currentAction = `[ğŸ®æ¸¸æˆ] åœ¨ ${v.name} é€šå®µå¼€é»‘`;
                        if (Math.random() < 0.3) {
                            p.skills.culture = Math.max(0, (p.skills.culture || 0) - 0.2);
                        }
                        p.hunger -= 2;
                    }
                    else if (buildingId === 'cinema') {
                        // ç”µå½±é™¢ï¼šè§‚å½±æå‡å¿ƒæƒ…å’Œç¤¾äº¤
                        happyGain = 18;
                        staminaGain += 5;
                        p.currentAction = `[ğŸ¬è§‚å½±] åœ¨ ${v.name} çœ‹ç”µå½±`;
                        this.improveSkill(p, 'social', 0.5);
                    }
                    else if (buildingId === 'bar') {
                        // é…’å§ï¼šå–é…’æå‡å¿ƒæƒ…ï¼Œä½†é™ä½å¥åº·
                        happyGain = 25;
                        staminaGain += 5;
                        p.currentAction = `[ğŸºä¹°é†‰] åœ¨ ${v.name} å–é…’`;
                        p.health = Math.max(0, p.health - 3);
                        p.skills.integrity = Math.max(0, (p.skills.integrity || 0) - 0.3);
                    }
                    else if (buildingId === 'amusement') {
                        // æ¸¸ä¹åœºï¼šæ¸¸ç©å¤§å¹…æå‡å¿ƒæƒ…
                        happyGain = 35;
                        staminaGain += 10;
                        p.currentAction = `[ğŸ¡æ¸¸ç©] åœ¨ ${v.name} å°½æƒ…å°–å«`;
                        this.improveSkill(p, 'social', 0.8);
                        p.hunger -= 2;
                    }
                    else if (buildingId === 'park') {
                        // å…¬å›­ï¼šå…è´¹ä¼‘é—²ï¼Œæå‡å¿ƒæƒ…å’Œç¤¾äº¤
                        happyGain = 8;
                        staminaGain += 10;
                        p.currentAction = `[ğŸŒ³æ•£æ­¥] åœ¨ ${v.name} æ‚ é—²æ¼«æ­¥`;
                        this.improveSkill(p, 'social', 0.3);
                        this.improveSkill(p, 'integrity', 0.1);
                    }
                    else if (buildingId === 'baozi') {
                        // åŒ…å­é“ºï¼šç”¨é¤
                        p.hunger = Math.min(100, p.hunger + 25);
                        p.lastMealTime = this.gameTime;
                        happyGain = 5;
                        staminaGain += 8;
                        p.currentAction = `[ğŸ¥Ÿç”¨é¤] åœ¨ ${v.name} åƒåŒ…å­`;
                        // éšæœºé€‰æ‹©ä¸€ç§åŒ…å­æ•ˆæœ
                        const baoziTypes = ['baozi_tofu', 'baozi_pork', 'baozi_beef'];
                        const baoziType = choose(baoziTypes);
                        const baoziItem = ITEMS_DB[baoziType];
                        if (baoziItem && baoziItem.staminaBonus) {
                            staminaGain += baoziItem.staminaBonus;
                        }
                    }
                    else if (buildingId === 'clinic') {
                        // ç¤¾åŒºè¯Šæ‰€ï¼šé—¨è¯Šæ²»ç–—
                        p.health = Math.min(p.healthMax || 100, p.health + 30);
                        happyGain = 5;
                        staminaGain += 5;
                        p.currentAction = `[ğŸ’Šé—¨è¯Š] åœ¨ ${v.name} çœ‹ç—…`;
                        // é—¨è¯Šå¯èƒ½æå‡å¥åº·ä¸Šé™
                        if (Math.random() < 0.03 && p.healthMax < 120) {
                            p.healthMax = Math.min(120, p.healthMax + 1);
                            p.addLog(`${timeStr} å®šæœŸä½“æ£€ï¼Œèº«ä½“æ›´å¥åº·äº†ï¼`);
                        }
                    }
                    else if (v.effect === 'food') { 
                        p.hunger = Math.min(100, p.hunger + v.food); 
                        p.lastMealTime = this.gameTime; 
                        staminaGain += 5; 
                        p.currentAction = `åœ¨ ${v.name} å¤§åƒä¸€é¡¿`; 
                    }
                    else if (v.effect === 'health' || v.effect === 'tourist_health') { 
                        p.health = Math.min(p.healthMax || 100, p.health + 40); 
                        happyGain = 5; 
                        staminaGain += 5; 
                        p.currentAction = `[æ²»ç–—] åœ¨ ${v.name} çœ‹ç—…ç–—ä¼¤`; 
                    } 
                    else if (v.effect === 'beauty') { 
                        p.health = Math.min(p.healthMax || 100, p.health + 5); 
                        p.appearance = Math.min(100, p.appearance + 2); 
                        happyGain = 10; 
                        staminaGain += 10; 
                        p.currentAction = `[å¥èº«] åœ¨ ${v.name} æ’¸é“å¡‘å½¢`; 
                        // å¥èº«æˆ¿æ•ˆæœå·²åœ¨ä¸Šé¢å¤„ç†ï¼Œè¿™é‡Œä½œä¸ºåå¤‡
                    }
                    else if (v.effect === 'fun_high' || v.effect === 'tourist_high') { 
                        happyGain = 30; 
                        staminaGain += 5; 
                        p.currentAction = `[æ¸¸ç©] åœ¨ ${v.name} å°½æƒ…å°–å«`; 
                    }
                    else if (v.effect === 'study') { 
                        happyGain = 5; 
                        staminaGain += 5; 
                        p.currentAction = `[å‚è§‚] åœ¨ ${v.name} å¢é•¿è§é—»`; 
                        this.improveSkill(p, 'culture', 0.5); 
                    }
                    else if (v.effect === 'tourist') { 
                        happyGain = 10; 
                        p.currentAction = `[æ‰“å¡] åœ¨ ${v.name} æ‹ç…§ç•™å¿µ`; 
                    }
                    else { 
                        p.currentAction = `åœ¨ ${v.name} æ”¾æ¾`; 
                        happyGain = 5; 
                    }
                    if (v.studyBonus) this.improveSkill(p, 'culture', v.studyBonus);
                    if (p.hasTrait('frugal')) happyGain *= 0.7; 
                    if (p.hasTrait('lavish')) happyGain *= 1.5; 
                    p.happiness = Math.min(100, p.happiness + happyGain);
                    p.stamina = Math.min(p.staminaMax || 100, p.stamina + staminaGain);
                    p.health = Math.min(p.healthMax || 100, p.health);
                    p.addLog(`${timeStr} åœ¨ ${v.name} æ¶ˆè´¹ä¼‘æ¯`); 
                    v.addLog(`${timeStr} é¡¾å®¢ ${p.name} åœ¨æ­¤æ¶ˆè´¹`);
                } else { p.currentAction = `åœ¨ è·¯è¾¹ é—²é€›`; p.addLog(`${timeStr} åœ¨è·¯è¾¹é—²é€›`); return; } 
            } else {
                if (v) { 
                    const buildingId = v.id;
                    if (buildingId === 'school') {
                        // å­¦æ ¡ï¼šå…è´¹ä¸Šè¯¾
                        p.happiness = Math.min(100, p.happiness + 10); 
                        staminaGain += 5;
                        p.currentAction = `[ğŸ“šä¸Šè¯¾] åœ¨ ${v.name} è®¤çœŸå­¦ä¹ `; 
                        this.improveSkill(p, 'culture', 1.5);
                        this.improveSkill(p, 'social', 0.3);
                        p.hunger -= 2;
                    }
                    else if (buildingId === 'library') {
                        // å›¾ä¹¦é¦†ï¼šå…è´¹é˜…è¯»
                        p.happiness = Math.min(100, p.happiness + 8); 
                        staminaGain += 5;
                        p.currentAction = `[ğŸ“–é˜…è¯»] åœ¨ ${v.name} é™å¿ƒè¯»ä¹¦`; 
                        this.improveSkill(p, 'culture', 1.2);
                        this.improveSkill(p, 'integrity', 0.2);
                    }
                    else if (buildingId === 'park') {
                        // å…¬å›­ï¼šå…è´¹ä¼‘é—²
                        p.happiness = Math.min(100, p.happiness + 10); 
                        staminaGain += 10;
                        p.currentAction = `[ğŸŒ³æ•£æ­¥] åœ¨ ${v.name} æ‚ é—²æ¼«æ­¥`; 
                        this.improveSkill(p, 'social', 0.3);
                        this.improveSkill(p, 'integrity', 0.1);
                    }
                    else if (buildingId === 'baozi') {
                        // åŒ…å­é“ºï¼šç”¨é¤
                        p.hunger = Math.min(100, p.hunger + 25);
                        p.lastMealTime = this.gameTime;
                        p.happiness = Math.min(100, p.happiness + 5);
                        staminaGain += 8;
                        p.currentAction = `[ğŸ¥Ÿç”¨é¤] åœ¨ ${v.name} åƒåŒ…å­`;
                        // éšæœºé€‰æ‹©ä¸€ç§åŒ…å­æ•ˆæœ
                        const baoziTypes = ['baozi_tofu', 'baozi_pork', 'baozi_beef'];
                        const baoziType = choose(baoziTypes);
                        const baoziItem = ITEMS_DB[baoziType];
                        if (baoziItem && baoziItem.staminaBonus) {
                            staminaGain += baoziItem.staminaBonus;
                        }
                    }
                    else if (buildingId === 'clinic') {
                        // ç¤¾åŒºè¯Šæ‰€ï¼šé—¨è¯Šæ²»ç–—
                        p.health = Math.min(p.healthMax || 100, p.health + 30);
                        p.happiness = Math.min(100, p.happiness + 5);
                        staminaGain += 5;
                        p.currentAction = `[ğŸ’Šé—¨è¯Š] åœ¨ ${v.name} çœ‹ç—…`;
                        // é—¨è¯Šå¯èƒ½æå‡å¥åº·ä¸Šé™
                        if (Math.random() < 0.03 && p.healthMax < 120) {
                            p.healthMax = Math.min(120, p.healthMax + 1);
                            p.addLog(`${timeStr} å®šæœŸä½“æ£€ï¼Œèº«ä½“æ›´å¥åº·äº†ï¼`);
                        }
                    }
                    else if (v.effect === 'study') { 
                        p.happiness = Math.min(100, p.happiness + 8); 
                        staminaGain += 5;
                        p.currentAction = `[å­¦ä¹ ] åœ¨ ${v.name} æ±²å–çŸ¥è¯†`; 
                        this.improveSkill(p, 'culture', 0.5); 
                    } else { 
                        p.currentAction = `åœ¨ ${v.name} æ”¾æ¾`; 
                    } 
                    if (v.studyBonus) this.improveSkill(p, 'culture', v.studyBonus);
                    p.stamina = Math.min(p.staminaMax || 100, p.stamina + staminaGain);
                    p.addLog(`${timeStr} åœ¨ ${v.name} ä¼‘æ¯`); 
                    v.addLog(`${timeStr} ${p.name} æ¥è®¿`); 
                } else { p.currentAction = `åœ¨ è·¯è¾¹ é—²é€›`; p.addLog(`${timeStr} åœ¨è·¯è¾¹é—²é€›`); p.stamina = Math.min(p.staminaMax || 100, p.stamina + staminaGain); }
            }
            p.happiness = Math.min(100, p.happiness + rand(5, 10)); 
            p.hunger -= 1; 
        }
        doShopping(p, shop, intention = null) {
            p.consecutiveWork = 0; const timeStr = this.getDateTimeStr(); p.stamina = Math.max(0, p.stamina - 2);
            if (shop.sells.length > 0 && p.money >= 5) { 
                let affordableItems = shop.sells.filter(id => ITEMS_DB[id] && p.money >= ITEMS_DB[id].price);
                if (intention) { const intendedItems = affordableItems.filter(id => { const item = ITEMS_DB[id]; if (intention === 'food') return item.type === 'food' || item.type === 'snack'; if (intention === 'medicine') return item.type === 'medicine'; if (intention === 'gift') return item.type === 'gift'; return true; }); if (intendedItems.length > 0) affordableItems = intendedItems; }
                if (affordableItems.length > 0) { 
                    const itemId = choose(affordableItems); 
                    const itemInfo = ITEMS_DB[itemId]; 
                    let cost = itemInfo.price;
                    if (p.hasTrait('frugal')) cost = Math.floor(cost * 0.8); // èŠ‚ä¿­
                    if (p.hasTrait('lavish')) cost = Math.floor(cost * 1.5); // æŒ¥éœ
                    p.money -= cost; 
                    this.collectTax(cost, `è´­ç‰©æ¶ˆè´¹ - ${p.name}åœ¨${shop.name}è´­ä¹°${itemInfo.name}`); 
                    p.bag.push(itemId); 
                    let happyGain = 5;
                    if (p.hasTrait('frugal')) happyGain = 2; 
                    if (p.hasTrait('lavish')) happyGain = 15; 
                    p.happiness = Math.min(100, p.happiness + happyGain); 
                    p.currentAction = `[è´­ç‰©] åœ¨ ${shop.name} ä¹°äº† ${itemInfo.name}`; 
                    shop.addLog(`${timeStr} é¡¾å®¢ ${p.name} è´­ä¹°äº† ${itemInfo.name}`); 
                    // å¦‚æœä¹°äº†ä¹¦ï¼Œå¯èƒ½ä¼šç«‹åˆ»è¯»æ‰
                    if (itemInfo.type === 'book' && Math.random() < 0.5) {
                        this.doUseItem(p, itemId);
                    }
                    else if ((intention === 'food' || itemInfo.type === 'food') && p.hunger < 80) { this.doUseItem(p, itemId); } 
                    else { p.addLog(`${timeStr} åœ¨ ${shop.name} ä¹°äº† ${itemInfo.name}`); } 
                } else { this.doRest(p, shop); }
            } else { this.doRest(p, shop); }
        }
        doUseItem(p, itemId) {
            const item = ITEMS_DB[itemId]; if (!item) return; const idx = p.bag.indexOf(itemId); if (idx === -1) return; p.bag.splice(idx, 1);
            if (item.hungerBonus) { p.hunger = Math.min(100, p.hunger + item.hungerBonus); if(item.hungerBonus > 5) p.lastMealTime = this.gameTime; }
            if (item.happinessBonus) p.happiness = Math.min(100, p.happiness + item.happinessBonus); if (item.healthBonus) p.health = Math.min(p.healthMax || 100, p.health + item.healthBonus); 
            if (item.staminaBonus) p.stamina = Math.min(p.staminaMax || 100, p.stamina + item.staminaBonus);
            // ä¹¦ç±æ•ˆæœ
            if (item.cultureBonus) this.improveSkill(p, 'culture', item.cultureBonus);
            if (item.maliceBonus) p.skills.malice = Math.min(100, (p.skills.malice||0) + item.maliceBonus);
            if (item.integrityBonus) p.skills.integrity = Math.max(0, (p.skills.integrity||0) + item.integrityBonus);
            let actionVerb = "ä½¿ç”¨"; if (item.type === 'food' || item.type === 'snack') actionVerb = "åƒ"; if (item.type === 'drink' || item.type === 'alcohol') actionVerb = "å–"; if (item.type === 'medicine') actionVerb = "æœç”¨"; if (item.type === 'book') actionVerb = "é˜…è¯»";
            p.currentAction = `[${actionVerb}] ç”¨äº† ${item.name}`; p.addLog(`${this.getDateTimeStr()} ${actionVerb}äº† ${item.name}`);
        }
        tryGift(p, t, venue) {
            const giftIndex = p.bag.findIndex(id => ITEMS_DB[id] && ITEMS_DB[id].type === 'gift');
            if (giftIndex !== -1) {
                const giftId = p.bag[giftIndex]; const gift = ITEMS_DB[giftId]; p.bag.splice(giftIndex, 1); const pRel = p.relationships[t.name]; const tRel = t.relationships[p.name]; const bonus = gift.loveBonus || 10; pRel.love = Math.min(100, pRel.love + bonus); tRel.love = Math.min(100, tRel.love + bonus); p.currentAction = `[ğŸé€ç¤¼] é€äº† ${t.name} ${gift.name}`; t.currentAction = `[ğŸæ”¶ç¤¼] æ”¶åˆ°äº† ${p.name} çš„ç¤¼ç‰©`; this.logInteraction(`[ğŸé€ç¤¼] **${p.name}** åœ¨ ${venue.name} é€ç»™äº† **${t.name}** ä¸€ä¸ª ${gift.name}ï¼Œæ„Ÿæƒ…å‡æ¸©äº†ï¼`, "tag-item");
                const timeStr = this.getDateTimeStr(); p.addLog(`${timeStr} é€ç»™ ${t.name} ä¸€ä¸ª ${gift.name}`); t.addLog(`${timeStr} æ”¶åˆ°äº† ${p.name} çš„ ${gift.name}`); if(venue.addLog) venue.addLog(`${timeStr} ${p.name} åœ¨æ­¤é€ç¤¼ç»™ ${t.name}`);
                this.updateRelationshipStatus(p, t, pRel, tRel); this.checkRomanceEvent(p, t, pRel, tRel, venue); return true;
            }
            return false;
        }
        // DeepSeek AI äº’åŠ¨å‡½æ•° (æ›´æ–°ç‰ˆ - å¢åŠ è¯šä¿¡ä¸æ¶æ„å½±å“)
        async generateAIInteraction(p, t, venue) {
            if (!this.aiInteractionEnabled || !this.deepseekApiKey) return false;
            try {
                const score = p.relationships[t.name].love;
                let toneInstruction = "";
                // å…³ç³»å±‚çº§è¯­æ°”åˆ¤æ–­
                if (score >= 90) toneInstruction = "çµé­‚ä¼´ä¾£ï¼Œå¿ƒæœ‰çµçŠ€";
                else if (score >= 80) toneInstruction = "æ·±çˆ±å…¥éª¨ï¼Œæåº¦ä¾èµ–";
                else if (score >= 70) toneInstruction = "çƒ­æ‹ç”œèœœï¼Œå……æ»¡çˆ±æ„";
                else if (score >= 60) toneInstruction = "ç¨³å®šæ‹çˆ±ï¼Œæ¸©æŸ”ä½“è´´";
                else if (score >= 50) toneInstruction = "çŸ¥å¿ƒå¥½å‹ï¼Œæ— è¯ä¸è°ˆ";
                else if (score >= 30) toneInstruction = "å‹å¥½ï¼Œè½»æ¾è‡ªåœ¨";
                else if (score >= 0) toneInstruction = "ç¤¼è²Œï¼Œä¿æŒè·ç¦»";
                else if (score >= -30) toneInstruction = "å†·æ·¡ï¼Œçˆ±ç­”ä¸ç†";
                else if (score >= -60) toneInstruction = "åŒæ¶ï¼Œè¨€è¾å°–é”";
                else toneInstruction = "ä»‡æ¨ï¼Œå……æ»¡æ•Œæ„";
                // è¯šä¿¡ä¸æ¶æ„å½±å“
                if (p.skills.integrity < 30) toneInstruction += "ï¼Œè¯­æ°”è™šä¼ªï¼Œä¸å¯ä¿¡";
                if (p.skills.malice > 60) toneInstruction += "ï¼Œå¸¦æœ‰æ”»å‡»æ€§ï¼Œé˜´é˜³æ€ªæ°”";
                let traitTones = p.traits.map(t => t.tone).join("ï¼Œ");
                const trustNotes = [];
                if ((p.skills.integrity || 0) < 30) trustNotes.push("è¯­æ°”å¤¹æ‚çŠ¹è±«ã€ä¸å¤ªå¯ä¿¡");
                if ((p.skills.malice || 0) > 70) trustNotes.push("æ½œå°è¯å¸¦æœ‰æ¶æ„æˆ–å¨èƒ");
                if (trustNotes.length) traitTones = `${traitTones ? traitTones + "ï¼Œ" : ""}${trustNotes.join("ï¼Œ")}`;
                const prompt = `
                ä½ æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿå°é•‡çš„å±…æ°‘ï¼Œè¯·æ ¹æ®ä»¥ä¸‹ä¿¡æ¯ç”Ÿæˆä¸€æ®µç®€çŸ­çš„äº’åŠ¨å¯¹è¯ï¼ˆä¸è¶…è¿‡30å­—ï¼‰ï¼š
                è¯´è¯äººï¼š${p.name} (è¯šä¿¡:${Math.floor(p.skills.integrity)}, æ¶æ„:${Math.floor(p.skills.malice)})
                ç‰¹è´¨é£æ ¼ï¼š${traitTones}
                å½“å‰å¿ƒæƒ…ï¼š${Math.floor(p.happiness)} (0-100)
                å¯¹è¯å¯¹è±¡ï¼š${t.name}
                å…³ç³»åˆ†ï¼š${Math.floor(score)}
                è¯­æ°”è¦æ±‚ï¼š${toneInstruction}
                äº’åŠ¨åœ°ç‚¹ï¼š${venue.name}
                è¯·ç”Ÿæˆä¸€æ®µç¬¦åˆè§’è‰²ç‰¹è´¨ã€è¯šä¿¡åº¦ã€æ¶æ„å€¼å’Œå…³ç³»è¯­æ°”çš„å¯¹è¯ã€‚
                `;
                const response = await fetch(this.deepseekApiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.deepseekApiKey}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [{ role: "user", content: prompt }],
                        max_tokens: 60,
                        temperature: 0.8
                    })
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                const generatedText = data.choices[0].message.content.trim().replace(/^"|"$/g, '');
                this.logInteraction(`[ğŸ’¬${p.name}å¯¹${t.name}] ${generatedText}`, "tag-ai");
                const boost = rand(1, 3);
                p.relationships[t.name].love = Math.min(100, p.relationships[t.name].love + boost);
                t.relationships[p.name].love = Math.min(100, t.relationships[p.name].love + boost);
                return true;
            } catch (error) {
                console.error("è°ƒç”¨DeepSeek APIå¤±è´¥:", error);
                return false;
            }
        }
        doSocial(p, v) { 
            p.consecutiveWork = 0; const timeStr = this.getDateTimeStr();
            if (v.price > 0) { if (p.money < v.price) { this.doRest(p, {name:"è·¯è¾¹",price:0}); return; } p.money -= v.price; this.collectTax(v.price, `ç¤¾äº¤æ¶ˆè´¹ - ${p.name}åœ¨${v.name}`); } 
            const t = choose(this.chars.filter(c => c.name !== p.name)); const pRel = p.relationships[t.name]; const tRel = t.relationships[p.name]; this.breakInteraction(t); 
            if (this.tryGift(p, t, v)) return;
            p.currentAction = `å’Œ ${t.name} åœ¨ ${v.name}`; t.currentAction = `å’Œ ${p.name} åœ¨ ${v.name}`; p.interactingWith = t.name; t.interactingWith = p.name; p.hunger -= 2; t.hunger -= 2; p.stamina = Math.max(0, p.stamina - 4); t.stamina = Math.max(0, t.stamina - 3); this.improveSkill(p, 'social', 0.1);
            if (this.checkRomanceEvent(p, t, pRel, tRel, v)) return; 
            let chaos = 0.1;
            p.traits.forEach(t => { if(t.id === 'irritable') chaos += 0.2; });
            t.traits.forEach(t => { if(t.id === 'irritable') chaos += 0.2; });
            chaos += p.ideology.chaosMod + t.ideology.chaosMod; 
            chaos += Math.max(0, (50 - (p.skills.integrity || 0)) / 200);
            chaos += Math.max(0, (50 - (t.skills.integrity || 0)) / 200);
            chaos += Math.max(0, ((p.skills.malice || 0) - 50) / 250);
            chaos += Math.max(0, ((t.skills.malice || 0) - 50) / 250);
            if (this.mayor) {
                const m = this.chars.find(c => c.name === this.mayor);
                if (m && m.ideology) chaos += (m.ideology.chaosMod || 0);
            }
            if (v.effect === 'chaos') chaos += 0.2; if (v.effect === 'ntr') chaos += 0.4; 
            if (Math.random() < Math.max(0, Math.min(1, chaos))) { 
                pRel.love -= 5; tRel.love -= 5; this.improveSkill(p, 'social', 0.25); this.improveSkill(t, 'social', 0.25); this.improveSkill(p, 'culture', 0.1); this.improveSkill(t, 'culture', 0.1);
                this.logInteraction(`[ğŸ’¢äº‰åµ] ${p.name} å’Œ ${t.name} åœ¨ ${v.name} åµæ¶äº†ã€‚`, "tag-reject"); p.addLog(`${timeStr} å’Œ ${t.name} åµæ¶`); t.addLog(`${timeStr} å’Œ ${p.name} åµæ¶`);
            } else { 
                const scenario = choose(SOCIAL_SCENARIOS); const text = scenario.text.replace("{A}", p.name).replace("{B}", t.name); this.logInteraction(`[ğŸ’¬äº’åŠ¨] ${text}`, "tag-gossip"); if(scenario.effect) scenario.effect(p, t);
                let boost = rand(1, 3); if (v.effect === 'romance') boost += 2; 
                if (p.hasTrait('kind')) boost += 2;
                if (t.hasTrait('kind')) boost += 2;
                boost += ((p.skills.integrity || 0) + (t.skills.integrity || 0)) / 200;
                if ((p.skills.malice || 0) > 70) boost -= 1;
                if ((t.skills.malice || 0) > 70) boost -= 1;
                boost += p.ideology.loveMod + t.ideology.loveMod; boost = Math.max(0, Math.round(boost)); pRel.love = Math.min(100, pRel.love + boost); tRel.love = Math.min(100, tRel.love + boost); p.addLog(`${timeStr} å’Œ ${t.name} äº’åŠ¨ (${boost}å¥½æ„Ÿ)`); t.addLog(`${timeStr} å’Œ ${p.name} äº’åŠ¨ (${boost}å¥½æ„Ÿ)`); this.updateRelationshipStatus(p, t, pRel, tRel); 
                this.improveSkill(p, 'culture', 0.05);
                this.improveSkill(t, 'culture', 0.05);
            } 
            if(v.addLog) v.addLog(`${timeStr} ${p.name} ä¸ ${t.name} æ¥è®¿`);
            if (Math.random() < this.aiInteractionProbability) {
                this.generateAIInteraction(p, t, v);
            }
        }
        distributeConstructionReward(b) { let total = 0; this.chars.forEach(c => total += (c.constructionContribution[b.id] || 0)); if (total === 0) return; const reward = Math.floor(b.totalCost * 0.3); this.chars.forEach(c => { const share = c.constructionContribution[b.id] || 0; if (share > 0) { const m = Math.floor(reward * (share / total)); this.collectTax(m, `å»ºè®¾å¥–åŠ± - ${c.name}å»ºè®¾${b.name}`); c.money += m; this.addCharIncome(c, m, `å»ºè®¾å¥–åŠ±-${b.name}`); if(m>0) this.log(`[ğŸ’°å¥–åŠ±] **${c.name}** è·å»ºè®¾å¥–åŠ± ğŸ’°${m}`, "tag-build"); } }); }
        updateRelationshipStatus(p, t, pRel, tRel) { if (pRel.status === 'stranger' && pRel.love > 10) { pRel.status = 'friend'; tRel.status = 'friend'; } else if (pRel.status === 'friend' && pRel.love > 60 && !['lover','spouse','mistress','enemy','ex'].includes(pRel.status)) { pRel.status = 'bestfriend'; tRel.status = 'bestfriend'; } }
        checkRomanceEvent(p, t, pRel, tRel, v) { if (!p.partner && !t.partner && pRel.love > 70 && pRel.status !== 'spouse') { if (Math.random() < 0.2) { if (t.decideProposal(p.name, 'confess')) { p.partner = t.name; t.partner = p.name; pRel.status = "lover"; tRel.status = "lover"; p.happiness += 20; t.happiness += 20; this.unlockAchievement('first_marriage'); this.logInteraction(`[â¤ï¸è¡¨ç™½] ${p.name} å‘ ${t.name} è¡¨ç™½æˆåŠŸï¼`, "tag-love"); } else { p.happiness -= 20; pRel.love -= 10; this.logInteraction(`[ğŸ’”æ‹’ç»] ${p.name} è¡¨ç™½å¤±è´¥...`, "tag-reject"); } return true; } } return false; }
        breakInteraction(c) { if (c.interactingWith) { const partner = this.chars.find(x => x.name === c.interactingWith); if (partner) { partner.interactingWith = null; partner.currentAction = "å‘å‘†"; } c.interactingWith = null; } }
        saveData(isAuto = false) { const data = { chars: this.chars, buildings: this.buildings, townMoney: this.townMoney, gameTime: this.gameTime, gameDay: this.gameDay, dateMonth: this.dateMonth, dateDay: this.dateDay, weather: this.weather, achievements: this.achievements, policySocialSecurity: this.policySocialSecurity, policyHousing: this.policyHousing, policyFood: this.policyFood, mayor: this.mayor, taxRate: this.taxRate, financeHistory: this.financeHistory, ts: Date.now() }; localStorage.setItem('happyTownV2_Save', JSON.stringify(data)); this.lastSaveTime = Date.now(); if (!isAuto) alert("âœ… å­˜æ¡£æˆåŠŸï¼"); }
        loadFromJSON(jsonStr) { 
            try { 
                const data = JSON.parse(jsonStr); 
                this.townMoney = data.townMoney || 0; 
                this.gameTime = data.gameTime || 480; 
                this.gameDay = data.gameDay !== undefined ? data.gameDay : 1;
                this.dateMonth = data.dateMonth || 1;
                this.dateDay = data.dateDay || 1;
                this.weather = data.weather || 'Sunny';
                this.achievements = data.achievements || [];
                this.policySocialSecurity = data.policySocialSecurity || false;
                this.policyHousing = data.policyHousing || false;
                this.policyFood = data.policyFood || false;
                this.mayor = data.mayor || null;
                this.taxRate = data.taxRate !== undefined ? data.taxRate : 5;
                this.financeHistory = data.financeHistory || [];
                this.buildings = data.buildings.map(bData => { 
                    const bp = BUILDINGS_BLUEPRINT.find(x => x.id === bData.id); 
                    let b = bp ? new Building(bp) : new Building(bData); 
                    if (bData.currentProgress !== undefined) b.currentProgress = bData.currentProgress; 
                    if (bData.isBuilt !== undefined) b.isBuilt = bData.isBuilt; 
                    if (bData.staff !== undefined) b.staff = bData.staff; if (!b.staff) b.staff = []; 
                    if (bData.prostitutes !== undefined) b.prostitutes = bData.prostitutes; if (!b.prostitutes) b.prostitutes = []; 
                    if(bData.history) b.history = bData.history; 
                    b.level = bData.level || 1; b.isUnderConstruction = bData.isUnderConstruction || false;
                    if (bData.hasPermit !== undefined) b.hasPermit = bData.hasPermit;
                    else if (b.currentProgress > 0 || b.isBuilt) b.hasPermit = true; 
                    return b; 
                }); 
                this.chars = data.chars.map(cData => { 
                    if (cData.ideology && cData.ideology.name) {
                        const canonical = IDEOLOGIES.find(i => i.name === cData.ideology.name);
                        cData.ideology = canonical || cData.ideology;
                    }
                    let c = new Character(cData.name); 
                    Object.assign(c, cData); 
                    if (c.money === undefined) c.money = 0; 
                    if (!c.ideology) c.ideology = choose(IDEOLOGIES); 
                    if (!c.gender) c.gender = Math.random() > 0.5 ? 'â™‚ ç”·' : 'â™€ å¥³'; 
                    if (c.hunger === undefined) c.hunger = 80; 
                    if (c.health === undefined) c.health = 100;
                    if (c.stamina === undefined) c.stamina = 100;
                    // åˆå§‹åŒ–å±æ€§ä¸Šé™ï¼ˆå…¼å®¹æ—§å­˜æ¡£ï¼‰
                    if (c.staminaMax === undefined) c.staminaMax = 100;
                    if (c.healthMax === undefined) c.healthMax = 100;
                    if (c.nextActionOverride === undefined) c.nextActionOverride = null; 
                    if(!c.bag) c.bag = []; if(!c.history) c.history = []; 
                    if (c.jailTerm === undefined) c.jailTerm = 0;
                    if (c.lastMealTime === undefined) c.lastMealTime = -999;
                    if (c.consecutiveWork === undefined) c.consecutiveWork = 0;
                    if (c.workHoursToday === undefined) c.workHoursToday = 0;
                    if (!c.incomeHistory) c.incomeHistory = [];
                    if (c.stat_rob === undefined) c.stat_rob = 0;
                    if (c.stat_be_robbed === undefined) c.stat_be_robbed = 0;
                    if (c.stat_streetwalk === undefined) c.stat_streetwalk = 0;
                    if (c.stat_assault === undefined) c.stat_assault = 0;
                    if (c.stat_be_assaulted === undefined) c.stat_be_assaulted = 0;
                    if (c.dailySleepOffset === undefined) c.dailySleepOffset = rand(-2, 4);
                    if (c.stayUpLate === undefined) c.stayUpLate = false;
                    // åˆå§‹åŒ–æ–°å››ç»´
                    if (!c.skills || !c.skills.culture) c.skills = { social: rand(10, 30), culture: rand(10, 30), integrity: rand(50, 80), malice: rand(0, 10) };
                    if (!c.traits || c.traits.length === 0) { c.traits = []; const traitCount = rand(1, 3); for (let i = 0; i < traitCount; i++) { const availableTraits = TRAITS.filter(t => !c.traits.find(tt => tt.id === t.id)); if (availableTraits.length > 0) c.traits.push(choose(availableTraits)); } } 
                    if (!c.constructionContribution) c.constructionContribution = {}; 
                    if (c.prostitute === undefined) c.prostitute = null; 
                    if(c.appearance === undefined) c.appearance = rand(40, 80); 
                    for (let name in c.relationships) { const rel = c.relationships[name]; if (!rel.status || !['stranger', 'friend', 'bestfriend', 'lover', 'spouse', 'mistress', 'ex','enemy'].includes(rel.status)) { rel.status = rel.love > 10 ? 'friend' : 'stranger'; } } 
                    return c; 
                }); 
                this.runElectionsAndHiring(); 
            } catch(e) { console.error("å­˜æ¡£æŸå", e); this.initNewGame(); } 
        }
        log(msg, type = "") { const el = document.getElementById('game-log'); if(el) { const div = document.createElement('div'); div.className = `log-entry ${type}`; div.innerHTML = `<span class="log-time">[${new Date().toLocaleTimeString()}]</span> ${msg}`; el.prepend(div); if (el.children.length > 60) el.lastChild.remove(); } }
        logInteraction(msg, type = "") { const el = document.getElementById('interaction-log'); if(el) { const div = document.createElement('div'); div.className = `log-entry ${type}`; div.innerHTML = `<span class="log-time">[${new Date().toLocaleTimeString()}]</span> ${msg}`; el.prepend(div); if (el.children.length > 40) el.lastChild.remove(); } }
        addNewResident(name) {
            if (this.chars.some(c => c.name === name)) { alert(`å±…æ°‘ "${name}" å·²ç»ä½åœ¨å°é•‡é‡Œäº†ï¼`); return; }
            const newChar = new Character(name);
            this.chars.forEach(existingChar => { newChar.relationships[existingChar.name] = { love: 0, status: 'stranger' }; existingChar.relationships[newChar.name] = { love: 0, status: 'stranger' }; });
            this.chars.push(newChar); newChar.money = 50; this.log(`[ğŸšå…¥ä½] æ¬¢è¿æ–°å±…æ°‘ **${name}** æ¬å…¥çŒ«ã®æ¨¡æ‹Ÿå°é•‡ï¼å¤§å®¶çƒ­çƒˆæ¬¢è¿ï¼`, "tag-event"); newChar.addLog(`[${this.getDateTimeStr()}] åˆšåˆšæ¬è¿›çŒ«ã®æ¨¡æ‹Ÿå°é•‡`);
            this.updateUI(); setTimeout(() => { const charList = document.getElementById('char-list'); if(charList) charList.scrollTop = charList.scrollHeight; }, 100);
        }
        renderUIStatic() { 
            const bList = document.getElementById('build-list'); if(!bList) return; bList.innerHTML = ''; 
            const categories = ['food', 'fun', 'service', 'shop', 'landmark', 'government'];
            categories.forEach(cat => {
                const catHeader = document.createElement('div'); catHeader.className = 'category-header'; catHeader.innerText = CATEGORY_NAMES[cat] || cat; bList.appendChild(catHeader);
                this.buildings.filter(b => b.category === cat).forEach(b => { 
                    const div = document.createElement('div'); div.className = 'build-card'; div.id = `build-${b.id}`; div.onclick = (e) => { if(e.target.tagName !== 'BUTTON') gameInstance.showBuildingDetail(b.id); };
                    let btnHtml = ''; 
                    if (!b.isBuilt) { 
                        if (b.isUnderConstruction) { 
                            btnHtml = `<button class="btn accelerate" onclick="gameInstance.accelerateBuild('${b.id}')">ğŸ’¸ èµ„é‡‘åŠ é€Ÿ (50)</button><button class="btn stop-build" onclick="gameInstance.toggleConstruction('${b.id}')">â¹ æš‚åœæ–½å·¥</button>`; 
                        } else if (b.currentProgress > 0 || b.hasPermit) {
                            btnHtml = `<button class="btn resume-build" onclick="gameInstance.toggleConstruction('${b.id}')">â–¶ æ¢å¤æ–½å·¥</button>`;
                        } else { 
                            btnHtml = `<button class="btn start-build" disabled title="è¯·ç­‰å¾…é•‡é•¿å‘èµ·æŠ•ç¥¨">ğŸ—³ï¸ å¾…æŠ•ç¥¨å¯åŠ¨</button>`; 
                        } 
                    }
                    // è·å–å½“å‰åœ¨æ­¤å»ºç­‘å·¥ä½œçš„å‘˜å·¥
                    let staffHtml = '';
                    if (b.isBuilt && b.staff && b.staff.length > 0) {
                        const staffList = b.staff.slice(0, 3).map(sName => {
                            const staff = this.chars.find(c => c.name === sName);
                            if (staff) {
                                const role = staff.job ? staff.job.role : 'å‘˜å·¥';
                                return `${sName}(${role})`;
                            }
                            return sName;
                        }).join('ã€');
                        const moreCount = b.staff.length > 3 ? `ç­‰${b.staff.length}äºº` : '';
                        staffHtml = `<div style="font-size:0.75rem; color:#3498db; margin-top:5px; padding:4px 8px; background:#ebf5fb; border-radius:4px; border:1px solid #aed6f1;">
                            <span style="font-weight:bold;">ğŸ‘· å½“å‰å‘˜å·¥:</span> ${staffList}${moreCount}
                        </div>`;
                    }
                    div.innerHTML = `<div><div style="font-weight:bold; font-size:1.05rem">${b.name}</div><div style="font-size:0.8rem; color:#666">${b.desc}</div>${staffHtml}</div><div><div class="bar-container"><div class="bar-fill" style="background:#00b894; width:0%"></div></div><div class="build-prog">æœªå»ºæˆ</div>${btnHtml}</div>`; bList.appendChild(div); 
                });
            });
        }
        showEmbezzle() { 
            const el = document.getElementById('embezzle-town-money'); if(el) el.innerText = Math.floor(this.townMoney); 
            const list = document.getElementById('embezzle-list'); 
            if(list) {
                list.innerHTML = ''; 
                this.chars.forEach(c => { const div = document.createElement('div'); div.className = 'fund-item'; div.innerHTML = `${c.name} <small>(ğŸ’°${Math.floor(c.money)})</small>`; div.onclick = () => { document.querySelectorAll('.fund-item').forEach(el=>el.classList.remove('selected')); div.classList.add('selected'); window.selectedFundTarget = c.name; }; list.appendChild(div); }); 
                document.getElementById('embezzle-modal').classList.add('active'); 
            }
        }
        doEmbezzle() { const name = window.selectedFundTarget; const amt = parseInt(document.getElementById('embezzle-amount').value); if (!name || isNaN(amt) || amt <= 0) return alert("è¯·é€‰æ‹©å±…æ°‘å¹¶è¾“å…¥æœ‰æ•ˆé‡‘é¢"); if (this.townMoney < amt) return alert("é•‡åº“èµ„é‡‘ä¸è¶³ï¼"); const c = this.chars.find(x => x.name === name); if (c) { c.money += amt; this.addCharIncome(c, amt, 'è´¢æ”¿æ‹¨æ¬¾'); this.townMoney -= amt; this.log(`[ğŸ’¸æ‹¨æ¬¾] é•‡é•¿å‘ **${c.name}** æ‹¨æ¬¾ ğŸ’°${amt}ã€‚`, "tag-build"); this.updateUI(); this.closeEmbezzle(); } }
        closeEmbezzle() { document.getElementById('embezzle-modal').classList.remove('active'); }
        showJobBoard() {
            const tabsContainer = document.getElementById('jobboard-tabs');
            const list = document.getElementById('jobboard-list');
            if(!tabsContainer || !list) return;
            tabsContainer.innerHTML = '';
            list.innerHTML = '';
            // åˆ›å»ºä¸´æ—¶é›¶å·¥é€‰é¡¹å¡
            const oddJobTab = document.createElement('button');
            oddJobTab.className = 'filter-btn active';
            oddJobTab.id = 'job-tab-odd';
            oddJobTab.innerText = 'ğŸ›  ä¸´æ—¶é›¶å·¥';
            oddJobTab.onclick = () => this.switchJobTab('odd');
            tabsContainer.appendChild(oddJobTab);
            // ä¸ºæ¯ä¸ªæœ‰å²—ä½çš„å»ºç­‘åˆ›å»ºé€‰é¡¹å¡
            const buildingsWithJobs = this.buildings.filter(b => b.jobs && b.jobs.length > 0);
            buildingsWithJobs.forEach((b, index) => {
                const tab = document.createElement('button');
                tab.className = 'filter-btn';
                tab.id = `job-tab-${b.id}`;
                tab.innerText = b.name;
                tab.onclick = () => this.switchJobTab(b.id);
                tabsContainer.appendChild(tab);
            });
            // é»˜è®¤æ˜¾ç¤ºä¸´æ—¶é›¶å·¥
            this.switchJobTab('odd');
            document.getElementById('jobboard-modal').classList.add('active');
        }
        switchJobTab(tabId) {
            // æ›´æ–°é€‰é¡¹å¡çŠ¶æ€
            document.querySelectorAll('#jobboard-tabs .filter-btn').forEach(btn => btn.classList.remove('active'));
            const activeTab = document.getElementById(`job-tab-${tabId}`);
            if(activeTab) activeTab.classList.add('active');
            const list = document.getElementById('jobboard-list');
            if(!list) return;
            list.innerHTML = '';
            if(tabId === 'odd') {
                // æ˜¾ç¤ºä¸´æ—¶é›¶å·¥
                ODD_JOBS.forEach(job => {
                    const item = document.createElement('div');
                    item.className = 'job-item';
                    item.innerHTML = `
                        <div>
                            <div class="job-name">${job.name}</div>
                            <div class="job-loc" style="font-size:0.8em; color:gray;">Mood: ${job.mood}</div>
                        </div>
                        <div class="job-wage" style="color:${job.wage<0?'#e74c3c':'#27ae60'}">ğŸ’° ${job.wage}</div>
                    `;
                    list.appendChild(item);
                });
                // æ·»åŠ ç«™è¡—é€‰é¡¹
                const hookerItem = document.createElement('div');
                hookerItem.className = 'job-item';
                hookerItem.innerHTML = `
                    <div>
                        <div class="job-name">ğŸ’‹ ç«™è¡—</div>
                    </div>
                    <div class="job-wage">ğŸ’° 8-15</div>
                `;
                list.appendChild(hookerItem);
            } else {
                // æ˜¾ç¤ºæŒ‡å®šå»ºç­‘çš„å²—ä½
                const building = this.buildings.find(b => b.id === tabId);
                if(building && building.jobs && building.jobs.length > 0) {
                    building.jobs.forEach(role => {
                        const item = document.createElement('div');
                        item.className = 'job-item';
                        item.innerHTML = `
                            <div>
                                <div class="job-name">ğŸ‘” ${role}</div>
                                <div class="job-loc">${building.name} <span class="lvl-badge">Lv.${building.level}</span></div>
                            </div>
                            <div class="job-wage">ğŸ’° ${getJobWage(role)}/å¤©</div>
                        `;
                        list.appendChild(item);
                    });
                } else {
                    list.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">è¯¥å»ºç­‘æš‚æ— å²—ä½</div>';
                }
            }
        }
        showAchievements() {
            const modal = document.getElementById('achievements-modal');
            const list = document.getElementById('achievements-list'); if(list) list.innerHTML = '';
            ACHIEVEMENTS_DB.forEach(ach => {
                const isUnlocked = this.achievements.includes(ach.id);
                const div = document.createElement('div'); div.className = `achieve-item ${isUnlocked ? 'unlocked' : ''}`;
                div.innerHTML = `<div class="achieve-icon">${ach.icon}</div><div class="achieve-info"><div class="achieve-title">${ach.name} ${isUnlocked ? 'âœ…' : ''}</div><div class="achieve-desc">${isUnlocked ? ach.desc : '??? (ç»§ç»­æ¢ç´¢å°é•‡ä»¥è§£é”)'}</div>${isUnlocked ? `<div class="achieve-reward">å¥–åŠ±: ğŸ’°${ach.reward}</div>` : ''}</div>`;
                if(list) list.appendChild(div);
            });
            if(modal) modal.classList.add('active');
        }
        closeAchievements() { document.getElementById('achievements-modal').classList.remove('active'); }
        showGameGuide() {
            const modal = document.getElementById('guide-modal');
            this.switchGuideTab('trait');
            modal.classList.add('active');
        }
        showLeaderboard() { this.renderLeaderboard('money'); }
        switchGuideTab(tab) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById(`guide-tab-${tab}`); if(btn) btn.classList.add('active');
            const container = document.getElementById('guide-content');
            if(!container) return;
            container.innerHTML = '';
            if (tab === 'trait') {
                TRAITS.forEach(t => {
                    const item = document.createElement('div'); item.className = 'guide-item';
                    item.innerHTML = `
                        <div class="guide-name">${t.name}</div>
                        <div class="guide-desc">${t.desc}</div>
                        <div class="guide-stats" style="color:#666; font-style:italic;">ğŸ—£ AIè¯­æ°”é£æ ¼: ${t.tone}</div>
                        `;
                    container.appendChild(item);
                });
            } else {
                IDEOLOGIES.forEach(i => {
                    const item = document.createElement('div'); item.className = 'guide-item';
                    item.style.borderLeft = `5px solid ${i.color}`;
                    const chaosText = i.chaosMod > 0 ? `<span class="stat-negative">+${(i.chaosMod * 100).toFixed(0)}% åµæ¶</span>` : `<span class="stat-positive">${(i.chaosMod * 100).toFixed(0)}% åµæ¶</span>`;
                    const loveText = i.loveMod > 0 ? `<span class="stat-positive">+${i.loveMod.toFixed(1)} å¥½æ„Ÿ</span>` : i.loveMod < 0 ? `<span class="stat-negative">${i.loveMod.toFixed(1)} å¥½æ„Ÿ</span>` : `<span>0 å¥½æ„Ÿ</span>`;
                    const wageText = i.wageMod > 0 ? `<span class="stat-positive">+${(i.wageMod * 100).toFixed(0)}% å·¥èµ„</span>` : i.wageMod < 0 ? `<span class="stat-negative">${(i.wageMod * 100).toFixed(0)}% å·¥èµ„</span>` : `<span>0 åŠ æˆ</span>`;
                    item.innerHTML = `
                        <div class="guide-name" style="color:${i.color}">${i.name}</div>
                        <div class="guide-desc">${i.desc}</div>
                        <div class="guide-stats">
                            <div class="stat-row">${loveText}</div>
                            <div class="stat-row">${chaosText}</div>
                            <div class="stat-row">${wageText}</div>
                        </div>`;
                    container.appendChild(item);
                });
            }
        }
        showCharacterDetail(name) {
            const c = this.chars.find(x => x.name === name); if (!c) return;
            const modal = document.getElementById('char-detail-modal');
            const content = document.getElementById('detail-content'); 
            const nameEl = document.getElementById('detail-name'); if(nameEl) nameEl.innerText = `${c.name} çš„ä¸ªäººæ¡£æ¡ˆ`;
            let jobText = "æ— ä¸š"; if (c.prostitute) { jobText = "å¤±è¶³"; } else if (c.job) { const skillType = getJobSkillType(c.job.role); const skillVal = c.skills[skillType] || 0; const levelInfo = getLevelInfo(skillVal); jobText = `${levelInfo.title}${c.job.role}`; }
            let wageHtml = ''; if (c.job) { const baseWage = getBaseJobWage(c.job.role); const actualWage = c.calculateWage(baseWage, c.job.role); const diff = actualWage - baseWage; const pct = baseWage > 0 ? Math.round((diff / baseWage) * 100) : 0; const color = diff >= 0 ? '#27ae60' : '#e74c3c'; const sign = diff >= 0 ? '+' : ''; wageHtml = `<span style="color:#999; text-decoration:line-through; font-size:0.9em;">${baseWage}</span> <span style="color:${color}; font-weight:bold;">ğŸ’°${Math.floor(actualWage)}</span> <small style="color:${color}">(${sign}${pct}%)</small>`; } else { wageHtml = `<span style="color:#aaa">æ— æ”¶å…¥</span>`; }
            let traitsHtml = c.traits.map(t => `<div class="trait-tag" title="${t.desc}">${t.name}</div>`).join('') || "æ— ";
            const ideology = c.ideology || { name: "æ— ", color: "#999", desc: "", chaosMod:0, loveMod:0, wageMod:0 };
            // åœ¨headerä¸­æ˜¾ç¤ºä¿¡ä»°ä¸»ä¹‰
            const ideologyEl = document.getElementById('detail-ideology'); 
            if(ideologyEl) {
                // å°†åå…­è¿›åˆ¶é¢œè‰²è½¬æ¢ä¸ºrgbaæ ¼å¼
                const hexToRgba = (hex, alpha) => {
                    const r = parseInt(hex.slice(1, 3), 16);
                    const g = parseInt(hex.slice(3, 5), 16);
                    const b = parseInt(hex.slice(5, 7), 16);
                    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
                };
                const colorRgba1 = hexToRgba(ideology.color, 0.12);
                const colorRgba2 = hexToRgba(ideology.color, 0.08);
                const loveText = ideology.loveMod > 0 ? `<span class="stat-positive">â¤ +${ideology.loveMod.toFixed(1)} å¥½æ„Ÿ</span>` : ideology.loveMod < 0 ? `<span class="stat-negative">â¤ ${ideology.loveMod.toFixed(1)} å¥½æ„Ÿ</span>` : '';
                const wageText = ideology.wageMod > 0 ? `<span class="stat-positive">ğŸ’° +${(ideology.wageMod * 100).toFixed(0)}% å·¥èµ„</span>` : ideology.wageMod < 0 ? `<span class="stat-negative">ğŸ’° ${(ideology.wageMod * 100).toFixed(0)}% å·¥èµ„</span>` : '';
                const chaosText = ideology.chaosMod > 0 ? `<span class="stat-negative">ğŸ’¢ +${(ideology.chaosMod * 100).toFixed(0)}% åµæ¶</span>` : ideology.chaosMod < 0 ? `<span class="stat-positive">ğŸ•Šï¸ ${(ideology.chaosMod * 100).toFixed(0)}% åµæ¶</span>` : '';
                const bonusText = [loveText, wageText, chaosText].filter(t => t).join(' | ');
                ideologyEl.innerHTML = `
                    <div style="display:inline-flex; align-items:center; gap:10px; padding:8px 15px; border-radius:8px; border:2px solid ${ideology.color}; background:linear-gradient(135deg, ${colorRgba1} 0%, ${colorRgba2} 100%); box-shadow:0 2px 8px ${hexToRgba(ideology.color, 0.2)};">
                        <span style="color:#666; font-size:0.9rem;">ä¿¡ä»°ä¸»ä¹‰:</span>
                        <span style="color:${ideology.color}; font-weight:bold; font-size:1rem;">${ideology.name}</span>
                        ${bonusText ? `<span style="font-size:0.85rem;">${bonusText}</span>` : ''}
                        <button class="edit-btn" onclick="gameInstance.openEditModal('ä¿®æ”¹ä¸»ä¹‰', gameInstance.getIdeologyNames(), '${ideology.name}', 'ideology', '${c.name}')" style="font-size:0.85rem; padding:2px 6px;">[ä¿®æ”¹]</button>
                    </div>
                `;
            }
            let bagHtml = '<div style="color:#999; font-size:0.85rem;">èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿ</div>'; if (c.bag && c.bag.length > 0) { bagHtml = '<div class="bag-grid">'; c.bag.forEach(itemId => { const item = ITEMS_DB[itemId]; if(item) { const tooltipText = getItemTooltipText(itemId); bagHtml += `<div class="bag-item tooltip-item" data-tip="${tooltipText}">${item.name}</div>`; } }); bagHtml += '</div>'; }
            let historyHtml = '<div class="history-list">'; if (!c.history || c.history.length === 0) { historyHtml += '<div class="history-item">æš‚æ— æ´»åŠ¨è®°å½•</div>'; } else { c.history.forEach(h => { historyHtml += `<div class="history-item">${h}</div>`; }); } historyHtml += '</div>';
            let jailStatus = ""; if (c.jailTerm > 0) { jailStatus = `<div style="margin-top:5px; color:#e74c3c; font-weight:bold;">â›“ï¸ æœåˆ‘ä¸­: å‰©ä½™ ${(c.jailTerm/60).toFixed(1)} å°æ—¶</div>`; }
            const skillsHtml = `
                <div class="skill-row"><span class="skill-name">ç¤¾äº¤</span><div class="skill-track"><div class="skill-bar sk-social" style="width:${c.skills.social}%"></div></div><span class="skill-val">${Math.floor(c.skills.social)}</span></div>
                <div class="skill-row"><span class="skill-name">æ–‡åŒ–</span><div class="skill-track"><div class="skill-bar sk-culture" style="width:${c.skills.culture}%"></div></div><span class="skill-val">${Math.floor(c.skills.culture)}</span></div>
                <div class="skill-row"><span class="skill-name">è¯šä¿¡</span><div class="skill-track"><div class="skill-bar sk-integrity" style="width:${c.skills.integrity}%"></div></div><span class="skill-val">${Math.floor(c.skills.integrity)}</span></div>
                <div class="skill-row"><span class="skill-name">æ¶æ„</span><div class="skill-track"><div class="skill-bar sk-malice" style="width:${c.skills.malice}%"></div></div><span class="skill-val">${Math.floor(c.skills.malice)}</span></div>
                `;
            const relationEntries = Object.entries(c.relationships || {})
                .map(([name, rel]) => ({ name, ...rel }))
                .filter(rel => rel.name !== c.name)
                .sort((a, b) => Math.abs(b.love) - Math.abs(a.love))
                .slice(0, 6);
            const relationListHtml = relationEntries.length > 0 ? relationEntries.map(rel => {
                const status = REL_TRANSLATE[rel.status] || rel.status;
                const loveColor = rel.love >= 0 ? '#2d98da' : '#e74c3c';
                return `<div style="display:flex; justify-content:space-between; font-size:0.85rem; border-bottom:1px dashed #eee; padding:3px 0;">
                    <span>${rel.name}</span>
                    <span><span style="color:#27ae60; margin-right:6px;">${status}</span><span style="color:${loveColor}">${Math.floor(rel.love)}</span></span>
                </div>`;
            }).join('') : `<div style="color:#bbb; font-size:0.85rem;">æš‚æ— å¥½æ„Ÿæ•°æ®</div>`;
            content.innerHTML = `
                <div class="detail-group">
                    <div class="detail-label">ç”Ÿç†éœ€æ±‚ <button class="edit-btn" onclick="gameInstance.openEditModal('ä¿®æ”¹æ€§åˆ«', ['â™‚ ç”·', 'â™€ å¥³'], '${c.gender}', 'gender', '${c.name}')">[ä¿®æ”¹æ€§åˆ«]</button></div>
                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:15px; width:100%; padding:10px 0;">
                        <div style="background:linear-gradient(135deg, #f39c12 0%, #e67e22 100%); border-radius:10px; padding:15px; color:#fff; box-shadow:0 4px 8px rgba(243,156,18,0.3);">
                            <div style="font-size:1.5rem; margin-bottom:8px;">ğŸ’°</div>
                            <div style="font-size:0.85rem; opacity:0.9; margin-bottom:5px;">èµ„é‡‘</div>
                            <div style="font-size:1.3rem; font-weight:bold;">${Math.floor(c.money)}</div>
                        </div>
                        <div style="background:linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); border-radius:10px; padding:15px; color:#fff; box-shadow:0 4px 8px rgba(231,76,60,0.3); position:relative; overflow:hidden;">
                            <div style="font-size:1.5rem; margin-bottom:8px;">â¤ï¸</div>
                            <div style="font-size:0.85rem; opacity:0.9; margin-bottom:5px;">å¿ƒæƒ…</div>
                            <div style="font-size:1.3rem; font-weight:bold; margin-bottom:5px;">${Math.floor(c.happiness)}</div>
                            <div style="background:rgba(255,255,255,0.3); height:6px; border-radius:3px; overflow:hidden;">
                                <div style="background:#fff; height:100%; width:${Math.min(c.happiness, 100)}%; transition:width 0.3s ease;"></div>
                            </div>
                        </div>
                        <div style="background:linear-gradient(135deg, #f1c40f 0%, #f39c12 100%); border-radius:10px; padding:15px; color:#fff; box-shadow:0 4px 8px rgba(241,196,15,0.3); position:relative; overflow:hidden;">
                            <div style="font-size:1.5rem; margin-bottom:8px;">ğŸ—</div>
                            <div style="font-size:0.85rem; opacity:0.9; margin-bottom:5px;">é¥±é£Ÿ</div>
                            <div style="font-size:1.3rem; font-weight:bold; margin-bottom:5px;">${Math.floor(c.hunger)}</div>
                            <div style="background:rgba(255,255,255,0.3); height:6px; border-radius:3px; overflow:hidden;">
                                <div style="background:#fff; height:100%; width:${Math.min(c.hunger, 100)}%; transition:width 0.3s ease;"></div>
                            </div>
                        </div>
                        <div style="background:linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); border-radius:10px; padding:15px; color:#fff; box-shadow:0 4px 8px rgba(46,204,113,0.3); position:relative; overflow:hidden;">
                            <div style="font-size:1.5rem; margin-bottom:8px;">ğŸš‘</div>
                            <div style="font-size:0.85rem; opacity:0.9; margin-bottom:5px;">å¥åº·</div>
                            <div style="font-size:1.3rem; font-weight:bold; margin-bottom:5px;">${Math.floor(c.health)}</div>
                            <div style="background:rgba(255,255,255,0.3); height:6px; border-radius:3px; overflow:hidden;">
                                <div style="background:#fff; height:100%; width:${Math.min(c.health, 100)}%; transition:width 0.3s ease;"></div>
                            </div>
                        </div>
                        <div style="background:linear-gradient(135deg, #3498db 0%, #2980b9 100%); border-radius:10px; padding:15px; color:#fff; box-shadow:0 4px 8px rgba(52,152,219,0.3); position:relative; overflow:hidden;">
                            <div style="font-size:1.5rem; margin-bottom:8px;">âš¡</div>
                            <div style="font-size:0.85rem; opacity:0.9; margin-bottom:5px;">ä½“åŠ›</div>
                            <div style="font-size:1.3rem; font-weight:bold; margin-bottom:5px;">${Math.floor(c.stamina)}</div>
                            <div style="background:rgba(255,255,255,0.3); height:6px; border-radius:3px; overflow:hidden;">
                                <div style="background:#fff; height:100%; width:${Math.min(c.stamina, 100)}%; transition:width 0.3s ease;"></div>
                            </div>
                        </div>
                        <div style="background:linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); border-radius:10px; padding:15px; color:#fff; box-shadow:0 4px 8px rgba(155,89,182,0.3);">
                            <div style="font-size:1.5rem; margin-bottom:8px;">âœ¨</div>
                            <div style="font-size:0.85rem; opacity:0.9; margin-bottom:5px;">é¢œå€¼</div>
                            <div style="font-size:1.3rem; font-weight:bold;">${c.appearance}</div>
                        </div>
                    </div>
                </div>
                <div class="detail-group">
                   <div class="detail-label">èŒä¸š & æŠ€èƒ½ <button class="edit-btn" onclick="gameInstance.showActionSelect('${c.name}')">[å¼ºåˆ¶å¹²é¢„]</button></div>
                   <div class="detail-val">${jobText}</div>
                   <div class="detail-desc">æ”¶å…¥: ${wageHtml}</div>
                   <div style="margin-top:8px;">${skillsHtml}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">ç‰¹è´¨ 
                        <button class="edit-btn" onclick="gameInstance.openEditModal('é‡ç½®ç‰¹è´¨', gameInstance.getTraitNames(), '', 'trait', '${c.name}')">[æ”¹ç‰¹è´¨]</button>
                    </div>
                    <div class="trait-container" style="margin-top:5px;">${traitsHtml}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">äººé™…å…³ç³» (ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…)</div>
                    <div class="detail-desc">ä¼´ä¾£: ${c.partner ? `<b>${c.partner}</b>` : 'å•èº«'} ${c.prostitute ? '(å¤±è¶³)' : ''}</div>
                    <div class="history-list" style="max-height:180px;">${relationListHtml}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">å½“å‰èƒŒåŒ…</div>
                    ${bagHtml}
                </div>
                <div class="detail-group">
                    <div class="detail-label">æœ€è¿‘åŠ¨æ€ ${jailStatus}</div>
                    ${historyHtml}
                </div>
                <div class="detail-group">
                    <div class="detail-label">ğŸ’° è¿‘åæ¬¡èµ„é‡‘æ”¶å…¥</div>
                    ${(() => {
                        if (!c.incomeHistory || c.incomeHistory.length === 0) {
                            return '<div class="history-list"><div class="history-item" style="color:#999;">æš‚æ— æ”¶å…¥è®°å½•</div></div>';
                        }
                        let incomeHtml = '<div class="history-list">';
                        c.incomeHistory.forEach((record, index) => {
                            incomeHtml += `
                                <div class="history-item" style="display:flex; justify-content:space-between; align-items:center;">
                                    <div style="flex:1;">
                                        <div style="font-weight:bold; color:#2c3e50; font-size:0.9rem;">${record.source}</div>
                                        <div style="font-size:0.75rem; color:#999; margin-top:2px;">${record.time}</div>
                                    </div>
                                    <div style="font-weight:bold; color:#27ae60; font-size:1rem; min-width:60px; text-align:right;">+ğŸ’°${record.amount}</div>
                                </div>
                            `;
                        });
                        incomeHtml += '</div>';
                        return incomeHtml;
                    })()}
                </div>
                <div class="detail-group">
                    <div class="detail-label">çŠ¯ç½ªè®°å½•</div>
                    <div class="detail-desc">æŠ¢åŠ«: ${c.stat_rob} | è¢«æŠ¢: ${c.stat_be_robbed} | ç«™è¡—: ${c.stat_streetwalk} | éªšæ‰°: ${c.stat_assault} | è¢«éªšæ‰°: ${c.stat_be_assaulted}</div>
                </div>
            `;
            modal.classList.add('active');
        }
        closeCharDetail() { document.getElementById('char-detail-modal').classList.remove('active'); }
        showBuildingDetail(bid) {
            const b = this.buildings.find(x => x.id === bid); if(!b) return;
            const modal = document.getElementById('building-detail-modal'); 
            const nameEl = document.getElementById('b-detail-name'); if(nameEl) nameEl.innerText = b.name;
            const content = document.getElementById('b-detail-content');
            const staffHtml = b.staff.map((sName, index) => {
                const char = this.chars.find(c => c.name === sName);
                let wageInfo = "æœªçŸ¥";
                let skillTitle = "";
                let skillBarHtml = "";
                let roleName = "å‘˜å·¥";
                if (char && char.job) {
                     const base = getBaseJobWage(char.job.role);
                     const wage = char.calculateWage(base, char.job.role);
                     const skillType = getJobSkillType(char.job.role);
                     const sVal = char.skills[skillType]||0;
                     const levelInfo = getLevelInfo(sVal);
                     skillTitle = levelInfo.title;
                     wageInfo = `ğŸ’°${Math.floor(wage)}`;
                     // æ˜¾ç¤ºå®é™…èŒä½åç§°
                     roleName = char.job.role;
                     let prevCap = 0;
                     let nextCap = 20;
                     if(levelInfo.level === 1) { prevCap = 20; nextCap = 50; }
                     if(levelInfo.level === 2) { prevCap = 50; nextCap = 80; }
                     if(levelInfo.level === 3) { prevCap = 80; nextCap = 100; }
                     const pct = Math.min(100, Math.max(0, ((sVal - prevCap) / (nextCap - prevCap)) * 100));
                     skillBarHtml = `<div style="width:60px; height:4px; background:#eee; margin-top:4px; border-radius:2px;" title="ç†Ÿç»ƒåº¦è¿›åº¦"><div style="height:100%; background:#0984e3; width:${pct}%"></div></div>`;
                } else {
                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°è§’è‰²æˆ–èŒä½ä¿¡æ¯ï¼Œå°è¯•ä»å»ºç­‘èŒä½åˆ—è¡¨ä¸­è·å–
                    if (b.jobs && b.jobs[index]) {
                        roleName = b.jobs[index];
                    }
                }
                return `<div class="staff-list-item">
                    <div style="display:flex; flex-direction:column;">
                        <div><span class="staff-role">${roleName}:</span> <span class="staff-name">${sName}</span> <span class="lvl-badge">${skillTitle}</span></div>
                        ${skillBarHtml}
                    </div>
                    <div style="font-weight:bold; color:#27ae60;">${wageInfo}</div>
                </div>`;
            }).join('') || '<div style="padding:10px; color:#999">æš‚æ— å‘˜å·¥</div>';
            const prosHtml = b.prostitutes.map(p => `<div class="staff-list-item"><span class="staff-role">æŠ€å¸ˆ:</span><span class="staff-name">${p}</span></div>`).join('');
            let historyHtml = '<div class="history-list">'; b.history.forEach(h => { historyHtml += `<div class="history-item">${h}</div>`; }); historyHtml += '</div>';
            // æ˜¾ç¤ºå”®å–çš„ç‰©å“
            let sellsHtml = '';
            if (b.sells && b.sells.length > 0) {
                sellsHtml = '<div class="section-title">ğŸ›ï¸ å”®å–ç‰©å“</div><div class="bag-grid" style="margin-bottom:15px;">';
                b.sells.forEach(itemId => {
                    const item = ITEMS_DB[itemId];
                    if (item) {
                        const tooltipText = getItemTooltipText(itemId);
                        sellsHtml += `<div class="bag-item tooltip-item" data-tip="${tooltipText}" style="cursor:help;">${item.name}<br><small style="color:#e67e22;">ğŸ’°${item.price}</small></div>`;
                    }
                });
                sellsHtml += '</div>';
            }
            let statsHtml = '';
            if (b.isBuilt) {
                statsHtml = `
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <button class="btn upgrade" onclick="gameInstance.upgradeBuilding('${b.id}')">ğŸ—ï¸ å‡çº§å»ºç­‘ (Lv.${b.level+1})</button>
                    ${b.staff.length > 0 ? `<button class="btn train" onclick="gameInstance.boostTraining('${b.id}')">ğŸ“š å‘˜å·¥åŸ¹è®­ (200)</button>` : ''}
                </div>
                <div style="font-size:0.9rem; color:#666; margin-bottom:5px;">å½“å‰ç­‰çº§: Lv.${b.level}</div>
                `;
            }
            // æ ¼å¼åŒ–è¥ä¸šæ—¶é—´
            let openTimeStr = '';
            if (b.open !== undefined && b.close !== undefined) {
                if (b.open === 0 && b.close === 24) {
                    openTimeStr = '24å°æ—¶è¥ä¸š';
                } else if (b.close < b.open) {
                    openTimeStr = `${b.open}:00 - æ¬¡æ—¥${b.close}:00`;
                } else {
                    openTimeStr = `${b.open}:00 - ${b.close}:00`;
                }
            }
            // æ ¼å¼åŒ–ä¼‘æ¯æ—¥
            let closedDaysStr = '';
            if (b.closedDays && b.closedDays.length > 0) {
                const dayNames = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
                closedDaysStr = b.closedDays.map(d => dayNames[d]).join('ã€');
            } else {
                closedDaysStr = 'æ— ';
            }
            // æ˜¾ç¤ºåŸºç¡€å·¥èµ„ä¿¡æ¯ï¼ˆå¦‚æœæœ‰èŒä½ï¼‰
            let wageInfoHtml = '';
            if (b.jobs && b.jobs.length > 0) {
                wageInfoHtml = '<div class="section-title">ğŸ’¼ èŒä½ä¸åŸºç¡€å·¥èµ„</div><div style="background:#f8f9fa; padding:10px; border-radius:6px; margin-bottom:15px; border:1px solid #eee;">';
                b.jobs.forEach((jobRole, idx) => {
                    const baseWage = getBaseJobWage(jobRole);
                    wageInfoHtml += `<div style="display:flex; justify-content:space-between; padding:5px 0; border-bottom:${idx < b.jobs.length - 1 ? '1px dashed #ddd' : 'none'};">
                        <span style="font-weight:bold;">${jobRole}</span>
                        <span style="color:#e67e22; font-weight:bold;">ğŸ’°${baseWage}/å¤©</span>
                    </div>`;
                });
                wageInfoHtml += '</div>';
            }
            // ç”Ÿæˆå»ºç­‘ç‰¹æ®Šäº’åŠ¨æ•ˆæœè¯´æ˜
            let interactionHtml = '';
            const buildingId = b.id;
            const effects = [];
            let hasSpecificEffect = false; // æ ‡è®°æ˜¯å¦å·²ç»æ·»åŠ äº†ç‰¹å®šå»ºç­‘çš„æ•ˆæœ
            if (buildingId === 'school') {
                effects.push({ icon: 'ğŸ“š', text: 'ä¸Šè¯¾å­¦ä¹ ', desc: 'æå‡æ–‡åŒ– +1.5ï¼Œç¤¾äº¤ +0.3ï¼Œå¿ƒæƒ… +8ï¼Œä½“åŠ› +5' });
                effects.push({ icon: 'ğŸ’¡', text: 'é•¿æœŸæ•ˆæœ', desc: 'æŒç»­å­¦ä¹ å¯æå‡æ–‡åŒ–æ°´å¹³' });
                hasSpecificEffect = true;
            }
            else if (buildingId === 'gym') {
                effects.push({ icon: 'ğŸ’ª', text: 'é”»ç‚¼å¥èº«', desc: 'å¥åº· +8ï¼Œé¢œå€¼ +3ï¼Œå¿ƒæƒ… +12ï¼Œä½“åŠ› +15' });
                effects.push({ icon: 'ğŸ“ˆ', text: 'ä¸Šé™æå‡', desc: '10%æ¦‚ç‡æå‡ä½“åŠ›ä¸Šé™ï¼Œ5%æ¦‚ç‡æå‡å¥åº·ä¸Šé™ï¼ˆæœ€é«˜120ï¼‰' });
                hasSpecificEffect = true;
            }
            else if (buildingId === 'library') {
                effects.push({ icon: 'ğŸ“–', text: 'é˜…è¯»å­¦ä¹ ', desc: 'æ–‡åŒ– +1.2ï¼Œè¯šä¿¡ +0.2ï¼Œå¿ƒæƒ… +6~8ï¼Œä½“åŠ› +5' });
                hasSpecificEffect = true;
            }
            else if (buildingId === 'museum') {
                effects.push({ icon: 'ğŸ›', text: 'å‚è§‚å±•è§ˆ', desc: 'æ–‡åŒ– +1.0ï¼Œç¤¾äº¤ +0.2ï¼Œå¿ƒæƒ… +8ï¼Œä½“åŠ› +5' });
                hasSpecificEffect = true;
            }
            else if (buildingId === 'hospital') {
                effects.push({ icon: 'ğŸ¥', text: 'åŒ»ç–—æ²»ç–—', desc: 'å¥åº· +50ï¼Œå¿ƒæƒ… +5ï¼Œä½“åŠ› +5' });
                effects.push({ icon: 'ğŸ“ˆ', text: 'ä¸Šé™æå‡', desc: '5%æ¦‚ç‡æå‡å¥åº·ä¸Šé™ï¼ˆæœ€é«˜120ï¼‰' });
                hasSpecificEffect = true;
            }
            else if (buildingId === 'hotspring') {
                effects.push({ icon: 'â™¨ï¸', text: 'æ¸©æ³‰ç–—å…»', desc: 'å¥åº· +30ï¼Œå¿ƒæƒ… +15ï¼Œä½“åŠ› +20' });
                effects.push({ icon: 'ğŸ“ˆ', text: 'ä¸Šé™æå‡', desc: '15%æ¦‚ç‡æå‡å¥åº·ä¸Šé™ï¼ˆæœ€é«˜120ï¼‰' });
                hasSpecificEffect = true;
            }
            else if (buildingId === 'church') {
                effects.push({ icon: 'â›ª', text: 'ç¥ˆç¥·ç¥·å‘Š', desc: 'è¯šä¿¡ +1.0ï¼Œæ¶æ„ -0.5ï¼Œå¿ƒæƒ… +10ï¼Œä½“åŠ› +5' });
                hasSpecificEffect = true;
            }
            else if (buildingId === 'netcafe') {
                effects.push({ icon: 'ğŸ®', text: 'æ¸¸æˆå¨±ä¹', desc: 'å¿ƒæƒ… +20ï¼Œä½“åŠ› +5' });
                effects.push({ icon: 'âš ï¸', text: 'è´Ÿé¢æ•ˆæœ', desc: '30%æ¦‚ç‡é™ä½æ–‡åŒ– -0.2' });
                hasSpecificEffect = true;
            }
            else if (buildingId === 'cinema') {
                effects.push({ icon: 'ğŸ¬', text: 'è§‚å½±å¨±ä¹', desc: 'å¿ƒæƒ… +18ï¼Œç¤¾äº¤ +0.5ï¼Œä½“åŠ› +5' });
                hasSpecificEffect = true;
            }
            else if (buildingId === 'bar') {
                effects.push({ icon: 'ğŸº', text: 'å–é…’ä¹°é†‰', desc: 'å¿ƒæƒ… +25ï¼Œä½“åŠ› +5' });
                effects.push({ icon: 'âš ï¸', text: 'è´Ÿé¢æ•ˆæœ', desc: 'å¥åº· -3ï¼Œè¯šä¿¡ -0.3' });
                hasSpecificEffect = true;
            }
            else if (buildingId === 'amusement') {
                effects.push({ icon: 'ğŸ¡', text: 'æ¸¸ç©å¨±ä¹', desc: 'å¿ƒæƒ… +35ï¼Œç¤¾äº¤ +0.8ï¼Œä½“åŠ› +10' });
                hasSpecificEffect = true;
            }
            else if (buildingId === 'park') {
                effects.push({ icon: 'ğŸŒ³', text: 'æ•£æ­¥ä¼‘é—²', desc: 'å¿ƒæƒ… +8~10ï¼Œç¤¾äº¤ +0.3ï¼Œè¯šä¿¡ +0.1ï¼Œä½“åŠ› +10ï¼ˆå…è´¹ï¼‰' });
                hasSpecificEffect = true;
            }
            else if (buildingId === 'baozi') {
                effects.push({ icon: 'ğŸ¥Ÿ', text: 'ç”¨é¤', desc: 'é¥±é£Ÿåº¦ +25ï¼Œå¿ƒæƒ… +5ï¼Œä½“åŠ› +8~33ï¼ˆæ ¹æ®åŒ…å­ç±»å‹ï¼‰' });
                hasSpecificEffect = true;
            }
            else if (buildingId === 'clinic') {
                effects.push({ icon: 'ğŸ’Š', text: 'é—¨è¯Šæ²»ç–—', desc: 'å¥åº· +30ï¼Œå¿ƒæƒ… +5ï¼Œä½“åŠ› +5' });
                effects.push({ icon: 'ğŸ“ˆ', text: 'ä¸Šé™æå‡', desc: '3%æ¦‚ç‡æå‡å¥åº·ä¸Šé™ï¼ˆæœ€é«˜120ï¼‰' });
                hasSpecificEffect = true;
            }
            // å¦‚æœæ²¡æœ‰ç‰¹å®šå»ºç­‘æ•ˆæœï¼Œåˆ™ä½¿ç”¨é€šç”¨effectç±»å‹
            if (!hasSpecificEffect) {
                if (b.effect === 'food') {
                    effects.push({ icon: 'ğŸ½ï¸', text: 'ç”¨é¤', desc: `æ¢å¤é¥±é£Ÿåº¦ +${b.food || 35}ï¼Œä½“åŠ› +5` });
                }
                else if (b.effect === 'health' || b.effect === 'tourist_health') {
                    effects.push({ icon: 'ğŸ¥', text: 'åŒ»ç–—', desc: 'å¥åº· +40ï¼Œå¿ƒæƒ… +5ï¼Œä½“åŠ› +5' });
                }
                else if (b.effect === 'beauty') {
                    effects.push({ icon: 'ğŸ’ª', text: 'å¥èº«', desc: 'å¥åº· +5ï¼Œé¢œå€¼ +2ï¼Œå¿ƒæƒ… +10ï¼Œä½“åŠ› +10' });
                }
                else if (b.effect === 'fun_high' || b.effect === 'tourist_high') {
                    effects.push({ icon: 'ğŸ‰', text: 'å¨±ä¹', desc: 'å¿ƒæƒ… +30ï¼Œä½“åŠ› +5' });
                }
                else if (b.effect === 'study') {
                    effects.push({ icon: 'ğŸ“š', text: 'å­¦ä¹ ', desc: 'æ–‡åŒ– +0.5ï¼Œå¿ƒæƒ… +5~8ï¼Œä½“åŠ› +5' });
                }
                else if (b.effect === 'tourist') {
                    effects.push({ icon: 'ğŸ“¸', text: 'è§‚å…‰', desc: 'å¿ƒæƒ… +10' });
                }
            }
            if (effects.length > 0) {
                interactionHtml = '<div class="section-title">âœ¨ ç‰¹æ®Šäº’åŠ¨æ•ˆæœ</div><div style="background:#f0f8ff; padding:12px; border-radius:6px; margin-bottom:15px; border:1px solid #b3d9ff;">';
                effects.forEach((eff, idx) => {
                    interactionHtml += `<div style="margin-bottom:${idx < effects.length - 1 ? '10px' : '0'}; padding-bottom:${idx < effects.length - 1 ? '10px' : '0'}; border-bottom:${idx < effects.length - 1 ? '1px dashed #cce5ff' : 'none'};">
                        <div style="display:flex; align-items:center; margin-bottom:4px;">
                            <span style="font-size:1.2rem; margin-right:8px;">${eff.icon}</span>
                            <span style="font-weight:bold; color:#2c3e50;">${eff.text}</span>
                        </div>
                        <div style="font-size:0.85rem; color:#555; margin-left:28px; line-height:1.4;">${eff.desc}</div>
                    </div>`;
                });
                interactionHtml += '</div>';
            }
            content.innerHTML = `
                <div style="margin-bottom:15px; font-size:0.9rem; color:#555;">${b.desc}</div>
                ${statsHtml}
                <div class="section-title">ğŸ“‹ åŸºæœ¬ä¿¡æ¯</div>
                <div style="background:#f8f9fa; padding:12px; border-radius:6px; margin-bottom:15px; border:1px solid #eee; font-size:0.9rem;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                        <span style="color:#666;">ğŸ•’ è¥ä¸šæ—¶é—´:</span>
                        <span style="font-weight:bold; color:#2c3e50;">${openTimeStr || 'æœªè®¾ç½®'}</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                        <span style="color:#666;">ğŸ“… ä¼‘æ¯æ—¥:</span>
                        <span style="font-weight:bold; color:#2c3e50;">${closedDaysStr}</span>
                    </div>
                    ${b.price > 0 ? `<div style="display:flex; justify-content:space-between;">
                        <span style="color:#666;">ğŸ’° æ¶ˆè´¹ä»·æ ¼:</span>
                        <span style="font-weight:bold; color:#e67e22;">${b.price}å…ƒ</span>
                    </div>` : ''}
                </div>
                ${interactionHtml}
                ${wageInfoHtml}
                ${sellsHtml}
                <div class="section-title">å‘˜å·¥åˆ—è¡¨ (${b.staff.length}/${b.jobs.length})</div>
                <div style="max-height:150px; overflow-y:auto; border:1px solid #eee; border-radius:4px; margin-bottom:15px;">${staffHtml}</div>
                ${prosHtml ? `<div class="section-title">ç‰¹æ®ŠæœåŠ¡äººå‘˜</div><div style="max-height:100px; overflow-y:auto; border:1px solid #eee; border-radius:4px; margin-bottom:15px;">${prosHtml}</div>` : ''}
                <div class="section-title">ç»è¥æ—¥å¿—</div>
                ${historyHtml}
            `;
            modal.classList.add('active');
        }
        closeBuildingDetail() { document.getElementById('building-detail-modal').classList.remove('active'); }
        updateUI() {
            const gameTimeEl = document.getElementById('game-time'); if(gameTimeEl) gameTimeEl.innerText = `${Math.floor(this.gameTime/60).toString().padStart(2,'0')}:${(this.gameTime%60).toString().padStart(2,'0')}`;
            const gameDayEl = document.getElementById('game-day'); if(gameDayEl) gameDayEl.innerText = DAYS[this.gameDay];
            const calEl = document.getElementById('calendar-display'); if(calEl) calEl.innerText = `ğŸ“… ${this.dateMonth}æœˆ${this.dateDay}æ—¥ (${this.getSeasonName()})`;
            const weatherEl = document.getElementById('weather-display'); if(weatherEl) weatherEl.innerText = WEATHER_TYPES[this.weather].name;
            const moneyEl = document.getElementById('town-money'); if(moneyEl) moneyEl.innerText = Math.floor(this.townMoney);
            const resCountEl = document.getElementById('resident-count'); if(resCountEl) resCountEl.innerText = this.chars.length;
            // å¦‚æœè´¢æ”¿ç•Œé¢æ˜¯æ‰“å¼€çš„ï¼Œæ›´æ–°è´¢æ”¿ç•Œé¢æ˜¾ç¤º
            const financeModal = document.getElementById('finance-modal');
            if(financeModal && financeModal.classList.contains('active')) {
                const financeMoneyEl = document.getElementById('finance-town-money');
                if(financeMoneyEl) financeMoneyEl.innerText = Math.floor(this.townMoney);
                this.renderFinanceHistory();
            }
            const charList = document.getElementById('char-list');
            if(charList) {
                charList.innerHTML = '';
                this.chars.forEach(c => {
                    const div = document.createElement('div');
                    let actionClass = 'action-rest';
                    if(c.currentAction.includes("æ‰“å·¥") || c.currentAction.includes("ä¸Šç­")) actionClass = 'action-work';
                    else if(c.currentAction.includes("å»ºè®¾")) actionClass = 'action-build';
                    else if(c.currentAction.includes("åƒé¥­") || c.currentAction.includes("åŒ…å­")) actionClass = 'action-eat';
                    else if(c.currentAction.includes("çŠ¯ç½ª") || c.currentAction.includes("æŠ¢åŠ«") || c.currentAction.includes("éªšæ‰°")) actionClass = 'action-crime';
                    else if(c.currentAction.includes("èººå¹³") || c.currentAction.includes("ç¡è§‰")) actionClass = 'action-sleep';
                    else if(c.currentAction.includes("äº’åŠ¨") || c.currentAction.includes("å’Œ")) actionClass = 'action-social';
                    else if(c.currentAction.includes("åç‰¢")) actionClass = 'action-jail';
                    else if(c.currentAction.includes("è´­ç‰©") || c.currentAction.includes("ä¹°")) actionClass = 'action-shop';
                    const isMayor = this.mayor === c.name;
                    div.className = `char-card ${actionClass} ${isMayor ? 'mayor' : ''}`;
                    div.onclick = () => gameInstance.showCharacterDetail(c.name);
                    let statusIcons = "";
                    if(c.partner) statusIcons += "â¤ï¸";
                    if(c.money < 10) statusIcons += "ğŸ’¸";
                    if(c.happiness < 30) statusIcons += "ğŸ˜­";
                    if(c.health < 30) statusIcons += "ğŸ˜·";
                    if(c.stamina < 20) statusIcons += "ğŸ’¤";
                    let mayorIcon = isMayor ? "ğŸ–ï¸" : "";
                    let jobDisplay = c.job ? `åœ¨${this.buildings.find(b=>b.id===c.job.buildingId)?.name||'æœªçŸ¥'}è¿›è¡Œ${c.job.role}å·¥ä½œ` : (c.prostitute ? "å¤±è¶³" : "æ— ä¸š");
                    div.innerHTML = `
                        <div style="display:flex; justify-content:space-between; font-weight:bold;">
                            <span>${mayorIcon} ${c.name} <span style="font-size:0.8em; color:#666;">${c.gender}</span></span>
                            <span>${statusIcons}</span>
                        </div>
                        <div style="font-size:0.85rem; margin:2px 0; display:flex; justify-content:space-between;">
                            <span style="color:#666;">${jobDisplay}</span>
                            <span style="color:#f1c40f; font-weight:bold;">ğŸ’°${Math.floor(c.money)}</span>
                        </div>
                        <div style="font-size:0.8rem; color:#888; margin-bottom:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${c.currentAction}</div>
                        <div style="display:flex; align-items:center; gap:5px; margin-top:2px;">
                            <span style="font-size:0.8rem; width:12px;">â¤</span>
                            <div class="bar-container" style="flex:1; margin:0;" title="å¿ƒæƒ…: ${Math.floor(c.happiness)}">
                                <div class="bar-fill" style="width:${c.happiness}%; background:${c.happiness<30?'#e74c3c':'#3498db'}"></div>
                            </div>
                        </div>
                        <div style="display:flex; align-items:center; gap:5px; margin-top:2px;">
                            <span style="font-size:0.8rem; width:12px;">ğŸ—</span>
                            <div class="bar-container" style="flex:1; margin:0;" title="é¥±é£Ÿ: ${Math.floor(c.hunger)}">
                                <div class="bar-fill food-fill" style="width:${c.hunger}%"></div>
                            </div>
                        </div>
                        <div style="display:flex; align-items:center; gap:5px; margin-top:2px;">
                            <span style="font-size:0.8rem; width:12px;">âš¡</span>
                            <div class="bar-container" style="flex:1; margin:0;" title="ä½“åŠ›: ${Math.floor(c.stamina)}">
                                <div class="bar-fill stamina-fill" style="width:${c.stamina}%"></div>
                            </div>
                        </div>
                        <div style="display:flex; align-items:center; gap:5px; margin-top:2px;">
                            <span style="font-size:0.8rem; width:12px;">ğŸš‘</span>
                            <div class="bar-container" style="flex:1; margin:0;" title="å¥åº·: ${Math.floor(c.health)}">
                                <div class="bar-fill health-fill" style="width:${c.health}%"></div>
                            </div>
                        </div>
                    `;
                    charList.appendChild(div);
                });
            }
            this.renderUIStatic();
            const bList = document.getElementById('build-list');
            this.buildings.forEach(b => {
                const card = document.getElementById(`build-${b.id}`);
                if (card) {
                    if (b.isBuilt) card.className = 'build-card built';
                    else if (b.isUnderConstruction) card.className = 'build-card building';
                    else card.className = 'build-card';
                    const bar = card.querySelector('.bar-fill');
                    const prog = card.querySelector('.build-prog');
                    if (bar && prog) {
                        const pct = Math.min(100, Math.floor((b.currentProgress / b.totalCost) * 100));
                        bar.style.width = `${pct}%`;
                        if(b.isBuilt) prog.innerText = `å·²å»ºæˆ (Lv.${b.level}) - å‘˜å·¥: ${b.staff.length}`;
                        else if(b.isUnderConstruction) prog.innerText = `å»ºè®¾ä¸­... ${pct}%`;
                        else prog.innerText = b.currentProgress > 0 ? `æš‚åœä¸­ (${pct}%)` : `æœªåŠ¨å·¥ (éœ€ğŸ’°${b.totalCost})`;
                    }
                    // æ›´æ–°å½“å‰åœ¨æ­¤å»ºç­‘äº’åŠ¨çš„è®¿å®¢æ˜¾ç¤ºï¼ˆä¸åŒ…æ‹¬å‘˜å·¥ï¼‰
                    if (b.isBuilt) {
                        const visitors = this.chars.filter(c => {
                            // æ’é™¤åœ¨æ­¤å»ºç­‘å·¥ä½œçš„å‘˜å·¥
                            if (c.job && c.job.buildingId === b.id) return false;
                            // æ£€æŸ¥currentActionä¸­æ˜¯å¦åŒ…å«å»ºç­‘åç§°
                            if (c.currentAction && c.currentAction.includes(b.name)) return true;
                            return false;
                        });
                        let visitorsDiv = card.querySelector('.visitors-info');
                        if (visitors.length > 0) {
                            const visitorList = visitors.slice(0, 3).map(c => {
                                let activity = '';
                                if (c.currentAction) {
                                    // ä»currentActionä¸­æå–æ´»åŠ¨æè¿°
                                    const action = c.currentAction;
                                    if (action.includes('ä¸Šè¯¾')) activity = 'åœ¨æ­¤ä¸Šè¯¾å­¦ä¹ ';
                                    else if (action.includes('é”»ç‚¼') || action.includes('å¥èº«')) activity = 'åœ¨æ­¤é”»ç‚¼å¥èº«';
                                    else if (action.includes('é˜…è¯»')) activity = 'åœ¨æ­¤é˜…è¯»å­¦ä¹ ';
                                    else if (action.includes('å‚è§‚')) activity = 'åœ¨æ­¤å‚è§‚å±•è§ˆ';
                                    else if (action.includes('æ²»ç–—') || action.includes('é—¨è¯Š')) activity = 'åœ¨æ­¤çœ‹ç—…æ²»ç–—';
                                    else if (action.includes('ç–—å…»') || action.includes('æ¸©æ³‰')) activity = 'åœ¨æ­¤æ¸©æ³‰ç–—å…»';
                                    else if (action.includes('ç¥ˆç¥·')) activity = 'åœ¨æ­¤ç¥ˆç¥·ç¥·å‘Š';
                                    else if (action.includes('æ¸¸æˆ')) activity = 'åœ¨æ­¤æ¸¸æˆå¨±ä¹';
                                    else if (action.includes('è§‚å½±')) activity = 'åœ¨æ­¤è§‚å½±å¨±ä¹';
                                    else if (action.includes('ä¹°é†‰') || action.includes('å–é…’')) activity = 'åœ¨æ­¤å–é…’ä¹°é†‰';
                                    else if (action.includes('æ¸¸ç©')) activity = 'åœ¨æ­¤æ¸¸ç©å¨±ä¹';
                                    else if (action.includes('æ•£æ­¥')) activity = 'åœ¨æ­¤æ•£æ­¥ä¼‘é—²';
                                    else if (action.includes('ç”¨é¤') || action.includes('åƒåŒ…å­')) activity = 'åœ¨æ­¤ç”¨é¤';
                                    else if (action.includes('åƒé¥­') || action.includes('åƒå¾—é¥±é¥±')) activity = 'åœ¨æ­¤ç”¨é¤';
                                    else if (action.includes('è´­ç‰©') || action.includes('ä¹°äº†')) activity = 'åœ¨æ­¤è´­ç‰©';
                                    else if (action.includes('æ”¾æ¾')) activity = 'åœ¨æ­¤æ”¾æ¾ä¼‘æ¯';
                                    else activity = 'åœ¨æ­¤äº’åŠ¨';
                                } else {
                                    activity = 'åœ¨æ­¤äº’åŠ¨';
                                }
                                return `${c.name}${activity}`;
                            }).join('ï¼Œ');
                            const moreCount = visitors.length > 3 ? `ç­‰${visitors.length}äºº` : '';
                            if (!visitorsDiv) {
                                visitorsDiv = document.createElement('div');
                                visitorsDiv.className = 'visitors-info';
                                const descDiv = card.querySelector('div > div:first-child');
                                if (descDiv) descDiv.appendChild(visitorsDiv);
                            }
                            visitorsDiv.style.cssText = 'font-size:0.75rem; color:#27ae60; margin-top:5px; padding:4px 8px; background:#e8f8f5; border-radius:4px; border:1px solid #a8e6cf;';
                            visitorsDiv.innerHTML = `<span style="font-weight:bold;">ğŸ‘¥ å½“å‰è®¿å®¢:</span> ${visitorList}${moreCount}`;
                        } else if (visitorsDiv) {
                            visitorsDiv.remove();
                        }
                    }
                }
            });
        }
        renderLeaderboard(type) {
            const list = document.getElementById('leaderboard-list'); if(!list) return; list.innerHTML = '';
            const sorted = [...this.chars].sort((a, b) => {
                if(type==='money') return b.money - a.money;
                if(type==='happiness') return b.happiness - a.happiness;
                if(type==='popularity') {
                    const popA = this.chars.reduce((acc, c) => acc + (c.relationships[a.name]?.love || 0), 0);
                    const popB = this.chars.reduce((acc, c) => acc + (c.relationships[b.name]?.love || 0), 0);
                    return popB - popA;
                }
                if(type==='robbery') return (b.stat_rob||0) - (a.stat_rob||0);
                if(type==='streetwalk') return (b.stat_streetwalk||0) - (a.stat_streetwalk||0);
                if(type==='assault') return (b.stat_assault||0) - (a.stat_assault||0);
                return 0;
            });
            sorted.forEach((c, i) => {
                const div = document.createElement('div'); div.className = 'rank-item';
                let val = 0; let unit = '';
                if(type==='money') { val = Math.floor(c.money); unit = 'ğŸ’°'; }
                if(type==='happiness') { val = Math.floor(c.happiness); unit = 'â¤'; }
                if(type==='popularity') { val = this.chars.reduce((acc, x) => acc + (x.relationships[c.name]?.love || 0), 0); unit = 'ğŸ”¥'; }
                if(type==='robbery') { val = c.stat_rob || 0; unit = 'æ¬¡'; }
                if(type==='streetwalk') { val = c.stat_streetwalk || 0; unit = 'æ¬¡'; }
                if(type==='assault') { val = c.stat_assault || 0; unit = 'æ¬¡'; }
                let displayVal = (['robbery','streetwalk','assault'].includes(type)) ? `${val} ${unit}` : `${unit} ${val}`;
                div.innerHTML = `<div class="rank-num rank-${i+1}">${i+1}</div><div class="rank-info"><div class="rank-name">${c.name}</div></div><div class="rank-val">${displayVal}</div>`;
                list.appendChild(div);
            });
            document.getElementById('leaderboard-modal').classList.add('active');
        }
        closeLeaderboard() { document.getElementById('leaderboard-modal').classList.remove('active'); }
        showCalendar() {
            const container = document.getElementById('calendar-container');
            if(!container) return;
            container.innerHTML = '';
            for (let m = 1; m <= 12; m++) {
                const monthDiv = document.createElement('div');
                monthDiv.className = 'month-card';
                let seasonIcon = '';
                if(m>=3 && m<=5) seasonIcon='ğŸŒ¸'; else if(m>=6 && m<=8) seasonIcon='ğŸŒ'; else if(m>=9 && m<=11) seasonIcon='ğŸ‚'; else seasonIcon='â„ï¸';
                let daysHtml = `<div class="month-title">${seasonIcon} ${m}æœˆ</div><div class="days-grid">`;
                const daysInMonth = MONTH_DAYS[m];
                for (let d = 1; d <= daysInMonth; d++) {
                    const isToday = (this.dateMonth === m && this.dateDay === d);
                    const evt = TOWN_EVENTS.find(e => e.date && e.date.m === m && e.date.d === d);
                    const evtClass = evt ? 'event-day' : '';
                    const todayClass = isToday ? 'today' : '';
                    const dataAttr = evt ? `data-evt="${evt.name}"` : '';
                    daysHtml += `<div class="day-cell ${evtClass} ${todayClass}" ${dataAttr}>${d}</div>`;
                }
                daysHtml += `</div>`;
                monthDiv.innerHTML = daysHtml;
                container.appendChild(monthDiv);
            }
            document.getElementById('calendar-modal').classList.add('active');
        }
        closeCalendar() { document.getElementById('calendar-modal').classList.remove('active'); }
        closeJobBoard() { document.getElementById('jobboard-modal').classList.remove('active'); }
        closeGameGuide() { document.getElementById('guide-modal').classList.remove('active'); }
        manualSave() { this.saveData(false); }
        resetData() { if(confirm("ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™å°†æ— æ³•æ’¤é”€ï¼")) { localStorage.removeItem('happyTownV2_Save'); location.reload(); } }
        openEditModal(title, options, currentVal, type, charName) {
            const titleEl = document.getElementById('edit-title'); if(titleEl) titleEl.innerText = title;
            const sel = document.getElementById('edit-select'); 
            if(sel) {
                sel.innerHTML = '';
                options.forEach(opt => { const op = document.createElement('option'); op.value = opt; op.innerText = opt; if(opt === currentVal) op.selected = true; sel.appendChild(op); });
                window.editContext = { type, charName };
                document.getElementById('edit-modal').classList.add('active');
            }
        }
        closeEditModal() { document.getElementById('edit-modal').classList.remove('active'); }
        confirmEdit() {
            const sel = document.getElementById('edit-select'); if(!sel) return;
            const val = sel.value;
            const ctx = window.editContext;
            if (ctx) {
                const c = this.chars.find(x => x.name === ctx.charName);
                if (c) {
                    if (ctx.type === 'gender') c.gender = val;
                    if (ctx.type === 'ideology') { const i = IDEOLOGIES.find(x=>x.name===val); if(i) c.ideology = i; }
                    if (ctx.type === 'trait') { const t = TRAITS.find(x=>x.name===val); if(t) c.traits = [t]; }
                    this.log(`[âœï¸ä¿®æ”¹] ç©å®¶ä¿®æ”¹äº† ${c.name} çš„å±æ€§`, "tag-build");
                    this.updateUI();
                    this.showCharacterDetail(c.name);
                }
            }
            this.closeEditModal();
        }
    }
    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`tab-${tab}`).classList.add('active');
        document.querySelectorAll('.col-view').forEach(v => v.classList.remove('active-view'));
        document.getElementById(`view-${tab}`).classList.add('active-view');
    }
    // çª—å£å¤§å°æ”¹å˜æ—¶çš„å¤„ç†å‡½æ•°
    let relationResizeHandler = null;
    function toggleRelationView() {
        const v = document.getElementById('relation-view');
        const main = document.getElementById('main-view');
        const canvas = document.getElementById('rel-canvas');
        if (v.classList.contains('active')) { 
            v.classList.remove('active'); 
            main.style.display = 'flex';
            // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
            if (canvas) {
                canvas.removeEventListener('mousemove', handleRelationCanvasMouseMove);
                canvas.removeEventListener('mouseleave', handleRelationCanvasMouseLeave);
                canvas.removeEventListener('click', handleRelationCanvasClick);
            }
            // ç§»é™¤çª—å£å¤§å°æ”¹å˜ç›‘å¬
            if (relationResizeHandler) {
                window.removeEventListener('resize', relationResizeHandler);
                relationResizeHandler = null;
            }
        } else { 
            v.classList.add('active'); 
            main.style.display = 'none'; 
            renderRelationGraph();
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            if (canvas) {
                canvas.addEventListener('mousemove', handleRelationCanvasMouseMove);
                canvas.addEventListener('mouseleave', handleRelationCanvasMouseLeave);
                canvas.addEventListener('click', handleRelationCanvasClick);
            }
            // æ·»åŠ çª—å£å¤§å°æ”¹å˜ç›‘å¬
            if (!relationResizeHandler) {
                relationResizeHandler = () => {
                    if (v.classList.contains('active')) {
                        renderRelationGraph();
                    }
                };
                window.addEventListener('resize', relationResizeHandler);
            }
        }
    }
    function handleRelationCanvasMouseMove(e) {
        const canvas = document.getElementById('rel-canvas');
        if (!canvas || relationGraphState.positions.length === 0) return;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        // æ£€æŸ¥é¼ æ ‡æ˜¯å¦åœ¨æŸä¸ªèŠ‚ç‚¹ä¸Š
        let foundIndex = -1;
        const hoverRadius = 30; // æ‚¬åœæ£€æµ‹åŠå¾„ï¼ˆæ¯”èŠ‚ç‚¹ç¨å¤§ï¼‰
        for (let i = 0; i < relationGraphState.positions.length; i++) {
            const pos = relationGraphState.positions[i];
            const distance = Math.sqrt(Math.pow(x - pos.x, 2) + Math.pow(y - pos.y, 2));
            if (distance <= hoverRadius) {
                foundIndex = i;
                break;
            }
        }
        // å¦‚æœæ‚¬åœçš„èŠ‚ç‚¹æ”¹å˜äº†ï¼Œé‡æ–°æ¸²æŸ“
        if (foundIndex !== relationGraphState.hoveredIndex) {
            relationGraphState.hoveredIndex = foundIndex;
            renderRelationGraph();
            // æ›´æ–°é¼ æ ‡æ ·å¼
            canvas.style.cursor = foundIndex >= 0 ? 'pointer' : 'default';
        }
    }
    function handleRelationCanvasMouseLeave() {
        if (relationGraphState.hoveredIndex >= 0) {
            relationGraphState.hoveredIndex = -1;
            renderRelationGraph();
        }
    }
    function handleRelationCanvasClick(e) {
        const canvas = document.getElementById('rel-canvas');
        if (!canvas || relationGraphState.positions.length === 0) return;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        // æ£€æŸ¥ç‚¹å‡»æ˜¯å¦åœ¨æŸä¸ªèŠ‚ç‚¹ä¸Š
        const clickRadius = 30;
        for (let i = 0; i < relationGraphState.positions.length; i++) {
            const pos = relationGraphState.positions[i];
            const distance = Math.sqrt(Math.pow(x - pos.x, 2) + Math.pow(y - pos.y, 2));
            if (distance <= clickRadius) {
                const char = gameInstance.chars[i];
                if (char) {
                    showSingleCharRelation(char);
                }
                break;
            }
        }
    }
    let singleCharRelationResizeHandler = null;
    let currentSingleChar = null;
    function showSingleCharRelation(char) {
        const modal = document.getElementById('single-char-relation-modal');
        const nameEl = document.getElementById('single-char-relation-name');
        if (nameEl) nameEl.innerText = `${char.name} çš„å…³ç³»ç½‘ç»œ`;
        currentSingleChar = char;
        renderSingleCharRelationGraph(char);
        renderSingleCharRelationList(char);
        modal.classList.add('active');
        // æ·»åŠ çª—å£å¤§å°æ”¹å˜ç›‘å¬
        if (!singleCharRelationResizeHandler) {
            singleCharRelationResizeHandler = () => {
                if (currentSingleChar && modal.classList.contains('active')) {
                    renderSingleCharRelationGraph(currentSingleChar);
                }
            };
            window.addEventListener('resize', singleCharRelationResizeHandler);
        }
    }
    function closeSingleCharRelation() {
        document.getElementById('single-char-relation-modal').classList.remove('active');
        currentSingleChar = null;
    }
    function renderSingleCharRelationGraph(char) {
        const canvas = document.getElementById('single-char-relation-canvas');
        if (!canvas) return;
        const container = canvas.parentElement;
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
        const ctx = canvas.getContext('2d');
        const w = canvas.width, h = canvas.height;
        const cx = w / 2, cy = h / 2;
        ctx.clearRect(0, 0, w, h);
        // è·å–ä¸è¯¥å±…æ°‘æœ‰å…³ç³»çš„å…¶ä»–å±…æ°‘
        const relatedChars = [];
        for (let name in char.relationships) {
            const otherChar = gameInstance.chars.find(c => c.name === name);
            if (otherChar && otherChar.name !== char.name) {
                const rel = char.relationships[name];
                if (Math.abs(rel.love) > 10 || rel.status !== 'stranger') {
                    relatedChars.push({ char: otherChar, rel: rel });
                }
            }
        }
        // ä¸­å¿ƒèŠ‚ç‚¹ï¼ˆå½“å‰å±…æ°‘ï¼‰
        const centerRadius = 30;
        ctx.beginPath();
        ctx.arc(cx, cy, centerRadius, 0, Math.PI * 2);
        ctx.fillStyle = '#fffef0';
        ctx.fill();
        ctx.lineWidth = 4;
        ctx.strokeStyle = char.gender.includes('å¥³') ? '#ff7675' : '#74b9ff';
        ctx.stroke();
        ctx.fillStyle = '#2c3e50';
        ctx.font = "bold 14px Arial";
        ctx.textAlign = "center";
        ctx.fillText(char.name, cx, cy + centerRadius + 20);
        // ç»˜åˆ¶å…³ç³»çº¿
        const n = relatedChars.length;
        if (n > 0) {
            const angleStep = (Math.PI * 2) / n;
            // æ ¹æ®å…³ç³»æ•°é‡åŠ¨æ€è°ƒæ•´åŠå¾„
            const baseRadius = Math.min(w, h) * 0.3;
            const radius = n <= 3 ? baseRadius * 0.7 : (n <= 6 ? baseRadius : baseRadius * 1.1);
            relatedChars.forEach((item, i) => {
                const angle = i * angleStep;
                const x = cx + Math.cos(angle) * radius;
                const y = cy + Math.sin(angle) * radius;
                // ç»˜åˆ¶å…³ç³»çº¿
                ctx.beginPath();
                ctx.moveTo(cx, cy);
                ctx.lineTo(x, y);
                let color = '#ccc';
                let width = 1;
                let label = "";
                const rel = item.rel;
                if (rel.status === 'spouse') { color = '#e84393'; width = 4; label = "â¤"; }
                else if (rel.status === 'lover') { color = '#ff7675'; width = 4; label = "â¤"; }
                else if (rel.status === 'enemy') { color = '#c0392b'; width = 3; label = "âš”ï¸"; }
                else if (rel.status === 'bestfriend') { color = '#3498db'; width = 3; }
                else if (rel.love > 50) { color = 'rgba(46, 204, 113, 0.8)'; width = 2; }
                else if (rel.love < -30) { color = 'rgba(231, 76, 60, 0.8)'; width = 2; }
                else {
                    const opacity = Math.min(0.6, Math.abs(rel.love) / 100);
                    color = rel.love > 0 ? `rgba(52, 152, 219, ${opacity})` : `rgba(231, 76, 60, ${opacity})`;
                }
                ctx.strokeStyle = color;
                ctx.lineWidth = width;
                ctx.stroke();
                // ç»˜åˆ¶å…³ç³»æ ‡ç­¾
                if (label) {
                    const mx = (cx + x) / 2;
                    const my = (cy + y) / 2;
                    ctx.fillStyle = '#fff';
                    ctx.beginPath();
                    ctx.arc(mx, my, 10, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = color;
                    ctx.font = "14px Arial";
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";
                    ctx.fillText(label, mx, my);
                }
                // ç»˜åˆ¶å…¶ä»–å±…æ°‘èŠ‚ç‚¹
                const nodeRadius = n <= 6 ? 18 : 15;
                ctx.beginPath();
                ctx.arc(x, y, nodeRadius, 0, Math.PI * 2);
                ctx.fillStyle = '#fff';
                ctx.fill();
                ctx.lineWidth = 2;
                ctx.strokeStyle = item.char.gender.includes('å¥³') ? '#ff7675' : '#74b9ff';
                ctx.stroke();
                // ç»˜åˆ¶åå­—ï¼ˆæ ¹æ®èŠ‚ç‚¹æ•°é‡è°ƒæ•´å­—ä½“å¤§å°ï¼‰
                const fontSize = n <= 6 ? 11 : 9;
                ctx.fillStyle = '#333';
                ctx.font = `bold ${fontSize}px Arial`;
                ctx.textAlign = "center";
                ctx.fillText(item.char.name, x, y + nodeRadius + (n <= 6 ? 15 : 12));
                // ç»˜åˆ¶å¥½æ„Ÿåº¦
                const loveColor = rel.love >= 0 ? '#2d98da' : '#e74c3c';
                ctx.fillStyle = loveColor;
                ctx.font = `${n <= 6 ? 10 : 8}px Arial`;
                ctx.fillText(`${Math.floor(rel.love)}`, x, y + nodeRadius + (n <= 6 ? 28 : 22));
            });
        } else {
            // æ²¡æœ‰å…³ç³»æ—¶æ˜¾ç¤ºæç¤º
            ctx.fillStyle = '#999';
            ctx.font = "16px Arial";
            ctx.textAlign = "center";
            ctx.fillText("æš‚æ— é‡è¦å…³ç³»", cx, cy + 50);
        }
    }
    function renderSingleCharRelationList(char) {
        const listEl = document.getElementById('single-char-relation-list');
        if (!listEl) return;
        listEl.innerHTML = '';
        // æŒ‰å…³ç³»ç±»å‹åˆ†ç»„
        const relationsByStatus = {
            'spouse': [],
            'lover': [],
            'mistress': [],
            'bestfriend': [],
            'friend': [],
            'ex': [],
            'enemy': [],
            'stranger': []
        };
        for (let name in char.relationships) {
            const otherChar = gameInstance.chars.find(c => c.name === name);
            if (otherChar && otherChar.name !== char.name) {
                const rel = char.relationships[name];
                const status = rel.status || 'stranger';
                if (relationsByStatus[status]) {
                    relationsByStatus[status].push({ char: otherChar, rel: rel });
                }
            }
        }
        // æŒ‰å¥½æ„Ÿåº¦æ’åºå¹¶æ˜¾ç¤º
        Object.keys(relationsByStatus).forEach(status => {
            const relations = relationsByStatus[status];
            if (relations.length === 0) return;
            relations.sort((a, b) => b.rel.love - a.rel.love);
            const statusTitle = document.createElement('div');
            statusTitle.style.cssText = 'font-weight:bold; margin-top:15px; margin-bottom:8px; padding-bottom:5px; border-bottom:2px solid #eee; color:#2c3e50;';
            statusTitle.innerText = REL_TRANSLATE[status] || status;
            listEl.appendChild(statusTitle);
            relations.forEach(item => {
                const div = document.createElement('div');
                div.style.cssText = 'padding:8px; margin-bottom:5px; background:#f8f9fa; border-radius:4px; border-left:3px solid #ddd;';
                const rel = item.rel;
                let borderColor = '#ddd';
                if (status === 'spouse') borderColor = '#e84393';
                else if (status === 'lover') borderColor = '#ff7675';
                else if (status === 'enemy') borderColor = '#c0392b';
                else if (status === 'bestfriend') borderColor = '#3498db';
                div.style.borderLeftColor = borderColor;
                const loveColor = rel.love >= 0 ? '#2d98da' : '#e74c3c';
                div.innerHTML = `
                    <div style="font-weight:bold; margin-bottom:3px;">${item.char.name}</div>
                    <div style="font-size:0.85rem; color:#666;">
                        å¥½æ„Ÿåº¦: <span style="color:${loveColor}; font-weight:bold;">${Math.floor(rel.love)}</span>
                    </div>
                `;
                listEl.appendChild(div);
            });
        });
    }
    // å…³ç³»è°±å…¨å±€çŠ¶æ€
    let relationGraphState = {
        hoveredIndex: -1,
        positions: []
    };
    function renderRelationGraph() {
        const canvas = document.getElementById('rel-canvas'); if(!canvas) return;
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('rel-graph-container');
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
        const w = canvas.width, h = canvas.height;
        const cx = w/2, cy = h/2;
        const r = Math.min(w, h) * 0.4;
        const chars = gameInstance.chars;
        const n = chars.length;
        const angleStep = (Math.PI * 2) / n;
        // å­˜å‚¨ä½ç½®ä¿¡æ¯ä¾›é¼ æ ‡äº‹ä»¶ä½¿ç”¨
        relationGraphState.positions = chars.map((c, i) => {
            return { 
                x: cx + Math.cos(i*angleStep)*r, 
                y: cy + Math.sin(i*angleStep)*r, 
                char: c,
                index: i
            };
        });
        ctx.clearRect(0,0,w,h);
        const hoveredIdx = relationGraphState.hoveredIndex;
        // Draw lines
        chars.forEach((c, i) => {
            const p1 = relationGraphState.positions[i];
            chars.forEach((t, j) => {
                if (i >= j) return;
                const rel = c.relationships[t.name];
                if (rel && (Math.abs(rel.love) > 25 || rel.status !== 'stranger')) {
                    const p2 = relationGraphState.positions[j];
                    // åˆ¤æ–­æ˜¯å¦åº”è¯¥é«˜äº®è¿™æ¡çº¿ï¼ˆä¸æ‚¬åœçš„å±…æ°‘ç›¸å…³ï¼‰
                    const isHighlighted = hoveredIdx >= 0 && (i === hoveredIdx || j === hoveredIdx);
                    const shouldDim = hoveredIdx >= 0 && !isHighlighted;
                    ctx.beginPath();
                    ctx.moveTo(p1.x, p1.y);
                    ctx.lineTo(p2.x, p2.y);
                    let color = `rgba(200, 200, 200, 0.1)`;
                    let width = 1;
                    let label = "";
                    if (rel.status === 'spouse') { color = '#e84393'; width = 3; label = "â¤"; }
                    else if (rel.status === 'lover') { color = '#ff7675'; width = 3; label = "â¤"; }
                    else if (rel.status === 'enemy') { color = '#c0392b'; width = 2.5; label = "âš”ï¸"; }
                    else if (rel.status === 'bestfriend') { color = '#3498db'; width = 2; }
                    else if (rel.love > 50) { color = 'rgba(46, 204, 113, 0.6)'; width = 1.5; }
                    else if (rel.love < -30) { color = 'rgba(231, 76, 60, 0.6)'; width = 1.5; }
                    else {
                         const opacity = Math.min(0.5, Math.abs(rel.love)/150);
                         color = rel.love > 0 ? `rgba(52, 152, 219, ${opacity})` : `rgba(231, 76, 60, ${opacity})`;
                    }
                    // é«˜äº®æ•ˆæœï¼šå¢åŠ å®½åº¦å’Œäº®åº¦
                    if (isHighlighted) {
                        width = Math.max(width * 2, 3);
                        // å¢åŠ é€æ˜åº¦
                        if (color.includes('rgba')) {
                            const match = color.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)/);
                            if (match) {
                                const alpha = Math.min(1, parseFloat(match[4]) * 2);
                                color = `rgba(${match[1]}, ${match[2]}, ${match[3]}, ${alpha})`;
                            }
                        } else {
                            // å¯¹äºérgbaé¢œè‰²ï¼Œæ·»åŠ é«˜äº®æ•ˆæœ
                            ctx.shadowBlur = 8;
                            ctx.shadowColor = color;
                        }
                    } else if (shouldDim) {
                        // éé«˜äº®çº¿å˜æš—
                        ctx.globalAlpha = 0.2;
                    }
                    ctx.strokeStyle = color;
                    ctx.lineWidth = width;
                    ctx.stroke();
                    // é‡ç½®é˜´å½±å’Œé€æ˜åº¦
                    ctx.shadowBlur = 0;
                    ctx.globalAlpha = 1.0;
                    if(label && !shouldDim) {
                        const mx = (p1.x + p2.x)/2;
                        const my = (p1.y + p2.y)/2;
                        ctx.fillStyle = '#fff';
                        ctx.beginPath();
                        ctx.arc(mx, my, 8, 0, Math.PI*2);
                        ctx.fill();
                        ctx.fillStyle = color;
                        ctx.font = "12px Arial";
                        ctx.textAlign = "center";
                        ctx.textBaseline = "middle";
                        ctx.fillText(label, mx, my);
                    }
                }
            });
        });
        // Draw nodes
        chars.forEach((c, i) => {
            const p = relationGraphState.positions[i];
            const isHovered = i === hoveredIdx;
            // æ ¹æ®æ‚¬åœçŠ¶æ€è°ƒæ•´èŠ‚ç‚¹å¤§å°
            const nodeRadius = isHovered ? 25 : 15;
            const fontSize = isHovered ? 14 : 10;
            const fontWeight = isHovered ? "bold" : "bold";
            // ç»˜åˆ¶èŠ‚ç‚¹é˜´å½±ï¼ˆæ‚¬åœæ—¶ï¼‰
            if (isHovered) {
                ctx.shadowBlur = 15;
                ctx.shadowColor = c.gender.includes('å¥³') ? '#ff7675' : '#74b9ff';
            }
            ctx.beginPath();
            ctx.arc(p.x, p.y, nodeRadius, 0, Math.PI*2);
            ctx.fillStyle = isHovered ? '#fffef0' : '#fff';
            ctx.fill();
            ctx.lineWidth = isHovered ? 3 : 2;
            ctx.strokeStyle = c.gender.includes('å¥³') ? '#ff7675' : '#74b9ff';
            ctx.stroke();
            // é‡ç½®é˜´å½±
            ctx.shadowBlur = 0;
            // ç»˜åˆ¶åå­—
            ctx.fillStyle = isHovered ? '#2c3e50' : '#333';
            ctx.font = `${fontWeight} ${fontSize}px Arial`;
            ctx.textAlign = "center";
            ctx.fillText(c.name, p.x, p.y + nodeRadius + 20);
        });
        // Stats Update
        const relList = document.getElementById('rel-list');
        relList.innerHTML = '';
        let maxPop = -9999, minPop = 9999;
        let maxName = "æ— ", minName = "æ— ";
        chars.forEach(c => {
            const div = document.createElement('div');
            div.className = 'rel-item';
            let relsHtml = "";
            let popScore = 0;
            for(let tName in c.relationships) {
                const rel = c.relationships[tName];
                if (Math.abs(rel.love) > 20 || rel.status !== 'stranger') {
                    let tagClass = `tag-${rel.status}`;
                    relsHtml += `<span title="å¥½æ„Ÿ: ${Math.floor(rel.love)}" style="cursor:help">${tName}: <span class="rel-tag ${tagClass}">${REL_TRANSLATE[rel.status]} (${Math.floor(rel.love)})</span></span> `;
                }
                popScore += rel.love;
            }
            if(popScore > maxPop) { maxPop = popScore; maxName = c.name; }
            if(popScore < minPop) { minPop = popScore; minName = c.name; }
            div.innerHTML = `<div style="font-weight:bold; margin-bottom:4px;">${c.name} <span style="color:#999; font-size:0.8em">äººæ°”: ${Math.floor(popScore)}</span></div><div style="font-size:0.85rem; line-height:1.6;">${relsHtml || '<span style="color:#ccc">æš‚æ— é‡è¦å…³ç³»</span>'}</div>`;
            relList.appendChild(div);
        });
        document.getElementById('stat-pop').innerText = `${maxName} (${Math.floor(maxPop)})`;
        document.getElementById('stat-lonely').innerText = `${minName} (${Math.floor(minPop)})`;
    }
    function showAchievementPopup(ach) {
        // éªŒè¯æˆå°±æ•°æ®
        if (!ach || !ach.name || ach.reward === undefined) {
            console.error('Invalid achievement data:', ach);
            return;
        }
        const modal = document.getElementById('achievement-popup-modal');
        const iconEl = document.getElementById('achievement-popup-icon');
        const nameEl = document.getElementById('achievement-popup-name');
        const descEl = document.getElementById('achievement-popup-desc');
        const rewardEl = document.getElementById('achievement-popup-reward');
        const contentEl = document.getElementById('achievement-popup-content');
        if (!modal) {
            console.error('Achievement popup modal not found');
            return;
        }
        if (iconEl) {
            iconEl.innerText = ach.icon || 'ğŸ†';
            iconEl.style.animation = 'none';
            setTimeout(() => {
                iconEl.style.animation = 'achievementIconBounce 0.6s ease-out 0.3s both';
            }, 10);
        }
        if (nameEl) nameEl.innerText = ach.name || 'æœªçŸ¥æˆå°±';
        if (descEl) descEl.innerText = ach.desc || '';
        if (rewardEl) rewardEl.innerText = `ğŸ’° +${ach.reward || 0}`;
        // é‡ç½®åŠ¨ç”»
        if (contentEl) {
            contentEl.style.animation = 'none';
            setTimeout(() => {
                contentEl.style.animation = 'achievementPopIn 0.5s ease-out';
            }, 10);
        }
        if (modal) {
            modal.classList.add('active');
            modal.style.display = 'flex';
            // æ¸…é™¤ä¹‹å‰çš„è‡ªåŠ¨å…³é—­å®šæ—¶å™¨
            if (window.achievementPopupTimer) {
                clearTimeout(window.achievementPopupTimer);
            }
            // 4ç§’åè‡ªåŠ¨å…³é—­ï¼Œæˆ–ç‚¹å‡»æŒ‰é’®/èƒŒæ™¯å…³é—­
            window.achievementPopupTimer = setTimeout(() => {
                if (modal.classList.contains('active')) {
                    closeAchievementPopup();
                }
            }, 4000);
        }
    }
    function closeAchievementPopup() {
        const modal = document.getElementById('achievement-popup-modal');
        if (modal) {
            modal.classList.remove('active');
            // ç¡®ä¿å¼¹çª—è¢«éšè—
            modal.style.display = 'none';
        }
    }
    function inputNewResident() {
        const name = prompt("è¯·è¾“å…¥æ–°å±…æ°‘çš„åå­—:");
        if (name && name.trim() !== "") {
            gameInstance.addNewResident(name.trim());
        }
    }
    // Start Game
    new Game();
</script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
